<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ•‘æ€¥å¯¾å¿œã‚µãƒãƒ¼ãƒˆï¼ˆå­¦æ ¡é…å¸ƒãƒ»å‹ã¡åˆ‡ã‚Š v13ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{
      -webkit-tap-highlight-color:transparent;
      padding-bottom: 170px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    }
    .safe-area-bottom{ padding-bottom: env(safe-area-inset-bottom); }
    input,select,textarea{ min-height:48px; }
    select{
      appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:right .75rem center;
      background-size:1rem;
      padding-right:2.5rem!important;
    }
    .input-label{
      font-size:.75rem;font-weight:900;color:#64748b;margin-bottom:.25rem;display:block;letter-spacing:.02em;
    }
    .chip{
      transition:all .12s;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
      min-height:44px;
      display:flex;align-items:center;justify-content:center;
      text-align:center;padding:10px 8px;line-height:1.2;user-select:none;
    }
    .chip:active{ transform:scale(.97); filter:brightness(.95); }
    .collapse-content{ max-height:0; overflow:hidden; transition:max-height .35s ease-out; }
    .collapse-content.open{ max-height:3600px; transition:max-height .5s ease-in; }
    .recording-ring{ animation:ring-pulse 1.5s cubic-bezier(.24,0,.38,1) infinite; }
    @keyframes ring-pulse{ 0%{transform:scale(1);opacity:.5} 100%{transform:scale(1.5);opacity:0} }
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:190px;z-index:60;background:rgba(15,23,42,.92);color:#fff;
      padding:10px 14px;border-radius:999px;font-weight:900;font-size:12px;
      box-shadow:0 10px 25px rgba(0,0,0,.25);
      opacity:0;pointer-events:none;transition:opacity .18s ease;
      max-width:calc(100vw - 24px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .toast.show{ opacity:1; }
    .pb-safe{ padding-bottom: env(safe-area-inset-bottom); }

    @media print{
      .no-print{ display:none!important; }
      body{ background:#fff!important; padding:0!important; }
      main{ padding:0!important; }
      #printArea{ display:block!important; }
      #printArea *{ color:#000!important; }
      .print-section{ break-inside:avoid; }
      .print-row{ border-bottom:1px solid #bbb; padding:6px 0; }
    }
    #printArea{ display:none; }
  </style>
</head>

<body class="bg-slate-100 text-slate-900">

  <!-- PRINT -->
  <section id="printArea" class="p-5">
    <div class="flex items-end justify-between border-b-2 border-black pb-2 mb-4">
      <div>
        <h1 class="text-2xl font-black">æ•‘æ€¥æ¬é€ãƒ»çµŒéè¨˜éŒ²ç”¨ç´™</h1>
        <div class="text-xs font-bold text-gray-600">ï¼ˆç«¯æœ«å†…ã§ä½œæˆãƒ»è¨˜éŒ²ï¼‰</div>
      </div>
      <div class="text-sm font-bold" id="printTimestamp"></div>
    </div>

    <div class="grid grid-cols-2 gap-3 border p-3 rounded-lg mb-3 print-section">
      <div>
        <div class="text-[10px] font-black text-gray-600">å­¦æ ¡å</div>
        <div id="p_schoolName" class="text-sm font-bold"></div>
      </div>
      <div>
        <div class="text-[10px] font-black text-gray-600">ä½æ‰€ / é›»è©±</div>
        <div id="p_schoolAddrPhone" class="text-sm font-bold"></div>
      </div>
      <div class="col-span-2 border-t pt-2">
        <div class="text-[10px] font-black text-gray-600">ç™ºç”Ÿå ´æ‰€ï¼ˆæ ¡å†…ï¼‰</div>
        <div id="p_place" class="text-sm font-bold"></div>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-3 border p-3 rounded-lg mb-3 print-section">
      <div>
        <div class="text-[10px] font-black text-gray-600">å‚·ç—…è€…ï¼ˆæ°åï¼‰</div>
        <div id="p_name" class="text-sm font-bold"></div>
      </div>
      <div>
        <div class="text-[10px] font-black text-gray-600">å­¦å¹´ / æ€§åˆ¥ / å¹´é½¢</div>
        <div id="p_gradeSexAge" class="text-sm font-bold"></div>
      </div>
      <div class="col-span-2 border-t pt-2">
        <div class="text-[10px] font-black text-gray-600">ä¸»è¨´ãƒ»ç—‡çŠ¶ / æ—¢å¾€ / ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</div>
        <div id="p_med" class="text-sm"></div>
      </div>
    </div>

    <div class="border p-3 rounded-lg mb-3 print-section">
      <div class="text-[10px] font-black text-gray-600 mb-1">å­¦æ ¡å›ºæœ‰ï¼ˆAED / å°ç·š / å†…ç·šãªã©ï¼‰</div>
      <div id="p_schoolOps" class="text-sm"></div>
    </div>

    <div class="border p-3 rounded-lg mb-3 print-section">
      <div class="text-[10px] font-black text-gray-600 mb-1">å½¹å‰²åˆ†æ‹…ï¼ˆç¢ºå®šã—ãŸã‚‚ã®ï¼‰</div>
      <div id="p_roles" class="text-sm"></div>
    </div>

    <div class="border p-3 rounded-lg mb-3 print-section">
      <div class="text-[10px] font-black text-gray-600 mb-1">åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆå®Œäº†ã—ãŸã‚‚ã®ï¼‰</div>
      <div id="p_checklist" class="text-sm"></div>
    </div>

    <div class="grid grid-cols-2 gap-3 border p-3 rounded-lg mb-3 print-section">
      <div>
        <div class="text-[10px] font-black text-gray-600">é–‹å§‹</div>
        <div id="p_start" class="text-sm font-bold"></div>
      </div>
      <div>
        <div class="text-[10px] font-black text-gray-600">çµ‚äº†</div>
        <div id="p_end" class="text-sm font-bold"></div>
      </div>
    </div>

    <div class="border-t-2 border-black pt-2 mb-2 print-section">
      <h2 class="text-lg font-black">æ™‚ç³»åˆ—è¨˜éŒ²</h2>
      <div class="text-[10px] font-bold text-gray-600 mb-1">â€»æŠ¼ã—ãŸé †ã«è¨˜éŒ²</div>
      <div id="p_timeline" class="border-t border-black"></div>
    </div>

    <div class="mt-6 text-[10px] text-gray-400 text-right">Generated by æ•‘æ€¥å¯¾å¿œã‚µãƒãƒ¼ãƒˆ v13</div>
  </section>

  <!-- HEADER -->
  <header class="sticky top-0 z-40 bg-white shadow-sm border-b no-print">
    <div class="px-4 py-3 flex items-center justify-between gap-3">
      <div class="min-w-0">
        <h1 class="text-base font-black leading-tight text-red-600 truncate">æ•‘æ€¥å¯¾å¿œã‚µãƒãƒ¼ãƒˆ</h1>
        <div class="text-[10px] text-slate-500 font-black">å­¦æ ¡å›ºæœ‰è¨­å®š + åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆæ ¡åˆ¥ï¼‰ + é€šå ±åŸç¨¿ + è¨˜éŒ² + å…¨ä»¶ãƒ“ãƒ¥ãƒ¼ + å¼•ç¶™ãï¼ˆç«¯æœ«å†…ä¿å­˜ï¼‰</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnNewIncident" class="px-3 py-2 rounded-full text-xs font-black border border-slate-200 bg-slate-50 active:bg-slate-100">æ–°è¦</button>
        <a href="tel:119" class="bg-red-600 text-white px-4 py-2 rounded-full text-sm font-black flex items-center gap-2 animate-pulse">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
          119
        </a>
      </div>
    </div>

    <div class="px-3 pb-2">
      <div class="bg-slate-50 border rounded-2xl p-2 flex items-center gap-2 overflow-x-auto">
        <button class="stepBtn px-3 py-2 rounded-xl text-xs font-black bg-white border" data-step="1">â‘ åˆå‹•</button>
        <button class="stepBtn px-3 py-2 rounded-xl text-xs font-black bg-white border" data-step="2">â‘¡é€šå ±</button>
        <button class="stepBtn px-3 py-2 rounded-xl text-xs font-black bg-white border" data-step="3">â‘¢è¨˜éŒ²</button>
        <button class="stepBtn px-3 py-2 rounded-xl text-xs font-black bg-white border" data-step="4">â‘£å¼•ç¶™ã</button>

        <div class="ml-auto flex items-center gap-2 pr-1">
          <div id="stateBadge" class="px-2 py-1 rounded-full bg-slate-200 text-slate-800 text-[10px] font-black">æœªé–‹å§‹</div>
          <div id="rolesBadge" class="px-2 py-1 rounded-full bg-white border text-slate-800 text-[10px] font-black">å½¹å‰²:0</div>
          <div id="elapsedBadge" class="px-2 py-1 rounded-full bg-slate-900 text-white text-[10px] font-black">--:--</div>
        </div>
      </div>
    </div>
  </header>

  <main class="p-3 space-y-4 no-print">

    <!-- STATUS CARD -->
    <section class="bg-white border rounded-2xl p-4 shadow-sm">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-2xl bg-emerald-50 border border-emerald-100 flex items-center justify-center">
          <svg class="w-5 h-5 text-emerald-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <div class="min-w-0 flex-1">
          <div class="font-black text-sm text-slate-900">ç¾åœ¨ã®çŠ¶æ…‹</div>
          <div class="text-xs text-slate-600 font-bold mt-1">
            çŠ¶æ…‹ï¼š<span id="stateInline" class="font-black">æœªé–‹å§‹</span>
            ï¼ çµŒéï¼š<span id="elapsedInline" class="font-black">--:--</span>
            ï¼ è¨˜éŒ²ï¼š<span id="countInline" class="font-black">0</span>ä»¶
          </div>
          <div class="mt-2 bg-slate-50 border rounded-2xl p-3">
            <div class="text-[10px] font-black text-slate-500">æœ€æ–°è¨˜éŒ²</div>
            <div id="latestInline" class="text-sm font-black text-slate-900 truncate">ï¼ˆè¨˜éŒ²ãªã—ï¼‰</div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2 mt-3">
        <button id="btnMarkStart" class="py-4 rounded-2xl bg-slate-900 text-white font-black text-sm active:scale-[0.99]">â± ç™ºç”Ÿï¼ˆé–‹å§‹ï¼‰ã‚’è¨˜éŒ²</button>
        <button id="btnMarkEnd" class="py-4 rounded-2xl bg-white border font-black text-sm active:bg-slate-50">â¹ åœæ­¢ï¼ˆçµ‚äº†ï¼‰ã‚’è¨˜éŒ²</button>
      </div>

      <div class="grid grid-cols-3 gap-2 mt-3">
        <button id="btnOpenRoleBoard" class="py-4 rounded-2xl bg-white border font-black text-sm active:bg-slate-50">ğŸ§© å½¹å‰²</button>
        <button id="btnOpenQuickSheet" class="py-4 rounded-2xl bg-blue-600 text-white font-black text-sm active:scale-[0.99]">âš¡ ã™ãè¨˜éŒ²</button>
        <button id="btnOpenLogViewer" class="py-4 rounded-2xl bg-slate-900 text-white font-black text-sm active:scale-[0.99]">ğŸ‘€ å…¨ä»¶</button>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="bg-white border rounded-2xl p-4 shadow-sm space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="font-black text-sm border-l-4 border-slate-900 pl-2">å­¦æ ¡å›ºæœ‰ã®åˆæœŸè¨­å®šï¼ˆå„æ ¡ã§ä¿å­˜ï¼‰</h2>
        <button id="btnToggleSettings" class="text-xs font-black text-blue-600">é–‹ã</button>
      </div>

      <div id="settingsPanel" class="hidden space-y-4 bg-slate-50 p-3 rounded-2xl border border-dashed border-slate-200">

        <div class="bg-white border rounded-2xl p-3 space-y-3">
          <div class="font-black text-sm">å­¦æ ¡æƒ…å ±</div>
          <div>
            <label class="input-label">å­¦æ ¡å</label>
            <input id="schoolName" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="ã€‡ã€‡å¸‚ç«‹ã€‡ã€‡å°å­¦æ ¡" />
          </div>
          <div>
            <label class="input-label">ä½æ‰€</label>
            <input id="schoolAddr" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="å¸‚åŒºç”ºæ‘ã‹ã‚‰ã®ä½æ‰€" />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="input-label">å­¦æ ¡é›»è©±</label>
              <input id="schoolPhone" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="03-xxxx-xxxx" inputmode="tel" />
            </div>
            <div>
              <label class="input-label">Googleãƒãƒƒãƒ—URLï¼ˆæ­£é–€/ç„é–¢ãƒ”ãƒ³ï¼‰</label>
              <input id="mapUrl" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="https://maps.google.com/..." inputmode="url" />
            </div>
          </div>
        </div>

        <div class="bg-white border rounded-2xl p-3 space-y-3">
          <div class="font-black text-sm">ç·Šæ€¥å°ç·šãƒ»AEDï¼ˆå‹ã¡åˆ‡ã‚Šãƒã‚¤ãƒ³ãƒˆï¼‰</div>
          <div class="grid grid-cols-1 gap-3">
            <div>
              <label class="input-label">æ•‘æ€¥è»Šã®å°ç·š</label>
              <input id="ambulanceRoute" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼šæ­£é–€â†’ä½“è‚²é¤¨æ¨ªâ†’ä¿å¥å®¤å‰" />
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="input-label">AEDè¨­ç½®â‘ </label>
                <input id="aed1" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼šè·å“¡å®¤å‰" />
              </div>
              <div>
                <label class="input-label">AEDè¨­ç½®â‘¡</label>
                <input id="aed2" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼šä½“è‚²é¤¨å…¥å£" />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="input-label">æ­£é–€ã®å‘¼ã³å</label>
                <input id="gateName" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼šæ­£é–€ / åŒ—é–€" />
              </div>
              <div>
                <label class="input-label">æ­£é–€ã®èª˜å°å¾…æ©Ÿå ´æ‰€</label>
                <input id="gateSpot" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼šé–€ã‚’å…¥ã£ã¦ã™ãå³" />
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white border rounded-2xl p-3 space-y-3">
          <div class="font-black text-sm">å†…ç·šãƒ»æ‹…å½“ï¼ˆä»»æ„ï¼‰</div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="input-label">è·å“¡å®¤ å†…ç·š</label>
              <input id="extStaff" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼š100" inputmode="numeric" />
            </div>
            <div>
              <label class="input-label">ä¿å¥å®¤ å†…ç·š</label>
              <input id="extNurse" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼š101" inputmode="numeric" />
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="input-label">ç®¡ç†è· å†…ç·š</label>
              <input id="extAdmin" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼š102" inputmode="numeric" />
            </div>
            <div>
              <label class="input-label">é¤Šè­·æ•™è«­ï¼ˆåå‰ï¼‰</label>
              <input id="nurseName" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼šã€‡ã€‡å…ˆç”Ÿ" />
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="input-label">ç®¡ç†è· æºå¸¯ï¼ˆä»»æ„ï¼‰</label>
              <input id="adminMobile" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼š090-xxxx-xxxx" inputmode="tel" />
            </div>
            <div>
              <label class="input-label">ä¿è­·è€…é€£çµ¡ï¼ˆä»»æ„ï¼‰</label>
              <input id="guardianPhone" class="w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼š090-xxxx-xxxx" inputmode="tel" />
            </div>
          </div>
        </div>

        <!-- CASE PRESETS -->
        <div class="bg-white border rounded-2xl p-3 space-y-2">
          <div class="flex items-center justify-between">
            <div class="font-black text-sm text-slate-900">ã‚ˆãèµ·ãã‚‹ã‚±ãƒ¼ã‚¹ï¼ˆæœ€å¤§10ï¼‰</div>
            <div class="text-[10px] font-black text-slate-500">åˆæœŸã‚»ãƒƒãƒˆå…¥ã‚Š</div>
          </div>
          <div class="grid grid-cols-1 gap-2">
            <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
            <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
            <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
            <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
            <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
            <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
            <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
            <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
            <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
            <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
          </div>
          <div class="grid grid-cols-2 gap-2 mt-2">
            <button id="btnRestoreDefaultCases" class="py-3 rounded-2xl bg-white border text-xs font-black active:bg-slate-50">åˆæœŸã‚»ãƒƒãƒˆã«æˆ»ã™</button>
            <button id="btnClearCases" class="py-3 rounded-2xl bg-white border text-xs font-black active:bg-slate-50">ã‚±ãƒ¼ã‚¹ã‚’ç©ºã«ã™ã‚‹</button>
          </div>
        </div>

        <!-- CHECKLIST PRESETS (NEW) -->
        <div class="bg-white border rounded-2xl p-3 space-y-2">
          <div class="flex items-center justify-between">
            <div class="font-black text-sm text-slate-900">åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§10ï¼‰</div>
            <div class="text-[10px] font-black text-slate-500">å­¦æ ¡ã”ã¨ã«è¨­å®š</div>
          </div>
          <div class="grid grid-cols-1 gap-2">
            <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
            <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
            <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
            <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
            <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
            <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
            <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
            <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
            <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
            <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
          </div>
          <div class="grid grid-cols-2 gap-2 mt-2">
            <button id="btnRestoreDefaultChecks" class="py-3 rounded-2xl bg-white border text-xs font-black active:bg-slate-50">åˆæœŸã‚»ãƒƒãƒˆã«æˆ»ã™</button>
            <button id="btnClearChecks" class="py-3 rounded-2xl bg-white border text-xs font-black active:bg-slate-50">ãƒã‚§ãƒƒã‚¯ã‚’ç©ºã«ã™ã‚‹</button>
          </div>
          <div class="text-[10px] font-bold text-slate-500">
            â€»ä¿å­˜å¾Œã«åæ˜ ï¼ˆãƒã‚§ãƒƒã‚¯é …ç›®ãŒå¤‰ã‚ã‚‹ã¨ã€æ—¢å­˜ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã¯é …ç›®åã§è¿½å¾“ã—ã¾ã™ï¼‰
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="btnSaveSettings" class="py-4 rounded-2xl bg-slate-900 text-white text-sm font-black active:scale-[0.99]">ã“ã®ç«¯æœ«ã«ä¿å­˜</button>
          <button id="btnResetSettings" class="py-4 rounded-2xl bg-white border text-sm font-black active:bg-slate-50">è¨­å®šã‚’æ¶ˆå»</button>
        </div>

        <div class="text-[10px] font-bold text-slate-500">
          â€»è¨­å®šã¯ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰ã«ä¿å­˜ã€‚ã‚µãƒ¼ãƒé€ä¿¡ã¯ã—ã¾ã›ã‚“ã€‚
        </div>
      </div>

      <div>
        <label class="input-label">æ ¡å†…ã®è©³ã—ã„å ´æ‰€ï¼ˆç™ºç”Ÿå ´æ‰€ï¼‰</label>
        <input id="place" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼š3Få›³å·¥å®¤ã€ä½“è‚²é¤¨åŒ—å´ãªã©" />
      </div>

      <!-- SCHOOL QUICK ACTIONS -->
      <div class="grid grid-cols-2 gap-2">
        <button id="btnOpenMap" class="py-4 rounded-2xl bg-white border font-black text-sm active:bg-slate-50">ğŸ—º åœ°å›³</button>
        <button id="btnCopySchoolOps" class="py-4 rounded-2xl bg-slate-900 text-white font-black text-sm active:scale-[0.99]">ğŸ“Œ å­¦æ ¡å›ºæœ‰æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <a id="btnCallAdmin" href="#" class="py-4 rounded-2xl bg-white border font-black text-sm flex items-center justify-center active:bg-slate-50">ğŸ“ ç®¡ç†è·ã¸é›»è©±</a>
        <a id="btnCallSchool" href="#" class="py-4 rounded-2xl bg-white border font-black text-sm flex items-center justify-center active:bg-slate-50">ğŸ“ å­¦æ ¡ã¸é›»è©±</a>
      </div>
    </section>

    <!-- åˆå‹•ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆæ ¡åˆ¥ãƒ»æœ€å¤§10ï¼‰ -->
    <section class="bg-white border rounded-2xl p-4 shadow-sm space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="font-black text-sm border-l-4 border-emerald-600 pl-2">åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆãƒã‚§ãƒƒã‚¯ã§è‡ªå‹•è¨˜éŒ²ï¼‰</h2>
        <button id="btnChecklistSettingsHint" class="text-xs font-black text-blue-600">è¨­å®š</button>
      </div>
      <div class="text-[10px] font-bold text-slate-500">â€»å­¦æ ¡ã”ã¨ã®ãƒã‚§ãƒƒã‚¯ã‚’åæ˜ ï¼ˆæœ€å¤§10ï¼‰</div>

      <div id="checklist" class="space-y-2"></div>

      <div class="grid grid-cols-2 gap-2">
        <button id="btnChecklistReset" class="py-4 rounded-2xl bg-white border font-black text-sm active:bg-slate-50">ãƒã‚§ãƒƒã‚¯è§£é™¤</button>
        <button id="btnCopyChecklist" class="py-4 rounded-2xl bg-slate-900 text-white font-black text-sm active:scale-[0.99]">ãƒã‚§ãƒƒã‚¯çŠ¶æ³ã‚³ãƒ”ãƒ¼</button>
      </div>
    </section>

    <!-- PATIENT -->
    <section class="bg-white border rounded-2xl p-4 shadow-sm space-y-3">
      <h2 class="font-black text-sm border-l-4 border-red-500 pl-2">å‚·ç—…è€…æƒ…å ±</h2>

      <div class="space-y-3">
        <div>
          <label class="input-label">æ°åï¼ˆãµã‚ŠãŒãªï¼‰</label>
          <input id="pName" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="å±±ç”° å¤ªéƒï¼ˆã‚„ã¾ã  ãŸã‚ã†ï¼‰" />
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="input-label">å­¦å¹´ãƒ»åŒºåˆ†</label>
            <select id="pGrade" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black">
              <option value="">é¸æŠ</option>
              <option value="1">1å¹´</option><option value="2">2å¹´</option><option value="3">3å¹´</option>
              <option value="4">4å¹´</option><option value="5">5å¹´</option><option value="6">6å¹´</option>
              <option value="è·å“¡">æ•™è·å“¡</option><option value="ä»–">ãã®ä»–</option>
            </select>
          </div>
          <div>
            <label class="input-label">æ€§åˆ¥</label>
            <select id="pSex" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black">
              <option value="">é¸æŠ</option>
              <option value="ç”·æ€§">ç”·æ€§</option>
              <option value="å¥³æ€§">å¥³æ€§</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-3 bg-blue-50 rounded-2xl border border-blue-100">
          <div>
            <label class="input-label text-blue-800">ç”Ÿå¹´æœˆæ—¥ï¼ˆä»»æ„ï¼‰</label>
            <input id="pBirth" type="date" class="w-full p-3 border rounded-xl text-sm bg-white font-black" />
          </div>
          <div class="flex items-end">
            <div id="ageDisplay" class="w-full p-3 rounded-xl bg-white border border-blue-200 text-sm font-black text-blue-900 text-center h-[48px] flex items-center justify-center shadow-sm">
              å¹´é½¢ï¼š-- æ­³
            </div>
          </div>
        </div>

        <div>
          <label class="input-label">ä¸»ãªç—‡çŠ¶ï¼ˆçŸ­ãOKï¼‰</label>
          <textarea id="symptom" class="w-full p-3 bg-slate-50 border rounded-2xl text-sm font-black" rows="2" placeholder="ä¾‹ï¼šå‘¼å¸è‹¦ã€æ„è­˜ã‚‚ã†ã‚ã†ã€å…¨èº«ã˜ã‚“ã¾ã—ã‚“ ç­‰"></textarea>
        </div>

        <button id="btnToggleMedical" class="w-full py-3 bg-slate-100 rounded-2xl text-[11px] font-black text-slate-600 flex justify-center items-center gap-2">
          æ—¢å¾€æ­´ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç­‰ï¼ˆå¿…è¦ãªã‚‰ï¼‰
          <svg id="iconMedical" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
        </button>
        <div id="medicalPanel" class="collapse-content bg-white">
          <div class="pt-3 space-y-3">
            <div>
              <label class="input-label">æ—¢å¾€æ­´ï¼ˆæŒç—…ï¼‰</label>
              <input id="pHistory" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="å–˜æ¯ã€ã¦ã‚“ã‹ã‚“ ç­‰" />
            </div>
            <div>
              <label class="input-label">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
              <input id="pAllergy" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="åµã€ãƒ”ãƒ¼ãƒŠãƒƒãƒ„ ç­‰" />
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <a id="btnCallGuardian" href="#" class="py-4 rounded-2xl bg-white border text-sm font-black flex items-center justify-center gap-2 active:bg-slate-50">
            ğŸ“ ä¿è­·è€…ã¸é›»è©±
          </a>
          <button id="btnCopyGuardianMsg" class="py-4 rounded-2xl bg-slate-900 text-white text-sm font-black active:scale-[0.99]">
            âœ‰ï¸ é€£çµ¡æ–‡ã‚’ã‚³ãƒ”ãƒ¼
          </button>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="btnCopyBroadcast" class="py-4 rounded-2xl bg-white border font-black text-sm active:bg-slate-50">ğŸ“¢ æ ¡å†…æ”¾é€æ–‡</button>
          <button id="btnCopyGuardianTransport" class="py-4 rounded-2xl bg-slate-700 text-white font-black text-sm active:scale-[0.99]">ğŸš‘ æ¬é€é€£çµ¡æ–‡</button>
        </div>
      </div>
    </section>

    <!-- CALL SCRIPT -->
    <section class="bg-slate-900 rounded-2xl p-4 shadow-xl space-y-3">
      <div class="flex items-center justify-between border-b border-white/10 pb-2">
        <div>
          <div class="text-[10px] uppercase tracking-widest text-slate-400 font-black">119é€šå ±ç”¨ åŸç¨¿</div>
          <div class="text-[10px] text-slate-500 font-black">å…¥åŠ›ã«å¿œã˜ã¦è‡ªå‹•ç”Ÿæˆ</div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnCopyScript" class="text-xs bg-white text-slate-900 px-3 py-2 rounded-full font-black active:bg-slate-200">ã‚³ãƒ”ãƒ¼</button>
          <button id="btnShareScript" class="text-xs bg-slate-700 text-white px-3 py-2 rounded-full font-black active:bg-slate-600">å…±æœ‰</button>
        </div>
      </div>
      <div id="scriptDisplay" class="text-white text-sm font-medium leading-relaxed min-h-[120px] whitespace-pre-wrap"></div>
    </section>

    <!-- LOG -->
    <section class="bg-white border rounded-2xl p-4 shadow-sm space-y-4" id="logSection">
      <div class="flex items-center justify-between">
        <div class="text-center flex-1">
          <h2 class="font-black text-slate-900">çµŒéãƒ»å‡¦ç½®ã®è¨˜éŒ²</h2>
          <p class="text-[10px] text-slate-500 font-black uppercase tracking-tight">Tap to Log / Voice / Edit</p>
        </div>
        <button id="btnOpenLogViewer2" class="px-3 py-2 rounded-full bg-slate-900 text-white text-xs font-black active:scale-[0.99]">å…¨ä»¶</button>
      </div>

      <!-- VOICE -->
      <div class="flex flex-col items-center py-2">
        <div class="relative">
          <div id="pulseRing" class="absolute inset-0 rounded-full bg-red-400 hidden recording-ring"></div>
          <button id="btnVoiceRec" class="relative z-10 w-20 h-20 rounded-full bg-blue-600 text-white shadow-lg flex items-center justify-center flex-col gap-0.5 active:scale-95 transition-transform">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-18a3 3 0 013 3v8a3 3 0 01-3 3 3 3 0 01-3-3V5a3 3 0 013-3z"></path></svg>
            <span id="micText" class="text-[9px] font-black tracking-tighter uppercase">REC START</span>
          </button>
        </div>
        <div id="interimText" class="mt-2 text-xs text-blue-600 font-black h-4 italic"></div>
        <div id="voiceHint" class="text-[10px] text-slate-500 font-bold mt-1">â€»å¯¾å¿œç«¯æœ«ã®ã¿éŸ³å£°å…¥åŠ›ã§ãã¾ã™</div>
      </div>

      <div class="space-y-2">
        <textarea id="voiceInputArea" class="w-full p-4 bg-slate-50 border rounded-2xl text-base font-black focus:ring-2 focus:ring-blue-500 outline-none" rows="2" placeholder="è‡ªç”±å…¥åŠ›ï¼ˆä¾‹ï¼šâ—‹â—‹ã§è»¢å€’ã€è†ã‚’æ‰“æ’²ã€‚å†·å´é–‹å§‹ ãªã©ï¼‰"></textarea>
        <div class="grid grid-cols-2 gap-2">
          <button id="btnAddTimeline" class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg active:scale-[0.98]">ï¼‹ è¨˜éŒ²</button>
          <button id="btnUndo" class="w-full py-4 bg-white border font-black rounded-2xl active:bg-slate-50">â†© å–ã‚Šæ¶ˆã—</button>
        </div>
      </div>

      <div class="pt-2">
        <div class="flex items-center justify-between">
          <h3 class="text-[11px] font-black text-slate-500 uppercase tracking-widest">Activity Log</h3>
          <div class="flex items-center gap-2">
            <button id="btnCopyTimeline" class="px-3 py-2 text-slate-600 text-xs font-black border rounded-full active:bg-slate-50">ã‚³ãƒ”ãƒ¼</button>
            <button id="btnExportTxt" class="px-3 py-2 text-slate-600 text-xs font-black border rounded-full active:bg-slate-50">TXT</button>
            <button id="btnExportJson" class="px-3 py-2 text-slate-600 text-xs font-black border rounded-full active:bg-slate-50">JSON</button>
          </div>
        </div>

        <div id="timeline" class="space-y-2 mt-3">
          <p id="timelineEmpty" class="text-center text-slate-400 py-10 text-sm font-bold">ï¼ˆè¨˜éŒ²ãªã—ï¼‰</p>
        </div>
      </div>
    </section>

    <!-- HANDOFF -->
    <section class="bg-white border rounded-2xl p-4 shadow-sm space-y-3" id="handoffSection">
      <h2 class="font-black text-sm border-l-4 border-blue-600 pl-2">å¼•ç¶™ãï¼ˆå°åˆ· / å…±æœ‰ / Teamsï¼‰</h2>

      <div class="grid grid-cols-2 gap-2">
        <button id="btnPrint" class="py-4 bg-blue-600 text-white text-sm font-black rounded-2xl shadow-lg flex items-center justify-center gap-2 active:scale-95">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 00-2 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
          ç”¨ç´™ã¨ã—ã¦å°åˆ·
        </button>
        <button id="btnShareAll" class="py-4 bg-slate-900 text-white text-sm font-black rounded-2xl shadow-lg active:scale-95">å…±æœ‰ï¼ˆå…¨æ–‡ï¼‰</button>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <button id="btnCopyTeams" class="py-4 bg-white border text-sm font-black rounded-2xl active:bg-slate-50">ğŸ“£ TeamsæŠ•ç¨¿æ–‡ã‚³ãƒ”ãƒ¼</button>
        <button id="btnShareTeams" class="py-4 bg-slate-700 text-white text-sm font-black rounded-2xl active:scale-95">TeamsæŠ•ç¨¿æ–‡ã‚’å…±æœ‰</button>
      </div>
    </section>

  </main>

  <!-- LIVE BAR -->
  <div class="fixed left-0 right-0 bottom-[86px] z-50 no-print px-3">
    <button id="liveBar" class="w-full bg-white border shadow-[0_-6px_18px_rgba(0,0,0,0.12)] rounded-2xl px-4 py-3 flex items-center gap-3 active:bg-slate-50">
      <div class="shrink-0">
        <div class="text-[10px] font-black text-slate-500">æœ€æ–°</div>
        <div id="liveTime" class="text-sm font-black text-blue-600">--:--</div>
      </div>
      <div class="min-w-0 flex-1 text-left">
        <div id="liveText" class="text-sm font-black text-slate-900 truncate">ï¼ˆè¨˜éŒ²ãªã—ï¼‰</div>
        <div class="text-[10px] font-black text-slate-500">ä»¶æ•°ï¼š<span id="liveCount">0</span> ï¼ å½¹å‰²ï¼š<span id="liveRoles">0</span> ï¼ ã‚¿ãƒƒãƒ—ã§ãƒ­ã‚°ã¸</div>
      </div>
      <div class="shrink-0 text-[10px] font-black text-slate-500"><span id="liveState">æœªé–‹å§‹</span></div>
    </button>
  </div>

  <!-- BOTTOM -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t no-print shadow-[0_-4px_15px_rgba(0,0,0,0.1)] z-50 safe-area-bottom pb-safe">
    <div class="px-3 py-2 grid grid-cols-4 gap-2">
      <button id="btnGoCall" class="py-3 rounded-2xl bg-white border font-black text-xs active:bg-slate-50">é€šå ±</button>
      <button id="btnGoLog" class="py-3 rounded-2xl bg-slate-900 text-white font-black text-xs active:scale-[0.99]">è¨˜éŒ²</button>
      <button id="btnGoHandoff" class="py-3 rounded-2xl bg-blue-600 text-white font-black text-xs active:scale-[0.99]">å¼•ç¶™ã</button>
      <button id="btnBigStartStop" class="py-3 rounded-2xl bg-emerald-600 text-white font-black text-xs active:scale-[0.99]">é–‹å§‹/åœæ­¢</button>
    </div>
  </nav>

  <!-- QUICK SHEET -->
  <div id="quickSheetWrap" class="fixed inset-0 z-[80] hidden no-print">
    <div id="sheetBackdrop" class="absolute inset-0 bg-black/40"></div>
    <div class="absolute left-0 right-0 bottom-0 bg-white rounded-t-3xl shadow-2xl p-4 pb-safe">
      <div class="flex items-center justify-between mb-2">
        <div class="font-black text-slate-900">âš¡ ã™ãè¨˜éŒ²ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ï¼‰</div>
        <button id="btnCloseQuickSheet" class="px-3 py-2 rounded-full border text-xs font-black active:bg-slate-50">é–‰ã˜ã‚‹</button>
      </div>
      <div class="text-[10px] font-black text-slate-500 mb-3">æŠ¼ã—ãŸå†…å®¹ãŒã€Œæ™‚åˆ»ä»˜ãã€ã§ãƒ­ã‚°ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>

      <div class="space-y-3">
        <div>
          <div class="text-[11px] font-black text-slate-700 mb-2">âœ… ã‚±ãƒ¼ã‚¹ï¼ˆå„æ ¡ã§è¨­å®šã—ãŸæœ€å¤§10ï¼‰</div>
          <div id="caseChips" class="grid grid-cols-2 gap-2"></div>
        </div>

        <div>
          <div class="text-[11px] font-black text-slate-700 mb-2">âœ… çŠ¶æ…‹ãƒ»å¯¾å¿œï¼ˆå…±é€šï¼‰</div>
          <div class="grid grid-cols-2 gap-2">
            <button class="chip rounded-2xl bg-red-600 text-white text-xs font-black" data-log="é‡å¤§ï¼šæ„è­˜ãªã— / å‘¼å¸ä¸æ˜ï¼ˆç·Šæ€¥å¯¾å¿œï¼‰">é‡å¤§ï¼šæ„è­˜ãªã—</button>
            <button class="chip rounded-2xl bg-orange-100 text-orange-900 text-xs font-black border border-orange-200" data-log="å®‰å…¨ç¢ºä¿ï¼šå‘¨å›²ã®å±é™ºæ’é™¤ / å…ç«¥ã‚’é›¢ã™">å®‰å…¨ç¢ºä¿</button>
            <button class="chip rounded-2xl bg-blue-100 text-blue-900 text-xs font-black border border-blue-200" data-log="é€£çµ¡ï¼šç®¡ç†è·ã¸å ±å‘Šï¼ˆçŠ¶æ³å…±æœ‰ï¼‰">ç®¡ç†è·ã¸å ±å‘Š</button>
            <button class="chip rounded-2xl bg-emerald-100 text-emerald-900 text-xs font-black border border-emerald-200" data-log="èª˜å°ï¼šæ­£é–€ã§æ•‘æ€¥éšŠã‚’èª˜å°ã™ã‚‹è·å“¡ã‚’é…ç½®">æ­£é–€èª˜å°</button>
            <button class="chip rounded-2xl bg-slate-100 text-slate-900 text-xs font-black border" data-log="å‘¼å¸ï¼šè‹¦ã—ãã†ï¼ˆå‘¼å¸å›°é›£ï¼‰">å‘¼å¸å›°é›£</button>
            <button class="chip rounded-2xl bg-white text-slate-900 text-xs font-black border" data-log="å˜”åã‚ã‚Š">å˜”åã‚ã‚Š</button>
            <button class="chip rounded-2xl bg-white text-slate-900 text-xs font-black border" id="btnLogAed">AEDæ¬é€ï¼ˆå ´æ‰€ã¤ãï¼‰</button>
            <button class="chip rounded-2xl bg-white text-slate-900 text-xs font-black border" id="btnLogGate">æ­£é–€èª˜å°ï¼ˆå ´æ‰€ã¤ãï¼‰</button>
          </div>
        </div>

        <button id="btnQuickToLog" class="w-full py-4 rounded-2xl bg-slate-900 text-white font-black text-sm active:scale-[0.99]">ãƒ­ã‚°ç”»é¢ã¸ç§»å‹•</button>
      </div>
    </div>
  </div>

  <!-- ROLE SHEET -->
  <div id="roleSheetWrap" class="fixed inset-0 z-[85] hidden no-print">
    <div id="roleBackdrop" class="absolute inset-0 bg-black/40"></div>
    <div class="absolute left-0 right-0 bottom-0 bg-white rounded-t-3xl shadow-2xl p-4 pb-safe">
      <div class="flex items-center justify-between mb-2">
        <div class="font-black text-slate-900">ğŸ§© å½¹å‰²åˆ†æ‹…ãƒœãƒ¼ãƒ‰ï¼ˆç¢ºå®šâ†’ãƒ­ã‚°åŒ–ï¼‰</div>
        <button id="btnCloseRoleSheet" class="px-3 py-2 rounded-full border text-xs font-black active:bg-slate-50">é–‰ã˜ã‚‹</button>
      </div>
      <div class="text-[10px] font-black text-slate-500 mb-3">å½¹å‰²ã‚’ã€Œç¢ºå®šã€ã™ã‚‹ã¨ã€æ‹…å½“è€…ä»˜ãã§è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚</div>

      <div class="grid grid-cols-2 gap-2">
        <button id="btnRoleAutoFill" class="py-3 rounded-2xl bg-slate-900 text-white text-xs font-black active:scale-[0.99]">ä¸»/è¨˜éŒ²ã‚’è‡ªå‹•å…¥åŠ›</button>
        <button id="btnRoleClear" class="py-3 rounded-2xl bg-white border text-xs font-black active:bg-slate-50">å½¹å‰²ã‚’å…¨è§£é™¤</button>
      </div>

      <div class="mt-3 space-y-2" id="roleList"></div>

      <button id="btnRoleToLog" class="w-full py-4 mt-3 rounded-2xl bg-blue-600 text-white font-black text-sm active:scale-[0.99]">ãƒ­ã‚°ç”»é¢ã¸ç§»å‹•</button>
    </div>
  </div>

  <!-- LOG VIEWER (NEW) -->
  <div id="logViewerWrap" class="fixed inset-0 z-[90] hidden no-print">
    <div id="logViewerBackdrop" class="absolute inset-0 bg-black/50"></div>
    <div class="absolute left-0 right-0 top-0 bottom-0 bg-white flex flex-col">
      <div class="sticky top-0 bg-white border-b p-3 flex items-center gap-2">
        <div class="font-black text-slate-900">ğŸ‘€ è¨˜éŒ² å…¨ä»¶ãƒ“ãƒ¥ãƒ¼</div>
        <div class="ml-auto flex items-center gap-2">
          <button id="btnCloseLogViewer" class="px-3 py-2 rounded-full border text-xs font-black active:bg-slate-50">é–‰ã˜ã‚‹</button>
        </div>
      </div>

      <div class="p-3 space-y-2 border-b bg-slate-50">
        <input id="lvSearch" class="w-full p-3 bg-white border rounded-2xl text-sm font-black" placeholder="æ¤œç´¢ï¼ˆä¾‹ï¼šAED / ã‘ã„ã‚Œã‚“ / 12:34 ãªã©ï¼‰">
        <div class="grid grid-cols-3 gap-2">
          <button id="lvOrder" class="py-3 rounded-2xl bg-white border text-xs font-black active:bg-slate-50">è¡¨ç¤ºï¼šæ–°â†’å¤</button>
          <button id="lvOnlyImp" class="py-3 rounded-2xl bg-white border text-xs font-black active:bg-slate-50">é‡è¦ã®ã¿ï¼šOFF</button>
          <button id="lvMode" class="py-3 rounded-2xl bg-slate-900 text-white text-xs font-black active:scale-[0.99]">è¡¨ç¤ºï¼šã‚«ãƒ¼ãƒ‰</button>
        </div>
        <div class="text-[10px] font-bold text-slate-500">
          ä»¶æ•°ï¼š<span id="lvCount" class="font-black">0</span>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-3" id="lvBody">
        <!-- list injected -->
      </div>

      <div class="border-t p-3 bg-white grid grid-cols-2 gap-2 pb-safe">
        <button id="lvCopy" class="py-4 rounded-2xl bg-white border font-black text-sm active:bg-slate-50">ã‚³ãƒ”ãƒ¼</button>
        <button id="lvShare" class="py-4 rounded-2xl bg-slate-900 text-white font-black text-sm active:scale-[0.99]">å…±æœ‰</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">OK</div>

<script>
  const $ = (id) => document.getElementById(id);

  // ===== Defaults =====
  const DEFAULT_CASES = [
    "è»¢å€’ï¼ˆé ­éƒ¨æ‰“æ’²ã®ç–‘ã„ï¼‰",
    "åˆ‡ã‚Šå‚·ãƒ»å‡ºè¡€ï¼ˆæ­¢è¡€ãŒå¿…è¦ï¼‰",
    "ç†±ä¸­ç—‡ç–‘ã„ï¼ˆã‚ã¾ã„ãƒ»åãæ°—ï¼‰",
    "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼åå¿œï¼ˆã˜ã‚“ã¾ã—ã‚“ç­‰ï¼‰",
    "å‘¼å¸å›°é›£ï¼ˆã‚¼ãƒ¼ã‚¼ãƒ¼/æ¯è‹¦ã—ã„ï¼‰",
    "ã‘ã„ã‚Œã‚“ï¼ˆç™ºä½œï¼‰",
    "èª¤åš¥ãƒ»çª’æ¯ç–‘ã„ï¼ˆã®ã©è©°ã¾ã‚Šï¼‰",
    "å¤±ç¥ï¼ˆæ„è­˜æ¶ˆå¤±ï¼‰",
    "éå‘¼å¸ãƒ»ãƒ‘ãƒ‹ãƒƒã‚¯",
    "æ ¡å¤–æ´»å‹•ä¸­ã®è² å‚·ï¼ˆè»¢å€’/æ¥è§¦ï¼‰"
  ];

  // NEW: æ ¡åˆ¥ãƒã‚§ãƒƒã‚¯åˆæœŸã‚»ãƒƒãƒˆï¼ˆæœ€å¤§10ï¼‰
  const DEFAULT_CHECKS = [
    "å‘¨å›²å®‰å…¨ç¢ºä¿ï¼ˆå±é™ºé™¤å»ãƒ»å…ç«¥ã‚’é›¢ã™ï¼‰",
    "ç®¡ç†è·ã¸é€£çµ¡ï¼ˆçŠ¶æ³å…±æœ‰ï¼‰",
    "119é€šå ±ï¼ˆå¿…è¦æ™‚ï¼‰",
    "AEDæ‰‹é…ï¼ˆå ´æ‰€ç¢ºèªâ†’æ¬é€ï¼‰",
    "èƒ¸éª¨åœ§è¿« / AEDè§£æï¼ˆå¿…è¦æ™‚ï¼‰",
    "æ­£é–€èª˜å°æ‰‹é…ï¼ˆå¾…æ©Ÿä½ç½®ã¾ã§ï¼‰",
    "ä¿å¥å®¤æº–å‚™ï¼ˆæ¯›å¸ƒãƒ»æ°·ãƒ»æ‹…æ¶ç­‰ï¼‰",
    "ä¿è­·è€…ã¸é€£çµ¡ï¼ˆçŠ¶æ³å…±æœ‰ï¼‰",
    "å…ç«¥èª˜å°ï¼ˆåˆ¥å®¤ãƒ»å»Šä¸‹æ•´ç†ï¼‰",
    "æ•‘æ€¥éšŠã¸å¼•ç¶™ãï¼ˆè¨˜éŒ²æ¸¡ã—ï¼‰"
  ];

  const ROLE_PRESETS = [
    { key:"admin", label:"ç®¡ç†è·é€£çµ¡", hint:"æ ¡å†…ä½“åˆ¶ãƒ»æŒ‡ç¤ºç³»çµ±" },
    { key:"call119", label:"119é€šå ±", hint:"é€šå ±ãƒ»æƒ…å ±ä¼é”" },
    { key:"aedduty", label:"AEDæº–å‚™", hint:"AEDæŒå‚/è£…ç€æº–å‚™" },
    { key:"cpr", label:"èƒ¸éª¨åœ§è¿«", hint:"æ•‘å‘½å‡¦ç½®" },
    { key:"gate", label:"æ­£é–€èª˜å°", hint:"æ•‘æ€¥éšŠèª˜å°" },
    { key:"guardian", label:"ä¿è­·è€…é€£çµ¡", hint:"é›»è©±/è¿ãˆ/èª¬æ˜" },
    { key:"safety", label:"å‘¨å›²å®‰å…¨ç¢ºä¿", hint:"å±é™ºé™¤å»ãƒ»ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿" },
    { key:"students", label:"å…ç«¥èª˜å°", hint:"ç¾¤è¡†æ•´ç†ãƒ»éš”é›¢" },
    { key:"nurse", label:"ä¿å¥å®¤æº–å‚™", hint:"æ‹…æ¶/æ¯›å¸ƒ/æ°·/è¨˜éŒ²ç”¨æ„" },
    { key:"log", label:"è¨˜éŒ²æ‹…å½“", hint:"æ™‚ç³»åˆ—ãƒ»å¼•ç¶™ã" },
  ];

  // keys
  const KEY_SETTINGS = "school_emergency_settings_v13";
  const KEY_INCIDENT = "school_emergency_incident_v13";

  // state
  let computedAgeStr = "--";
  let incidentStartAt = null;
  let incidentEndAt = null;
  let lastDeleted = null;

  // settings cache
  let currentCasePresets = [];
  let currentCheckPresets = [];

  // Log Viewer state
  let lvOrderNewestFirst = true;
  let lvOnlyImportant = false;
  let lvMode = "card"; // "card" | "text"

  // ===== Utils =====
  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1200);
  }
  function haptic(ms=15){ if(navigator.vibrate) navigator.vibrate(ms); }
  function safeText(v){ return (v||"").toString().trim(); }
  function nowTimeStr(d=new Date()){ return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
  function nowDateTimeStr(d=new Date()){ return d.toLocaleString('ja-JP'); }
  function escapeHtml(str){
    return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function scrollToSection(selector){
    const el = document.querySelector(selector);
    if(!el) return;
    el.scrollIntoView({behavior:"smooth", block:"start"});
  }

  // ===== Step nav =====
  function setStepActive(step){
    document.querySelectorAll(".stepBtn").forEach(b=>{
      const on = (b.dataset.step === String(step));
      b.classList.toggle("bg-slate-900", on);
      b.classList.toggle("text-white", on);
      b.classList.toggle("border-slate-900", on);
      b.classList.toggle("bg-white", !on);
    });
  }
  document.querySelectorAll(".stepBtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      const s = b.dataset.step;
      setStepActive(s);
      if(s==="1") scrollToSection("main section:nth-of-type(1)");
      if(s==="2") scrollToSection("main section:nth-of-type(4)");
      if(s==="3") scrollToSection("#logSection");
      if(s==="4") scrollToSection("#handoffSection");
    });
  });
  $("btnGoCall").onclick = ()=>{ setStepActive(2); scrollToSection("main section:nth-of-type(4)"); };
  $("btnGoLog").onclick  = ()=>{ setStepActive(3); scrollToSection("#logSection"); };
  $("btnGoHandoff").onclick = ()=>{ setStepActive(4); scrollToSection("#handoffSection"); };

  // ===== Toggle panels =====
  $("btnToggleSettings").onclick = ()=>{
    $("settingsPanel").classList.toggle("hidden");
    $("btnToggleSettings").textContent = $("settingsPanel").classList.contains("hidden") ? "é–‹ã" : "é–‰ã˜ã‚‹";
  };
  $("btnChecklistSettingsHint").onclick = ()=>{
    $("settingsPanel").classList.remove("hidden");
    $("btnToggleSettings").textContent = "é–‰ã˜ã‚‹";
    $("settingsPanel").scrollIntoView({behavior:"smooth", block:"start"});
    toast("è¨­å®šå†…ã®ã€Œåˆå‹•ãƒã‚§ãƒƒã‚¯ã€ã§ç·¨é›†ã§ãã¾ã™");
  };
  $("btnToggleMedical").onclick = ()=>{
    $("medicalPanel").classList.toggle("open");
    $("iconMedical").classList.toggle("rotate-180");
  };

  // ===== Age calc =====
  function gradeLabel(){
    const v = $("pGrade").value;
    if(!v) return "ï¼ˆä¸æ˜ï¼‰";
    if(/^\d$/.test(v)) return v + "å¹´ç”Ÿ";
    return v;
  }
  function updateAge(){
    const birthVal = $("pBirth").value;
    const gradeVal = $("pGrade").value;
    const now = new Date();
    if (birthVal) {
      const birthDate = new Date(birthVal);
      let age = now.getFullYear() - birthDate.getFullYear();
      const m = now.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && now.getDate() < birthDate.getDate())) age--;
      computedAgeStr = `${age}æ­³`;
    } else if (gradeVal && !isNaN(gradeVal)) {
      const grade = parseInt(gradeVal,10);
      computedAgeStr = `${grade + 5}ã€œ${grade + 6}æ­³ç›¸å½“`;
    } else {
      computedAgeStr = "--";
    }
    $("ageDisplay").innerText = `å¹´é½¢ï¼š${computedAgeStr}`;
    buildScript();
    persistIncident();
  }

  // ===== Speech Recognition =====
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let isRecording = false;
  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = "ja-JP";
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.onresult = (event)=>{
      let interim = "";
      let final = "";
      for(let i=event.resultIndex; i<event.results.length; i++){
        if(event.results[i].isFinal) final += event.results[i][0].transcript;
        else interim += event.results[i][0].transcript;
      }
      if(final) $("voiceInputArea").value += final;
      $("interimText").innerText = interim;
    };
    recognition.onend = ()=>{ if(isRecording) recognition.start(); };
  } else {
    $("voiceHint").textContent = "â€»ã“ã®ç«¯æœ«ã§ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“";
    $("btnVoiceRec").disabled = true;
    $("btnVoiceRec").classList.add("opacity-50");
  }
  function startRec(){
    if(!recognition) return;
    isRecording = true;
    try{
      recognition.start();
      $("pulseRing").classList.remove("hidden");
      $("btnVoiceRec").classList.replace("bg-blue-600","bg-red-600");
      $("micText").innerText = "REC ON";
      toast("éŒ²éŸ³é–‹å§‹");
      haptic(20);
    }catch(e){}
  }
  function stopRec(){
    isRecording = false;
    if(recognition) recognition.stop();
    $("pulseRing").classList.add("hidden");
    $("btnVoiceRec").classList.replace("bg-red-600","bg-blue-600");
    $("micText").innerText = "REC START";
    $("interimText").innerText = "";
    haptic(10);
  }
  $("btnVoiceRec").onclick = ()=> isRecording ? stopRec() : startRec();

  // ===== Incident storage =====
  function loadIncidentRaw(){
    const saved = localStorage.getItem(KEY_INCIDENT);
    if(!saved) return null;
    try { return JSON.parse(saved); } catch { return null; }
  }
  function ensureIncident(){
    const raw = loadIncidentRaw();
    if(!raw){
      localStorage.setItem(KEY_INCIDENT, JSON.stringify({ meta:{}, form:{}, entries:[], roles:{}, checklist:{} }));
    }
  }
  function getEntries(){
    const obj = loadIncidentRaw();
    return (obj?.entries && Array.isArray(obj.entries)) ? obj.entries : [];
  }
  function setEntries(entries){
    const obj = loadIncidentRaw() || {};
    obj.entries = entries;
    localStorage.setItem(KEY_INCIDENT, JSON.stringify(obj));
  }
  function getRoles(){
    const obj = loadIncidentRaw();
    return obj?.roles && typeof obj.roles==="object" ? obj.roles : {};
  }
  function setRoles(roles){
    const obj = loadIncidentRaw() || {};
    obj.roles = roles;
    localStorage.setItem(KEY_INCIDENT, JSON.stringify(obj));
    refreshRolesBadge();
    refreshLiveBar();
  }
  // NEW: checklist state is keyed by "item text" (ç·¨é›†ã«å¼·ã„)
  function getChecklistState(){
    const obj = loadIncidentRaw();
    return obj?.checklist && typeof obj.checklist==="object" ? obj.checklist : {};
  }
  function setChecklistState(state){
    const obj = loadIncidentRaw() || {};
    obj.checklist = state;
    localStorage.setItem(KEY_INCIDENT, JSON.stringify(obj));
  }

  // ===== Timeline CRUD =====
  function makeEntryObj(text, t=new Date()){
    return {
      id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
      at: t.toISOString(),
      time: nowTimeStr(t),
      text: safeText(text),
      important: false
    };
  }
  function addEntry(text){
    const t = safeText(text);
    if(!t) return;

    if(!incidentStartAt){
      incidentStartAt = Date.now();
      incidentEndAt = null;
      toast("é–‹å§‹ã‚‚è‡ªå‹•è¨˜éŒ²ã—ã¾ã—ãŸ");
    }
    const entries = getEntries();
    entries.push(makeEntryObj(t, new Date()));
    setEntries(entries);

    $("voiceInputArea").value = "";
    stopRec();
    refreshTimeline();
    buildScript();
    persistIncident();
    refreshLogViewerIfOpen();
    toast("è¨˜éŒ²ã—ã¾ã—ãŸ");
    haptic(12);
  }
  function findEntryIndex(entries, id){ return entries.findIndex(e=>e.id===id); }
  function editEntry(id){
    const entries = getEntries();
    const idx = findEntryIndex(entries, id);
    if(idx<0) return;
    const next = prompt("è¨˜éŒ²ã‚’ç·¨é›†ï¼ˆçŸ­ãã¦ã‚‚OKï¼‰", entries[idx].text);
    if(next===null) return;
    entries[idx].text = safeText(next);
    setEntries(entries);
    refreshTimeline();
    buildScript();
    persistIncident();
    refreshLogViewerIfOpen();
    toast("ç·¨é›†ã—ã¾ã—ãŸ");
  }
  function deleteEntry(id){
    const entries = getEntries();
    const idx = findEntryIndex(entries, id);
    if(idx<0) return;
    const removed = entries.splice(idx,1)[0];
    setEntries(entries);
    lastDeleted = { removed, idx };
    refreshTimeline();
    buildScript();
    persistIncident();
    refreshLogViewerIfOpen();
    toast("å‰Šé™¤ã—ã¾ã—ãŸï¼ˆå–ã‚Šæ¶ˆã—å¯ï¼‰");
    haptic(10);
  }
  function toggleImportant(id){
    const entries = getEntries();
    const idx = findEntryIndex(entries, id);
    if(idx<0) return;
    entries[idx].important = !entries[idx].important;
    setEntries(entries);
    refreshTimeline();
    persistIncident();
    refreshLogViewerIfOpen();
  }
  function renderEntry(entry){
    const div = document.createElement("div");
    div.className = "bg-white border rounded-2xl p-3 shadow-sm";
    div.dataset.id = entry.id;
    div.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="shrink-0">
          <div class="text-blue-600 font-black text-xs">${entry.time}</div>
          <button class="mt-1 px-2 py-1 rounded-full text-[10px] font-black border ${entry.important ? "bg-yellow-200 border-yellow-300" : "bg-slate-50"}" data-act="imp">
            ${entry.important ? "â˜…é‡è¦" : "â˜†é‡è¦"}
          </button>
        </div>
        <div class="flex-1 min-w-0">
          <div class="text-slate-900 text-sm font-black whitespace-pre-wrap break-words" data-role="text">${escapeHtml(entry.text)}</div>
          <div class="flex items-center gap-2 mt-2">
            <button class="px-3 py-2 rounded-full text-xs font-black border bg-white active:bg-slate-50" data-act="edit">ç·¨é›†</button>
            <button class="px-3 py-2 rounded-full text-xs font-black border bg-white active:bg-slate-50" data-act="del">å‰Šé™¤</button>
            <button class="ml-auto px-3 py-2 rounded-full text-xs font-black bg-slate-900 text-white active:scale-[0.99]" data-act="dup">åŒã˜å†…å®¹</button>
          </div>
        </div>
      </div>
    `;
    div.addEventListener("click",(e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const act = btn.dataset.act;
      if(act==="edit") editEntry(entry.id);
      if(act==="del") deleteEntry(entry.id);
      if(act==="dup") addEntry(entry.text);
      if(act==="imp") toggleImportant(entry.id);
    });
    return div;
  }
  function refreshTimeline(){
    const box = $("timeline");
    box.innerHTML = "";
    const entries = getEntries();
    if(entries.length===0){
      $("timelineEmpty").classList.remove("hidden");
      box.appendChild($("timelineEmpty"));
      refreshLiveBar();
      refreshInlineStatus();
      return;
    }
    $("timelineEmpty").classList.add("hidden");
    entries.slice().reverse().forEach(en=> box.appendChild(renderEntry(en)));
    refreshLiveBar();
    refreshInlineStatus();
  }
  $("btnAddTimeline").onclick = ()=> addEntry($("voiceInputArea").value);
  $("btnUndo").onclick = ()=>{
    if(!lastDeleted){ toast("å–ã‚Šæ¶ˆã™ã‚‚ã®ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
    const entries = getEntries();
    entries.splice(lastDeleted.idx, 0, lastDeleted.removed);
    setEntries(entries);
    lastDeleted = null;
    refreshTimeline();
    persistIncident();
    refreshLogViewerIfOpen();
    toast("å–ã‚Šæ¶ˆã—ã¾ã—ãŸ");
  };
  document.querySelectorAll("[data-log]").forEach(btn=>{
    btn.addEventListener("click", ()=> addEntry(btn.dataset.log));
  });

  // ===== Build Script =====
  function schoolOpsText(){
    const a1 = safeText($("aed1").value);
    const a2 = safeText($("aed2").value);
    const gateName = safeText($("gateName").value) || "æ­£é–€";
    const gateSpot = safeText($("gateSpot").value);
    const route = safeText($("ambulanceRoute").value);
    const extS = safeText($("extStaff").value);
    const extN = safeText($("extNurse").value);
    const extA = safeText($("extAdmin").value);
    const parts = [];
    if(a1 || a2) parts.push(`AEDï¼š${[a1,a2].filter(Boolean).join(" / ")}`);
    if(route) parts.push(`å°ç·šï¼š${route}`);
    if(gateSpot) parts.push(`${gateName}èª˜å°ï¼š${gateSpot}`);
    const extParts = [];
    if(extS) extParts.push(`è·å“¡å®¤${extS}`);
    if(extN) extParts.push(`ä¿å¥å®¤${extN}`);
    if(extA) extParts.push(`ç®¡ç†è·${extA}`);
    if(extParts.length) parts.push(`å†…ç·šï¼š${extParts.join(" / ")}`);
    return parts.join("ï½œ") || "ï¼ˆæœªè¨­å®šï¼‰";
  }

  function buildScript(){
    const startLine = incidentStartAt ? `ç™ºç”Ÿï¼š${new Date(incidentStartAt).toLocaleString('ja-JP')}` : `ç™ºç”Ÿï¼šæœªè¨˜éŒ²`;
    const endLine = incidentEndAt ? `çµ‚äº†ï¼š${new Date(incidentEndAt).toLocaleString('ja-JP')}` : ``;

    const gateName = safeText($("gateName").value) || "æ­£é–€";
    const gateSpot = safeText($("gateSpot").value);

    const script =
`ã€Œæ•‘æ€¥è¦è«‹ã§ã™ã€
${startLine}${endLine ? "\n" + endLine : ""}

å ´æ‰€ï¼š${$("schoolName").value || "ï¼ˆå­¦æ ¡åï¼‰"}
ä½æ‰€ï¼š${$("schoolAddr").value || "ï¼ˆå­¦æ ¡ä½æ‰€ï¼‰"}
æ ¡å†…ï¼š${$("place").value || "ï¼ˆæ ¡å†…ã®å ´æ‰€ï¼‰"}
é›»è©±ï¼š${$("schoolPhone").value || "ï¼ˆé›»è©±ï¼‰"}

å¯¾è±¡ï¼š${$("pName").value || "ï¼ˆæ°åï¼‰"}ï¼ˆ${gradeLabel()}ãƒ»${$("pSex").value || "ï¼ˆæ€§åˆ¥ï¼‰"}${computedAgeStr!=="--" ? "ãƒ»" + computedAgeStr : ""}ï¼‰
ç—‡çŠ¶ï¼š${$("symptom").value || "ï¼ˆç—‡çŠ¶ï¼‰"}

å­¦æ ¡å›ºæœ‰ï¼š${schoolOpsText()}

${gateSpot ? `${gateName}ï¼ˆèª˜å°å¾…æ©Ÿï¼‰ï¼š${gateSpot}` : `${gateName}ã«ã¦èª˜å°å¾…æ©Ÿã—ã¾ã™ã€‚`}`;

    $("scriptDisplay").innerText = script.trim();
  }

  // ===== Copy / Share =====
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }catch{
      const temp=document.createElement("textarea");
      temp.value=text;
      document.body.appendChild(temp);
      temp.select();
      document.execCommand("copy");
      temp.remove();
      toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }
  }
  async function shareText(title,text){
    if(navigator.share){
      try{ await navigator.share({title,text}); toast("å…±æœ‰ã—ã¾ã—ãŸ"); return; }catch(e){}
    }
    await copyText(text);
    toast("å…±æœ‰ã§ããªã„ãŸã‚ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  }

  function rolesSummaryText(){
    const roles = getRoles();
    const parts = ROLE_PRESETS.map(r=>{
      const v = safeText(roles[r.key]);
      return v ? `${r.label}ï¼š${v}` : "";
    }).filter(Boolean);
    return parts.join(" / ") || "ï¼ˆæœªç¢ºå®šï¼‰";
  }

  function checklistItems(){
    return (currentCheckPresets || []).filter(Boolean).slice(0,10);
  }

  function checklistDoneText(){
    const state = getChecklistState();
    const done = checklistItems().filter(item => !!state[item]);
    return done.length ? done.map(x=>"âœ… "+x).join("\n") : "ï¼ˆå®Œäº†ãªã—ï¼‰";
  }

  function checklistSummaryText(){
    const items = checklistItems();
    const state = getChecklistState();
    const done = items.filter(x=>!!state[x]);
    const todo = items.filter(x=>!state[x]);
    return [
      `å®Œäº†ï¼š${done.length} / ${items.length}`,
      ...(done.length ? done.map(x=>"âœ… "+x) : ["âœ…ï¼ˆãªã—ï¼‰"]),
      "",
      ...(todo.length ? ["æœªï¼š"] : []),
      ...(todo.length ? todo.map(x=>"â–¡ "+x) : [])
    ].join("\n");
  }

  function fullReportText(){
    const entries = getEntries();
    const lines = entries.map(e=> `${e.time} ${e.important ? "â˜… " : ""}${e.text}`);
    const chk = checklistSummaryText();
    return [
      "ã€æ•‘æ€¥å¯¾å¿œ è¨˜éŒ²ã€‘",
      `ä½œæˆï¼š${nowDateTimeStr()}`,
      "",
      `å­¦æ ¡ï¼š${$("schoolName").value || "æœªè¨­å®š"}`,
      `ä½æ‰€ï¼š${$("schoolAddr").value || "æœªè¨­å®š"}`,
      `é›»è©±ï¼š${$("schoolPhone").value || "æœªè¨­å®š"}`,
      `ç™ºç”Ÿå ´æ‰€ï¼š${$("place").value || "æœªå…¥åŠ›"}`,
      `å­¦æ ¡å›ºæœ‰ï¼š${schoolOpsText()}`,
      "",
      `å‚·ç—…è€…ï¼š${$("pName").value || "æœªå…¥åŠ›"}`,
      `å­¦å¹´ç­‰ï¼š${gradeLabel()}`,
      `æ€§åˆ¥ï¼š${$("pSex").value || "-"}`,
      `å¹´é½¢ï¼š${computedAgeStr}`,
      `ç—‡çŠ¶ï¼š${$("symptom").value || "-"}`,
      `æ—¢å¾€ï¼š${$("pHistory").value || "-"}`,
      `ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ï¼š${$("pAllergy").value || "-"}`,
      "",
      `ã€åˆå‹•ãƒã‚§ãƒƒã‚¯ã€‘`,
      chk,
      "",
      `ã€å½¹å‰²åˆ†æ‹…ã€‘`,
      rolesSummaryText(),
      "",
      `é–‹å§‹ï¼š${incidentStartAt ? new Date(incidentStartAt).toLocaleString('ja-JP') : "æœªè¨˜éŒ²"}`,
      `çµ‚äº†ï¼š${incidentEndAt ? new Date(incidentEndAt).toLocaleString('ja-JP') : "æœªè¨˜éŒ²"}`,
      "",
      "ã€æ™‚ç³»åˆ—ã€‘",
      ...(lines.length ? lines : ["ï¼ˆè¨˜éŒ²ãªã—ï¼‰"]),
    ].join("\n");
  }

  function teamsPostText(){
    const start = incidentStartAt ? new Date(incidentStartAt).toLocaleString('ja-JP') : "æœªè¨˜éŒ²";
    const end = incidentEndAt ? new Date(incidentEndAt).toLocaleString('ja-JP') : "æœªè¨˜éŒ²";
    const roles = rolesSummaryText();
    const place = $("place").value || "æœªå…¥åŠ›";
    const symptom = $("symptom").value || "ç¢ºèªä¸­";
    const name = $("pName").value || "æœªå…¥åŠ›";
    const grade = gradeLabel();
    const sex = $("pSex").value || "-";
    const age = computedAgeStr !== "--" ? computedAgeStr : "-";
    const school = $("schoolName").value || "ï¼ˆå­¦æ ¡ï¼‰";
    return [
      "ã€æ•‘æ€¥å¯¾å¿œ å…±æœ‰ã€‘",
      `å­¦æ ¡ï¼š${school}`,
      `é–‹å§‹ï¼š${start} / çµ‚äº†ï¼š${end}`,
      `å ´æ‰€ï¼š${place}`,
      `å¯¾è±¡ï¼š${name}ï¼ˆ${grade}ãƒ»${sex}ãƒ»${age}ï¼‰`,
      `çŠ¶æ³ï¼š${symptom}`,
      `å­¦æ ¡å›ºæœ‰ï¼š${schoolOpsText()}`,
      `åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼šå®Œäº†${(getChecklistState() ? Object.values(getChecklistState()).filter(Boolean).length : 0)}ä»¶`,
      `å½¹å‰²ï¼š${roles}`,
      "",
      "â€»å¿…è¦ã«å¿œã˜ã¦è¿½åŠ å¯¾å¿œãƒ»å¼•ç¶™ãã‚’è¡Œã„ã¾ã™ã€‚"
    ].join("\n");
  }

  function downloadBlob(filename, text, type="text/plain"){
    const blob = new Blob([text], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  $("btnCopyScript").onclick = ()=> copyText($("scriptDisplay").innerText);
  $("btnShareScript").onclick = ()=> shareText("119é€šå ±ç”¨åŸç¨¿", $("scriptDisplay").innerText);
  $("btnCopyTimeline").onclick = ()=>{
    const entries = getEntries();
    const lines = entries.map(e=> `${e.time} ${e.important ? "â˜… " : ""}${e.text}`);
    copyText(lines.join("\n") || "ï¼ˆè¨˜éŒ²ãªã—ï¼‰");
  };
  $("btnExportTxt").onclick = ()=>{
    const name = ($("pName").value || "report").replace(/\s+/g,"_");
    downloadBlob(`emergency_${name}_${Date.now()}.txt`, fullReportText(), "text/plain");
    toast("TXTã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ");
  };
  $("btnExportJson").onclick = ()=>{
    const obj = loadIncidentRaw() || {};
    downloadBlob(`emergency_data_${Date.now()}.json`, JSON.stringify(obj, null, 2), "application/json");
    toast("JSONã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ");
  };
  $("btnShareAll").onclick = ()=> shareText("æ•‘æ€¥å¯¾å¿œ è¨˜éŒ²", fullReportText());
  $("btnCopyTeams").onclick = ()=> copyText(teamsPostText());
  $("btnShareTeams").onclick = ()=> shareText("TeamsæŠ•ç¨¿æ–‡", teamsPostText());

  // ===== Print =====
  $("btnPrint").onclick = ()=>{
    $("printTimestamp").innerText = `ä½œæˆï¼š${nowDateTimeStr()}`;
    $("p_schoolName").innerText = $("schoolName").value || "æœªè¨­å®š";
    $("p_schoolAddrPhone").innerText = `${$("schoolAddr").value || "æœªè¨­å®š"} / ${$("schoolPhone").value || "æœªè¨­å®š"}`;
    $("p_place").innerText = $("place").value || "æœªå…¥åŠ›";
    $("p_name").innerText = $("pName").value || "æœªå…¥åŠ›";
    $("p_gradeSexAge").innerText = `${gradeLabel()} / ${$("pSex").value || "-"} / ${computedAgeStr}`;

    let med = `ã€ç—‡çŠ¶ã€‘${$("symptom").value || "æœªå…¥åŠ›"}`;
    if($("pHistory").value) med += `ã€€ã€æ—¢å¾€ã€‘${$("pHistory").value}`;
    if($("pAllergy").value) med += `ã€€ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã€‘${$("pAllergy").value}`;
    $("p_med").innerText = med;

    $("p_schoolOps").innerText = schoolOpsText();
    $("p_roles").innerText = rolesSummaryText();
    $("p_checklist").innerText = checklistDoneText();
    $("p_start").innerText = incidentStartAt ? new Date(incidentStartAt).toLocaleString('ja-JP') : "æœªè¨˜éŒ²";
    $("p_end").innerText = incidentEndAt ? new Date(incidentEndAt).toLocaleString('ja-JP') : "æœªè¨˜éŒ²";

    const entries = getEntries();
    const container = $("p_timeline");
    container.innerHTML = "";
    if(entries.length===0){
      container.innerHTML = `<div class="print-row text-sm text-gray-500">è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    }else{
      entries.forEach(e=>{
        const row = document.createElement("div");
        row.className = "print-row flex gap-3";
        row.innerHTML = `<div class="w-16 font-bold">${e.time}</div><div class="flex-1 text-sm">${escapeHtml((e.important ? "â˜… " : "") + e.text)}</div>`;
        container.appendChild(row);
      });
    }
    window.print();
  };

  // ===== Start/Stop =====
  function updateStartStopUI(){
    const started = !!incidentStartAt;
    const ended = !!incidentEndAt;

    const state = $("stateBadge");
    if(!started){
      state.textContent="æœªé–‹å§‹";
      state.className="px-2 py-1 rounded-full bg-slate-200 text-slate-800 text-[10px] font-black";
    }else if(started && !ended){
      state.textContent="å¯¾å¿œä¸­";
      state.className="px-2 py-1 rounded-full bg-emerald-600 text-white text-[10px] font-black";
    }else{
      state.textContent="çµ‚äº†";
      state.className="px-2 py-1 rounded-full bg-slate-900 text-white text-[10px] font-black";
    }

    $("btnMarkStart").disabled = started && !ended;
    $("btnMarkStart").classList.toggle("opacity-50", started && !ended);
    $("btnMarkEnd").disabled = !started || ended;
    $("btnMarkEnd").classList.toggle("opacity-50", !started || ended);

    const big = $("btnBigStartStop");
    if(!started){
      big.textContent="é–‹å§‹";
      big.className="py-3 rounded-2xl bg-emerald-600 text-white font-black text-xs active:scale-[0.99]";
    }else if(started && !ended){
      big.textContent="åœæ­¢";
      big.className="py-3 rounded-2xl bg-red-600 text-white font-black text-xs active:scale-[0.99]";
    }else{
      big.textContent="å†é–‹";
      big.className="py-3 rounded-2xl bg-amber-500 text-white font-black text-xs active:scale-[0.99]";
    }

    $("liveState").textContent = state.textContent;
    $("stateInline").textContent = state.textContent;
    refreshInlineStatus();
  }

  $("btnMarkStart").onclick = ()=>{
    if(incidentStartAt && !incidentEndAt){ toast("ã™ã§ã«é–‹å§‹ã¯è¨˜éŒ²æ¸ˆã¿"); return; }
    incidentStartAt = Date.now();
    incidentEndAt = null;
    persistIncident();
    addEntry("ç™ºç”Ÿï¼ˆé–‹å§‹ï¼‰ã‚’è¨˜éŒ²");
    buildScript();
    updateStartStopUI();
  };
  $("btnMarkEnd").onclick = ()=>{
    if(!incidentStartAt){ toast("é–‹å§‹ãŒæœªè¨˜éŒ²ã§ã™"); return; }
    if(incidentEndAt){ toast("ã™ã§ã«çµ‚äº†ã¯è¨˜éŒ²æ¸ˆã¿"); return; }
    incidentEndAt = Date.now();
    persistIncident();
    addEntry("åœæ­¢ï¼ˆçµ‚äº†ï¼‰ã‚’è¨˜éŒ²");
    buildScript();
    updateStartStopUI();
  };
  $("btnBigStartStop").onclick = ()=>{
    if(!incidentStartAt){ $("btnMarkStart").click(); return; }
    if(incidentStartAt && !incidentEndAt){ $("btnMarkEnd").click(); return; }
    const ok = confirm("çµ‚äº†æ¸ˆã¿ã®å¯¾å¿œã‚’ã€Œå†é–‹ã€ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆçµ‚äº†æ™‚åˆ»ã¯æ¶ˆãˆã€ç¶™ç¶šã—ã¦è¨˜éŒ²ã§ãã¾ã™ï¼‰");
    if(!ok) return;
    incidentEndAt = null;
    persistIncident();
    addEntry("å¯¾å¿œã‚’å†é–‹");
    updateStartStopUI();
  };

  function tickElapsed(){
    const badge = $("elapsedBadge");
    if(!incidentStartAt){
      badge.textContent="--:--";
      $("elapsedInline").textContent="--:--";
      return;
    }
    const end = incidentEndAt ? incidentEndAt : Date.now();
    const diff = end - incidentStartAt;
    const m = Math.floor(diff/60000);
    const s = Math.floor((diff%60000)/1000);
    const txt = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    badge.textContent = txt;
    $("elapsedInline").textContent = txt;
  }
  setInterval(tickElapsed, 1000);

  // ===== Live Bar / inline status =====
  function countAssignedRoles(roles){
    return Object.values(roles||{}).filter(v=>safeText(v)).length;
  }
  function refreshRolesBadge(){
    const roles = getRoles();
    $("rolesBadge").textContent = `å½¹å‰²:${countAssignedRoles(roles)}`;
  }
  function refreshLiveBar(){
    const entries = getEntries();
    const roles = getRoles();
    $("liveCount").textContent = String(entries.length);
    $("liveRoles").textContent = String(countAssignedRoles(roles));

    if(entries.length===0){
      $("liveTime").textContent="--:--";
      $("liveText").textContent="ï¼ˆè¨˜éŒ²ãªã—ï¼‰";
      return;
    }
    const last = entries[entries.length-1];
    $("liveTime").textContent = last.time || "--:--";
    $("liveText").textContent = last.text || "";
  }
  function refreshInlineStatus(){
    const entries = getEntries();
    $("countInline").textContent = String(entries.length);
    if(entries.length===0){
      $("latestInline").textContent = "ï¼ˆè¨˜éŒ²ãªã—ï¼‰";
      return;
    }
    $("latestInline").textContent = entries[entries.length-1].text || "";
  }
  $("liveBar").onclick = ()=>{ setStepActive(3); scrollToSection("#logSection"); };

  // ===== Quick Sheet =====
  function openQuickSheet(){ $("quickSheetWrap").classList.remove("hidden"); haptic(8); }
  function closeQuickSheet(){ $("quickSheetWrap").classList.add("hidden"); }
  $("btnOpenQuickSheet").onclick = openQuickSheet;
  $("btnCloseQuickSheet").onclick = closeQuickSheet;
  $("sheetBackdrop").onclick = closeQuickSheet;
  $("btnQuickToLog").onclick = ()=>{ closeQuickSheet(); setStepActive(3); scrollToSection("#logSection"); };

  $("btnLogAed").onclick = ()=>{
    const a1 = safeText($("aed1").value);
    const a2 = safeText($("aed2").value);
    addEntry(`AEDæ¬é€ï¼š${[a1,a2].filter(Boolean).join(" / ") || "ï¼ˆå ´æ‰€æœªè¨­å®šï¼‰"} ã‹ã‚‰æ¬é€é–‹å§‹`);
  };
  $("btnLogGate").onclick = ()=>{
    const gateName = safeText($("gateName").value) || "æ­£é–€";
    const gateSpot = safeText($("gateSpot").value);
    addEntry(`æ­£é–€èª˜å°ï¼š${gateName}${gateSpot ? "ï¼ˆ" + gateSpot + "ï¼‰" : ""} ã«ã¦å¾…æ©Ÿãƒ»èª˜å°`);
  };

  // ===== Role Sheet =====
  function openRoleSheet(){ $("roleSheetWrap").classList.remove("hidden"); renderRoleBoard(); haptic(8); }
  function closeRoleSheet(){ $("roleSheetWrap").classList.add("hidden"); }
  $("btnOpenRoleBoard").onclick = openRoleSheet;
  $("btnCloseRoleSheet").onclick = closeRoleSheet;
  $("roleBackdrop").onclick = closeRoleSheet;
  $("btnRoleToLog").onclick = ()=>{ closeRoleSheet(); setStepActive(3); scrollToSection("#logSection"); };

  function renderRoleBoard(){
    const roles = getRoles();
    const list = $("roleList");
    list.innerHTML = "";
    ROLE_PRESETS.forEach(r=>{
      const assigned = safeText(roles[r.key]);
      const row = document.createElement("div");
      row.className = "border rounded-2xl p-3 bg-slate-50";
      row.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <div class="min-w-0">
            <div class="font-black text-slate-900 text-sm">${r.label}</div>
            <div class="text-[10px] font-bold text-slate-500">${r.hint}</div>
          </div>
          <div class="text-[10px] font-black ${assigned ? "text-emerald-700" : "text-slate-400"}">${assigned ? "ç¢ºå®šæ¸ˆ" : "æœªç¢ºå®š"}</div>
        </div>
        <div class="grid grid-cols-3 gap-2 mt-2">
          <input data-rolekey="${r.key}" class="roleName col-span-2 w-full p-3 bg-white border rounded-xl text-sm font-black" placeholder="æ‹…å½“è€…åï¼ˆä¾‹ï¼šã€‡ã€‡ï¼‰" value="${assigned ? escapeHtml(assigned) : ""}">
          <button data-act="confirm" data-rolekey="${r.key}" class="py-3 rounded-2xl ${assigned ? "bg-emerald-600 text-white" : "bg-slate-900 text-white"} text-xs font-black active:scale-[0.99]">
            ${assigned ? "æ›´æ–°" : "ç¢ºå®š"}
          </button>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <button data-act="logOnly" data-rolekey="${r.key}" class="py-3 rounded-2xl bg-white border text-xs font-black active:bg-slate-50">è¨˜éŒ²ã ã‘</button>
          <button data-act="clear" data-rolekey="${r.key}" class="py-3 rounded-2xl bg-white border text-xs font-black active:bg-slate-50">è§£é™¤</button>
        </div>
      `;
      row.addEventListener("click",(e)=>{
        const btn = e.target.closest("button");
        if(!btn) return;
        const act = btn.dataset.act;
        const key = btn.dataset.rolekey;
        const input = row.querySelector(`input[data-rolekey="${key}"]`);
        const name = safeText(input.value);
        const rolesNow = getRoles();

        if(act==="confirm"){
          if(!name){ toast("æ‹…å½“è€…åã‚’å…¥ã‚Œã¦ãã ã•ã„"); haptic(10); return; }
          rolesNow[key] = name;
          setRoles(rolesNow);
          addEntry(`å½¹å‰²ç¢ºå®šï¼š${ROLE_PRESETS.find(x=>x.key===key).label}ï¼${name}`);
          toast("å½¹å‰²ã‚’ç¢ºå®šã—ã¾ã—ãŸ");
          renderRoleBoard();
          return;
        }
        if(act==="logOnly"){
          addEntry(`å½¹å‰²ï¼š${ROLE_PRESETS.find(x=>x.key===key).label}${name ? "ï¼ˆ" + name + "ï¼‰" : ""}`);
          toast("å½¹å‰²ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ");
          return;
        }
        if(act==="clear"){
          delete rolesNow[key];
          setRoles(rolesNow);
          addEntry(`å½¹å‰²è§£é™¤ï¼š${ROLE_PRESETS.find(x=>x.key===key).label}`);
          toast("è§£é™¤ã—ã¾ã—ãŸ");
          renderRoleBoard();
          return;
        }
      });
      list.appendChild(row);
    });
    refreshRolesBadge();
    refreshLiveBar();
  }

  $("btnRoleAutoFill").onclick = ()=>{
    const main = safeText($("nurseName").value) || "ï¼ˆæœªå…¥åŠ›ï¼‰";
    document.querySelectorAll(".roleName").forEach(inp=>{
      if(!safeText(inp.value)) inp.value = main;
    });
    toast("å…¥åŠ›è£œåŠ©ã—ã¾ã—ãŸï¼ˆå¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ï¼‰");
  };
  $("btnRoleClear").onclick = ()=>{
    const ok = confirm("å½¹å‰²åˆ†æ‹…ã‚’å…¨è§£é™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if(!ok) return;
    setRoles({});
    addEntry("å½¹å‰²åˆ†æ‹…ï¼šå…¨è§£é™¤");
    renderRoleBoard();
    toast("å…¨è§£é™¤ã—ã¾ã—ãŸ");
  };

  // ===== Checklist (school-specific max 10) =====
  function renderChecklist(){
    const items = checklistItems();
    const wrap = $("checklist");
    const state = getChecklistState();
    wrap.innerHTML = "";

    if(items.length===0){
      const p = document.createElement("div");
      p.className = "text-center text-sm font-black text-slate-400 py-6 border rounded-2xl bg-slate-50";
      p.textContent = "ï¼ˆãƒã‚§ãƒƒã‚¯é …ç›®ãŒæœªè¨­å®šã§ã™ã€‚è¨­å®šã‹ã‚‰å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰";
      wrap.appendChild(p);
      return;
    }

    items.forEach((label)=>{
      const checked = !!state[label];
      const row = document.createElement("button");
      row.className = `w-full text-left border rounded-2xl p-3 flex items-start gap-3 active:bg-slate-50 ${checked ? "bg-emerald-50 border-emerald-200" : "bg-white"}`;
      row.innerHTML = `
        <div class="mt-0.5 w-6 h-6 rounded-lg flex items-center justify-center ${checked ? "bg-emerald-600 text-white" : "bg-slate-100 text-slate-500"} font-black text-xs">
          ${checked ? "âœ“" : ""}
        </div>
        <div class="flex-1">
          <div class="font-black text-sm text-slate-900">${escapeHtml(label)}</div>
          <div class="text-[10px] font-bold ${checked ? "text-emerald-700" : "text-slate-500"}">${checked ? "å®Œäº†ï¼ˆã‚¿ãƒƒãƒ—ã§è§£é™¤ï¼‰" : "æœªï¼ˆã‚¿ãƒƒãƒ—ã§å®Œäº†ï¼‰"}</div>
        </div>
      `;
      row.onclick = ()=>{
        const st = getChecklistState();
        st[label] = !st[label];
        setChecklistState(st);
        renderChecklist();
        addEntry((st[label] ? "åˆå‹•ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼š " : "åˆå‹•ãƒã‚§ãƒƒã‚¯è§£é™¤ï¼š ") + label);
        toast(st[label] ? "ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ãŸ" : "è§£é™¤ã—ã¾ã—ãŸ");
      };
      wrap.appendChild(row);
    });
  }

  $("btnChecklistReset").onclick = ()=>{
    const ok = confirm("ãƒã‚§ãƒƒã‚¯ã‚’ã™ã¹ã¦è§£é™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if(!ok) return;
    setChecklistState({});
    renderChecklist();
    addEntry("åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼šå…¨è§£é™¤");
    toast("å…¨è§£é™¤ã—ã¾ã—ãŸ");
  };
  $("btnCopyChecklist").onclick = ()=> copyText(checklistSummaryText());

  // ===== Settings save/load =====
  function applyDefaultCasesToInputs(){
    const inputs = document.querySelectorAll(".casePreset");
    inputs.forEach((inp, idx)=> inp.value = DEFAULT_CASES[idx] || "");
  }
  function applyDefaultChecksToInputs(){
    const inputs = document.querySelectorAll(".checkPreset");
    inputs.forEach((inp, idx)=> inp.value = DEFAULT_CHECKS[idx] || "");
  }

  function getCasePresetsFromUI(){
    const arr = [];
    document.querySelectorAll(".casePreset").forEach(inp=>{
      const v = safeText(inp.value);
      if(v) arr.push(v);
    });
    return arr.slice(0,10);
  }
  function getCheckPresetsFromUI(){
    const arr = [];
    document.querySelectorAll(".checkPreset").forEach(inp=>{
      const v = safeText(inp.value);
      if(v) arr.push(v);
    });
    return arr.slice(0,10);
  }

  function buildCaseChips(cases){
    const box = $("caseChips");
    box.innerHTML = "";
    const list = (cases || []).filter(Boolean).slice(0,10);
    if(list.length===0){
      const p = document.createElement("div");
      p.className="col-span-2 text-center text-xs font-black text-slate-400 py-4 border rounded-2xl bg-slate-50";
      p.textContent="ï¼ˆè¨­å®šã«ã‚±ãƒ¼ã‚¹ã‚’å…¥åŠ›ã™ã‚‹ã¨ã“ã“ã«ãƒœã‚¿ãƒ³ãŒå‡ºã¾ã™ï¼‰";
      box.appendChild(p);
      return;
    }
    list.forEach(txt=>{
      const b = document.createElement("button");
      b.className="chip rounded-2xl bg-white border text-slate-900 text-xs font-black";
      b.textContent = txt;
      b.onclick = ()=>{
        const cur = safeText($("symptom").value);
        $("symptom").value = cur ? (cur + " / " + txt) : txt;
        addEntry("ã‚±ãƒ¼ã‚¹ï¼š " + txt);
        buildScript();
        persistIncident();
        toast("ã‚±ãƒ¼ã‚¹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ");
      };
      box.appendChild(b);
    });
  }

  $("btnRestoreDefaultCases").onclick = ()=>{
    applyDefaultCasesToInputs();
    currentCasePresets = getCasePresetsFromUI();
    buildCaseChips(currentCasePresets);
    toast("åˆæœŸã‚»ãƒƒãƒˆã«æˆ»ã—ã¾ã—ãŸï¼ˆä¿å­˜ã™ã‚‹ã¨åæ˜ ï¼‰");
  };
  $("btnClearCases").onclick = ()=>{
    document.querySelectorAll(".casePreset").forEach(inp=> inp.value="");
    currentCasePresets = [];
    buildCaseChips([]);
    toast("ã‚±ãƒ¼ã‚¹ã‚’ç©ºã«ã—ã¾ã—ãŸï¼ˆä¿å­˜ã™ã‚‹ã¨åæ˜ ï¼‰");
  };

  $("btnRestoreDefaultChecks").onclick = ()=>{
    applyDefaultChecksToInputs();
    currentCheckPresets = getCheckPresetsFromUI();
    renderChecklist();
    toast("åˆæœŸã‚»ãƒƒãƒˆã«æˆ»ã—ã¾ã—ãŸï¼ˆä¿å­˜ã™ã‚‹ã¨åæ˜ ï¼‰");
  };
  $("btnClearChecks").onclick = ()=>{
    document.querySelectorAll(".checkPreset").forEach(inp=> inp.value="");
    currentCheckPresets = [];
    renderChecklist();
    toast("ãƒã‚§ãƒƒã‚¯ã‚’ç©ºã«ã—ã¾ã—ãŸï¼ˆä¿å­˜ã™ã‚‹ã¨åæ˜ ï¼‰");
  };

  function updateQuickLinks(){
    const school = safeText($("schoolPhone").value);
    const admin = safeText($("adminMobile").value);
    const guard = safeText($("guardianPhone").value);
    $("btnCallSchool").href = school ? `tel:${school}` : "#";
    $("btnCallAdmin").href = admin ? `tel:${admin}` : "#";
    $("btnCallGuardian").href = guard ? `tel:${guard}` : "#";
  }

  $("btnSaveSettings").onclick = ()=>{
    const settings = {
      schoolName: $("schoolName").value,
      schoolAddr: $("schoolAddr").value,
      schoolPhone: $("schoolPhone").value,
      mapUrl: $("mapUrl").value,
      ambulanceRoute: $("ambulanceRoute").value,
      aed1: $("aed1").value,
      aed2: $("aed2").value,
      gateName: $("gateName").value,
      gateSpot: $("gateSpot").value,
      extStaff: $("extStaff").value,
      extNurse: $("extNurse").value,
      extAdmin: $("extAdmin").value,
      nurseName: $("nurseName").value,
      adminMobile: $("adminMobile").value,
      guardianPhone: $("guardianPhone").value,
      casePresets: getCasePresetsFromUI(),
      checkPresets: getCheckPresetsFromUI()
    };
    localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings));
    currentCasePresets = settings.casePresets || [];
    currentCheckPresets = settings.checkPresets || [];
    buildCaseChips(currentCasePresets);
    renderChecklist();
    updateQuickLinks();
    buildScript();
    persistIncident();
    toast("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    haptic(12);
  };

  $("btnResetSettings").onclick = ()=>{
    const ok = confirm("å­¦æ ¡å›ºæœ‰è¨­å®šã‚’æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if(!ok) return;
    localStorage.removeItem(KEY_SETTINGS);
    ["schoolName","schoolAddr","schoolPhone","mapUrl","ambulanceRoute","aed1","aed2","gateName","gateSpot","extStaff","extNurse","extAdmin","nurseName","adminMobile","guardianPhone"]
      .forEach(id=> $(id).value="");
    applyDefaultCasesToInputs();
    applyDefaultChecksToInputs();
    currentCasePresets = getCasePresetsFromUI();
    currentCheckPresets = getCheckPresetsFromUI();
    buildCaseChips(currentCasePresets);
    renderChecklist();
    updateQuickLinks();
    buildScript();
    persistIncident();
    toast("è¨­å®šã‚’æ¶ˆå»ã—ã¾ã—ãŸï¼ˆåˆæœŸã‚»ãƒƒãƒˆã¯æˆ»ã—ã¾ã—ãŸï¼‰");
  };

  function loadSettings(){
    const saved = localStorage.getItem(KEY_SETTINGS);
    if(!saved){
      applyDefaultCasesToInputs();
      applyDefaultChecksToInputs();
      return { casePresets: getCasePresetsFromUI(), checkPresets: getCheckPresetsFromUI() };
    }
    try{
      const s = JSON.parse(saved);
      Object.keys(s).forEach(k=>{
        if($(k)) $(k).value = s[k] ?? "";
      });

      // cases
      const cList = Array.isArray(s.casePresets) ? s.casePresets.slice(0,10) : [];
      const cInputs = document.querySelectorAll(".casePreset");
      if(cList.length){
        cInputs.forEach((inp, idx)=> inp.value = cList[idx] || "");
      }else{
        applyDefaultCasesToInputs();
      }

      // checks
      const ckList = Array.isArray(s.checkPresets) ? s.checkPresets.slice(0,10) : [];
      const ckInputs = document.querySelectorAll(".checkPreset");
      if(ckList.length){
        ckInputs.forEach((inp, idx)=> inp.value = ckList[idx] || "");
      }else{
        applyDefaultChecksToInputs();
      }

      return { casePresets: getCasePresetsFromUI(), checkPresets: getCheckPresetsFromUI() };
    }catch{
      applyDefaultCasesToInputs();
      applyDefaultChecksToInputs();
      return { casePresets: getCasePresetsFromUI(), checkPresets: getCheckPresetsFromUI() };
    }
  }

  // ===== Incident persist/load =====
  function persistIncident(){
    const cur = loadIncidentRaw() || {};
    cur.meta = { updatedAt: Date.now(), startAt: incidentStartAt, endAt: incidentEndAt };
    cur.form = {
      place: $("place").value,
      pName: $("pName").value,
      pGrade: $("pGrade").value,
      pSex: $("pSex").value,
      pBirth: $("pBirth").value,
      symptom: $("symptom").value,
      pHistory: $("pHistory").value,
      pAllergy: $("pAllergy").value,
      computedAgeStr,
    };
    if(!Array.isArray(cur.entries)) cur.entries = [];
    if(!cur.roles || typeof cur.roles!=="object") cur.roles = {};
    if(!cur.checklist || typeof cur.checklist!=="object") cur.checklist = {};
    localStorage.setItem(KEY_INCIDENT, JSON.stringify(cur));
    updateStartStopUI();
    refreshRolesBadge();
    refreshLiveBar();
    refreshInlineStatus();
  }

  function loadIncident(){
    const obj = loadIncidentRaw();
    if(!obj) return;
    const form = obj.form || {};
    ["place","pName","pGrade","pSex","pBirth","symptom","pHistory","pAllergy"].forEach(id=>{
      if($(id)) $(id).value = form[id] || "";
    });
    computedAgeStr = form.computedAgeStr || "--";
    $("ageDisplay").innerText = `å¹´é½¢ï¼š${computedAgeStr}`;
    incidentStartAt = obj.meta?.startAt || null;
    incidentEndAt = obj.meta?.endAt || null;
  }

  // ===== School quick actions =====
  $("btnOpenMap").onclick = ()=>{
    const url = safeText($("mapUrl").value);
    if(!url){ toast("åœ°å›³URLãŒæœªè¨­å®šã§ã™"); return; }
    window.open(url, "_blank");
  };
  $("btnCopySchoolOps").onclick = ()=>{
    const txt = `ã€å­¦æ ¡å›ºæœ‰ã€‘\n${schoolOpsText()}\nå­¦æ ¡ï¼š${$("schoolName").value || "æœªè¨­å®š"}\nä½æ‰€ï¼š${$("schoolAddr").value || "æœªè¨­å®š"}\né›»è©±ï¼š${$("schoolPhone").value || "æœªè¨­å®š"}`;
    copyText(txt);
  };

  // ===== Broadcast / Guardian messages =====
  $("btnCopyBroadcast").onclick = ()=>{
    const msg =
`ã€æ ¡å†…æ”¾é€ï¼ˆä¾‹ï¼‰ã€‘
ã“ã¡ã‚‰ã¯è·å“¡å®¤ã§ã™ã€‚
${$("place").value || "æ ¡å†…"}ã§å¯¾å¿œä¸­ã§ã™ã€‚å‘¨å›²ã®å…ç«¥ã¯è·é›¢ã‚’å–ã‚Šã€æ‹…ä»»ã¯è½ã¡ç€ã„ã¦èª˜å°ã—ã¦ãã ã•ã„ã€‚
å¿…è¦ãªè·å“¡ã¯è·å“¡å®¤ã¸ã€‚`;
    copyText(msg);
  };

  $("btnCopyGuardianMsg").onclick = ()=>{
    const msg =
`ã€å­¦æ ¡ã‹ã‚‰ã®é€£çµ¡ã€‘${$("schoolName").value || "ï¼ˆå­¦æ ¡ï¼‰"}ã§ã™ã€‚
ãŠå­ã•ã‚“ã®ä½“èª¿ä¸è‰¯/è² å‚·ã§å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
çŠ¶æ³ï¼š${$("symptom").value || "ç¢ºèªä¸­"}
å ´æ‰€ï¼š${$("place").value || "æ ¡å†…"}
å¿…è¦ã«å¿œã˜ã¦æ•‘æ€¥è¦è«‹ãƒ»åŒ»ç™‚æ©Ÿé–¢å—è¨ºã‚’è¡Œã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
æŠ˜ã‚Šè¿”ã—ï¼š${$("schoolPhone").value || "ï¼ˆå­¦æ ¡é›»è©±ï¼‰"}`;
    copyText(msg);
  };

  $("btnCopyGuardianTransport").onclick = ()=>{
    const msg =
`ã€å­¦æ ¡ã‹ã‚‰ã®é€£çµ¡ã€‘${$("schoolName").value || "ï¼ˆå­¦æ ¡ï¼‰"}ã§ã™ã€‚
æ•‘æ€¥æ¬é€ã¨ãªã‚Šã¾ã—ãŸï¼ˆã¾ãŸã¯ãã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚
çŠ¶æ³ï¼š${$("symptom").value || "ç¢ºèªä¸­"}
æ¬é€å…ˆï¼šç¢ºèªä¸­ï¼ˆæ±ºã¾ã‚Šæ¬¡ç¬¬ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ï¼‰
æŠ˜ã‚Šè¿”ã—ï¼š${$("schoolPhone").value || "ï¼ˆå­¦æ ¡é›»è©±ï¼‰"}`;
    copyText(msg);
  };

  // ===== New incident =====
  $("btnNewIncident").onclick = ()=>{
    const ok = confirm("æ–°è¦å¯¾å¿œã¨ã—ã¦è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚\nï¼ˆå­¦æ ¡å›ºæœ‰è¨­å®šã¯æ®‹ã‚Šã¾ã™ï¼å½¹å‰²ãƒ»ãƒã‚§ãƒƒã‚¯ãƒ»è¨˜éŒ²ã¯ãƒªã‚»ãƒƒãƒˆï¼‰\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if(!ok) return;
    localStorage.removeItem(KEY_INCIDENT);
    incidentStartAt = null;
    incidentEndAt = null;
    lastDeleted = null;

    ["place","pName","pGrade","pSex","pBirth","symptom","pHistory","pAllergy"].forEach(id=> $(id).value="");
    computedAgeStr="--";
    $("ageDisplay").innerText = `å¹´é½¢ï¼š${computedAgeStr} æ­³`;
    $("voiceInputArea").value = "";

    ensureIncident();
    setRoles({});
    setChecklistState({});
    renderChecklist();
    persistIncident();
    refreshTimeline();
    buildScript();
    refreshLogViewerIfOpen();
    toast("æ–°è¦ã¨ã—ã¦é–‹å§‹ã§ãã¾ã™");
  };

  // ===== Autosave =====
  let autosaveTimer = null;
  function scheduleAutosave(){
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(()=> persistIncident(), 250);
  }
  $("pBirth").addEventListener("change", ()=>{ updateAge(); scheduleAutosave(); });
  $("pGrade").addEventListener("change", ()=>{ updateAge(); scheduleAutosave(); });
  document.querySelectorAll("input, textarea, select").forEach(el=>{
    el.addEventListener("input", ()=>{
      buildScript();
      updateQuickLinks();
      scheduleAutosave();
    });
  });

  // ===== Log Viewer (NEW) =====
  function openLogViewer(){
    $("logViewerWrap").classList.remove("hidden");
    renderLogViewer();
    haptic(8);
  }
  function closeLogViewer(){
    $("logViewerWrap").classList.add("hidden");
  }
  $("btnOpenLogViewer").onclick = openLogViewer;
  $("btnOpenLogViewer2").onclick = openLogViewer;
  $("btnCloseLogViewer").onclick = closeLogViewer;
  $("logViewerBackdrop").onclick = closeLogViewer;

  function entriesToText(entries){
    const list = entries.map(e=> `${e.time} ${e.important ? "â˜… " : ""}${e.text}`);
    return list.join("\n") || "ï¼ˆè¨˜éŒ²ãªã—ï¼‰";
  }

  function filteredEntries(){
    const q = safeText($("lvSearch").value).toLowerCase();
    let entries = getEntries().slice();
    if(lvOnlyImportant){
      entries = entries.filter(e=>!!e.important);
    }
    if(q){
      entries = entries.filter(e=>{
        const t = (e.text||"").toLowerCase();
        const tm = (e.time||"").toLowerCase();
        return t.includes(q) || tm.includes(q);
      });
    }
    // order
    entries = lvOrderNewestFirst ? entries.slice().reverse() : entries;
    return entries;
  }

  function renderLogViewer(){
    const list = filteredEntries();
    $("lvCount").textContent = String(list.length);
    $("lvOrder").textContent = `è¡¨ç¤ºï¼š${lvOrderNewestFirst ? "æ–°â†’å¤" : "å¤â†’æ–°"}`;
    $("lvOnlyImp").textContent = `é‡è¦ã®ã¿ï¼š${lvOnlyImportant ? "ON" : "OFF"}`;
    $("lvMode").textContent = `è¡¨ç¤ºï¼š${lvMode === "card" ? "ã‚«ãƒ¼ãƒ‰" : "ãƒ†ã‚­ã‚¹ãƒˆ"}`;

    const body = $("lvBody");
    body.innerHTML = "";

    if(lvMode === "text"){
      const pre = document.createElement("pre");
      pre.className = "w-full whitespace-pre-wrap break-words text-sm font-black text-slate-900 bg-slate-50 border rounded-2xl p-3";
      pre.textContent = entriesToText(list);
      body.appendChild(pre);
      return;
    }

    if(list.length===0){
      const p = document.createElement("div");
      p.className="text-center text-sm font-black text-slate-400 py-10";
      p.textContent="ï¼ˆè©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰";
      body.appendChild(p);
      return;
    }

    list.forEach(e=>{
      const card = document.createElement("div");
      card.className = "bg-white border rounded-2xl p-3 shadow-sm mb-2";
      card.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="shrink-0">
            <div class="text-blue-600 font-black text-xs">${escapeHtml(e.time||"--:--")}</div>
            <div class="mt-1 text-[10px] font-black ${e.important ? "text-amber-600" : "text-slate-400"}">${e.important ? "â˜…é‡è¦" : ""}</div>
          </div>
          <div class="flex-1">
            <div class="text-sm font-black text-slate-900 whitespace-pre-wrap break-words">${escapeHtml(e.text||"")}</div>
          </div>
        </div>
      `;
      body.appendChild(card);
    });
  }

  function refreshLogViewerIfOpen(){
    if(!$("logViewerWrap").classList.contains("hidden")){
      renderLogViewer();
    }
  }

  $("lvOrder").onclick = ()=>{ lvOrderNewestFirst = !lvOrderNewestFirst; renderLogViewer(); };
  $("lvOnlyImp").onclick = ()=>{ lvOnlyImportant = !lvOnlyImportant; renderLogViewer(); };
  $("lvMode").onclick = ()=>{ lvMode = (lvMode==="card" ? "text" : "card"); renderLogViewer(); };
  $("lvSearch").addEventListener("input", ()=> renderLogViewer());
  $("lvCopy").onclick = ()=>{
    const list = filteredEntries();
    copyText(entriesToText(list));
  };
  $("lvShare").onclick = ()=>{
    const list = filteredEntries();
    shareText("æ•‘æ€¥å¯¾å¿œ è¨˜éŒ²ï¼ˆãƒ•ã‚£ãƒ«ã‚¿çµæœï¼‰", entriesToText(list));
  };

  // ===== init =====
  ensureIncident();
  const s = loadSettings();
  currentCasePresets = s.casePresets || [];
  currentCheckPresets = s.checkPresets || [];
  loadIncident();

  buildCaseChips(currentCasePresets);
  renderChecklist();
  updateQuickLinks();

  refreshRolesBadge();
  refreshTimeline();
  buildScript();
  updateStartStopUI();
  tickElapsed();
  refreshLiveBar();
  refreshInlineStatus();

  // Step default
  setStepActive(1);

  // Live refresh
  setInterval(()=>{ refreshLiveBar(); refreshInlineStatus(); }, 2500);

  // ===== extra buttons =====
  $("btnOpenLogViewer").onclick = openLogViewer;
  $("btnOpenLogViewer2").onclick = openLogViewer;

  // ===== quick sheet close wiring already set =====
</script>

</body>
</html>
