<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ•‘æ€¥è¦è«‹ã‚µãƒãƒ¼ãƒˆï¼ˆç¾å ´æœ€å¼· v14ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body{
      -webkit-tap-highlight-color: transparent;
      padding-bottom: 92px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .safe-area-bottom{ padding-bottom: env(safe-area-inset-bottom); }

    /* iOS dateå…¥åŠ›ãŒã‚°ãƒªãƒƒãƒ‰ã§é£›ã³å‡ºã™å¯¾ç­– + å…¨ä½“ã®ã¯ã¿å‡ºã—ä¿é™º */
    *, *::before, *::after { box-sizing: border-box; }
    input[type="date"] { max-width: 100%; min-width: 0; }

    input, select, textarea{ min-height: 48px; }
    select{
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1rem;
      padding-right: 2.5rem !important;
    }

    .quick-tag{
      transition: all 0.1s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      min-height: 44px;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      padding: 10px 10px;
      line-height: 1.2;
      user-select:none;
    }
    .quick-tag:active{ transform: scale(0.96); filter: brightness(0.92); }

    .collapse-content{ max-height: 0; overflow:hidden; transition: max-height .28s ease-out; }
    .collapse-content.open{ max-height: 1400px; transition: max-height .45s ease-in; }

    .recording-ring{ animation: ring-pulse 1.5s cubic-bezier(0.24, 0, 0.38, 1) infinite; }
    @keyframes ring-pulse{
      0% { transform: scale(1); opacity: 0.55; }
      100% { transform: scale(1.55); opacity: 0; }
    }

    /* æŠ¼ã—ãŸæ„Ÿï¼ˆå…¨ãƒœã‚¿ãƒ³/ãƒªãƒ³ã‚¯å…±é€šï¼‰ */
    button, a { -webkit-tap-highlight-color: transparent; }
    button:active, a:active { filter: brightness(0.92); }
    button:active { box-shadow: inset 0 0 0 9999px rgba(0,0,0,0.06); }

    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff !important; padding:0 !important; }
      .print-report{ display:block !important; padding:18px !important; color:#000; }
      .timeline-item{ border-bottom: 1px solid #ccc !important; break-inside: avoid; }
    }
    .print-report{ display:none; }
  </style>
</head>

<body class="bg-slate-100 text-slate-900">

  <!-- ===================== PRINT REPORT (hidden) ===================== -->
  <div class="print-report">
    <div class="border-b-2 border-black pb-2 mb-4 flex justify-between items-end">
      <div>
        <h1 class="text-2xl font-bold">æ•‘æ€¥æ¬é€ãƒ»çµŒéè¨˜éŒ²ç”¨ç´™</h1>
        <div class="text-xs text-gray-600 mt-1">ï¼ˆç¾å ´æœ€å¼· v14 / ç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«è¨˜éŒ²ï¼‰</div>
      </div>
      <p id="printTimestamp" class="text-sm"></p>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-4 border p-3 rounded-lg">
      <div>
        <p class="text-xs font-bold text-gray-500">å­¦æ ¡å / ä½æ‰€ / é›»è©±</p>
        <p id="printSchoolInfo" class="text-sm font-bold"></p>
      </div>
      <div>
        <p class="text-xs font-bold text-gray-500">ç™ºç”Ÿ / çµ‚äº† / çµŒé</p>
        <p id="printIncidentInfo" class="text-sm font-bold"></p>
      </div>

      <div class="col-span-2 border-t pt-2">
        <p class="text-xs font-bold text-gray-500">å‚·ç—…è€…ï¼ˆæ°å / å­¦å¹´ / æ€§åˆ¥ / å¹´é½¢ï¼‰</p>
        <p id="printPatientInfo" class="text-sm font-bold"></p>
      </div>

      <div class="col-span-2 border-t pt-2">
        <p class="text-xs font-bold text-gray-500">ç¾åœ¨ã®ä¸»ãªç—‡çŠ¶ãƒ»æ—¢å¾€æ­´ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</p>
        <p id="printMedicalInfo" class="text-sm"></p>
      </div>

      <div class="col-span-2 border-t pt-2">
        <p class="text-xs font-bold text-gray-500">åˆå‹•ãƒã‚§ãƒƒã‚¯çŠ¶æ³</p>
        <div id="printChecklist" class="text-sm"></div>
      </div>
    </div>

    <h2 class="text-lg font-bold border-l-4 border-black pl-2 mb-2">æ™‚ç³»åˆ—è¨˜éŒ²</h2>
    <div id="printTimeline" class="border-t border-black"></div>

    <div class="mt-6 text-[10px] text-gray-400 text-right">
      Generated by æ•‘æ€¥è¦è«‹ã‚µãƒãƒ¼ãƒˆï¼ˆç¾å ´æœ€å¼· v14ï¼‰
    </div>
  </div>

  <!-- ===================== HEADER ===================== -->
  <header class="sticky top-0 z-30 bg-white shadow-sm border-b no-print">
    <div class="px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex flex-col">
        <h1 class="text-base font-black leading-tight text-red-600">æ•‘æ€¥è¦è«‹ã‚µãƒãƒ¼ãƒˆ</h1>
        <div class="text-[10px] text-slate-400 font-bold">ç¾å ´æœ€å¼· v14ï¼ˆæŠ¼ä¸‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‹çµŒéæ å›ºå®šï¼‹iOS dateä¿®æ­£ï¼‰</div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnOpenSettings" class="px-3 py-2 rounded-full border text-xs font-black text-slate-700 active:bg-slate-50">
          è¨­å®š
        </button>
        <a href="tel:119" class="bg-red-600 text-white px-4 py-2 rounded-full text-sm font-black flex items-center gap-2 animate-pulse">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
          119
        </a>
      </div>
    </div>
  </header>

  <!-- ===================== MAIN ===================== -->
  <main class="p-3 space-y-4 no-print">

    <!-- ===================== SECTION 1 ===================== -->
    <div id="section1" class="space-y-4">

      <div class="bg-white border rounded-2xl p-3 shadow-sm">
        <div class="flex items-start gap-3">
          <div class="shrink-0 mt-0.5 w-9 h-9 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-black">!</div>
          <div class="flex-1">
            <div class="font-black text-sm">ã“ã®ã‚¢ãƒ—ãƒªã¯ã€Œç«¯æœ«å†…ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ã€ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™</div>
            <div class="text-[11px] text-slate-600 font-bold mt-0.5">
              é€šä¿¡ã—ã¾ã›ã‚“ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰é€ä¿¡ãªã—ï¼‰ã€‚å¿…è¦ãªã‚‰ <span class="text-slate-900">å…±æœ‰ãƒœã‚¿ãƒ³</span> ã§æ–‡ç« ã¨ã—ã¦é€ã‚Œã¾ã™ã€‚
            </div>
          </div>
        </div>
      </div>

      <!-- ç™ºç”Ÿå ´æ‰€ -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
        <div class="flex justify-between items-center border-b pb-2 mb-2">
          <h2 class="font-black text-sm border-l-4 border-slate-800 pl-2 text-slate-800">1. ç™ºç”Ÿå ´æ‰€</h2>
          <button onclick="toggleCollapse('schoolPanel')" class="text-xs text-blue-600 font-black">å­¦æ ¡æƒ…å ±</button>
        </div>

        <div id="schoolPanel" class="hidden space-y-3 bg-slate-50 p-3 rounded-xl border border-dashed border-slate-200">
          <div><label class="text-[11px] font-black text-slate-500">å­¦æ ¡å</label><input id="schoolName" class="w-full p-3 border rounded-xl text-sm font-black bg-white" placeholder="ã€‡ã€‡å¸‚ç«‹ã€‡ã€‡å°å­¦æ ¡" /></div>
          <div><label class="text-[11px] font-black text-slate-500">ä½æ‰€</label><input id="schoolAddr" class="w-full p-3 border rounded-xl text-sm font-black bg-white" placeholder="å¸‚åŒºç”ºæ‘ã‹ã‚‰ã®ä½æ‰€" /></div>
          <div><label class="text-[11px] font-black text-slate-500">é›»è©±ç•ªå·</label><input id="schoolPhone" class="w-full p-3 border rounded-xl text-sm font-black bg-white" placeholder="03-xxxx-xxxx" inputmode="tel" /></div>

          <!-- ã‚ˆãèµ·ãã‚‹ã‚±ãƒ¼ã‚¹ï¼ˆæœ€å¤§10ï¼‰ -->
          <div class="bg-white border rounded-2xl p-3 space-y-2">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">ã‚ˆãèµ·ãã‚‹ã‚±ãƒ¼ã‚¹ï¼ˆæœ€å¤§10ï¼‰</div>
              <div class="text-[10px] font-black text-slate-500">å­¦æ ¡ã”ã¨ã«è¨­å®š</div>
            </div>
            <div class="grid grid-cols-1 gap-2">
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button id="btnRestoreDefaultCases" class="py-3 rounded-2xl bg-white border text-xs font-black">åˆæœŸã‚»ãƒƒãƒˆã«æˆ»ã™</button>
              <button id="btnClearCases" class="py-3 rounded-2xl bg-white border text-xs font-black">ç©ºã«ã™ã‚‹</button>
            </div>
          </div>

          <!-- åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§10ï¼‰ -->
          <div class="bg-white border rounded-2xl p-3 space-y-2">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§10ï¼‰</div>
              <div class="text-[10px] font-black text-slate-500">ãƒã‚§ãƒƒã‚¯ã§è‡ªå‹•è¨˜éŒ²</div>
            </div>
            <div class="grid grid-cols-1 gap-2">
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button id="btnRestoreDefaultChecks" class="py-3 rounded-2xl bg-white border text-xs font-black">åˆæœŸã‚»ãƒƒãƒˆã«æˆ»ã™</button>
              <button id="btnClearChecks" class="py-3 rounded-2xl bg-white border text-xs font-black">ç©ºã«ã™ã‚‹</button>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <button id="btnSaveSettings" class="py-4 bg-slate-900 text-white text-sm rounded-2xl font-black active:scale-[0.99]">ã“ã®ã‚¹ãƒãƒ›ã«ä¿å­˜</button>
            <button id="btnExportSettings" class="py-4 bg-white border text-sm rounded-2xl font-black active:bg-slate-50">è¨­å®šã‚’å…±æœ‰</button>
          </div>

          <div class="text-[11px] text-slate-500 font-bold">
            â€»ã€Œè¨­å®šã‚’å…±æœ‰ã€ã¯ã€ä»–æ ¡ã¸é…å¸ƒã™ã‚‹æ™‚ã«ä¾¿åˆ©ï¼ˆæ–‡ç« ã¨ã—ã¦é€ã‚Œã¾ã™ï¼‰
          </div>
        </div>

        <div>
          <label class="text-[11px] font-black text-slate-500">æ ¡å†…ã®è©³ã—ã„å ´æ‰€</label>
          <input id="place" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼š3Få›³å·¥å®¤ã€ä½“è‚²é¤¨åŒ—å´ãªã©" />
        </div>
      </div>

      <!-- å‚·ç—…è€… -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-4">
        <h2 class="font-black text-sm border-l-4 border-red-500 pl-2 text-slate-800">2. å‚·ç—…è€…ã®è©³ç´°</h2>

        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <div class="text-[11px] font-black text-slate-500">ã‚ˆãèµ·ãã‚‹ã‚±ãƒ¼ã‚¹ï¼ˆã‚¿ãƒƒãƒ—ã§ç—‡çŠ¶ã¸åæ˜ ï¼‹è¨˜éŒ²ï¼‰</div>
            <button id="btnCasesHint" class="text-xs font-black text-blue-600">è¨­å®š</button>
          </div>
          <div id="caseButtons" class="grid grid-cols-2 gap-2"></div>
        </div>

        <div class="space-y-3">
          <div>
            <label class="text-[11px] font-black text-slate-500">æ°åï¼ˆãµã‚ŠãŒãªï¼‰</label>
            <input id="pName" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black placeholder:font-bold placeholder:text-slate-400" placeholder="å±±ç”° å¤ªéƒï¼ˆã‚„ã¾ã  ãŸã‚ã†ï¼‰" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-[11px] font-black text-slate-500">å­¦å¹´ãƒ»åŒºåˆ†</label>
              <select id="pGrade" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black">
                <option value="">é¸æŠ</option>
                <option value="1">1å¹´</option><option value="2">2å¹´</option><option value="3">3å¹´</option>
                <option value="4">4å¹´</option><option value="5">5å¹´</option><option value="6">6å¹´</option>
                <option value="è·å“¡">æ•™è·å“¡</option><option value="ä»–">ãã®ä»–</option>
              </select>
            </div>
            <div>
              <label class="text-[11px] font-black text-slate-500">æ€§åˆ¥</label>
              <select id="pSex" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black">
                <option value="">é¸æŠ</option>
                <option value="ç”·æ€§">ç”·æ€§</option>
                <option value="å¥³æ€§">å¥³æ€§</option>
                <option value="ä¸æ˜">ä¸æ˜</option>
              </select>
            </div>
          </div>

          <!-- ç”Ÿå¹´æœˆæ—¥ï¼ˆã‚¹ãƒãƒ›ã§é£›ã³å‡ºã™å¯¾ç­–æ¸ˆã¿ï¼‰ -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-3 bg-blue-50 rounded-xl border border-blue-100">
            <div class="min-w-0">
              <label class="text-[11px] font-black text-blue-700">ç”Ÿå¹´æœˆæ—¥</label>
              <input id="pBirth" type="date" class="w-full min-w-0 h-[48px] px-3 border rounded-xl text-sm font-black bg-white" />
            </div>
            <div class="flex items-end min-w-0">
              <div id="ageDisplay" class="text-sm font-black text-blue-800 bg-white border border-blue-200 w-full px-3 rounded-xl text-center h-[48px] flex items-center justify-center shadow-sm">
                å¹´é½¢ï¼š-- æ­³
              </div>
            </div>
          </div>
        </div>

        <div>
          <label class="text-[11px] font-black text-slate-500">ç¾åœ¨ã®ç—‡çŠ¶</label>
          <textarea id="symptom" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" rows="2"
            placeholder="ä¾‹ï¼šã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼åå¿œã€å‘¼å¸å›°é›£ã€æ„è­˜æ··æ¿"></textarea>
        </div>

        <button onclick="toggleCollapse('detailMedical')" class="w-full py-3 bg-slate-100 rounded-xl text-[11px] font-black text-slate-600 flex justify-center items-center gap-1">
          æ—¢å¾€æ­´ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç­‰
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
        </button>

        <div id="detailMedical" class="hidden space-y-3 pt-1">
          <div><label class="text-[11px] font-black text-slate-500">æ—¢å¾€æ­´ï¼ˆæŒç—…ï¼‰</label><input id="pHistory" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="å–˜æ¯ã€ã¦ã‚“ã‹ã‚“ç­‰" /></div>
          <div><label class="text-[11px] font-black text-slate-500">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label><input id="pAllergy" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="ãƒ”ãƒ¼ãƒŠãƒƒãƒ„ã€åµç­‰" /></div>
        </div>
      </div>

      <!-- é€šå ±ç”¨åŸç¨¿ -->
      <div class="bg-slate-900 rounded-2xl p-4 shadow-xl">
        <div class="flex justify-between items-center mb-2 border-b border-white/10 pb-2">
          <span class="text-[10px] uppercase tracking-widest text-slate-400 font-black">119é€šå ±ç”¨åŸç¨¿</span>
          <div class="flex items-center gap-2">
            <button id="btnCopyScript" class="text-xs bg-white text-slate-900 px-3 py-2 rounded-full font-black active:bg-slate-200">ã‚³ãƒ”ãƒ¼</button>
            <button id="btnShareScript" class="text-xs bg-white/10 text-white px-3 py-2 rounded-full font-black active:bg-white/20">å…±æœ‰</button>
          </div>
        </div>
        <div id="scriptDisplay" class="text-white text-sm font-bold leading-relaxed min-h-[120px] whitespace-pre-wrap"></div>
      </div>
    </div>

    <!-- ===================== SECTION 2 ===================== -->
    <div id="section2" class="hidden space-y-4 pb-24">

      <!-- incident barï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å›ºå®šï¼‰ -->
      <div class="bg-white/95 backdrop-blur border rounded-2xl p-4 shadow-sm space-y-3 sticky top-[64px] z-20">
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="font-black text-sm">çµŒéãƒ»å‡¦ç½®ã®è¨˜éŒ²</div>
            <div class="text-[10px] font-black text-slate-500">ç™ºç”Ÿã€œå¼•ç¶™ãã¾ã§ã€Œå…¨éƒ¨ã“ã“ã«ã€æ®‹ã™</div>
          </div>

          <div class="flex items-center gap-2">
            <button id="btnOpenLogViewer" class="px-3 py-2 rounded-full border text-xs font-black active:bg-slate-50">ğŸ‘€ å…¨ä»¶</button>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-2">
          <button id="btnStartIncident" class="py-4 rounded-2xl bg-red-600 text-white font-black text-sm active:scale-[0.99]">ç™ºç”Ÿï¼ˆé–‹å§‹ï¼‰ã‚’è¨˜éŒ²</button>
          <button id="btnStopIncident" class="py-4 rounded-2xl bg-white border font-black text-sm text-slate-900 active:bg-slate-50">çµ‚äº†ã‚’è¨˜éŒ²</button>
          <button id="btnResetAll" class="py-4 rounded-2xl bg-white border font-black text-sm text-slate-900 active:bg-slate-50">å…¨æ¶ˆå»</button>
        </div>

        <div class="grid grid-cols-3 gap-2">
          <div class="bg-slate-50 border rounded-2xl p-3">
            <div class="text-[10px] font-black text-slate-500">é–‹å§‹</div>
            <div id="incidentStartLabel" class="text-sm font-black text-slate-900">--:--</div>
          </div>
          <div class="bg-slate-50 border rounded-2xl p-3">
            <div class="text-[10px] font-black text-slate-500">çµŒé</div>
            <div id="incidentElapsedLabel" class="text-sm font-black text-slate-900">--</div>
          </div>
          <div class="bg-slate-50 border rounded-2xl p-3">
            <div class="text-[10px] font-black text-slate-500">æœ€æ–°è¨˜éŒ²</div>
            <div id="lastEntryLabel" class="text-sm font-black text-slate-900">--:--</div>
          </div>
        </div>
      </div>

      <!-- checklist -->
      <section class="bg-white border rounded-2xl p-4 shadow-sm space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="font-black text-sm border-l-4 border-emerald-600 pl-2">
            åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆãƒã‚§ãƒƒã‚¯ã§è‡ªå‹•è¨˜éŒ²ï¼‰
          </h2>
          <button id="btnChecklistSettingsHint" class="text-xs font-black text-blue-600">è¨­å®š</button>
        </div>

        <div id="checklist" class="space-y-2"></div>

        <div class="grid grid-cols-2 gap-2">
          <button id="btnChecklistReset" class="py-4 rounded-2xl bg-white border font-black text-sm">ãƒã‚§ãƒƒã‚¯è§£é™¤</button>
          <button id="btnCopyChecklist" class="py-4 rounded-2xl bg-slate-900 text-white font-black text-sm">ãƒã‚§ãƒƒã‚¯çŠ¶æ³ã‚³ãƒ”ãƒ¼</button>
        </div>
      </section>

      <!-- voice / memo -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="font-black text-sm">ãƒ¡ãƒ¢ï¼ˆéŸ³å£°å…¥åŠ›OKï¼‰</div>
            <div class="text-[10px] font-black text-slate-500">çŸ­ããƒ»ç¢ºå®Ÿã«æ®‹ã™ï¼ˆå¾Œã§å…¨ä»¶ãƒ“ãƒ¥ãƒ¼ã§æ•´ã†ï¼‰</div>
          </div>

          <button id="btnToggleImportant" class="px-3 py-2 rounded-full border text-xs font-black active:bg-slate-50">
            é‡è¦ï¼šOFF
          </button>
        </div>

        <div class="flex flex-col items-center py-1">
          <div class="relative">
            <div id="pulseRing" class="absolute inset-0 rounded-full bg-red-400 hidden recording-ring"></div>
            <button id="btnVoiceRec" class="relative z-10 w-20 h-20 rounded-full bg-blue-600 text-white shadow-lg flex items-center justify-center flex-col gap-0.5 active:scale-95 transition-transform">
              <svg id="micIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-18a3 3 0 013 3v8a3 3 0 01-3 3 3 3 0 01-3-3V5a3 3 0 013-3z"></path></svg>
              <span id="micText" class="text-[9px] font-black tracking-tighter uppercase">REC START</span>
            </button>
          </div>
          <div id="interimText" class="mt-2 text-xs text-blue-600 font-black h-4 italic"></div>
        </div>

        <div class="space-y-2">
          <textarea id="voiceInputArea" class="w-full p-4 bg-slate-50 border rounded-2xl text-base font-black focus:ring-2 focus:ring-blue-500 outline-none" rows="2" placeholder="è©³ç´°ãªãƒ¡ãƒ¢ã¯ã“ã¡ã‚‰..."></textarea>
          <button id="btnAddTimeline" class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg active:scale-[0.98]">è‡ªç”±å…¥åŠ›ã‚’è¨˜éŒ²</button>
        </div>
      </div>

      <!-- quick tags accordions -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
        <div class="text-center">
          <div class="font-black text-sm text-slate-900">ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›</div>
          <div class="text-[10px] text-slate-400 font-black uppercase tracking-tight">Tap to Log</div>
        </div>

        <div class="space-y-3">
          <!-- status -->
          <div class="border rounded-xl overflow-hidden">
            <button onclick="toggleAccordion('acc-status')" class="w-full px-4 py-3 bg-blue-50 flex justify-between items-center text-blue-800 font-black text-sm">
              <span>STATUS / æ„è­˜ãƒ»å‘¼å¸</span>
              <svg id="icon-acc-status" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="acc-status" class="collapse-content bg-white">
              <div class="grid grid-cols-2 gap-2 p-3">
                <button class="quick-tag bg-blue-100 text-blue-800 rounded-lg text-xs font-black" data-val="æ„è­˜ã‚ã‚Šï¼ˆæ˜ç­ï¼‰">æ„è­˜ã‚ã‚Š</button>
                <button class="quick-tag bg-blue-100 text-blue-800 rounded-lg text-xs font-black" data-val="æ„è­˜æ··æ¿ï¼ˆå‘¼ã³ã‹ã‘ã«åå¿œè–„ã„ï¼‰">æ„è­˜æ··æ¿</button>
                <button class="quick-tag bg-red-100 text-red-800 rounded-lg text-xs font-black" data-val="æ„è­˜æ¶ˆå¤±ãƒ»ç„¡åå¿œ">æ„è­˜æ¶ˆå¤±</button>
                <button class="quick-tag bg-slate-100 text-slate-800 rounded-lg text-xs font-black" data-val="å‘¼å¸æ­£å¸¸">å‘¼å¸æ­£å¸¸</button>
                <button class="quick-tag bg-orange-100 text-orange-800 rounded-lg text-xs font-black" data-val="å‘¼å¸å›°é›£ï¼ˆã‚¼ãƒ¼ã‚¼ãƒ¼ã™ã‚‹ï¼‰">å‘¼å¸å›°é›£</button>
                <button class="quick-tag bg-red-600 text-white rounded-lg text-xs font-black" data-val="å‘¼å¸åœæ­¢ãƒ»æ­»æˆ¦æœŸå‘¼å¸ï¼ˆã‚ãˆãå‘¼å¸ï¼‰">å‘¼å¸åœæ­¢</button>
              </div>
            </div>
          </div>

          <!-- symptoms -->
          <div class="border rounded-xl overflow-hidden">
            <button onclick="toggleAccordion('acc-symptoms')" class="w-full px-4 py-3 bg-slate-100 flex justify-between items-center text-slate-800 font-black text-sm">
              <span>SYMPTOMS / å…¨èº«ç—‡çŠ¶</span>
              <svg id="icon-acc-symptoms" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="acc-symptoms" class="collapse-content bg-white">
              <div class="grid grid-cols-2 gap-2 p-3">
                <button class="quick-tag bg-slate-50 border text-slate-800 rounded-lg text-xs font-black" data-val="é¡”é¢è’¼ç™½ï¼ˆè¡€ã®æ°—ãŒå¼•ã„ãŸï¼‰">é¡”é¢è’¼ç™½</button>
                <button class="quick-tag bg-slate-50 border text-slate-800 rounded-lg text-xs font-black" data-val="é¡”é¢ç´…æ½®ï¼ˆèµ¤ã‚‰é¡”ï¼‰">é¡”é¢ç´…æ½®</button>
                <button class="quick-tag bg-slate-50 border text-slate-800 rounded-lg text-xs font-black" data-val="å†·ã‚„æ±—ãŒã²ã©ã„">å†·ã‚„æ±—</button>
                <button class="quick-tag bg-slate-50 border text-slate-800 rounded-lg text-xs font-black" data-val="å˜”åï¼ˆãŠã†ã¨ï¼‰ã‚ã‚Š">å˜”åã‚ã‚Š</button>
                <button class="quick-tag bg-slate-50 border text-slate-800 rounded-lg text-xs font-black" data-val="ç—™æ”£ï¼ˆã‘ã„ã‚Œã‚“ï¼‰é–‹å§‹">ç—™æ”£é–‹å§‹</button>
                <button class="quick-tag bg-slate-50 border text-slate-800 rounded-lg text-xs font-black" data-val="ç—™æ”£ï¼ˆã‘ã„ã‚Œã‚“ï¼‰æ¶ˆå¤±">ç—™æ”£æ¶ˆå¤±</button>
                <button class="quick-tag bg-slate-50 border text-slate-800 rounded-lg text-xs font-black" data-val="å…¨èº«ã«ã˜ã‚“ã¾ã—ã‚“å‡ºç¾">ã˜ã‚“ã¾ã—ã‚“</button>
                <button class="quick-tag bg-slate-50 border text-slate-800 rounded-lg text-xs font-black" data-val="æ¿€ã—ã„è…¹ç—›">æ¿€ã—ã„è…¹ç—›</button>
                <button class="quick-tag bg-slate-50 border text-slate-800 rounded-lg text-xs font-black" data-val="å¤±ç¦ã‚ã‚Š">å¤±ç¦ã‚ã‚Š</button>
                <button class="quick-tag bg-slate-50 border text-slate-800 rounded-lg text-xs font-black" data-val="é¼»å‡ºè¡€ï¼ˆé¼»è¡€ï¼‰">é¼»å‡ºè¡€</button>
              </div>
            </div>
          </div>

          <!-- treatment -->
          <div class="border rounded-xl overflow-hidden">
            <button onclick="toggleAccordion('acc-treatment')" class="w-full px-4 py-3 bg-green-50 flex justify-between items-center text-green-800 font-black text-sm">
              <span>TREATMENT / å‡¦ç½®å†…å®¹</span>
              <svg id="icon-acc-treatment" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="acc-treatment" class="collapse-content bg-white">
              <div class="grid grid-cols-2 gap-2 p-3">
                <button class="quick-tag bg-green-100 text-green-800 rounded-lg text-xs font-black" data-val="ã‚¨ãƒ”ãƒšãƒ³ï¼ˆè‡ªå·±æ³¨å°„è–¬ï¼‰ä½¿ç”¨">ã‚¨ãƒ”ãƒšãƒ³ä½¿ç”¨</button>
                <button class="quick-tag bg-green-100 text-green-800 rounded-lg text-xs font-black" data-val="å›å¾©ä½“ä½ï¼ˆæ¨ªå‘ãï¼‰ã«å›ºå®š">å›å¾©ä½“ä½</button>
                <button class="quick-tag bg-green-100 text-green-800 rounded-lg text-xs font-black" data-val="è¡£æœã‚’ç·©ã‚ã‚‹ï¼ˆè¥Ÿå…ƒç­‰ï¼‰">è¡£æœã‚’ç·©ã‚ã‚‹</button>
                <button class="quick-tag bg-green-100 text-green-800 rounded-lg text-xs font-black" data-val="æ¯›å¸ƒã§ä¿æ¸©é–‹å§‹">æ¯›å¸ƒã§ä¿æ¸©</button>
                <button class="quick-tag bg-green-100 text-green-800 rounded-lg text-xs font-black" data-val="ä¿å†·å‰¤ã§æ‚£éƒ¨ã‚’å†·å´ä¸­">å†·å´é–‹å§‹</button>
                <button class="quick-tag bg-green-100 text-green-800 rounded-lg text-xs font-black" data-val="å‚·å£ã‚’æµæ°´ã§æ´—æµ„">å‚·å£æ´—æµ„</button>
                <button class="quick-tag bg-green-100 text-green-800 rounded-lg text-xs font-black" data-val="åœ§è¿«ã«ã‚ˆã‚‹æ­¢è¡€å‡¦ç½®">åœ§è¿«æ­¢è¡€</button>
                <button class="quick-tag bg-green-100 text-green-800 rounded-lg text-xs font-black" data-val="é…¸ç´ æŠ•ä¸é–‹å§‹">é…¸ç´ æŠ•ä¸</button>
                <button class="quick-tag bg-red-100 text-red-800 rounded-lg text-xs font-black border-2 border-red-300" data-val="èƒ¸éª¨åœ§è¿«ï¼ˆå¿ƒè‡“ãƒãƒƒã‚µãƒ¼ã‚¸ï¼‰é–‹å§‹">èƒ¸éª¨åœ§è¿«é–‹å§‹</button>
                <button class="quick-tag bg-red-100 text-red-800 rounded-lg text-xs font-black border-2 border-red-300" data-val="AEDè£…ç€ãƒ»è§£æé–‹å§‹">AEDè§£æ</button>
                <button class="quick-tag bg-red-100 text-red-800 rounded-lg text-xs font-black border-2 border-red-300" data-val="AEDã«ã‚ˆã‚‹é›»æ°—ã‚·ãƒ§ãƒƒã‚¯å®Ÿæ–½">é›»æ°—ã‚·ãƒ§ãƒƒã‚¯</button>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-2">
            <button class="quick-tag bg-slate-900 text-white rounded-2xl text-xs font-black" data-val="æ•‘æ€¥è»ŠãŒåˆ°ç€ãƒ»å¼•ãç¶™ãé–‹å§‹">æ•‘æ€¥è»Š åˆ°ç€</button>
          </div>
        </div>
      </div>

      <!-- timeline -->
      <div class="space-y-3 px-1">
        <div class="flex items-center justify-between">
          <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center py-2 italic border-b border-slate-200 flex-1">Activity Log</h3>
        </div>

        <div id="timeline" class="space-y-3">
          <p id="timelineEmpty" class="text-center text-slate-400 py-10 text-sm font-black">ï¼ˆè¨˜éŒ²ãªã—ï¼‰</p>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-6">
          <button id="btnCopyTimeline" class="py-4 text-slate-700 text-sm font-black border-2 border-dashed border-slate-300 rounded-2xl active:bg-slate-50">è¨˜éŒ²ã‚’ã‚³ãƒ”ãƒ¼</button>
          <button id="btnPrint" class="py-4 bg-blue-600 text-white text-sm font-black rounded-2xl shadow-lg flex items-center justify-center gap-2 active:scale-95">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
            ç”¨ç´™ã¨ã—ã¦å°åˆ·
          </button>
        </div>
      </div>

    </div>
  </main>

  <!-- ===================== BOTTOM NAV ===================== -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex items-center justify-around px-2 py-2 no-print shadow-[0_-4px_15px_rgba(0,0,0,0.1)] z-40 safe-area-bottom">
    <button id="nav1" class="flex flex-col items-center gap-1 flex-1 py-1 text-blue-600">
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
      <span class="text-[10px] font-black">1. é€šå ±åŸç¨¿</span>
    </button>

    <button id="nav2" class="flex flex-col items-center gap-1 flex-1 py-1 text-slate-400">
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path></svg>
      <span class="text-[10px] font-black">2. çµŒéè¨˜éŒ²</span>
    </button>
  </nav>

  <!-- ===================== LOG VIEWER (å…¨ä»¶ãƒ“ãƒ¥ãƒ¼) ===================== -->
  <div id="logViewerWrap" class="fixed inset-0 z-[90] hidden">
    <div id="logViewerBackdrop" class="absolute inset-0 bg-black/50"></div>

    <div class="absolute inset-0 bg-white flex flex-col">
      <div class="sticky top-0 bg-white border-b p-3 flex items-center gap-2">
        <div class="font-black">ğŸ‘€ è¨˜éŒ² å…¨ä»¶ãƒ“ãƒ¥ãƒ¼</div>
        <button id="btnCloseLogViewer" class="ml-auto px-3 py-2 rounded-full border text-xs font-black active:bg-slate-50">é–‰ã˜ã‚‹</button>
      </div>

      <div class="p-3 space-y-2 border-b bg-slate-50">
        <input id="lvSearch" class="w-full p-3 bg-white border rounded-2xl text-sm font-black" placeholder="æ¤œç´¢ï¼ˆä¾‹ï¼šAED / ã‘ã„ã‚Œã‚“ / 12:34ï¼‰">
        <div class="grid grid-cols-3 gap-2">
          <button id="lvOrder" class="py-3 rounded-2xl bg-white border text-xs font-black active:bg-slate-50">è¡¨ç¤ºï¼šæ–°â†’å¤</button>
          <button id="lvOnlyImp" class="py-3 rounded-2xl bg-white border text-xs font-black active:bg-slate-50">é‡è¦ã®ã¿ï¼šOFF</button>
          <button id="lvMode" class="py-3 rounded-2xl bg-slate-900 text-white text-xs font-black active:opacity-90">è¡¨ç¤ºï¼šã‚«ãƒ¼ãƒ‰</button>
        </div>
        <div class="text-[10px] font-bold text-slate-500">ä»¶æ•°ï¼š<span id="lvCount" class="font-black">0</span></div>
      </div>

      <div class="flex-1 overflow-y-auto p-3" id="lvBody"></div>

      <div class="border-t p-3 bg-white grid grid-cols-2 gap-2">
        <button id="lvCopy" class="py-4 rounded-2xl bg-white border font-black text-sm active:bg-slate-50">ã‚³ãƒ”ãƒ¼</button>
        <button id="lvShare" class="py-4 rounded-2xl bg-slate-900 text-white font-black text-sm active:opacity-90">å…±æœ‰</button>
      </div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const SETTINGS_KEY = "school_emergency_settings_v13";
const INCIDENT_KEY  = "school_emergency_incident_v13";

function nowTimeStr(d=new Date()){
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}
function fmtDateTime(ts){
  if(!ts) return "--";
  const d = new Date(ts);
  return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")} ${nowTimeStr(d)}`;
}
function msToElapsed(ms){
  if(ms==null || isNaN(ms)) return "--";
  const sec = Math.max(0, Math.floor(ms/1000));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  if(h>0) return `${h}æ™‚é–“${String(m).padStart(2,"0")}åˆ†`;
  if(m>0) return `${m}åˆ†${String(s).padStart(2,"0")}ç§’`;
  return `${s}ç§’`;
}

function copyText(text){
  return navigator.clipboard.writeText(text).then(()=>alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")).catch(()=>{
    const ta=document.createElement("textarea");
    ta.value=text; document.body.appendChild(ta); ta.select();
    document.execCommand("copy"); document.body.removeChild(ta);
    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  });
}
async function shareText(title, text){
  try{
    if(navigator.share){
      await navigator.share({ title, text });
      return;
    }
  }catch(e){}
  return copyText(text);
}

/* åˆæœŸã‚»ãƒƒãƒˆï¼ˆã‚±ãƒ¼ã‚¹10ï¼‰ */
const DEFAULT_CASES = [
  "é ­éƒ¨æ‰“æ’²ï¼ˆè»¢å€’ãƒ»è¡çªï¼‰",
  "åˆ‡ã‚Šå‚·ãƒ»å‡ºè¡€ï¼ˆå·¥ä½œ/ä½“è‚²ï¼‰",
  "éª¨æŠ˜ç–‘ã„ï¼ˆè»¢å€’ãƒ»è½ä¸‹ï¼‰",
  "ç†±ä¸­ç—‡ç–‘ã„ï¼ˆå±‹å¤–æ´»å‹•ï¼‰",
  "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼åå¿œï¼ˆã˜ã‚“ã¾ã—ã‚“ç­‰ï¼‰",
  "å–˜æ¯ç™ºä½œï¼ˆå‘¼å¸è‹¦ï¼‰",
  "ã‘ã„ã‚Œã‚“ï¼ˆã²ãã¤ã‘ï¼‰",
  "èª¤é£²ãƒ»çª’æ¯ç–‘ã„",
  "è…¹ç—›ãƒ»å˜”åï¼ˆä½“èª¿æ€¥å¤‰ï¼‰",
  "æ„è­˜æ¶ˆå¤±ï¼ˆå€’ã‚ŒãŸï¼‰"
];

/* åˆæœŸã‚»ãƒƒãƒˆï¼ˆåˆå‹•ãƒã‚§ãƒƒã‚¯10ï¼‰ */
const DEFAULT_CHECKS = [
  "å‘¨å›²å®‰å…¨ç¢ºä¿ï¼ˆå±é™ºé™¤å»ãƒ»å…ç«¥ã‚’é›¢ã™ï¼‰",
  "ç®¡ç†è·ã¸é€£çµ¡ï¼ˆçŠ¶æ³å…±æœ‰ï¼‰",
  "119é€šå ±ï¼ˆå¿…è¦æ™‚ï¼‰",
  "AEDæ‰‹é…ï¼ˆå ´æ‰€ç¢ºèªâ†’æ¬é€ï¼‰",
  "èƒ¸éª¨åœ§è¿« / AEDè§£æï¼ˆå¿…è¦æ™‚ï¼‰",
  "æ­£é–€èª˜å°æ‰‹é…ï¼ˆèª˜å°ä½ç½®ã¸ï¼‰",
  "ä¿å¥å®¤æº–å‚™ï¼ˆæ¯›å¸ƒãƒ»æ°·ãƒ»æ‹…æ¶ç­‰ï¼‰",
  "ä¿è­·è€…ã¸é€£çµ¡ï¼ˆçŠ¶æ³å…±æœ‰ï¼‰",
  "å…ç«¥èª˜å°ï¼ˆåˆ¥å®¤ãƒ»å°ç·šç¢ºä¿ï¼‰",
  "æ•‘æ€¥éšŠã¸å¼•ç¶™ãï¼ˆè¨˜éŒ²æ¸¡ã—ï¼‰"
];

let settings = {
  schoolName:"", schoolAddr:"", schoolPhone:"",
  casePresets:[...DEFAULT_CASES],
  checkPresets:[...DEFAULT_CHECKS]
};

let incident = {
  active:false,
  startTs:null,
  endTs:null,
  importantNext:false,
  entries:[],
  checklist:{},
  form:{
    place:"", pName:"", pGrade:"", pSex:"", pBirth:"",
    symptom:"", pHistory:"", pAllergy:""
  },
  computedAgeStr:"--"
};

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function toggleCollapse(id){ $(id).classList.toggle("hidden"); }
function toggleAccordion(id){
  const el = $(id);
  const icon = $("icon-" + id);
  el.classList.toggle("open");
  icon.classList.toggle("rotate-180");
}

/* ã‚¿ãƒ– */
function switchTab(tabNum){
  if(tabNum===1){
    $("section1").classList.remove("hidden");
    $("section2").classList.add("hidden");
    $("nav1").classList.replace("text-slate-400", "text-blue-600");
    $("nav2").classList.replace("text-blue-600", "text-slate-400");
  }else{
    $("section1").classList.add("hidden");
    $("section2").classList.remove("hidden");
    $("nav2").classList.replace("text-slate-400", "text-blue-600");
    $("nav1").classList.replace("text-blue-600", "text-slate-400");
    updateIncidentBar();
  }
}
$("nav1").onclick = () => switchTab(1);
$("nav2").onclick = () => switchTab(2);

/* è¨­å®š */
function setPresetInputs(){
  document.querySelectorAll(".casePreset").forEach(inp=>{
    const idx = parseInt(inp.dataset.idx,10);
    inp.value = settings.casePresets[idx] ?? "";
  });
  document.querySelectorAll(".checkPreset").forEach(inp=>{
    const idx = parseInt(inp.dataset.idx,10);
    inp.value = settings.checkPresets[idx] ?? "";
  });
}
function getCasePresetsFromUI(){
  const arr=[];
  document.querySelectorAll(".casePreset").forEach(inp=>{
    const v=(inp.value||"").trim();
    if(v) arr.push(v);
  });
  return arr.slice(0,10);
}
function getCheckPresetsFromUI(){
  const arr=[];
  document.querySelectorAll(".checkPreset").forEach(inp=>{
    const v=(inp.value||"").trim();
    if(v) arr.push(v);
  });
  return arr.slice(0,10);
}

function loadSettings(){
  const saved = localStorage.getItem(SETTINGS_KEY);
  if(saved){
    try{
      const s=JSON.parse(saved);
      settings = {
        schoolName: s.schoolName ?? s.name ?? "",
        schoolAddr: s.schoolAddr ?? s.addr ?? "",
        schoolPhone: s.schoolPhone ?? s.phone ?? "",
        casePresets: Array.isArray(s.casePresets) ? s.casePresets.slice(0,10) : [...DEFAULT_CASES],
        checkPresets: Array.isArray(s.checkPresets) ? s.checkPresets.slice(0,10) : [...DEFAULT_CHECKS]
      };
    }catch(e){}
  }
  $("schoolName").value = settings.schoolName || "";
  $("schoolAddr").value = settings.schoolAddr || "";
  $("schoolPhone").value = settings.schoolPhone || "";
  setPresetInputs();
  renderCaseButtons();
}
function saveSettings(){
  settings.schoolName = $("schoolName").value || "";
  settings.schoolAddr = $("schoolAddr").value || "";
  settings.schoolPhone = $("schoolPhone").value || "";
  settings.casePresets = getCasePresetsFromUI();
  settings.checkPresets = getCheckPresetsFromUI();
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
}

/* ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ */
function getEntries(){ return Array.isArray(incident.entries) ? incident.entries : []; }

function saveIncident(){
  incident.form = {
    place:$("place").value || "",
    pName:$("pName").value || "",
    pGrade:$("pGrade").value || "",
    pSex:$("pSex").value || "",
    pBirth:$("pBirth").value || "",
    symptom:$("symptom").value || "",
    pHistory:$("pHistory").value || "",
    pAllergy:$("pAllergy").value || ""
  };
  localStorage.setItem(INCIDENT_KEY, JSON.stringify(incident));
}
function loadIncident(){
  const saved = localStorage.getItem(INCIDENT_KEY);
  if(saved){
    try{
      const i=JSON.parse(saved);
      incident = {
        ...incident,
        ...i,
        entries: Array.isArray(i.entries) ? i.entries : [],
        checklist: (i.checklist && typeof i.checklist==="object") ? i.checklist : {},
        form: (i.form && typeof i.form==="object") ? i.form : incident.form,
        computedAgeStr: i.computedAgeStr ?? incident.computedAgeStr
      };
    }catch(e){}
  }

  $("place").value   = incident.form.place || "";
  $("pName").value   = incident.form.pName || "";
  $("pGrade").value  = incident.form.pGrade || "";
  $("pSex").value    = incident.form.pSex || "";
  $("pBirth").value  = incident.form.pBirth || "";
  $("symptom").value = incident.form.symptom || "";
  $("pHistory").value = incident.form.pHistory || "";
  $("pAllergy").value = incident.form.pAllergy || "";

  $("ageDisplay").innerText = `å¹´é½¢ï¼š${incident.computedAgeStr || "--"} æ­³`.replace("æ­³ æ­³","æ­³");
  renderTimeline();
  renderChecklist();
  updateIncidentBar();
  buildScript();
}

/* å¹´é½¢ */
function updateAge(){
  const birthVal = $("pBirth").value;
  const gradeVal = $("pGrade").value;
  const now = new Date();

  let computedAgeStr = "--";
  if(birthVal){
    const bd = new Date(birthVal);
    let age = now.getFullYear() - bd.getFullYear();
    const m = now.getMonth() - bd.getMonth();
    if(m < 0 || (m===0 && now.getDate() < bd.getDate())) age--;
    computedAgeStr = String(age);
  }else if(gradeVal && !isNaN(gradeVal)){
    const g = parseInt(gradeVal,10);
    computedAgeStr = `${g+5}ã€œ${g+6}`;
  }else{
    computedAgeStr = "--";
  }
  incident.computedAgeStr = computedAgeStr;
  $("ageDisplay").innerText = `å¹´é½¢ï¼š${computedAgeStr} æ­³`.replace(" æ­³","æ­³");
  saveIncident();
  buildScript();
}

/* åŸç¨¿ */
function buildScript(){
  const gradeVal = $("pGrade").value;
  const gradeStr = gradeVal
    ? (String(gradeVal).match(/^\d$/) ? `${gradeVal}å¹´ç”Ÿ` : gradeVal)
    : "ï¼ˆä¸æ˜ï¼‰";

  const ageStr = (incident.computedAgeStr && incident.computedAgeStr!=="--") ? `${incident.computedAgeStr}æ­³` : "";

  const data = {
    school: $("schoolName").value || "ï¼ˆå­¦æ ¡åï¼‰",
    addr: $("schoolAddr").value || "ï¼ˆå­¦æ ¡ä½æ‰€ï¼‰",
    place: $("place").value || "ï¼ˆå ´æ‰€ä¸æ˜ï¼‰",
    phone: $("schoolPhone").value || "ï¼ˆé›»è©±ï¼‰",
    pName: $("pName").value || "ï¼ˆæ°åä¸æ˜ï¼‰",
    pGrade: gradeStr,
    pSex: $("pSex").value || "ï¼ˆæ€§åˆ¥ä¸æ˜ï¼‰",
    symptom: $("symptom").value || "ï¼ˆç—‡çŠ¶ä¸æ˜ï¼‰",
    age: ageStr
  };

  $("scriptDisplay").innerText =
`ã€Œæ•‘æ€¥è¦è«‹ã§ã™ã€
å ´æ‰€ï¼š${data.school}
ä½æ‰€ï¼š${data.addr}
è©³ç´°ï¼š${data.place}
é›»è©±ï¼š${data.phone}

å¯¾è±¡ï¼š${data.pName}ã•ã‚“ï¼ˆ${data.pGrade}ãƒ»${data.pSex}${data.age ? "ãƒ»" + data.age : ""}ï¼‰
ç—‡çŠ¶ï¼š${data.symptom}

æ­£é–€ã«ã¦èª˜å°å¾…æ©Ÿä¸­ã§ã™ã€‚`;
}

/* ã‚±ãƒ¼ã‚¹ */
function renderCaseButtons(){
  const wrap = $("caseButtons");
  wrap.innerHTML = "";
  const cases = (settings.casePresets || []).filter(Boolean).slice(0,10);

  if(cases.length===0){
    wrap.innerHTML = `<div class="col-span-2 text-center text-sm font-black text-slate-400 py-6 border rounded-2xl bg-slate-50">
      ï¼ˆã‚±ãƒ¼ã‚¹æœªè¨­å®šã§ã™ã€‚å­¦æ ¡æƒ…å ±ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰
    </div>`;
    return;
  }

  cases.forEach(label=>{
    const btn = document.createElement("button");
    btn.className = "quick-tag bg-amber-50 border border-amber-200 text-amber-900 rounded-2xl text-xs font-black";
    btn.textContent = label;
    btn.onclick = ()=>{
      const cur = ($("symptom").value || "").trim();
      const add = label;
      $("symptom").value = cur ? (cur.includes(add) ? cur : (cur + " / " + add)) : add;
      buildScript();
      saveIncident();
      addEntry(`ã‚±ãƒ¼ã‚¹é¸æŠï¼š${label}`, true);
    };
    wrap.appendChild(btn);
  });
}

/* è¨˜éŒ² */
function addEntry(text, forceImportant=false){
  const t = (text||"").trim();
  if(!t) return;

  const d = new Date();
  const e = {
    ts: d.getTime(),
    time: nowTimeStr(d),
    text: t,
    important: forceImportant ? true : !!incident.importantNext
  };

  incident.entries = getEntries();
  incident.entries.push(e);
  incident.importantNext = false;
  $("btnToggleImportant").textContent = "é‡è¦ï¼šOFF";
  $("btnToggleImportant").classList.remove("bg-amber-400","border-amber-400","text-slate-900");
  $("btnToggleImportant").classList.add("border");

  $("voiceInputArea").value = "";
  $("interimText").innerText = "";
  stopRec();

  saveIncident();
  renderTimeline();
  updateIncidentBar();
}

function renderTimeline(){
  const wrap = $("timeline");
  const empty = $("timelineEmpty");
  wrap.innerHTML = "";
  const entries = getEntries();

  if(entries.length===0){
    empty.classList.remove("hidden");
    wrap.appendChild(empty);
    return;
  }
  empty.classList.add("hidden");

  const list = entries.slice().reverse();
  list.forEach(e=>{
    const div = document.createElement("div");
    div.className = `flex gap-3 bg-white p-4 rounded-2xl shadow-sm border ${e.important ? "border-amber-300 bg-amber-50" : "border-slate-200"}`;
    div.innerHTML = `
      <div class="shrink-0">
        <div class="text-blue-600 font-black text-xs">${e.time}</div>
        <div class="mt-1 text-[10px] font-black ${e.important ? "text-amber-700" : "text-slate-400"}">${e.important ? "â˜…é‡è¦" : ""}</div>
      </div>
      <div class="flex-1 text-slate-900 text-sm font-black whitespace-pre-wrap break-words">${escapeHtml(e.text)}</div>
    `;
    wrap.appendChild(div);
  });
}

/* é–‹å§‹/çµ‚äº† */
let incidentTimer = null;

function updateIncidentBar(){
  const start = incident.startTs;
  $("incidentStartLabel").textContent = start ? fmtDateTime(start).split(" ").slice(-1)[0] : "--:--";

  const entries = getEntries();
  $("lastEntryLabel").textContent = entries.length ? entries[entries.length-1].time : "--:--";

  if(incident.active && start){
    $("incidentElapsedLabel").textContent = msToElapsed(Date.now() - start);
  }else if(!incident.active && start && incident.endTs){
    $("incidentElapsedLabel").textContent = msToElapsed(incident.endTs - start);
  }else{
    $("incidentElapsedLabel").textContent = "--";
  }

  $("btnStartIncident").disabled = incident.active;
  $("btnStartIncident").classList.toggle("opacity-50", incident.active);

  $("btnStopIncident").disabled = !incident.active;
  $("btnStopIncident").classList.toggle("opacity-50", !incident.active);
}

function startIncident(){
  if(incident.active) return;
  incident.active = true;
  incident.startTs = incident.startTs || Date.now();
  incident.endTs = null;
  saveIncident();
  addEntry("ç™ºç”Ÿï¼ˆé–‹å§‹ï¼‰ã‚’è¨˜éŒ²", true);
  updateIncidentBar();
  startIncidentTimer();
}
function stopIncident(){
  if(!incident.active) return;
  incident.active = false;
  incident.endTs = Date.now();
  saveIncident();
  addEntry("å¯¾å¿œçµ‚äº†ã‚’è¨˜éŒ²ï¼ˆå¼•ãç¶™ãå®Œäº†ãªã©ï¼‰", true);
  updateIncidentBar();
  stopIncidentTimer();
}
function startIncidentTimer(){
  if(incidentTimer) clearInterval(incidentTimer);
  incidentTimer = setInterval(()=>updateIncidentBar(), 1000);
}
function stopIncidentTimer(){
  if(incidentTimer) clearInterval(incidentTimer);
  incidentTimer = null;
}

/* åˆå‹•ãƒã‚§ãƒƒã‚¯ */
function checklistItems(){
  return (settings.checkPresets || []).filter(Boolean).slice(0,10);
}
function renderChecklist(){
  const wrap = $("checklist");
  wrap.innerHTML = "";
  const items = checklistItems();

  if(items.length===0){
    wrap.innerHTML = `<div class="text-center text-sm font-black text-slate-400 py-6 border rounded-2xl bg-slate-50">
      ï¼ˆãƒã‚§ãƒƒã‚¯é …ç›®ãŒæœªè¨­å®šã§ã™ã€‚å­¦æ ¡æƒ…å ±ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰
    </div>`;
    return;
  }

  items.forEach(label=>{
    const checked = !!incident.checklist[label];
    const row = document.createElement("button");
    row.className = `w-full text-left border rounded-2xl p-3 flex items-start gap-3 ${checked ? "bg-emerald-50 border-emerald-200" : "bg-white border-slate-200"}`;
    row.innerHTML = `
      <div class="mt-0.5 w-7 h-7 rounded-xl flex items-center justify-center ${checked ? "bg-emerald-600 text-white" : "bg-slate-100 text-slate-500"} font-black text-xs">
        ${checked ? "âœ“" : ""}
      </div>
      <div class="flex-1">
        <div class="font-black text-sm text-slate-900">${escapeHtml(label)}</div>
        <div class="text-[10px] font-black ${checked ? "text-emerald-700" : "text-slate-500"}">
          ${checked ? "å®Œäº†ï¼ˆã‚¿ãƒƒãƒ—ã§è§£é™¤ï¼‰" : "æœªï¼ˆã‚¿ãƒƒãƒ—ã§å®Œäº†ï¼‰"}
        </div>
      </div>
    `;
    row.onclick = ()=>{
      incident.checklist[label] = !incident.checklist[label];
      saveIncident();
      renderChecklist();
      addEntry((incident.checklist[label] ? "åˆå‹•ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼š " : "åˆå‹•ãƒã‚§ãƒƒã‚¯è§£é™¤ï¼š ") + label);
    };
    wrap.appendChild(row);
  });
}
function resetChecklist(){
  incident.checklist = {};
  saveIncident();
  renderChecklist();
  addEntry("åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼šå…¨è§£é™¤");
}

/* å…¨ä»¶ãƒ“ãƒ¥ãƒ¼ */
let lvOrderNewestFirst = true;
let lvOnlyImportant = false;
let lvMode = "card";

function openLogViewer(){ $("logViewerWrap").classList.remove("hidden"); renderLogViewer(); }
function closeLogViewer(){ $("logViewerWrap").classList.add("hidden"); }
function entriesToText(entries){
  return entries.map(e=>`${e.time} ${e.important ? "â˜… " : ""}${e.text}`).join("\n") || "ï¼ˆè¨˜éŒ²ãªã—ï¼‰";
}
function filteredEntries(){
  const q = ($("lvSearch").value||"").trim().toLowerCase();
  let entries = getEntries().slice();
  if(lvOnlyImportant) entries = entries.filter(e=>!!e.important);
  if(q){
    entries = entries.filter(e=>{
      const t=(e.text||"").toLowerCase();
      const tm=(e.time||"").toLowerCase();
      return t.includes(q) || tm.includes(q);
    });
  }
  if(lvOrderNewestFirst) entries = entries.slice().reverse();
  return entries;
}
function renderLogViewer(){
  const list = filteredEntries();
  $("lvCount").textContent = String(list.length);
  $("lvOrder").textContent = `è¡¨ç¤ºï¼š${lvOrderNewestFirst ? "æ–°â†’å¤" : "å¤â†’æ–°"}`;
  $("lvOnlyImp").textContent = `é‡è¦ã®ã¿ï¼š${lvOnlyImportant ? "ON" : "OFF"}`;
  $("lvMode").textContent = `è¡¨ç¤ºï¼š${lvMode==="card" ? "ã‚«ãƒ¼ãƒ‰" : "ãƒ†ã‚­ã‚¹ãƒˆ"}`;

  const body = $("lvBody");
  body.innerHTML = "";

  if(lvMode==="text"){
    const pre=document.createElement("pre");
    pre.className="w-full whitespace-pre-wrap break-words text-sm font-black bg-slate-50 border rounded-2xl p-3";
    pre.textContent = entriesToText(list);
    body.appendChild(pre);
    return;
  }

  if(list.length===0){
    body.innerHTML = `<div class="text-center text-sm font-black text-slate-400 py-10">ï¼ˆè©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰</div>`;
    return;
  }

  list.forEach(e=>{
    const card=document.createElement("div");
    card.className="bg-white border rounded-2xl p-3 shadow-sm mb-2";
    card.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="shrink-0">
          <div class="text-blue-600 font-black text-xs">${e.time}</div>
          <div class="mt-1 text-[10px] font-black ${e.important ? "text-amber-600" : "text-slate-400"}">${e.important ? "â˜…é‡è¦" : ""}</div>
        </div>
        <div class="flex-1 text-sm font-black whitespace-pre-wrap break-words">${escapeHtml(e.text||"")}</div>
      </div>
    `;
    body.appendChild(card);
  });
}

/* éŸ³å£°å…¥åŠ› */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let isRecording = false;

if(SpeechRecognition){
  recognition = new SpeechRecognition();
  recognition.lang = "ja-JP";
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onresult = (event)=>{
    let interim = "";
    let final = "";
    for(let i=event.resultIndex; i<event.results.length; i++){
      if(event.results[i].isFinal) final += event.results[i][0].transcript;
      else interim += event.results[i][0].transcript;
    }
    if(final) $("voiceInputArea").value += final;
    $("interimText").innerText = interim;
  };
  recognition.onend = ()=>{ if(isRecording) recognition.start(); };
}
function startRec(){
  if(!recognition) return alert("ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«æœªå¯¾å¿œã§ã™");
  isRecording = true; recognition.start();
  $("pulseRing").classList.remove("hidden");
  $("btnVoiceRec").classList.replace("bg-blue-600","bg-red-600");
  $("micText").innerText = "REC ON";
}
function stopRec(){
  isRecording = false;
  try{ if(recognition) recognition.stop(); }catch(e){}
  $("pulseRing").classList.add("hidden");
  $("btnVoiceRec").classList.remove("bg-red-600");
  $("btnVoiceRec").classList.add("bg-blue-600");
  $("micText").innerText = "REC START";
  $("interimText").innerText = "";
}
$("btnVoiceRec").onclick = ()=> isRecording ? stopRec() : startRec();

/* å°åˆ· */
$("btnPrint").onclick = ()=>{
  $("printTimestamp").innerText = `ä½œæˆæ—¥ï¼š${new Date().toLocaleString("ja-JP")}`;

  const schoolLine = `${$("schoolName").value || "æœªè¨­å®š"} / ${$("schoolAddr").value || "ä½æ‰€æœªè¨­å®š"} / ${$("schoolPhone").value || "é›»è©±æœªè¨­å®š"}`;
  $("printSchoolInfo").innerText = schoolLine;

  const start = incident.startTs ? fmtDateTime(incident.startTs) : "æœªè¨˜éŒ²";
  const end   = incident.endTs ? fmtDateTime(incident.endTs) : (incident.active ? "ç¶™ç¶šä¸­" : "æœªè¨˜éŒ²");
  const elapsed = (incident.startTs && (incident.endTs || incident.active))
    ? msToElapsed((incident.endTs || Date.now()) - incident.startTs)
    : "--";
  $("printIncidentInfo").innerText = `é–‹å§‹ï¼š${start} / çµ‚äº†ï¼š${end} / çµŒéï¼š${elapsed}`;

  const gradeVal = $("pGrade").value || "-";
  const gradeStr = String(gradeVal).match(/^\d$/) ? `${gradeVal}å¹´` : gradeVal;
  const pInfo = `${$("pName").value || "æ°åæœªè©³"} / ${gradeStr} / ${$("pSex").value || "-"} / ${incident.computedAgeStr || "--"}æ­³`;
  $("printPatientInfo").innerText = pInfo;

  let medInfo = `ã€ç—‡çŠ¶ã€‘${$("symptom").value || "æœªå…¥åŠ›"}`;
  if($("pHistory").value) medInfo += `  ã€æ—¢å¾€ã€‘${$("pHistory").value}`;
  if($("pAllergy").value) medInfo += `  ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã€‘${$("pAllergy").value}`;
  $("printMedicalInfo").innerText = medInfo;

  const items = checklistItems();
  if(items.length===0){
    $("printChecklist").innerText = "ï¼ˆæœªè¨­å®šï¼‰";
  }else{
    const ok = items.filter(x=>incident.checklist[x]);
    const ng = items.filter(x=>!incident.checklist[x]);
    $("printChecklist").innerHTML =
      `<div><b>å®Œäº†ï¼š</b>${ok.length ? ok.join(" / ") : "ãªã—"}</div>` +
      `<div><b>æœªï¼š</b>${ng.length ? ng.join(" / ") : "ãªã—"}</div>`;
  }

  const container = $("printTimeline");
  container.innerHTML = "";
  const entries = getEntries();
  if(entries.length===0){
    container.innerHTML = "<p class='py-4 text-center text-sm text-gray-400'>è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
  }else{
    entries.forEach(e=>{
      const row = document.createElement("div");
      row.className = "flex border-b border-gray-300 py-2 timeline-item";
      row.innerHTML = `<div class="w-24 font-bold text-sm">${e.time}${e.important ? " â˜…" : ""}</div><div class="flex-1 text-sm">${escapeHtml(e.text)}</div>`;
      container.appendChild(row);
    });
  }

  window.print();
};

/* ãƒœã‚¿ãƒ³ wiring */
$("btnAddTimeline").onclick = ()=> addEntry($("voiceInputArea").value);

document.querySelectorAll(".quick-tag").forEach(btn=>{
  btn.onclick = ()=> addEntry(btn.dataset.val);
});

$("btnToggleImportant").onclick = ()=>{
  incident.importantNext = !incident.importantNext;
  $("btnToggleImportant").textContent = incident.importantNext ? "é‡è¦ï¼šON" : "é‡è¦ï¼šOFF";
  if(incident.importantNext){
    $("btnToggleImportant").classList.add("bg-amber-400","border-amber-400","text-slate-900");
    $("btnToggleImportant").classList.remove("border");
  }else{
    $("btnToggleImportant").classList.remove("bg-amber-400","border-amber-400","text-slate-900");
    $("btnToggleImportant").classList.add("border");
  }
  saveIncident();
};

$("btnCopyTimeline").onclick = ()=> copyText(entriesToText(getEntries()));
$("btnCopyScript").onclick = ()=> copyText($("scriptDisplay").innerText);
$("btnShareScript").onclick = ()=> shareText("119é€šå ±ç”¨åŸç¨¿", $("scriptDisplay").innerText);

$("btnStartIncident").onclick = startIncident;
$("btnStopIncident").onclick = stopIncident;

$("btnResetAll").onclick = ()=>{
  const ok = confirm("å…¨æ¶ˆå»ã—ã¾ã™ã€‚\nï¼ˆè¨˜éŒ²ãƒ»ãƒã‚§ãƒƒã‚¯ãƒ»å…¥åŠ›å†…å®¹ãŒç«¯æœ«ã‹ã‚‰æ¶ˆãˆã¾ã™ï¼‰\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
  if(!ok) return;
  incident = {
    active:false, startTs:null, endTs:null,
    importantNext:false,
    entries:[],
    checklist:{},
    form:{ place:"", pName:"", pGrade:"", pSex:"", pBirth:"", symptom:"", pHistory:"", pAllergy:"" },
    computedAgeStr:"--"
  };
  saveIncident();
  loadIncident();
  stopIncidentTimer();
  alert("æ¶ˆå»ã—ã¾ã—ãŸã€‚");
};

$("btnChecklistReset").onclick = resetChecklist;

$("btnCopyChecklist").onclick = ()=>{
  const items = checklistItems();
  if(items.length===0) return copyText("ï¼ˆåˆå‹•ãƒã‚§ãƒƒã‚¯ï¼šæœªè¨­å®šï¼‰");

  const ok = items.filter(x=>incident.checklist[x]);
  const ng = items.filter(x=>!incident.checklist[x]);
  const txt = `ã€åˆå‹•ãƒã‚§ãƒƒã‚¯ã€‘\nå®Œäº†ï¼š${ok.length ? ok.join(" / ") : "ãªã—"}\næœªï¼š${ng.length ? ng.join(" / ") : "ãªã—"}`;
  copyText(txt);
};

$("btnSaveSettings").onclick = ()=>{
  saveSettings();
  loadSettings();
  renderChecklist();
  alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
};

$("btnExportSettings").onclick = async ()=>{
  saveSettings();
  const pack = {
    version:"v14",
    school: settings.schoolName || "",
    addr: settings.schoolAddr || "",
    phone: settings.schoolPhone || "",
    casePresets: settings.casePresets || [],
    checkPresets: settings.checkPresets || []
  };
  const txt = `ã€æ•‘æ€¥è¦è«‹ã‚µãƒãƒ¼ãƒˆ è¨­å®šï¼ˆv14ï¼‰ã€‘\n` + JSON.stringify(pack, null, 2);
  await shareText("æ•‘æ€¥è¦è«‹ã‚µãƒãƒ¼ãƒˆ è¨­å®šï¼ˆv14ï¼‰", txt);
};

$("btnRestoreDefaultCases").onclick = ()=>{
  document.querySelectorAll(".casePreset").forEach((inp,idx)=> inp.value = DEFAULT_CASES[idx] || "");
};
$("btnClearCases").onclick = ()=> document.querySelectorAll(".casePreset").forEach(inp=> inp.value = "");

$("btnRestoreDefaultChecks").onclick = ()=>{
  document.querySelectorAll(".checkPreset").forEach((inp,idx)=> inp.value = DEFAULT_CHECKS[idx] || "");
};
$("btnClearChecks").onclick = ()=> document.querySelectorAll(".checkPreset").forEach(inp=> inp.value = "");

$("btnCasesHint").onclick = ()=> { toggleCollapse("schoolPanel"); $("schoolPanel").scrollIntoView({behavior:"smooth", block:"start"}); };
$("btnChecklistSettingsHint").onclick = ()=> { switchTab(1); toggleCollapse("schoolPanel"); $("schoolPanel").scrollIntoView({behavior:"smooth", block:"start"}); };
$("btnOpenSettings").onclick = ()=> { switchTab(1); toggleCollapse("schoolPanel"); $("schoolPanel").scrollIntoView({behavior:"smooth", block:"start"}); };

/* Log viewer */
$("btnOpenLogViewer").onclick = openLogViewer;
$("btnCloseLogViewer").onclick = closeLogViewer;
$("logViewerBackdrop").onclick = closeLogViewer;
$("lvSearch").addEventListener("input", renderLogViewer);
$("lvOrder").onclick = ()=>{ lvOrderNewestFirst=!lvOrderNewestFirst; renderLogViewer(); };
$("lvOnlyImp").onclick = ()=>{ lvOnlyImportant=!lvOnlyImportant; renderLogViewer(); };
$("lvMode").onclick = ()=>{ lvMode = (lvMode==="card" ? "text" : "card"); renderLogViewer(); };
$("lvCopy").onclick = ()=> copyText(entriesToText(filteredEntries()));
$("lvShare").onclick = ()=> shareText("æ•‘æ€¥å¯¾å¿œ è¨˜éŒ²ï¼ˆãƒ•ã‚£ãƒ«ã‚¿çµæœï¼‰", entriesToText(filteredEntries()));

/* å…¥åŠ›ã®è‡ªå‹•ä¿å­˜ */
$("pBirth").onchange = updateAge;
$("pGrade").onchange = updateAge;

document.querySelectorAll("input, textarea, select").forEach(el=>{
  el.addEventListener("input", ()=>{
    if(el.classList.contains("casePreset") || el.classList.contains("checkPreset")) return;
    buildScript();
    saveIncident();
  });
});

/* åˆæœŸåŒ– */
loadSettings();
loadIncident();
if(incident.active && incident.startTs) startIncidentTimer();
updateAge();
buildScript();
renderCaseButtons();
</script>
</body>
</html>
