<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>救急要請サポートアプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body{
      -webkit-tap-highlight-color: transparent;
      padding-bottom: 96px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .safe-area-bottom{ padding-bottom: env(safe-area-inset-bottom); }

    *, *::before, *::after { box-sizing: border-box; }
    button, a { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    button{ cursor: pointer; }

    /* iOS dateが右に飛び出す対策 */
    .date-wrap { min-width: 0; overflow: hidden; }
    input[type="date"]{
      width: 100%;
      max-width: 100%;
      min-width: 0;
      display: block;
      font-size: 16px; /* iOS拡大防止 */
      -webkit-appearance: none;
      appearance: none;
      padding-right: 10px;
      border-radius: 0.75rem;
    }

    /* 生年月日（#pBirth）の縦位置（上詰め）対策 */
    #pBirth{
      line-height: 48px;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
    }

    input, select, textarea{ min-height: 48px; }
    select{
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='https://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1rem;
      padding-right: 2.5rem !important;
      font-size: 16px;
    }

    /* v18: すべてのボタンに「押した感」を強制付与 */
    .pressing{
      transform: scale(0.97);
      filter: brightness(0.90);
      box-shadow: inset 0 0 0 9999px rgba(0,0,0,0.06);
    }

    .quick-tag{
      transition: transform .08s, filter .08s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      min-height: 44px;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      padding: 10px 10px;
      line-height: 1.2;
      user-select:none;
      position: relative;
      overflow: hidden;
    }
    .tap-flash::after{
      content:"";
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.09);
      animation: flash .18s ease-out;
      pointer-events:none;
    }
    @keyframes flash{
      from{ opacity: .9; }
      to{ opacity: 0; }
    }

    .collapse-content{ max-height: 0; overflow:hidden; transition: max-height .28s ease-out; }
    .collapse-content.open{ max-height: 2000px; transition: max-height .45s ease-in; }

    .recording-ring{ animation: ring-pulse 1.5s cubic-bezier(0.24, 0, 0.38, 1) infinite; }
    @keyframes ring-pulse{
      0% { transform: scale(1); opacity: 0.55; }
      100% { transform: scale(1.55); opacity: 0; }
    }

    /* ===== 印刷/Word向け（旧レイアウトに完全復帰） ===== */
    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff !important; padding:0 !important; }
      .print-report{ display:block !important; padding:18px !important; color:#000; }
      .timeline-item{ border-bottom: 1px solid #ccc !important; break-inside: avoid; }
    }
    .print-report{ display:none; }
  </style>
</head>

<body class="bg-slate-100 text-slate-900">

  <!-- ===================== PRINT REPORT (hidden) ===================== -->
  <div class="print-report">
    <div class="border-b-2 border-black pb-2 mb-4 flex justify-between items-end">
      <div>
        <h1 class="text-2xl font-bold">救急対応・経過記録</h1>
        <div class="text-xs text-gray-600 mt-1">（端末ローカル記録）</div>
      </div>
      <p id="printTimestamp" class="text-sm"></p>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-4 border p-3 rounded-lg">
      <div>
        <p class="text-xs font-bold text-gray-500">学校名 / 住所 / 電話</p>
        <p id="printSchoolInfo" class="text-sm font-bold"></p>
      </div>
      <div>
        <p class="text-xs font-bold text-gray-500">開始 / 終了 / 経過</p>
        <p id="printIncidentInfo" class="text-sm font-bold"></p>
      </div>

      <div class="col-span-2 border-t pt-2">
        <p class="text-xs font-bold text-gray-500">傷病者（氏名 / 学年 / 性別 / 年齢）</p>
        <p id="printPatientInfo" class="text-sm font-bold"></p>
      </div>

      <div class="col-span-2 border-t pt-2">
        <p class="text-xs font-bold text-gray-500">現在の主な症状・既往歴・アレルギー</p>
        <p id="printMedicalInfo" class="text-sm"></p>
      </div>

      <div class="col-span-2 border-t pt-2">
        <p class="text-xs font-bold text-gray-500">初動チェック状況</p>
        <div id="printChecklist" class="text-sm"></div>
      </div>
    </div>

    <h2 class="text-lg font-bold border-l-4 border-black pl-2 mb-2">時系列記録</h2>
    <div id="printTimeline" class="border-t border-black"></div>

    <div class="mt-6 text-[10px] text-gray-400 text-right">
      ©2026 Takayuki WAYAMA.
    </div>
  </div>

  <!-- ===================== HEADER ===================== -->
  <header class="sticky top-0 z-30 bg-white shadow-sm border-b no-print">
    <div class="px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex flex-col">
        <h1 class="text-base font-black leading-tight text-red-600">救急要請サポート</h1>
        <div class="text-[10px] text-slate-400 font-bold">（v1）</div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnOpenSettings" class="px-3 py-2 rounded-full border text-xs font-black text-slate-700">
          設定
        </button>
        <!-- 「119」のボタンや機能は削除 -->
      </div>
    </div>
  </header>

  <!-- ===================== MAIN ===================== -->
  <main class="p-3 space-y-4 no-print">

    <!-- ===================== SECTION 1 ===================== -->
    <div id="section1" class="space-y-4">

      <div class="bg-white border rounded-2xl p-3 shadow-sm">
        <div class="flex items-start gap-3">
          <div class="shrink-0 mt-0.5 w-9 h-9 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-black">!</div>
          <div class="flex-1">
            <div class="font-black text-sm">このアプリは「端末内（ローカル）」にのみ保存されます</div>
            <div class="text-[11px] text-slate-600 font-bold mt-0.5">
              キャッシュ削除で消える場合があります。<span class="text-slate-900 font-black">設定CSVの保存</span>をおすすめします。
            </div>
          </div>
        </div>
      </div>

      <!-- 発生場所 -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
        <div class="flex justify-between items-center border-b pb-2 mb-2">
          <h2 class="font-black text-sm border-l-4 border-slate-800 pl-2 text-slate-800">1. 発生場所</h2>
          <button onclick="toggleCollapse('schoolPanel')" class="text-xs text-blue-600 font-black">学校情報</button>
        </div>

        <div id="schoolPanel" class="hidden space-y-3 bg-slate-50 p-3 rounded-xl border border-dashed border-slate-200">
          <div><label class="text-[11px] font-black text-slate-500">学校名</label><input id="schoolName" class="w-full p-3 border rounded-xl text-sm font-black bg-white" placeholder="〇〇市立〇〇小学校" /></div>
          <div><label class="text-[11px] font-black text-slate-500">住所</label><input id="schoolAddr" class="w-full p-3 border rounded-xl text-sm font-black bg-white" placeholder="市区町村からの住所" /></div>
          <div><label class="text-[11px] font-black text-slate-500">電話番号</label><input id="schoolPhone" class="w-full p-3 border rounded-xl text-sm font-black bg-white" placeholder="03-xxxx-xxxx" inputmode="tel" /></div>

          <!-- 設定CSV -->
          <div class="bg-white border rounded-2xl p-3 space-y-2">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">設定バックアップ（CSV）</div>
              <div class="text-[10px] font-black text-slate-500">別端末へ移行OK</div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <button id="btnExportCSV" class="py-4 rounded-2xl bg-slate-900 text-white text-sm font-black">CSVエクスポート</button>
              <button id="btnImportCSV" class="py-4 rounded-2xl bg-white border text-sm rounded-2xl font-black">CSVインポート</button>
            </div>
            <input id="csvFile" type="file" accept=".csv,text/csv" class="hidden" />
            <div class="text-[11px] font-bold text-slate-500 leading-relaxed">
              ※CSVは「学校情報/よく起きるケース/初動チェック/クイック入力」すべてを含みます。
            </div>
          </div>

          <!-- よく起きるケース（最大10） -->
          <div class="bg-white border rounded-2xl p-3 space-y-2">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">よく起きるケース（最大10）</div>
              <div class="text-[10px] font-black text-slate-500">学校ごとに設定</div>
            </div>
            <div class="grid grid-cols-1 gap-2">
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button id="btnRestoreDefaultCases" class="py-3 rounded-2xl bg-white border text-xs font-black">初期セットに戻す</button>
              <button id="btnClearCases" class="py-3 rounded-2xl bg-white border text-xs font-black">空にする</button>
            </div>
          </div>

          <!-- 初動チェック（最大10） -->
          <div class="bg-white border rounded-2xl p-3 space-y-2">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">初動チェック（最大10）</div>
              <div class="text-[10px] font-black text-slate-500">チェックで自動記録</div>
            </div>
            <div class="grid grid-cols-1 gap-2">
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button id="btnRestoreDefaultChecks" class="py-3 rounded-2xl bg-white border text-xs font-black">初期セットに戻す</button>
              <button id="btnClearChecks" class="py-3 rounded-2xl bg-white border text-xs font-black">空にする</button>
            </div>
          </div>

          <!-- クイック入力（各最大10） -->
          <div class="bg-white border rounded-2xl p-3 space-y-3">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">クイック入力（各最大10）</div>
              <div class="text-[10px] font-black text-slate-500">「表示|記録」形式もOK</div>
            </div>

            <div class="space-y-2">
              <div class="text-xs font-black text-blue-700">STATUS / 意識・呼吸</div>
              <div class="grid grid-cols-1 gap-2">
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
              </div>
              <div class="grid grid-cols-2 gap-2">
                <button id="btnRestoreDefaultQuickStatus" class="py-3 rounded-2xl bg-white border text-xs font-black">初期値</button>
                <button id="btnClearQuickStatus" class="py-3 rounded-2xl bg-white border text-xs font-black">空</button>
              </div>
            </div>

            <div class="space-y-2">
              <div class="text-xs font-black text-slate-800">SYMPTOMS / 全身症状</div>
              <div class="grid grid-cols-1 gap-2">
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
              </div>
              <div class="grid grid-cols-2 gap-2">
                <button id="btnRestoreDefaultQuickSymptoms" class="py-3 rounded-2xl bg-white border text-xs font-black">初期値</button>
                <button id="btnClearQuickSymptoms" class="py-3 rounded-2xl bg-white border text-xs font-black">空</button>
              </div>
            </div>

            <div class="space-y-2">
              <div class="text-xs font-black text-green-700">TREATMENT / 処置内容</div>
              <div class="grid grid-cols-1 gap-2">
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
              </div>
              <div class="grid grid-cols-2 gap-2">
                <button id="btnRestoreDefaultQuickTreatment" class="py-3 rounded-2xl bg-white border text-xs font-black">初期値</button>
                <button id="btnClearQuickTreatment" class="py-3 rounded-2xl bg-white border text-xs font-black">空</button>
              </div>
            </div>

            <div class="text-[11px] font-bold text-slate-500">
              例：<span class="font-black">意識あり|意識あり（明瞭）</span>（表示＝左、記録＝右）
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <button id="btnSaveSettings" class="py-4 bg-slate-900 text-white text-sm rounded-2xl font-black">このスマホに保存</button>
            <button id="btnExportSettings" class="py-4 bg-white border text-sm rounded-2xl font-black">設定を共有</button>
          </div>
        </div>

        <div>
          <label class="text-[11px] font-black text-slate-500">校内の詳しい場所</label>
          <input id="place" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="例：3F図工室、体育館北側など" />
        </div>
      </div>

      <!-- 傷病者 -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-4">
        <h2 class="font-black text-sm border-l-4 border-red-500 pl-2 text-slate-800">2. 傷病者の詳細</h2>

        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <div class="text-[11px] font-black text-slate-500">よく起きるケース（タップで症状へ反映＋記録）</div>
            <button id="btnCasesHint" class="text-xs font-black text-blue-600">設定</button>
          </div>
          <div id="caseButtons" class="grid grid-cols-2 gap-2"></div>
        </div>

        <div class="space-y-3">
          <div>
            <label class="text-[11px] font-black text-slate-500">氏名（ふりがな）</label>
            <input id="pName" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black placeholder:font-bold placeholder:text-slate-400" placeholder="山田 太郎（やまだ たろう）" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-[11px] font-black text-slate-500">学年・区分</label>
              <select id="pGrade" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black">
                <option value="">選択</option>
                <option value="1">1年</option><option value="2">2年</option><option value="3">3年</option>
                <option value="4">4年</option><option value="5">5年</option><option value="6">6年</option>
                <option value="職員">教職員</option><option value="他">その他</option>
              </select>
            </div>
            <div>
              <label class="text-[11px] font-black text-slate-500">性別</label>
              <select id="pSex" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black">
                <option value="">選択</option>
                <option value="男性">男性</option>
                <option value="女性">女性</option>
                <option value="不明">不明</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-3 bg-blue-50 rounded-xl border border-blue-100 overflow-hidden">
            <div class="date-wrap">
              <label class="text-[11px] font-black text-blue-700">生年月日</label>
              <input id="pBirth" type="date" class="w-full h-[48px] px-3 border text-base font-black bg-white" />
            </div>
            <div class="flex items-end min-w-0">
              <div id="ageDisplay" class="text-sm font-black text-blue-800 bg-white border border-blue-200 w-full px-3 rounded-xl text-center h-[48px] flex items-center justify-center shadow-sm">
                年齢：-- 歳
              </div>
            </div>
          </div>
        </div>

        <div>
          <label class="text-[11px] font-black text-slate-500">現在の症状</label>
          <textarea id="symptom" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" rows="2"
            placeholder="例：アレルギー反応、呼吸困難、意識混濁"></textarea>
        </div>

        <button onclick="toggleCollapse('detailMedical')" class="w-full py-3 bg-slate-100 rounded-xl text-[11px] font-black text-slate-600 flex justify-center items-center gap-1">
          既往歴・アレルギー等
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
        </button>

        <div id="detailMedical" class="hidden space-y-3 pt-1">
          <div><label class="text-[11px] font-black text-slate-500">既往歴（持病）</label><input id="pHistory" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="喘息、てんかん等" /></div>
          <div><label class="text-[11px] font-black text-slate-500">アレルギー</label><input id="pAllergy" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="ピーナッツ、卵等" /></div>
        </div>
      </div>

      <!-- 通報用原稿 -->
      <div class="bg-slate-900 rounded-2xl p-4 shadow-xl">
        <div class="flex justify-between items-center mb-2 border-b border-white/10 pb-2">
          <span class="text-[10px] uppercase tracking-widest text-slate-400 font-black">119通報用原稿</span>
          <div class="flex items-center gap-2">
            <button id="btnCopyScript" class="text-xs bg-white text-slate-900 px-3 py-2 rounded-full font-black">コピー</button>
            <button id="btnShareScript" class="text-xs bg-white/10 text-white px-3 py-2 rounded-full font-black">共有</button>
          </div>
        </div>
        <div id="scriptDisplay" class="text-white text-sm font-bold leading-relaxed min-h-[120px] whitespace-pre-wrap"></div>
      </div>
    </div>

    <!-- ===================== SECTION 2 ===================== -->
    <div id="section2" class="hidden space-y-4 pb-24">

      <!-- 上部固定（sticky） -->
      <div class="bg-white/95 backdrop-blur border rounded-2xl p-4 shadow-sm space-y-3 sticky top-[64px] z-20">
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="font-black text-sm">経過・処置の記録</div>
            <!-- ✅ v25: 文言を削除し、ここに最新LOGを表示 -->
            <div id="latestLogPreview" class="text-[10px] font-black text-slate-500 leading-snug">最新LOG：（記録なし）</div>
          </div>

          <div class="flex items-center gap-2">
            <button id="btnOpenLogViewer" class="px-3 py-2 rounded-full border text-xs font-black">全件LOG</button>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-2">
          <button id="btnStartIncident" class="py-4 rounded-2xl bg-red-600 text-white font-black text-sm">記録開始</button>
          <button id="btnStopIncident" class="py-4 rounded-2xl bg-white border font-black text-sm text-slate-900">記録終了</button>
          <button id="btnResetAll" class="py-4 rounded-2xl bg-white border font-black text-sm text-slate-900">全消去</button>
        </div>

        <div class="grid grid-cols-3 gap-2">
          <div class="bg-slate-50 border rounded-2xl p-3">
            <div class="text-[10px] font-black text-slate-500">開始</div>
            <div id="incidentStartLabel" class="text-sm font-black text-slate-900">--:--</div>
          </div>
          <div class="bg-slate-50 border rounded-2xl p-3">
            <div class="text-[10px] font-black text-slate-500">経過</div>
            <div id="incidentElapsedLabel" class="text-sm font-black text-slate-900">--</div>
          </div>
          <div class="bg-slate-50 border rounded-2xl p-3">
            <div class="text-[10px] font-black text-slate-500">最新記録</div>
            <div id="lastEntryLabel" class="text-sm font-black text-slate-900">--:--</div>
          </div>
        </div>
      </div>

      <!-- checklist -->
      <section class="bg-white border rounded-2xl p-4 shadow-sm space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="font-black text-sm border-l-4 border-emerald-600 pl-2">
            初動チェック（チェックで自動記録）
          </h2>
          <button id="btnChecklistSettingsHint" class="text-xs font-black text-blue-600">設定</button>
        </div>

        <div id="checklist" class="space-y-2"></div>

        <div class="grid grid-cols-2 gap-2">
          <button id="btnChecklistReset" class="py-4 rounded-2xl bg-white border font-black text-sm">チェック解除</button>
          <button id="btnCopyChecklist" class="py-4 rounded-2xl bg-slate-900 text-white font-black text-sm">チェック状況コピー</button>
        </div>
      </section>

      <!-- memo / voice -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="font-black text-sm">メモ（音声入力）</div>
            <!-- ✅ v25: 説明をすっきり -->
            <div class="text-[10px] font-black text-slate-500">
              音声が動かない場合は、下の「キーボードのマイク」で入力してください
            </div>
          </div>

          <button id="btnToggleImportant" class="px-3 py-2 rounded-full border text-xs font-black">
            重要：OFF
          </button>
        </div>

        <div class="flex flex-col items-center py-1">
          <div class="relative">
            <div id="pulseRing" class="absolute inset-0 rounded-full bg-red-400 hidden recording-ring"></div>
            <button id="btnVoiceRec" class="relative z-10 w-20 h-20 rounded-full bg-blue-600 text-white shadow-lg flex items-center justify-center flex-col gap-0.5 transition-transform">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-18a3 3 0 013 3v8a3 3 0 01-3 3 3 3 0 01-3-3V5a3 3 0 013-3z"></path></svg>
              <span id="micText" class="text-[9px] font-black tracking-tighter uppercase">REC START</span>
            </button>
          </div>
          <div id="interimText" class="mt-2 text-xs text-blue-600 font-black h-4 italic"></div>

          <div id="voiceSupportHint" class="mt-1 text-[10px] font-bold text-slate-500 text-center leading-snug"></div>

          <button id="btnKeyboardDictation" class="mt-2 w-full py-3 rounded-2xl bg-white border text-sm font-black">
            （iPhone等）キーボードのマイクで音声入力する
          </button>
        </div>

        <div class="space-y-2">
          <textarea id="voiceInputArea" class="w-full p-4 bg-slate-50 border rounded-2xl text-base font-black focus:ring-2 focus:ring-blue-500 outline-none" rows="3" placeholder="メモを入力（音声の場合もここに入ります）..."></textarea>
          <button id="btnAddTimeline" class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg">記録（ログに残す）</button>
        </div>
      </div>

      <!-- quick tags accordions -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
        <div class="text-center">
          <div class="font-black text-sm text-slate-900">クイック入力</div>
          <div class="text-[10px] text-slate-400 font-black uppercase tracking-tight">Tap to Log</div>
        </div>

        <div class="space-y-3">
          <div class="border rounded-xl overflow-hidden">
            <button onclick="toggleAccordion('acc-status')" class="w-full px-4 py-3 bg-blue-50 flex justify-between items-center text-blue-800 font-black text-sm">
              <span>STATUS / 意識・呼吸</span>
              <svg id="icon-acc-status" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="acc-status" class="collapse-content bg-white">
              <div id="quickStatusGrid" class="grid grid-cols-2 gap-2 p-3"></div>
            </div>
          </div>

          <div class="border rounded-xl overflow-hidden">
            <button onclick="toggleAccordion('acc-symptoms')" class="w-full px-4 py-3 bg-slate-100 flex justify-between items-center text-slate-800 font-black text-sm">
              <span>SYMPTOMS / 全身症状</span>
              <svg id="icon-acc-symptoms" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="acc-symptoms" class="collapse-content bg-white">
              <div id="quickSymptomsGrid" class="grid grid-cols-2 gap-2 p-3"></div>
            </div>
          </div>

          <div class="border rounded-xl overflow-hidden">
            <button onclick="toggleAccordion('acc-treatment')" class="w-full px-4 py-3 bg-green-50 flex justify-between items-center text-green-800 font-black text-sm">
              <span>TREATMENT / 処置内容</span>
              <svg id="icon-acc-treatment" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="acc-treatment" class="collapse-content bg-white">
              <div id="quickTreatmentGrid" class="grid grid-cols-2 gap-2 p-3"></div>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-2">
            <button id="btnQuickAmbulance" class="quick-tag bg-slate-900 text-white rounded-2xl text-base font-black">
              救急車 到着
            </button>
          </div>
        </div>
      </div>

      <!-- timeline -->
      <div class="space-y-3 px-1">
        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center py-2 italic border-b border-slate-200">Activity Log</h3>

        <div id="timeline" class="space-y-3">
          <p id="timelineEmpty" class="text-center text-slate-400 py-10 text-sm font-black">（記録なし）</p>
        </div>

        <div class="flex flex-col gap-2 mt-6">
          <button id="btnCopyTimeline" class="w-full py-4 text-slate-700 text-sm font-black border-2 border-dashed border-slate-300 rounded-2xl">記録をコピー</button>

          <button id="btnPrint" class="w-full py-4 bg-blue-600 text-white text-sm font-black rounded-2xl shadow-lg flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
            用紙として印刷
          </button>

          <button id="btnWord" class="w-full py-4 bg-white border text-slate-900 text-sm font-black rounded-2xl shadow-sm">
            Wordでエクスポート
          </button>
        </div>
      </div>

    </div>
  </main>

  <!-- ===================== BOTTOM NAV ===================== -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex items-center justify-around px-2 py-2 no-print shadow-[0_-4px_15px_rgba(0,0,0,0.1)] z-40 safe-area-bottom">
    <button id="nav1" class="flex flex-col items-center gap-1 flex-1 py-1 text-blue-600">
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
      <span class="text-[10px] font-black">1. 通報原稿</span>
    </button>

    <button id="nav2" class="flex flex-col items-center gap-1 flex-1 py-1 text-slate-400">
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path></svg>
      <span class="text-[10px] font-black">2. 経過記録</span>
    </button>
  </nav>

  <!-- ===================== LOG VIEWER ===================== -->
  <div id="logViewerWrap" class="fixed inset-0 z-[90] hidden">
    <div id="logViewerBackdrop" class="absolute inset-0 bg-black/50"></div>

    <div class="absolute inset-0 bg-white flex flex-col">
      <div class="sticky top-0 bg-white border-b p-3 flex items-center gap-2">
        <div class="font-black">全件LOG</div>
        <button id="btnCloseLogViewer" class="ml-auto px-3 py-2 rounded-full border text-xs font-black">閉じる</button>
      </div>

      <div class="p-3 space-y-2 border-b bg-slate-50">
        <input id="lvSearch" class="w-full p-3 bg-white border rounded-2xl text-sm font-black" placeholder="検索（例：AED / けいれん / 12:34）">

        <div class="grid grid-cols-4 gap-2">
          <button id="lvAddToggle" class="py-3 rounded-2xl bg-slate-900 text-white text-xs font-black">＋追加</button>
          <button id="lvOrder" class="py-3 rounded-2xl bg-white border text-xs font-black">表示：新→古</button>
          <button id="lvOnlyImp" class="py-3 rounded-2xl bg-white border text-xs font-black">重要のみ：OFF</button>
          <button id="lvMode" class="py-3 rounded-2xl bg-white border text-xs font-black">表示：カード</button>
        </div>

        <div id="lvAddBox" class="hidden bg-white border rounded-2xl p-3 space-y-2">
          <textarea id="lvAddText" class="w-full p-3 bg-slate-50 border rounded-2xl text-sm font-black" rows="3" placeholder="追加する記録内容（例：保護者へ連絡、AED到着 など）"></textarea>
          <div class="grid grid-cols-2 gap-2">
            <button id="lvAddDo" class="py-3 rounded-2xl bg-blue-600 text-white text-sm font-black">追加して保存</button>
            <button id="lvAddCancel" class="py-3 rounded-2xl bg-white border text-sm font-black">やめる</button>
          </div>
        </div>

        <div class="text-[10px] font-bold text-slate-500">件数：<span id="lvCount" class="font-black">0</span></div>
      </div>

      <div class="flex-1 overflow-y-auto p-3" id="lvBody"></div>

      <div class="border-t p-3 bg-white grid grid-cols-2 gap-2">
        <button id="lvCopy" class="py-4 rounded-2xl bg-white border font-black text-sm">コピー</button>
        <button id="lvShare" class="py-4 rounded-2xl bg-slate-900 text-white font-black text-sm">共有</button>
      </div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const HAS_POINTER = ("PointerEvent" in window);

/* ===================== v18: 全ボタン押下感（強制） ===================== */
(function installGlobalPressFeedback(){
  const add = (el)=>{ try{ el.classList.add("pressing"); }catch(e){} };
  const del = (el)=>{ try{ el.classList.remove("pressing"); }catch(e){} };
  const findBtn = (t)=> t && (t.closest ? t.closest("button, a") : null);

  document.addEventListener("pointerdown", (e)=>{
    const b = findBtn(e.target);
    if(b) add(b);
  }, true);
  document.addEventListener("pointerup", (e)=>{
    const b = findBtn(e.target);
    if(b) del(b);
  }, true);
  document.addEventListener("pointercancel", (e)=>{
    const b = findBtn(e.target);
    if(b) del(b);
  }, true);

  document.addEventListener("touchstart", (e)=>{
    const b = findBtn(e.target);
    if(b) add(b);
  }, {capture:true, passive:true});
  document.addEventListener("touchend", (e)=>{
    const b = findBtn(e.target);
    if(b) del(b);
  }, {capture:true, passive:true});
})();

/* ===================== v18: 二重発火ガード（共通） ===================== */
const __gate = new Map();
function gateOnce(key, ms=500){
  const now = Date.now();
  const prev = __gate.get(key) || 0;
  if(now - prev < ms) return false;
  __gate.set(key, now);
  return true;
}

/* v18: クリック/タップの「発火」は1種類に統一（pointer対応ならpointerupのみ、非対応ならclick） */
function bindActivate(el, handler, keyPrefix="act"){
  if(!el) return;
  const fn = (e)=>{
    try{
      e?.preventDefault?.();
      e?.stopPropagation?.();
    }catch(_){}
    // どのイベントから来ても1回に制限
    if(!gateOnce(`${keyPrefix}:${el.id || el.className || "x"}`, 450)) return;
    try{
      handler(e);
    }catch(err){
      console.error(err);
      alert("処理中にエラーが発生しました。\n（端末やブラウザによる場合があります）");
    }
  };

  if(HAS_POINTER){
    el.addEventListener("pointerup", fn, {passive:false});
  }else{
    el.addEventListener("click", fn, {passive:false});
  }
}

/* ===================== utils ===================== */
function nowTimeStr(d=new Date()){
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}
function fmtDateTime(ts){
  if(!ts) return "--";
  const d = new Date(ts);
  return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")} ${nowTimeStr(d)}`;
}
function msToElapsed(ms){
  if(ms==null || isNaN(ms)) return "--";
  const sec = Math.max(0, Math.floor(ms/1000));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  if(h>0) return `${h}時間${String(m).padStart(2,"0")}分`;
  if(m>0) return `${m}分${String(s).padStart(2,"0")}秒`;
  return `${s}秒`;
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function tapFlash(el){
  el.classList.add("tap-flash");
  setTimeout(()=> el.classList.remove("tap-flash"), 180);
}
function genId(){
  return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
}
function copyText(text){
  return navigator.clipboard.writeText(text).then(()=>alert("コピーしました")).catch(()=>{
    const ta=document.createElement("textarea");
    ta.value=text; document.body.appendChild(ta); ta.select();
    document.execCommand("copy"); document.body.removeChild(ta);
    alert("コピーしました");
  });
}
async function shareText(title, text){
  try{
    if(navigator.share){
      await navigator.share({ title, text });
      return;
    }
  }catch(e){}
  return copyText(text);
}
function downloadFile(filename, content, mime){
  const blob = new Blob([content], {type: mime || "text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function ymd_hm(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0");
  const mm=String(d.getMinutes()).padStart(2,"0");
  return `${y}${m}${da}_${hh}${mm}`;
}

/* v18: CSS.escape フォールバック */
function cssEscapeCompat(s){
  if(window.CSS && typeof CSS.escape === "function") return CSS.escape(String(s));
  return String(s).replace(/[^a-zA-Z0-9_\-]/g, (c)=> "\\" + c);
}

/* v18: DOM存在耐性（開始/終了エラー対策） */
function val(id){
  const el = $(id);
  return el ? (el.value ?? "") : "";
}
function setText(id, text){
  const el = $(id);
  if(el) el.textContent = text;
}

/* CSV helpers */
function csvEscape(v){
  const s = String(v ?? "");
  if(/[",\n\r]/.test(s)){
    return `"${s.replaceAll('"','""')}"`;
  }
  return s;
}
function toCSV(rows){
  return rows.map(r=>r.map(csvEscape).join(",")).join("\n");
}
function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let i = 0;
  let inQ = false;
  while(i < text.length){
    const ch = text[i];
    if(inQ){
      if(ch === '"'){
        if(text[i+1] === '"'){ cur += '"'; i += 2; continue; }
        inQ = false; i++; continue;
      }
      cur += ch; i++; continue;
    }else{
      if(ch === '"'){ inQ = true; i++; continue; }
      if(ch === ","){ row.push(cur); cur = ""; i++; continue; }
      if(ch === "\n"){
        row.push(cur); rows.push(row);
        row = []; cur = ""; i++; continue;
      }
      if(ch === "\r"){ i++; continue; }
      cur += ch; i++; continue;
    }
  }
  row.push(cur);
  rows.push(row);
  return rows.filter(r=>r.some(c=>String(c).trim()!==""));
}

/* ===================== defaults ===================== */
const DEFAULT_CASES = [
  "頭部打撲（転倒・衝突）",
  "切り傷・出血（工作/体育）",
  "骨折疑い（転倒・落下）",
  "熱中症疑い（屋外活動）",
  "アレルギー反応（じんましん等）",
  "喘息発作（呼吸苦）",
  "けいれん（ひきつけ）",
  "誤飲・窒息疑い",
  "腹痛・嘔吐（体調急変）",
  "意識消失（倒れた）"
];
const DEFAULT_CHECKS = [
  "周囲安全確保（危険除去・児童を離す）",
  "管理職へ連絡（状況共有）",
  "119通報（必要時）",
  "AED手配（場所確認→搬送）",
  "胸骨圧迫 / AED解析（必要時）",
  "正門誘導手配（誘導位置へ）",
  "保健室準備（毛布・氷・担架等）",
  "保護者へ連絡（状況共有）",
  "児童誘導（別室・導線確保）",
  "救急隊へ引継ぎ（記録渡し）"
];

const DEFAULT_QUICK_STATUS = [
  "意識あり|意識あり（明瞭）",
  "意識混濁|意識混濁（呼びかけに反応薄い）",
  "意識消失|意識消失・無反応",
  "呼吸正常|呼吸正常",
  "呼吸困難|呼吸困難（ゼーゼーする）",
  "呼吸停止|呼吸停止・死戦期呼吸（あえぎ呼吸）"
];
const DEFAULT_QUICK_SYMPTOMS = [
  "顔面蒼白|顔面蒼白（血の気が引いた）",
  "顔面紅潮|顔面紅潮（赤ら顔）",
  "冷や汗|冷や汗がひどい",
  "嘔吐あり|嘔吐（おうと）あり",
  "痙攣開始|痙攣（けいれん）開始",
  "痙攣消失|痙攣（けいれん）消失",
  "じんましん|全身にじんましん出現",
  "激しい腹痛|激しい腹痛",
  "失禁あり|失禁あり",
  "鼻出血|鼻出血（鼻血）"
];
const DEFAULT_QUICK_TREATMENT = [
  "エピペン使用|エピペン（自己注射薬）使用",
  "回復体位|回復体位（横向き）に固定",
  "衣服を緩める|衣服を緩める（襟元等）",
  "毛布で保温|毛布で保温開始",
  "冷却開始|保冷剤で患部を冷却中",
  "傷口洗浄|傷口を流水で洗浄",
  "圧迫止血|圧迫による止血処置",
  "胸骨圧迫開始|胸骨圧迫（心臓マッサージ）開始",
  "AED解析|AED装着・解析開始",
  "電気ショック|AEDによる電気ショック実施"
];

/* ===================== state ===================== */
let settings = {
  schoolName:"", schoolAddr:"", schoolPhone:"",
  casePresets:[...DEFAULT_CASES],
  checkPresets:[...DEFAULT_CHECKS],
  quickStatus:[...DEFAULT_QUICK_STATUS],
  quickSymptoms:[...DEFAULT_QUICK_SYMPTOMS],
  quickTreatment:[...DEFAULT_QUICK_TREATMENT]
};

let incident = {
  active:false,
  startTs:null,
  endTs:null,
  importantNext:false,
  entries:[],
  checklist:{},
  form:{
    place:"", pName:"", pGrade:"", pSex:"", pBirth:"",
    symptom:"", pHistory:"", pAllergy:""
  },
  computedAgeStr:"--"
};

function toggleCollapse(id){ const el=$(id); if(el) el.classList.toggle("hidden"); }
function toggleAccordion(id){
  const el = $(id);
  const icon = $("icon-" + id);
  if(!el || !icon) return;
  el.classList.toggle("open");
  icon.classList.toggle("rotate-180");
}

/* ===================== tab ===================== */
let activeTab = 1;

function switchTab(tabNum){
  activeTab = tabNum;

  // リロード後もタブ維持
  try{ sessionStorage.setItem("emergency_active_tab", String(activeTab)); }catch(e){}

  if(tabNum===1){
    $("section1")?.classList.remove("hidden");
    $("section2")?.classList.add("hidden");
    $("nav1")?.classList.replace("text-slate-400", "text-blue-600");
    $("nav2")?.classList.replace("text-blue-600", "text-slate-400");
  }else{
    $("section1")?.classList.add("hidden");
    $("section2")?.classList.remove("hidden");
    $("nav2")?.classList.replace("text-slate-400", "text-blue-600");
    $("nav1")?.classList.replace("text-blue-600", "text-slate-400");
    updateIncidentBar();
  }
}
$("nav1").onclick = () => switchTab(1);
$("nav2").onclick = () => switchTab(2);

/* リロード後も「今の場所」にとどまる（タブ＋スクロール） */
(function viewStatePersistence(){
  const TAB_KEY = "emergency_active_tab";
  const SCROLL_KEY = "emergency_scroll_y";

  function saveView(){
    try{
      sessionStorage.setItem(TAB_KEY, String(activeTab || 1));
      sessionStorage.setItem(SCROLL_KEY, String(window.scrollY || 0));
    }catch(e){}
  }

  window.addEventListener("beforeunload", saveView);
  window.addEventListener("pagehide", saveView);

  window.restoreViewState = function(){
    try{
      const t = parseInt(sessionStorage.getItem(TAB_KEY) || "1", 10);
      if(t === 2) switchTab(2); else switchTab(1);

      const y = parseInt(sessionStorage.getItem(SCROLL_KEY) || "0", 10);
      if(!isNaN(y)){
        setTimeout(()=>{ try{ window.scrollTo(0, y); }catch(e){} }, 0);
        setTimeout(()=>{ try{ window.scrollTo(0, y); }catch(e){} }, 120);
      }
    }catch(e){}
  };
})();

/* ===================== keys ===================== */
const SETTINGS_KEY_V18 = "school_emergency_settings_v18";
const INCIDENT_KEY_V18  = "school_emergency_incident_v18";
const SETTINGS_KEY_V17 = "school_emergency_settings_v17";
const INCIDENT_KEY_V17  = "school_emergency_incident_v17";

/* ===================== migration v17 -> v18 ===================== */
function migrateIfNeeded(){
  if(!localStorage.getItem(SETTINGS_KEY_V18)){
    const s17 = localStorage.getItem(SETTINGS_KEY_V17);
    if(s17) localStorage.setItem(SETTINGS_KEY_V18, s17);
  }
  if(!localStorage.getItem(INCIDENT_KEY_V18)){
    const i17 = localStorage.getItem(INCIDENT_KEY_V17);
    if(i17) localStorage.setItem(INCIDENT_KEY_V18, i17);
  }
}

/* ===================== settings UI ===================== */
function setPresetInputs(){
  document.querySelectorAll(".casePreset").forEach(inp=>{
    const idx = parseInt(inp.dataset.idx,10);
    inp.value = settings.casePresets[idx] ?? "";
  });
  document.querySelectorAll(".checkPreset").forEach(inp=>{
    const idx = parseInt(inp.dataset.idx,10);
    inp.value = settings.checkPresets[idx] ?? "";
  });
  document.querySelectorAll(".quickStatusPreset").forEach(inp=>{
    const idx = parseInt(inp.dataset.idx,10);
    inp.value = settings.quickStatus[idx] ?? "";
  });
  document.querySelectorAll(".quickSymptomsPreset").forEach(inp=>{
    const idx = parseInt(inp.dataset.idx,10);
    inp.value = settings.quickSymptoms[idx] ?? "";
  });
  document.querySelectorAll(".quickTreatmentPreset").forEach(inp=>{
    const idx = parseInt(inp.dataset.idx,10);
    inp.value = settings.quickTreatment[idx] ?? "";
  });
}
function compactListFromInputs(selector){
  const arr=[];
  document.querySelectorAll(selector).forEach(inp=>{
    const v=(inp.value||"").trim();
    if(v) arr.push(v);
  });
  return arr.slice(0,10);
}
function loadSettings(){
  const saved = localStorage.getItem(SETTINGS_KEY_V18);
  if(saved){
    try{
      const s=JSON.parse(saved);
      settings = {
        schoolName: s.schoolName ?? s.name ?? "",
        schoolAddr: s.schoolAddr ?? s.addr ?? "",
        schoolPhone: s.schoolPhone ?? s.phone ?? "",
        casePresets: Array.isArray(s.casePresets) ? s.casePresets.slice(0,10) : [...DEFAULT_CASES],
        checkPresets: Array.isArray(s.checkPresets) ? s.checkPresets.slice(0,10) : [...DEFAULT_CHECKS],
        quickStatus: Array.isArray(s.quickStatus) ? s.quickStatus.slice(0,10) : [...DEFAULT_QUICK_STATUS],
        quickSymptoms: Array.isArray(s.quickSymptoms) ? s.quickSymptoms.slice(0,10) : [...DEFAULT_QUICK_SYMPTOMS],
        quickTreatment: Array.isArray(s.quickTreatment) ? s.quickTreatment.slice(0,10) : [...DEFAULT_QUICK_TREATMENT],
      };
    }catch(e){}
  }
  if($("schoolName")) $("schoolName").value = settings.schoolName || "";
  if($("schoolAddr")) $("schoolAddr").value = settings.schoolAddr || "";
  if($("schoolPhone")) $("schoolPhone").value = settings.schoolPhone || "";
  setPresetInputs();
  renderCaseButtons();
  renderChecklist();
  renderQuickButtons();
}
function saveSettings(){
  settings.schoolName = val("schoolName");
  settings.schoolAddr = val("schoolAddr");
  settings.schoolPhone = val("schoolPhone");
  settings.casePresets = compactListFromInputs(".casePreset");
  settings.checkPresets = compactListFromInputs(".checkPreset");
  settings.quickStatus = compactListFromInputs(".quickStatusPreset");
  settings.quickSymptoms = compactListFromInputs(".quickSymptomsPreset");
  settings.quickTreatment = compactListFromInputs(".quickTreatmentPreset");
  localStorage.setItem(SETTINGS_KEY_V18, JSON.stringify(settings));
}

/* ===================== settings CSV export/import ===================== */
function settingsToCSV(){
  const rows = [];
  rows.push(["type","index","value"]);
  rows.push(["schoolName","",settings.schoolName||""]);
  rows.push(["schoolAddr","",settings.schoolAddr||""]);
  rows.push(["schoolPhone","",settings.schoolPhone||""]);
  (settings.casePresets||[]).slice(0,10).forEach((v,i)=> rows.push(["case", String(i+1), v]));
  (settings.checkPresets||[]).slice(0,10).forEach((v,i)=> rows.push(["check", String(i+1), v]));
  (settings.quickStatus||[]).slice(0,10).forEach((v,i)=> rows.push(["quickStatus", String(i+1), v]));
  (settings.quickSymptoms||[]).slice(0,10).forEach((v,i)=> rows.push(["quickSymptoms", String(i+1), v]));
  (settings.quickTreatment||[]).slice(0,10).forEach((v,i)=> rows.push(["quickTreatment", String(i+1), v]));
  return toCSV(rows);
}
function applySettingsFromCSV(csvText){
  const rows = parseCSV(csvText);
  if(rows.length < 2) throw new Error("CSVの内容が不足しています");

  const head = rows[0].map(x=>String(x||"").trim());
  const tIdx = head.indexOf("type");
  const vIdx = head.indexOf("value");
  if(tIdx === -1 || vIdx === -1) throw new Error("CSVヘッダーが不正です（type,valueが必要）");

  const next = {
    schoolName:"", schoolAddr:"", schoolPhone:"",
    casePresets:[],
    checkPresets:[],
    quickStatus:[],
    quickSymptoms:[],
    quickTreatment:[]
  };

  for(let r=1; r<rows.length; r++){
    const row = rows[r];
    const type = String(row[tIdx] ?? "").trim();
    const val  = String(row[vIdx] ?? "").trim();
    if(!type) continue;

    if(type === "schoolName") next.schoolName = val;
    else if(type === "schoolAddr") next.schoolAddr = val;
    else if(type === "schoolPhone") next.schoolPhone = val;
    else if(type === "case") next.casePresets.push(val);
    else if(type === "check") next.checkPresets.push(val);
    else if(type === "quickStatus") next.quickStatus.push(val);
    else if(type === "quickSymptoms") next.quickSymptoms.push(val);
    else if(type === "quickTreatment") next.quickTreatment.push(val);
  }

  settings = {
    schoolName: next.schoolName || "",
    schoolAddr: next.schoolAddr || "",
    schoolPhone: next.schoolPhone || "",
    casePresets: (next.casePresets.length ? next.casePresets : DEFAULT_CASES).slice(0,10),
    checkPresets: (next.checkPresets.length ? next.checkPresets : DEFAULT_CHECKS).slice(0,10),
    quickStatus: (next.quickStatus.length ? next.quickStatus : DEFAULT_QUICK_STATUS).slice(0,10),
    quickSymptoms: (next.quickSymptoms.length ? next.quickSymptoms : DEFAULT_QUICK_SYMPTOMS).slice(0,10),
    quickTreatment: (next.quickTreatment.length ? next.quickTreatment : DEFAULT_QUICK_TREATMENT).slice(0,10),
  };

  localStorage.setItem(SETTINGS_KEY_V18, JSON.stringify(settings));
  loadSettings();
}

/* ===================== incident load/save ===================== */
function ensureEntryIds(){
  incident.entries = (Array.isArray(incident.entries) ? incident.entries : []).map(e=>{
    if(!e) return null;
    return {
      id: e.id || genId(),
      ts: e.ts || Date.now(),
      time: e.time || nowTimeStr(new Date(e.ts || Date.now())),
      text: e.text || "",
      important: !!e.important
    };
  }).filter(Boolean);
}
function saveIncident(){
  // v18: DOMが無いケースでも落ちない
  incident.form = {
    place: val("place"),
    pName: val("pName"),
    pGrade: val("pGrade"),
    pSex: val("pSex"),
    pBirth: val("pBirth"),
    symptom: val("symptom"),
    pHistory: val("pHistory"),
    pAllergy: val("pAllergy")
  };
  ensureEntryIds();
  localStorage.setItem(INCIDENT_KEY_V18, JSON.stringify(incident));
}
function loadIncident(){
  const saved = localStorage.getItem(INCIDENT_KEY_V18);
  if(saved){
    try{
      const i=JSON.parse(saved);
      incident = {
        ...incident,
        ...i,
        entries: Array.isArray(i.entries) ? i.entries : [],
        checklist: (i.checklist && typeof i.checklist==="object") ? i.checklist : {},
        form: (i.form && typeof i.form==="object") ? i.form : incident.form,
        computedAgeStr: i.computedAgeStr ?? incident.computedAgeStr
      };
    }catch(e){}
  }

  ensureEntryIds();

  if($("place")) $("place").value   = incident.form.place || "";
  if($("pName")) $("pName").value   = incident.form.pName || "";
  if($("pGrade")) $("pGrade").value  = incident.form.pGrade || "";
  if($("pSex")) $("pSex").value    = incident.form.pSex || "";
  if($("pBirth")) $("pBirth").value  = incident.form.pBirth || "";
  if($("symptom")) $("symptom").value = incident.form.symptom || "";
  if($("pHistory")) $("pHistory").value = incident.form.pHistory || "";
  if($("pAllergy")) $("pAllergy").value = incident.form.pAllergy || "";

  if($("ageDisplay")) $("ageDisplay").innerText = `年齢：${incident.computedAgeStr || "--"} 歳`;
  renderTimeline();
  renderChecklist();
  updateIncidentBar();
  buildScript();
}

/* ===================== age ===================== */
function updateAge(){
  const birthVal = val("pBirth");
  const gradeVal = val("pGrade");
  const now = new Date();

  let computedAgeStr = "--";
  if(birthVal){
    const bd = new Date(birthVal);
    let age = now.getFullYear() - bd.getFullYear();
    const m = now.getMonth() - bd.getMonth();
    if(m < 0 || (m===0 && now.getDate() < bd.getDate())) age--;
    computedAgeStr = String(age);
  }else if(gradeVal && !isNaN(gradeVal)){
    const g = parseInt(gradeVal,10);
    computedAgeStr = `${g+5}〜${g+6}`;
  }else{
    computedAgeStr = "--";
  }
  incident.computedAgeStr = computedAgeStr;
  if($("ageDisplay")) $("ageDisplay").innerText = `年齢：${computedAgeStr} 歳`;
  saveIncident();
  buildScript();
}

/* ===================== script ===================== */
function buildScript(){
  const gradeVal = val("pGrade");
  const gradeStr = gradeVal
    ? (String(gradeVal).match(/^\d$/) ? `${gradeVal}年生` : gradeVal)
    : "（不明）";

  const ageStr = (incident.computedAgeStr && incident.computedAgeStr!=="--") ? `${incident.computedAgeStr}歳` : "";

  const data = {
    school: val("schoolName") || "（学校名）",
    addr: val("schoolAddr") || "（学校住所）",
    place: val("place") || "（場所不明）",
    phone: val("schoolPhone") || "（電話）",
    pName: val("pName") || "（氏名不明）",
    pGrade: gradeStr,
    pSex: val("pSex") || "（性別不明）",
    symptom: val("symptom") || "（症状不明）",
    history: val("pHistory") || "（未入力）",
    allergy: val("pAllergy") || "（未入力）",
    age: ageStr
  };

  const el = $("scriptDisplay");
  if(!el) return;
  el.innerText =
`「救急要請です」
場所：${data.school}
住所：${data.addr}
詳細：${data.place}
電話：${data.phone}

対象：${data.pName}さん（${data.pGrade}・${data.pSex}${data.age ? "・" + data.age : ""}）
症状：${data.symptom}
既往歴：${data.history}
アレルギー：${data.allergy}`;
}

/* ===================== logging ===================== */
function addEntry(text, forceImportant=false){
  const t = (text||"").trim();
  if(!t) return;

  const d = new Date();
  const e = {
    id: genId(),
    ts: d.getTime(),
    time: nowTimeStr(d),
    text: t,
    important: forceImportant ? true : !!incident.importantNext
  };

  incident.entries.push(e);

  incident.importantNext = false;
  const btn = $("btnToggleImportant");
  if(btn){
    btn.textContent = "重要：OFF";
    btn.classList.remove("bg-amber-400","border-amber-400","text-slate-900");
    btn.classList.add("border");
  }

  saveIncident();
  renderTimeline();
  updateIncidentBar();
}

function renderTimeline(){
  const wrap = $("timeline");
  const empty = $("timelineEmpty");
  if(!wrap || !empty) return;

  wrap.innerHTML = "";
  const entries = Array.isArray(incident.entries) ? incident.entries : [];

  if(entries.length===0){
    empty.classList.remove("hidden");
    wrap.appendChild(empty);
    updateIncidentBar();
    return;
  }
  empty.classList.add("hidden");
  wrap.appendChild(empty);

  const list = entries.slice().reverse();
  list.forEach(e=>{
    const div = document.createElement("div");
    div.className = `flex gap-3 bg-white p-4 rounded-2xl shadow-sm border ${e.important ? "border-amber-300 bg-amber-50" : "border-slate-200"}`;
    div.innerHTML = `
      <div class="shrink-0">
        <div class="text-blue-600 font-black text-xs">${escapeHtml(e.time)}</div>
        <div class="mt-1 text-[10px] font-black ${e.important ? "text-amber-700" : "text-slate-400"}">${e.important ? "★重要" : ""}</div>
      </div>
      <div class="flex-1 text-slate-900 text-sm font-black whitespace-pre-wrap break-words">${escapeHtml(e.text)}</div>
    `;
    wrap.appendChild(div);
  });

  updateIncidentBar();
}

/* ===================== incident bar ===================== */
let incidentTimer = null;

/* ✅ v25: 最新LOG表示（ここに反映） */
function updateLatestLogPreview(){
  const el = $("latestLogPreview");
  if(!el) return;
  const entries = Array.isArray(incident.entries) ? incident.entries : [];
  if(entries.length===0){
    el.textContent = "最新LOG：（記録なし）";
    return;
  }
  const last = entries[entries.length - 1];
  const raw = String(last.text || "").replace(/\s+/g, " ").trim();
  const short = raw.length > 40 ? (raw.slice(0, 40) + "…") : raw;
  el.textContent = `最新LOG：${last.time} ${short || "（内容なし）"}`;
}

function updateIncidentBar(){
  setText("incidentStartLabel", incident.startTs ? fmtDateTime(incident.startTs).split(" ").slice(-1)[0] : "--:--");
  const entries = Array.isArray(incident.entries) ? incident.entries : [];
  setText("lastEntryLabel", entries.length ? entries[entries.length-1].time : "--:--");

  /* ✅ v25 */
  updateLatestLogPreview();

  if(incident.active && incident.startTs){
    setText("incidentElapsedLabel", msToElapsed(Date.now() - incident.startTs));
  }else if(!incident.active && incident.startTs && incident.endTs){
    setText("incidentElapsedLabel", msToElapsed(incident.endTs - incident.startTs));
  }else{
    setText("incidentElapsedLabel", "--");
  }

  $("btnStartIncident")?.classList.toggle("opacity-50", incident.active);
  $("btnStopIncident")?.classList.toggle("opacity-50", !incident.active);
}
function startIncident(){
  if(incident.active) return;
  incident.active = true;
  incident.startTs = incident.startTs || Date.now();
  incident.endTs = null;
  saveIncident();
  addEntry("記録開始", true);
  updateIncidentBar();
  startIncidentTimer();
}
function stopIncident(){
  if(!incident.active) return;
  incident.active = false;
  incident.endTs = Date.now();
  saveIncident();
  addEntry("記録終了（引き継ぎ完了など）", true);
  updateIncidentBar();
  stopIncidentTimer();
}
function startIncidentTimer(){
  if(incidentTimer) clearInterval(incidentTimer);
  incidentTimer = setInterval(()=>updateIncidentBar(), 1000);
}
function stopIncidentTimer(){
  if(incidentTimer) clearInterval(incidentTimer);
  incidentTimer = null;
}

/* ===================== checklist ===================== */
function checklistItems(){
  return (settings.checkPresets || []).filter(Boolean).slice(0,10);
}
function renderChecklist(){
  const wrap = $("checklist");
  if(!wrap) return;
  wrap.innerHTML = "";
  const items = checklistItems();

  if(items.length===0){
    wrap.innerHTML = `<div class="text-center text-sm font-black text-slate-400 py-6 border rounded-2xl bg-slate-50">
      （チェック項目が未設定です。学校情報で入力してください）
    </div>`;
    return;
  }

  items.forEach(label=>{
    const checked = !!incident.checklist[label];
    const row = document.createElement("button");
    row.className = `w-full text-left border rounded-2xl p-3 flex items-start gap-3 ${checked ? "bg-emerald-50 border-emerald-200" : "bg-white border-slate-200"}`;
    row.innerHTML = `
      <div class="mt-0.5 w-7 h-7 rounded-xl flex items-center justify-center ${checked ? "bg-emerald-600 text-white" : "bg-slate-100 text-slate-500"} font-black text-xs">
        ${checked ? "✓" : ""}
      </div>
      <div class="flex-1">
        <div class="font-black text-sm text-slate-900">${escapeHtml(label)}</div>
        <div class="text-[10px] font-black ${checked ? "text-emerald-700" : "text-slate-500"}">
          ${checked ? "完了（タップで解除）" : "未（タップで完了）"}
        </div>
      </div>
    `;
    row.onclick = ()=>{
      incident.checklist[label] = !incident.checklist[label];
      saveIncident();
      renderChecklist();
      addEntry((incident.checklist[label] ? "初動チェック完了： " : "初動チェック解除： ") + label);
    };
    wrap.appendChild(row);
  });
}
function resetChecklist(){
  incident.checklist = {};
  saveIncident();
  renderChecklist();
  addEntry("初動チェック：全解除");
}

/* ===================== cases ===================== */
function renderCaseButtons(){
  const wrap = $("caseButtons");
  if(!wrap) return;
  wrap.innerHTML = "";
  const cases = (settings.casePresets || []).filter(Boolean).slice(0,10);

  if(cases.length===0){
    wrap.innerHTML = `<div class="col-span-2 text-center text-sm font-black text-slate-400 py-6 border rounded-2xl bg-slate-50">
      （ケース未設定です。学校情報で入力してください）
    </div>`;
    return;
  }

  cases.forEach(label=>{
    const btn = document.createElement("button");
    btn.className = "quick-tag bg-amber-50 border border-amber-200 text-amber-900 rounded-2xl text-xs font-black";
    btn.textContent = label;
    btn.onclick = ()=>{
      tapFlash(btn);
      const cur = (val("symptom")).trim();
      const add = label;
      const sEl = $("symptom");
      if(sEl){
        sEl.value = cur ? (cur.includes(add) ? cur : (cur + " / " + add)) : add;
      }
      buildScript();
      saveIncident();
      addEntry(`ケース選択：${label}`, true);
    };
    wrap.appendChild(btn);
  });
}

/* ===================== quick inputs ===================== */
function parseQuickLine(line){
  const raw = (line||"").trim();
  if(!raw) return null;
  if(raw.includes("|")){
    const [left, ...rest] = raw.split("|");
    const label = (left||"").trim();
    const val = rest.join("|").trim();
    if(!label && !val) return null;
    return { label: label || val || raw, val: val || label || raw };
  }
  const display = raw.split("（")[0].trim() || raw;
  return { label: display.length > 10 ? display.slice(0,10) : display, val: raw };
}
function renderQuickGrid(gridId, lines, theme){
  const grid = $(gridId);
  if(!grid) return;
  grid.innerHTML = "";
  const items = (lines || []).filter(Boolean).slice(0,10).map(parseQuickLine).filter(Boolean);

  if(items.length===0){
    grid.innerHTML = `<div class="col-span-2 text-center text-sm font-black text-slate-400 py-6 border rounded-2xl bg-slate-50">
      （未設定です。学校情報で入力してください）
    </div>`;
    return;
  }

  items.forEach(it=>{
    const btn = document.createElement("button");
    btn.className = `quick-tag rounded-lg text-xs font-black ${theme}`;
    btn.textContent = it.label;
    btn.onclick = ()=>{
      tapFlash(btn);
      addEntry(it.val);
    };
    grid.appendChild(btn);
  });
}
function renderQuickButtons(){
  renderQuickGrid("quickStatusGrid", settings.quickStatus, "bg-blue-100 text-blue-800");
  renderQuickGrid("quickSymptomsGrid", settings.quickSymptoms, "bg-slate-50 border text-slate-800");
  renderQuickGrid("quickTreatmentGrid", settings.quickTreatment, "bg-green-100 text-green-800");
}

/* ===================== voice ===================== */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let isRecording = false;
let voiceBase = "";
let voiceInterim = "";

function isIOS(){
  const ua = navigator.userAgent || "";
  return /iPhone|iPad|iPod/.test(ua);
}
function isSecure(){
  return window.isSecureContext || location.protocol === "https:" || location.hostname === "localhost";
}

/* ✅ v25: 説明を簡潔化 */
function voiceSupportedHint(){
  const el = $("voiceSupportHint");
  if(!el) return;
  if(SpeechRecognition && isSecure() && !isIOS()){
    el.textContent = "✅ 音声ボタンで入力可（うまく動かない場合は下の「キーボードのマイク」）";
  }else{
    el.textContent = "※ うまく動かない場合は下の「キーボードのマイク」で入力";
  }
}

function setupRecognition(){
  if(!SpeechRecognition) return;
  try{
    recognition = new SpeechRecognition();
  }catch(e){
    recognition = null;
    return;
  }
  recognition.lang = "ja-JP";
  try{ recognition.continuous = true; }catch(e){}
  try{ recognition.interimResults = true; }catch(e){}

  recognition.onresult = (event)=>{
    let interim = "";
    let final = "";
    for(let i=event.resultIndex; i<event.results.length; i++){
      if(event.results[i].isFinal) final += event.results[i][0].transcript;
      else interim += event.results[i][0].transcript;
    }

    if(final){
      voiceBase += final;
      voiceInterim = "";
    }else{
      voiceInterim = interim;
    }

    const area = $("voiceInputArea");
    if(area) area.value = (voiceBase + voiceInterim).trimStart();
    if($("interimText")) $("interimText").innerText = voiceInterim ? voiceInterim : "";
    saveIncident();
  };

  recognition.onerror = (e)=>{
    if($("interimText")) $("interimText").innerText = "";
    stopRecUIOnly();
    const msg = e?.error ? `音声入力エラー：${e.error}` : "音声入力エラー";
    alert(msg + "\n\n動かない場合：\n・HTTPSで開く\n・権限（マイク）許可\n・iPhoneは「キーボードのマイク」で入力");
  };

  recognition.onend = ()=>{
    if(isRecording){
      try{ recognition.start(); }catch(e){}
    }
  };
}
function stopRecUIOnly(){
  $("pulseRing")?.classList.add("hidden");
  const b = $("btnVoiceRec");
  if(b){
    b.classList.remove("bg-red-600");
    b.classList.add("bg-blue-600");
  }
  setText("micText","REC START");
}
function stopRec(){
  isRecording = false;
  try{ if(recognition) recognition.stop(); }catch(e){}
  stopRecUIOnly();
  if($("interimText")) $("interimText").innerText = "";
  if(voiceInterim){
    voiceBase += voiceInterim;
    voiceInterim = "";
    const area = $("voiceInputArea");
    if(area) area.value = voiceBase.trimStart();
  }
  saveIncident();
}
function focusForKeyboardDictation(){
  stopRec();
  const area = $("voiceInputArea");
  if(area){
    area.focus();
    area.scrollIntoView({behavior:"smooth", block:"center"});
    area.classList.add("ring-2","ring-amber-400");
    setTimeout(()=>{ try{ area.classList.remove("ring-2","ring-amber-400"); }catch(e){} }, 1200);
  }
  if($("voiceSupportHint")){
    $("voiceSupportHint").textContent = "👇 キーボードのマイクで入力";
  }
  if($("interimText")) $("interimText").innerText = "";
}
function startRec(){
  if(isIOS() && !SpeechRecognition){
    focusForKeyboardDictation();
    return;
  }
  if(!recognition){
    focusForKeyboardDictation();
    return;
  }
  if(!isSecure()){
    alert("このページがHTTPSではありません。\n音声入力はHTTPSでないと動かない場合があります。\n\n可能ならHTTPSで開いてください。");
  }

  isRecording = true;
  voiceBase = (val("voiceInputArea") || "");
  voiceInterim = "";

  try{ recognition.start(); }catch(e){
    isRecording = false;
    focusForKeyboardDictation();
    return;
  }

  $("pulseRing")?.classList.remove("hidden");
  const b = $("btnVoiceRec");
  if(b){
    b.classList.remove("bg-blue-600");
    b.classList.add("bg-red-600");
  }
  setText("micText","REC ON");
}

/* ===================== log viewer ===================== */
let lvOrderNewestFirst = true;
let lvOnlyImportant = false;
let lvMode = "card";
let lvEditingId = null;

function entriesToText(entries){
  return entries.map(e=>`${e.time} ${e.important ? "★ " : ""}${e.text}`).join("\n") || "（記録なし）";
}
function filteredEntries(){
  const q = (val("lvSearch")||"").trim().toLowerCase();
  let entries = incident.entries.slice();

  if(lvOnlyImportant) entries = entries.filter(e=>!!e.important);
  if(q){
    entries = entries.filter(e=>{
      const t=(e.text||"").toLowerCase();
      const tm=(e.time||"").toLowerCase();
      return t.includes(q) || tm.includes(q);
    });
  }
  if(lvOrderNewestFirst) entries = entries.slice().reverse();
  return entries;
}
function updateEntryById(id, patch){
  const idx = incident.entries.findIndex(e=>e.id===id);
  if(idx<0) return false;
  incident.entries[idx] = { ...incident.entries[idx], ...patch };
  saveIncident();
  renderTimeline();
  updateIncidentBar();
  return true;
}
function deleteEntryById(id){
  const idx = incident.entries.findIndex(e=>e.id===id);
  if(idx<0) return false;
  incident.entries.splice(idx,1);
  if(lvEditingId === id) lvEditingId = null;
  saveIncident();
  renderTimeline();
  updateIncidentBar();
  return true;
}

function openLogViewer(){
  $("logViewerWrap")?.classList.remove("hidden");
  renderLogViewer();
}
function closeLogViewer(){
  $("logViewerWrap")?.classList.add("hidden");
  lvEditingId = null;
  $("lvAddBox")?.classList.add("hidden");
  if($("lvAddText")) $("lvAddText").value = "";
}

function renderLogViewer(){
  const list = filteredEntries();
  setText("lvCount", String(list.length));
  setText("lvOrder", `表示：${lvOrderNewestFirst ? "新→古" : "古→新"}`);
  setText("lvOnlyImp", `重要のみ：${lvOnlyImportant ? "ON" : "OFF"}`);
  setText("lvMode", `表示：${lvMode==="card" ? "カード" : "テキスト"}`);

  const body = $("lvBody");
  if(!body) return;
  body.innerHTML = "";

  if(lvMode==="text"){
    const pre=document.createElement("pre");
    pre.className="w-full whitespace-pre-wrap break-words text-sm font-black bg-slate-50 border rounded-2xl p-3";
    pre.textContent = entriesToText(list);
    body.appendChild(pre);
    return;
  }

  if(list.length===0){
    body.innerHTML = `<div class="text-center text-sm font-black text-slate-400 py-10">（該当する記録がありません）</div>`;
    return;
  }

  list.forEach(e=>{
    const isEditing = (lvEditingId === e.id);
    const card=document.createElement("div");
    card.className=`bg-white border rounded-2xl p-3 shadow-sm mb-2 ${e.important ? "border-amber-300" : "border-slate-200"}`;

    card.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="shrink-0">
          <div class="text-blue-600 font-black text-xs">${escapeHtml(e.time)}</div>
          <button data-action="toggleImp" data-id="${escapeHtml(e.id)}" class="mt-1 text-[10px] font-black ${e.important ? "text-amber-600" : "text-slate-400"}">
            ${e.important ? "★重要（解除）" : "☆重要にする"}
          </button>
        </div>

        <div class="flex-1">
          ${isEditing
            ? `<textarea data-edit-id="${escapeHtml(e.id)}" class="w-full p-3 bg-slate-50 border rounded-2xl text-sm font-black" rows="3">${escapeHtml(e.text)}</textarea>
               <div class="grid grid-cols-2 gap-2 mt-2">
                 <button data-action="save" data-id="${escapeHtml(e.id)}" class="py-3 rounded-2xl bg-blue-600 text-white text-sm font-black">保存</button>
                 <button data-action="cancel" data-id="${escapeHtml(e.id)}" class="py-3 rounded-2xl bg-white border text-sm font-black">キャンセル</button>
               </div>`
            : `<div class="text-sm font-black whitespace-pre-wrap break-words">${escapeHtml(e.text||"")}</div>`
          }
        </div>
      </div>

      ${isEditing ? "" : `
      <div class="grid grid-cols-2 gap-2 mt-3">
        <button data-action="edit" data-id="${escapeHtml(e.id)}" class="py-3 rounded-2xl bg-white border text-sm font-black">編集</button>
        <button data-action="del" data-id="${escapeHtml(e.id)}" class="py-3 rounded-2xl bg-white border text-sm font-black text-red-600">削除</button>
      </div>`}
    `;
    body.appendChild(card);
  });
}

/* v18: 削除確認が2回出る問題 → イベントを1種類に統一＋ゲートで確実に1回 */
function handleLvAction(ev){
  const btn = ev.target.closest && ev.target.closest("button[data-action]");
  if(!btn) return;

  ev.preventDefault?.();
  ev.stopPropagation?.();

  const act = btn.dataset.action;
  const id = btn.dataset.id;

  // v18: ここで「アクション単位」にもゲート（確実に1回）
  if(!gateOnce(`lv:${act}:${id}`, 600)) return;

  if(act==="toggleImp"){
    const e = incident.entries.find(x=>x.id===id);
    if(!e) return;
    updateEntryById(id, { important: !e.important });
    renderLogViewer();
    return;
  }
  if(act==="edit"){
    lvEditingId = id;
    renderLogViewer();
    return;
  }
  if(act==="cancel"){
    lvEditingId = null;
    renderLogViewer();
    return;
  }
  if(act==="save"){
    const sel = `textarea[data-edit-id="${cssEscapeCompat(id)}"]`;
    const ta = document.querySelector(sel);
    const newText = (ta?.value || "").trim();
    if(!newText){
      alert("空の記録は保存できません。");
      return;
    }
    updateEntryById(id, { text: newText });
    lvEditingId = null;
    renderLogViewer();
    return;
  }
  if(act==="del"){
    const ok = confirm("この記録を削除します。よろしいですか？");
    if(!ok) return;
    deleteEntryById(id);         // ← ここは1回だけ
    lvEditingId = null;
    renderLogViewer();
    return;
  }
}

/* v18: lvBodyのイベントは「1種類だけ」 */
(function bindLvBody(){
  const body = $("lvBody");
  if(!body) return;
  if(HAS_POINTER){
    body.addEventListener("pointerup", handleLvAction, {passive:false});
  }else{
    body.addEventListener("click", handleLvAction, {passive:false});
  }
})();

/* ===================== report build (print + word) ===================== */
function buildReportData(){
  const schoolName = val("schoolName") || "未設定";
  const schoolAddr = val("schoolAddr") || "住所未設定";
  const schoolPhone = val("schoolPhone") || "電話未設定";
  const schoolLine = `${schoolName}\n${schoolAddr}\n${schoolPhone}`;

  const start = incident.startTs ? fmtDateTime(incident.startTs) : "未記録";
  const end   = incident.endTs ? fmtDateTime(incident.endTs) : (incident.active ? "継続中" : "未記録");
  const elapsed = (incident.startTs && (incident.endTs || incident.active))
    ? msToElapsed((incident.endTs || Date.now()) - incident.startTs)
    : "--";

  const gradeVal = val("pGrade") || "-";
  const gradeStr = String(gradeVal).match(/^\d$/) ? `${gradeVal}年` : gradeVal;
  const patientLine = `${val("pName") || "氏名未詳"} / ${gradeStr} / ${val("pSex") || "-"} / ${incident.computedAgeStr || "--"}歳`;

  const medSym = val("symptom") || "未入力";
  const medHis = val("pHistory") || "未入力";
  const medAll = val("pAllergy") || "未入力";
  const medInfo = `現在の主な症状：${medSym}\n既往歴：${medHis}\nアレルギー：${medAll}`;

  const items = checklistItems();
  const ok = items.filter(x=>incident.checklist[x]);
  const ng = items.filter(x=>!incident.checklist[x]);

  return {
    created: new Date().toLocaleString("ja-JP"),
    schoolLine,
    incidentLine: `開始：${start}\n終了：${end}\n経過：${elapsed}`,
    patientLine,
    medInfo,
    checklistOk: ok,
    checklistNg: ng,
    entries: incident.entries.slice()
  };
}

/* 旧コードのWord出力レイアウトに復帰 */
function buildWordHtml(data){
  const schoolHtml = escapeHtml(data.schoolLine).replaceAll("\n","<br>");
  const medHtml = escapeHtml(data.medInfo).replaceAll("\n","<br>");
  const incidentHtml = escapeHtml(data.incidentLine).replaceAll("\n","<br>");
  const checklistHtml = data.checklistOk.length
    ? data.checklistOk.map(x=>`✓ ${escapeHtml(x)}`).join("<br>")
    : "（完了なし）";

  const timelineHtml = data.entries.length
    ? data.entries.map(e=>`
      <div class="timeline-item">
        <div class="time">${escapeHtml(e.time)}${e.important ? " ★" : ""}</div>
        <div class="text">${escapeHtml(e.text).replaceAll("\n","<br>")}</div>
      </div>
    `).join("")
    : `<div class="timeline-item"><div class="text">記録はありません</div></div>`;

  return `
<html>
<head>
<meta charset="UTF-8">
<style>
  body{ font-family: "Meiryo","Yu Gothic","MS PGothic",sans-serif; line-height:1.45; }
  h1{ font-size: 20pt; margin: 0 0 6pt 0; }
  .sub{ color:#666; font-size:10pt; margin-bottom:10pt; }
  .box{ border:1px solid #000; padding:10pt; }
  table{ width:100%; border-collapse:collapse; }
  td{ vertical-align:top; }
  .label{ font-size:9pt; color:#666; font-weight:700; margin:0 0 4pt 0; }
  .val{ font-size:10.5pt; font-weight:700; margin:0; }
  .rowline{ border-top:1px solid #ccc; padding-top:8pt; margin-top:8pt; }
  .timeline-wrap{ border-top:2px solid #000; margin-top:6pt; }
  .timeline-item{ border-bottom:1px solid #ccc; padding:8pt 0; page-break-inside: avoid; }
  .time{ width:90px; display:inline-block; font-weight:700; }
  .text{ display:inline-block; width:calc(100% - 100px); white-space:pre-wrap; word-break:break-word; font-weight:700; }
</style>
</head>
<body>
  <h1>救急対応・経過記録</h1>
  <div class="sub">作成日：${escapeHtml(data.created)}（端末ローカル記録）</div>

  <div class="box">
    <table>
      <tr>
        <td style="width:50%; padding-right:10pt;">
          <p class="label">学校名 / 住所 / 電話</p>
          <p class="val">${schoolHtml}</p>
        </td>
        <td style="width:50%;">
          <p class="label">開始 / 終了 / 経過</p>
          <p class="val">${incidentHtml}</p>
        </td>
      </tr>
      <tr>
        <td colspan="2" class="rowline">
          <p class="label">傷病者（氏名 / 学年 / 性別 / 年齢）</p>
          <p class="val">${escapeHtml(data.patientLine)}</p>
        </td>
      </tr>
      <tr>
        <td colspan="2" class="rowline">
          <p class="label">現在の主な症状・既往歴・アレルギー</p>
          <p style="margin:0; font-weight:700;">${medHtml}</p>
        </td>
      </tr>
      <tr>
        <td colspan="2" class="rowline">
          <p class="label">初動チェック状況</p>
          <div style="font-weight:700;">${checklistHtml}</div>
        </td>
      </tr>
    </table>
  </div>

  <h2 style="font-size:14pt;border-left:4px solid #000;padding-left:6pt;margin:12pt 0 6pt 0;">時系列記録</h2>
  <div class="timeline-wrap">
    ${timelineHtml}
  </div>
</body>
</html>`;
}

/* ===================== print（旧レイアウトに復帰） ===================== */
$("btnPrint").onclick = ()=>{
  const d = buildReportData();
  setText("printTimestamp", `作成日：${d.created}`);

  const sc = $("printSchoolInfo");
  if(sc) sc.innerHTML = escapeHtml(d.schoolLine).replaceAll("\n","<br>");

  const inc = $("printIncidentInfo");
  if(inc) inc.innerHTML = escapeHtml(d.incidentLine).replaceAll("\n","<br>");

  setText("printPatientInfo", d.patientLine);

  const med = $("printMedicalInfo");
  if(med) med.innerHTML = escapeHtml(d.medInfo).replaceAll("\n","<br>");

  const chk = $("printChecklist");
  if(chk){
    chk.innerHTML = d.checklistOk.length
      ? d.checklistOk.map(x=>`<div>✓ ${escapeHtml(x)}</div>`).join("")
      : "（完了なし）";
  }

  const tl = $("printTimeline");
  if(tl){
    tl.innerHTML = "";
    if(d.entries.length===0){
      tl.innerHTML = `<div class="timeline-item py-2 text-sm text-gray-500">記録はありません</div>`;
    }else{
      d.entries.forEach(e=>{
        const item = document.createElement("div");
        item.className = "timeline-item py-2 flex gap-3";
        item.innerHTML = `
          <div class="w-20 font-bold whitespace-nowrap">${escapeHtml(e.time)}${e.important ? " ★" : ""}</div>
          <div class="flex-1 whitespace-pre-wrap break-words font-bold">${escapeHtml(e.text)}</div>
        `;
        tl.appendChild(item);
      });
    }
  }

  window.print();
};

/* ===================== Word export（旧レイアウトに復帰） ===================== */
$("btnWord").onclick = ()=>{
  const d = buildReportData();
  const html = buildWordHtml(d);
  const content = "\ufeff" + html;
  downloadFile(`救急搬送_経過記録_${ymd_hm()}.doc`, content, "application/msword");
  alert("Wordファイル（.doc）を保存しました。\n（Wordで開けます）");
};

/* ===================== wiring ===================== */
$("btnAddTimeline").onclick = ()=>{
  const text = (val("voiceInputArea") || "").trim();
  if(!text) return;
  addEntry(text);
  if($("voiceInputArea")) $("voiceInputArea").value = "";
  voiceBase = ""; voiceInterim = "";
  stopRec();
};

$("btnToggleImportant").onclick = ()=>{
  incident.importantNext = !incident.importantNext;
  const b = $("btnToggleImportant");
  if(b){
    b.textContent = incident.importantNext ? "重要：ON" : "重要：OFF";
    if(incident.importantNext){
      b.classList.add("bg-amber-400","border-amber-400","text-slate-900");
      b.classList.remove("border");
    }else{
      b.classList.remove("bg-amber-400","border-amber-400","text-slate-900");
      b.classList.add("border");
    }
  }
  saveIncident();
};

$("btnCopyTimeline").onclick = ()=> copyText(entriesToText(incident.entries));
$("btnCopyScript").onclick = ()=> copyText($("scriptDisplay")?.innerText || "");
$("btnShareScript").onclick = ()=> shareText("119通報用原稿", $("scriptDisplay")?.innerText || "");

/* v18: 記録開始/終了を bindActivate（イベント統一＋二重発火防止） */
bindActivate($("btnStartIncident"), ()=>{
  if(incident.active){ alert("すでに記録中です。"); return; }
  startIncident();
}, "startStop");
bindActivate($("btnStopIncident"), ()=>{
  if(!incident.active){ alert("まだ記録開始していません。"); return; }
  stopIncident();
}, "startStop");

/* v18: 他の主要ボタンも bindActivate（反応安定化） */
bindActivate($("btnOpenLogViewer"), openLogViewer, "lvOpen");
bindActivate($("btnCloseLogViewer"), closeLogViewer, "lvClose");
bindActivate($("logViewerBackdrop"), closeLogViewer, "lvClose2");

bindActivate($("btnVoiceRec"), ()=>{
  if(isRecording) stopRec();
  else startRec();
}, "voice");

bindActivate($("btnKeyboardDictation"), focusForKeyboardDictation, "kbd");

$("btnResetAll").onclick = ()=>{
  const ok = confirm("全消去します。\n（記録・チェック・入力内容が端末から消えます）\nよろしいですか？");
  if(!ok) return;
  incident = {
    active:false, startTs:null, endTs:null,
    importantNext:false,
    entries:[],
    checklist:{},
    form:{ place:"", pName:"", pGrade:"", pSex:"", pBirth:"", symptom:"", pHistory:"", pAllergy:"" },
    computedAgeStr:"--"
  };
  saveIncident();
  loadIncident();
  stopIncidentTimer();
  if(!$("logViewerWrap")?.classList.contains("hidden")) renderLogViewer();
  alert("消去しました。");
};

$("btnChecklistReset").onclick = resetChecklist;

$("btnCopyChecklist").onclick = ()=>{
  const items = checklistItems();
  if(items.length===0) return copyText("（初動チェック：未設定）");

  const ok = items.filter(x=>incident.checklist[x]);
  const ng = items.filter(x=>!incident.checklist[x]);
  const txt = `【初動チェック】\n完了：${ok.length ? ok.join(" / ") : "なし"}\n未：${ng.length ? ng.join(" / ") : "なし"}`;
  copyText(txt);
};

$("btnSaveSettings").onclick = ()=>{
  saveSettings();
  loadSettings();
  alert("保存しました。");
};

$("btnExportSettings").onclick = async ()=>{
  saveSettings();
  const pack = {
    version:"v18",
    school: settings.schoolName || "",
    addr: settings.schoolAddr || "",
    phone: settings.schoolPhone || "",
    casePresets: settings.casePresets || [],
    checkPresets: settings.checkPresets || [],
    quickStatus: settings.quickStatus || [],
    quickSymptoms: settings.quickSymptoms || [],
    quickTreatment: settings.quickTreatment || []
  };
  const txt = `【救急要請サポート 設定（v18）】\n` + JSON.stringify(pack, null, 2);
  await shareText("救急要請サポート 設定（v18）", txt);
};

$("btnRestoreDefaultCases").onclick = ()=> document.querySelectorAll(".casePreset").forEach((inp,idx)=> inp.value = DEFAULT_CASES[idx] || "");
$("btnClearCases").onclick = ()=> document.querySelectorAll(".casePreset").forEach(inp=> inp.value = "");

$("btnRestoreDefaultChecks").onclick = ()=> document.querySelectorAll(".checkPreset").forEach((inp,idx)=> inp.value = DEFAULT_CHECKS[idx] || "");
$("btnClearChecks").onclick = ()=> document.querySelectorAll(".checkPreset").forEach(inp=> inp.value = "");

$("btnRestoreDefaultQuickStatus").onclick = ()=> document.querySelectorAll(".quickStatusPreset").forEach((inp,idx)=> inp.value = DEFAULT_QUICK_STATUS[idx] || "");
$("btnClearQuickStatus").onclick = ()=> document.querySelectorAll(".quickStatusPreset").forEach(inp=> inp.value = "");

$("btnRestoreDefaultQuickSymptoms").onclick = ()=> document.querySelectorAll(".quickSymptomsPreset").forEach((inp,idx)=> inp.value = DEFAULT_QUICK_SYMPTOMS[idx] || "");
$("btnClearQuickSymptoms").onclick = ()=> document.querySelectorAll(".quickSymptomsPreset").forEach(inp=> inp.value = "");

$("btnRestoreDefaultQuickTreatment").onclick = ()=> document.querySelectorAll(".quickTreatmentPreset").forEach((inp,idx)=> inp.value = DEFAULT_QUICK_TREATMENT[idx] || "");
$("btnClearQuickTreatment").onclick = ()=> document.querySelectorAll(".quickTreatmentPreset").forEach(inp=> inp.value = "");

$("btnCasesHint").onclick = ()=> { toggleCollapse("schoolPanel"); $("schoolPanel")?.scrollIntoView({behavior:"smooth", block:"start"}); };
$("btnChecklistSettingsHint").onclick = ()=> { switchTab(1); toggleCollapse("schoolPanel"); $("schoolPanel")?.scrollIntoView({behavior:"smooth", block:"start"}); };
$("btnOpenSettings").onclick = ()=> { switchTab(1); toggleCollapse("schoolPanel"); $("schoolPanel")?.scrollIntoView({behavior:"smooth", block:"start"}); };

$("btnQuickAmbulance").onclick = ()=>{ tapFlash($("btnQuickAmbulance")); addEntry("救急車が到着・引き継ぎ開始"); };

$("pBirth").onchange = updateAge;
$("pGrade").onchange = updateAge;

/* 入力の自動保存（設定入力は除外） */
document.querySelectorAll("input, textarea, select").forEach(el=>{
  el.addEventListener("input", ()=>{
    if(el.classList.contains("casePreset") || el.classList.contains("checkPreset")
      || el.classList.contains("quickStatusPreset") || el.classList.contains("quickSymptomsPreset") || el.classList.contains("quickTreatmentPreset")) return;
    buildScript();
    saveIncident();
  });
});

/* log viewer toolbar */
$("lvSearch").addEventListener("input", renderLogViewer);
$("lvOrder").onclick = ()=>{ lvOrderNewestFirst=!lvOrderNewestFirst; renderLogViewer(); };
$("lvOnlyImp").onclick = ()=>{ lvOnlyImportant=!lvOnlyImportant; renderLogViewer(); };
$("lvMode").onclick = ()=>{ lvMode = (lvMode==="card" ? "text" : "card"); renderLogViewer(); };
$("lvCopy").onclick = ()=> copyText(entriesToText(filteredEntries()));
$("lvShare").onclick = ()=> shareText("救急対応 記録（フィルタ結果）", entriesToText(filteredEntries()));

$("lvAddToggle").onclick = ()=>{
  $("lvAddBox")?.classList.toggle("hidden");
  if(!$("lvAddBox")?.classList.contains("hidden")) $("lvAddText")?.focus();
};
$("lvAddCancel").onclick = ()=>{
  $("lvAddBox")?.classList.add("hidden");
  if($("lvAddText")) $("lvAddText").value = "";
};
$("lvAddDo").onclick = ()=>{
  const t = (val("lvAddText")||"").trim();
  if(!t) return;
  addEntry(t, false);
  if($("lvAddText")) $("lvAddText").value = "";
  $("lvAddBox")?.classList.add("hidden");
  renderLogViewer();
};

/* CSV export/import */
$("btnExportCSV").onclick = ()=>{
  saveSettings();
  const csv = settingsToCSV();
  downloadFile(`救急要請サポート_設定_${ymd_hm()}.csv`, csv, "text/csv;charset=utf-8");
  alert("設定CSVを保存しました。");
};
$("btnImportCSV").onclick = ()=> $("csvFile")?.click();
$("csvFile").addEventListener("change", async (ev)=>{
  const file = ev.target.files?.[0];
  if(!file) return;
  try{
    const text = await file.text();
    applySettingsFromCSV(text);
    alert("CSVを読み込みました。");
  }catch(e){
    alert("CSVの読み込みに失敗しました。\n" + (e?.message || e));
  }finally{
    $("csvFile").value = "";
  }
});

/* ===================== init ===================== */
migrateIfNeeded();
loadSettings();
loadIncident();
if(incident.active && incident.startTs) startIncidentTimer();
updateAge();
buildScript();
setupRecognition();
voiceSupportedHint();
renderQuickButtons();

/* リロード後の表示復元（タブ＋スクロール） */
window.restoreViewState?.();
</script>
</body>
</html>
