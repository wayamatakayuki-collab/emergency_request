<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ•‘æ€¥è¦è«‹ã‚µãƒãƒ¼ãƒˆï¼ˆç¾å ´æœ€å¼· v17ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body{
      -webkit-tap-highlight-color: transparent;
      padding-bottom: 96px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .safe-area-bottom{ padding-bottom: env(safe-area-inset-bottom); }

    *, *::before, *::after { box-sizing: border-box; }
    button, a { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    button{ cursor: pointer; }

    /* iOS dateãŒå³ã«é£›ã³å‡ºã™å¯¾ç­–ï¼ˆv17ï¼‰ */
    .date-wrap { min-width: 0; overflow: hidden; }
    input[type="date"]{
      width: 100%;
      max-width: 100%;
      min-width: 0;
      display: block;
      font-size: 16px; /* iOSæ‹¡å¤§é˜²æ­¢ */
      -webkit-appearance: none;
      appearance: none;
      padding-right: 10px; /* å³ã®ä½™ç™½ã‚’è©°ã‚ã‚‹ï¼ˆé£›ã³å‡ºã—æŠ‘æ­¢ï¼‰ */
      border-radius: 0.75rem;
    }

    input, select, textarea{ min-height: 48px; }
    select{
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1rem;
      padding-right: 2.5rem !important;
      font-size: 16px; /* iOSæ‹¡å¤§é˜²æ­¢ */
    }

    /* v17: ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã«ã€ŒæŠ¼ã—ãŸæ„Ÿã€ã‚’å¼·åˆ¶ä»˜ä¸ï¼ˆactiveã ã‘ã«ä¾å­˜ã—ãªã„ï¼‰ */
    .pressing{
      transform: scale(0.97);
      filter: brightness(0.90);
      box-shadow: inset 0 0 0 9999px rgba(0,0,0,0.06);
    }

    /* ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ï¼šæŠ¼ã—ãŸã¨åˆ†ã‹ã‚‹ï¼ˆv17ï¼‰ */
    .quick-tag{
      transition: transform .08s, filter .08s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      min-height: 44px;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      padding: 10px 10px;
      line-height: 1.2;
      user-select:none;
      position: relative;
      overflow: hidden;
    }
    .tap-flash::after{
      content:"";
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.09);
      animation: flash .18s ease-out;
      pointer-events:none;
    }
    @keyframes flash{
      from{ opacity: .9; }
      to{ opacity: 0; }
    }

    .collapse-content{ max-height: 0; overflow:hidden; transition: max-height .28s ease-out; }
    .collapse-content.open{ max-height: 2000px; transition: max-height .45s ease-in; }

    .recording-ring{ animation: ring-pulse 1.5s cubic-bezier(0.24, 0, 0.38, 1) infinite; }
    @keyframes ring-pulse{
      0% { transform: scale(1); opacity: 0.55; }
      100% { transform: scale(1.55); opacity: 0; }
    }

    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff !important; padding:0 !important; }
      .print-report{ display:block !important; padding:18px !important; color:#000; }
      .timeline-item{ border-bottom: 1px solid #ccc !important; break-inside: avoid; }
    }
    .print-report{ display:none; }
  </style>
</head>

<body class="bg-slate-100 text-slate-900">

  <!-- ===================== PRINT REPORT (hidden) ===================== -->
  <div class="print-report">
    <div class="border-b-2 border-black pb-2 mb-4 flex justify-between items-end">
      <div>
        <h1 class="text-2xl font-bold">æ•‘æ€¥æ¬é€ãƒ»çµŒéè¨˜éŒ²ç”¨ç´™</h1>
        <div class="text-xs text-gray-600 mt-1">ï¼ˆç¾å ´æœ€å¼· v17 / ç«¯æœ«ãƒ­ãƒ¼ã‚«ãƒ«è¨˜éŒ²ï¼‰</div>
      </div>
      <p id="printTimestamp" class="text-sm"></p>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-4 border p-3 rounded-lg">
      <div>
        <p class="text-xs font-bold text-gray-500">å­¦æ ¡å / ä½æ‰€ / é›»è©±</p>
        <p id="printSchoolInfo" class="text-sm font-bold"></p>
      </div>
      <div>
        <p class="text-xs font-bold text-gray-500">ç™ºç”Ÿ / çµ‚äº† / çµŒé</p>
        <p id="printIncidentInfo" class="text-sm font-bold"></p>
      </div>

      <div class="col-span-2 border-t pt-2">
        <p class="text-xs font-bold text-gray-500">å‚·ç—…è€…ï¼ˆæ°å / å­¦å¹´ / æ€§åˆ¥ / å¹´é½¢ï¼‰</p>
        <p id="printPatientInfo" class="text-sm font-bold"></p>
      </div>

      <div class="col-span-2 border-t pt-2">
        <p class="text-xs font-bold text-gray-500">ç¾åœ¨ã®ä¸»ãªç—‡çŠ¶ãƒ»æ—¢å¾€æ­´ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</p>
        <p id="printMedicalInfo" class="text-sm"></p>
      </div>

      <div class="col-span-2 border-t pt-2">
        <p class="text-xs font-bold text-gray-500">åˆå‹•ãƒã‚§ãƒƒã‚¯çŠ¶æ³</p>
        <div id="printChecklist" class="text-sm"></div>
      </div>
    </div>

    <h2 class="text-lg font-bold border-l-4 border-black pl-2 mb-2">æ™‚ç³»åˆ—è¨˜éŒ²</h2>
    <div id="printTimeline" class="border-t border-black"></div>

    <div class="mt-6 text-[10px] text-gray-400 text-right">
      Generated by æ•‘æ€¥è¦è«‹ã‚µãƒãƒ¼ãƒˆï¼ˆç¾å ´æœ€å¼· v17ï¼‰
    </div>
  </div>

  <!-- ===================== HEADER ===================== -->
  <header class="sticky top-0 z-30 bg-white shadow-sm border-b no-print">
    <div class="px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex flex-col">
        <h1 class="text-base font-black leading-tight text-red-600">æ•‘æ€¥è¦è«‹ã‚µãƒãƒ¼ãƒˆ</h1>
        <div class="text-[10px] text-slate-400 font-bold">ç¾å ´æœ€å¼· v17ï¼ˆå…¨ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ„Ÿ/ç¸¦3è¡Œ/é–‹å§‹çµ‚äº†æ”¹å–„/å…¨ä»¶ãƒ“ãƒ¥ãƒ¼ä¿®æ­£ï¼‰</div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnOpenSettings" class="px-3 py-2 rounded-full border text-xs font-black text-slate-700">
          è¨­å®š
        </button>
        <a href="tel:119" class="bg-red-600 text-white px-4 py-2 rounded-full text-sm font-black flex items-center gap-2 animate-pulse">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
          119
        </a>
      </div>
    </div>
  </header>

  <!-- ===================== MAIN ===================== -->
  <main class="p-3 space-y-4 no-print">

    <!-- ===================== SECTION 1 ===================== -->
    <div id="section1" class="space-y-4">

      <div class="bg-white border rounded-2xl p-3 shadow-sm">
        <div class="flex items-start gap-3">
          <div class="shrink-0 mt-0.5 w-9 h-9 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-black">!</div>
          <div class="flex-1">
            <div class="font-black text-sm">ã“ã®ã‚¢ãƒ—ãƒªã¯ã€Œç«¯æœ«å†…ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ã€ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™</div>
            <div class="text-[11px] text-slate-600 font-bold mt-0.5">
              ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã§æ¶ˆãˆã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<span class="text-slate-900 font-black">è¨­å®šCSVã®ä¿å­˜</span>ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚
            </div>
          </div>
        </div>
      </div>

      <!-- ç™ºç”Ÿå ´æ‰€ -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
        <div class="flex justify-between items-center border-b pb-2 mb-2">
          <h2 class="font-black text-sm border-l-4 border-slate-800 pl-2 text-slate-800">1. ç™ºç”Ÿå ´æ‰€</h2>
          <button onclick="toggleCollapse('schoolPanel')" class="text-xs text-blue-600 font-black">å­¦æ ¡æƒ…å ±</button>
        </div>

        <div id="schoolPanel" class="hidden space-y-3 bg-slate-50 p-3 rounded-xl border border-dashed border-slate-200">
          <div><label class="text-[11px] font-black text-slate-500">å­¦æ ¡å</label><input id="schoolName" class="w-full p-3 border rounded-xl text-sm font-black bg-white" placeholder="ã€‡ã€‡å¸‚ç«‹ã€‡ã€‡å°å­¦æ ¡" /></div>
          <div><label class="text-[11px] font-black text-slate-500">ä½æ‰€</label><input id="schoolAddr" class="w-full p-3 border rounded-xl text-sm font-black bg-white" placeholder="å¸‚åŒºç”ºæ‘ã‹ã‚‰ã®ä½æ‰€" /></div>
          <div><label class="text-[11px] font-black text-slate-500">é›»è©±ç•ªå·</label><input id="schoolPhone" class="w-full p-3 border rounded-xl text-sm font-black bg-white" placeholder="03-xxxx-xxxx" inputmode="tel" /></div>

          <!-- è¨­å®šCSV -->
          <div class="bg-white border rounded-2xl p-3 space-y-2">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">è¨­å®šãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆCSVï¼‰</div>
              <div class="text-[10px] font-black text-slate-500">åˆ¥ç«¯æœ«ã¸ç§»è¡ŒOK</div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <button id="btnExportCSV" class="py-4 rounded-2xl bg-slate-900 text-white text-sm font-black">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
              <button id="btnImportCSV" class="py-4 rounded-2xl bg-white border text-sm rounded-2xl font-black">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            </div>
            <input id="csvFile" type="file" accept=".csv,text/csv" class="hidden" />
            <div class="text-[11px] font-bold text-slate-500 leading-relaxed">
              â€»CSVã¯ã€Œå­¦æ ¡æƒ…å ±/ã‚ˆãèµ·ãã‚‹ã‚±ãƒ¼ã‚¹/åˆå‹•ãƒã‚§ãƒƒã‚¯/ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ã€ã™ã¹ã¦ã‚’å«ã¿ã¾ã™ã€‚
            </div>
          </div>

          <!-- ã‚ˆãèµ·ãã‚‹ã‚±ãƒ¼ã‚¹ï¼ˆæœ€å¤§10ï¼‰ -->
          <div class="bg-white border rounded-2xl p-3 space-y-2">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">ã‚ˆãèµ·ãã‚‹ã‚±ãƒ¼ã‚¹ï¼ˆæœ€å¤§10ï¼‰</div>
              <div class="text-[10px] font-black text-slate-500">å­¦æ ¡ã”ã¨ã«è¨­å®š</div>
            </div>
            <div class="grid grid-cols-1 gap-2">
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
              <input class="casePreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button id="btnRestoreDefaultCases" class="py-3 rounded-2xl bg-white border text-xs font-black">åˆæœŸã‚»ãƒƒãƒˆã«æˆ»ã™</button>
              <button id="btnClearCases" class="py-3 rounded-2xl bg-white border text-xs font-black">ç©ºã«ã™ã‚‹</button>
            </div>
          </div>

          <!-- åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§10ï¼‰ -->
          <div class="bg-white border rounded-2xl p-3 space-y-2">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§10ï¼‰</div>
              <div class="text-[10px] font-black text-slate-500">ãƒã‚§ãƒƒã‚¯ã§è‡ªå‹•è¨˜éŒ²</div>
            </div>
            <div class="grid grid-cols-1 gap-2">
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
              <input class="checkPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <button id="btnRestoreDefaultChecks" class="py-3 rounded-2xl bg-white border text-xs font-black">åˆæœŸã‚»ãƒƒãƒˆã«æˆ»ã™</button>
              <button id="btnClearChecks" class="py-3 rounded-2xl bg-white border text-xs font-black">ç©ºã«ã™ã‚‹</button>
            </div>
          </div>

          <!-- ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ï¼ˆå„æœ€å¤§10ï¼‰ -->
          <div class="bg-white border rounded-2xl p-3 space-y-3">
            <div class="flex items-center justify-between">
              <div class="font-black text-sm">ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ï¼ˆå„æœ€å¤§10ï¼‰</div>
              <div class="text-[10px] font-black text-slate-500">ã€Œè¡¨ç¤º|è¨˜éŒ²ã€å½¢å¼ã‚‚OK</div>
            </div>

            <div class="space-y-2">
              <div class="text-xs font-black text-blue-700">STATUS / æ„è­˜ãƒ»å‘¼å¸</div>
              <div class="grid grid-cols-1 gap-2">
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
                <input class="quickStatusPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
              </div>
              <div class="grid grid-cols-2 gap-2">
                <button id="btnRestoreDefaultQuickStatus" class="py-3 rounded-2xl bg-white border text-xs font-black">åˆæœŸå€¤</button>
                <button id="btnClearQuickStatus" class="py-3 rounded-2xl bg-white border text-xs font-black">ç©º</button>
              </div>
            </div>

            <div class="space-y-2">
              <div class="text-xs font-black text-slate-800">SYMPTOMS / å…¨èº«ç—‡çŠ¶</div>
              <div class="grid grid-cols-1 gap-2">
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
                <input class="quickSymptomsPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
              </div>
              <div class="grid grid-cols-2 gap-2">
                <button id="btnRestoreDefaultQuickSymptoms" class="py-3 rounded-2xl bg-white border text-xs font-black">åˆæœŸå€¤</button>
                <button id="btnClearQuickSymptoms" class="py-3 rounded-2xl bg-white border text-xs font-black">ç©º</button>
              </div>
            </div>

            <div class="space-y-2">
              <div class="text-xs font-black text-green-700">TREATMENT / å‡¦ç½®å†…å®¹</div>
              <div class="grid grid-cols-1 gap-2">
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="0" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="1" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="2" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="3" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="4" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="5" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="6" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="7" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="8" />
                <input class="quickTreatmentPreset w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-idx="9" />
              </div>
              <div class="grid grid-cols-2 gap-2">
                <button id="btnRestoreDefaultQuickTreatment" class="py-3 rounded-2xl bg-white border text-xs font-black">åˆæœŸå€¤</button>
                <button id="btnClearQuickTreatment" class="py-3 rounded-2xl bg-white border text-xs font-black">ç©º</button>
              </div>
            </div>

            <div class="text-[11px] font-bold text-slate-500">
              ä¾‹ï¼š<span class="font-black">æ„è­˜ã‚ã‚Š|æ„è­˜ã‚ã‚Šï¼ˆæ˜ç­ï¼‰</span>ï¼ˆè¡¨ç¤ºï¼å·¦ã€è¨˜éŒ²ï¼å³ï¼‰
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <button id="btnSaveSettings" class="py-4 bg-slate-900 text-white text-sm rounded-2xl font-black">ã“ã®ã‚¹ãƒãƒ›ã«ä¿å­˜</button>
            <button id="btnExportSettings" class="py-4 bg-white border text-sm rounded-2xl font-black">è¨­å®šã‚’å…±æœ‰</button>
          </div>
        </div>

        <div>
          <label class="text-[11px] font-black text-slate-500">æ ¡å†…ã®è©³ã—ã„å ´æ‰€</label>
          <input id="place" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼š3Få›³å·¥å®¤ã€ä½“è‚²é¤¨åŒ—å´ãªã©" />
        </div>
      </div>

      <!-- å‚·ç—…è€… -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-4">
        <h2 class="font-black text-sm border-l-4 border-red-500 pl-2 text-slate-800">2. å‚·ç—…è€…ã®è©³ç´°</h2>

        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <div class="text-[11px] font-black text-slate-500">ã‚ˆãèµ·ãã‚‹ã‚±ãƒ¼ã‚¹ï¼ˆã‚¿ãƒƒãƒ—ã§ç—‡çŠ¶ã¸åæ˜ ï¼‹è¨˜éŒ²ï¼‰</div>
            <button id="btnCasesHint" class="text-xs font-black text-blue-600">è¨­å®š</button>
          </div>
          <div id="caseButtons" class="grid grid-cols-2 gap-2"></div>
        </div>

        <div class="space-y-3">
          <div>
            <label class="text-[11px] font-black text-slate-500">æ°åï¼ˆãµã‚ŠãŒãªï¼‰</label>
            <input id="pName" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black placeholder:font-bold placeholder:text-slate-400" placeholder="å±±ç”° å¤ªéƒï¼ˆã‚„ã¾ã  ãŸã‚ã†ï¼‰" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-[11px] font-black text-slate-500">å­¦å¹´ãƒ»åŒºåˆ†</label>
              <select id="pGrade" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black">
                <option value="">é¸æŠ</option>
                <option value="1">1å¹´</option><option value="2">2å¹´</option><option value="3">3å¹´</option>
                <option value="4">4å¹´</option><option value="5">5å¹´</option><option value="6">6å¹´</option>
                <option value="è·å“¡">æ•™è·å“¡</option><option value="ä»–">ãã®ä»–</option>
              </select>
            </div>
            <div>
              <label class="text-[11px] font-black text-slate-500">æ€§åˆ¥</label>
              <select id="pSex" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black">
                <option value="">é¸æŠ</option>
                <option value="ç”·æ€§">ç”·æ€§</option>
                <option value="å¥³æ€§">å¥³æ€§</option>
                <option value="ä¸æ˜">ä¸æ˜</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-3 bg-blue-50 rounded-xl border border-blue-100 overflow-hidden">
            <div class="date-wrap">
              <label class="text-[11px] font-black text-blue-700">ç”Ÿå¹´æœˆæ—¥</label>
              <input id="pBirth" type="date" class="w-full h-[48px] px-3 border text-base font-black bg-white" />
            </div>
            <div class="flex items-end min-w-0">
              <div id="ageDisplay" class="text-sm font-black text-blue-800 bg-white border border-blue-200 w-full px-3 rounded-xl text-center h-[48px] flex items-center justify-center shadow-sm">
                å¹´é½¢ï¼š-- æ­³
              </div>
            </div>
          </div>
        </div>

        <div>
          <label class="text-[11px] font-black text-slate-500">ç¾åœ¨ã®ç—‡çŠ¶</label>
          <textarea id="symptom" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" rows="2"
            placeholder="ä¾‹ï¼šã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼åå¿œã€å‘¼å¸å›°é›£ã€æ„è­˜æ··æ¿"></textarea>
        </div>

        <button onclick="toggleCollapse('detailMedical')" class="w-full py-3 bg-slate-100 rounded-xl text-[11px] font-black text-slate-600 flex justify-center items-center gap-1">
          æ—¢å¾€æ­´ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç­‰
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
        </button>

        <div id="detailMedical" class="hidden space-y-3 pt-1">
          <div><label class="text-[11px] font-black text-slate-500">æ—¢å¾€æ­´ï¼ˆæŒç—…ï¼‰</label><input id="pHistory" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="å–˜æ¯ã€ã¦ã‚“ã‹ã‚“ç­‰" /></div>
          <div><label class="text-[11px] font-black text-slate-500">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label><input id="pAllergy" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="ãƒ”ãƒ¼ãƒŠãƒƒãƒ„ã€åµç­‰" /></div>
        </div>
      </div>

      <!-- é€šå ±ç”¨åŸç¨¿ -->
      <div class="bg-slate-900 rounded-2xl p-4 shadow-xl">
        <div class="flex justify-between items-center mb-2 border-b border-white/10 pb-2">
          <span class="text-[10px] uppercase tracking-widest text-slate-400 font-black">119é€šå ±ç”¨åŸç¨¿</span>
          <div class="flex items-center gap-2">
            <button id="btnCopyScript" class="text-xs bg-white text-slate-900 px-3 py-2 rounded-full font-black">ã‚³ãƒ”ãƒ¼</button>
            <button id="btnShareScript" class="text-xs bg-white/10 text-white px-3 py-2 rounded-full font-black">å…±æœ‰</button>
          </div>
        </div>
        <div id="scriptDisplay" class="text-white text-sm font-bold leading-relaxed min-h-[120px] whitespace-pre-wrap"></div>
      </div>
    </div>

    <!-- ===================== SECTION 2 ===================== -->
    <div id="section2" class="hidden space-y-4 pb-24">

      <!-- ä¸Šéƒ¨å›ºå®šï¼ˆstickyï¼‰ -->
      <div class="bg-white/95 backdrop-blur border rounded-2xl p-4 shadow-sm space-y-3 sticky top-[64px] z-20">
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="font-black text-sm">çµŒéãƒ»å‡¦ç½®ã®è¨˜éŒ²</div>
            <div class="text-[10px] font-black text-slate-500">ç™ºç”Ÿã€œå¼•ç¶™ãã¾ã§ã€Œå…¨éƒ¨ã“ã“ã«ã€æ®‹ã™</div>
          </div>

          <div class="flex items-center gap-2">
            <button id="btnOpenLogViewer" class="px-3 py-2 rounded-full border text-xs font-black">ğŸ‘€ å…¨ä»¶</button>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-2">
          <button id="btnStartIncident" class="py-4 rounded-2xl bg-red-600 text-white font-black text-sm">è¨˜éŒ²é–‹å§‹</button>
          <button id="btnStopIncident" class="py-4 rounded-2xl bg-white border font-black text-sm text-slate-900">è¨˜éŒ²çµ‚äº†</button>
          <button id="btnResetAll" class="py-4 rounded-2xl bg-white border font-black text-sm text-slate-900">å…¨æ¶ˆå»</button>
        </div>

        <div class="grid grid-cols-3 gap-2">
          <div class="bg-slate-50 border rounded-2xl p-3">
            <div class="text-[10px] font-black text-slate-500">é–‹å§‹</div>
            <div id="incidentStartLabel" class="text-sm font-black text-slate-900">--:--</div>
          </div>
          <div class="bg-slate-50 border rounded-2xl p-3">
            <div class="text-[10px] font-black text-slate-500">çµŒé</div>
            <div id="incidentElapsedLabel" class="text-sm font-black text-slate-900">--</div>
          </div>
          <div class="bg-slate-50 border rounded-2xl p-3">
            <div class="text-[10px] font-black text-slate-500">æœ€æ–°è¨˜éŒ²</div>
            <div id="lastEntryLabel" class="text-sm font-black text-slate-900">--:--</div>
          </div>
        </div>
      </div>

      <!-- checklist -->
      <section class="bg-white border rounded-2xl p-4 shadow-sm space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="font-black text-sm border-l-4 border-emerald-600 pl-2">
            åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆãƒã‚§ãƒƒã‚¯ã§è‡ªå‹•è¨˜éŒ²ï¼‰
          </h2>
          <button id="btnChecklistSettingsHint" class="text-xs font-black text-blue-600">è¨­å®š</button>
        </div>

        <div id="checklist" class="space-y-2"></div>

        <div class="grid grid-cols-2 gap-2">
          <button id="btnChecklistReset" class="py-4 rounded-2xl bg-white border font-black text-sm">ãƒã‚§ãƒƒã‚¯è§£é™¤</button>
          <button id="btnCopyChecklist" class="py-4 rounded-2xl bg-slate-900 text-white font-black text-sm">ãƒã‚§ãƒƒã‚¯çŠ¶æ³ã‚³ãƒ”ãƒ¼</button>
        </div>
      </section>

      <!-- memo / voice -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="font-black text-sm">ãƒ¡ãƒ¢ï¼ˆéŸ³å£°å…¥åŠ›ï¼‰</div>
            <div class="text-[10px] font-black text-slate-500">
              å¯¾å¿œç«¯æœ«ï¼šãƒœã‚¿ãƒ³ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã— â†’ ã€Œè¨˜éŒ²ã€ã§ãƒ­ã‚°åŒ–<br>
              iPhoneç­‰æœªå¯¾å¿œï¼š<span class="text-slate-900 font-black">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒã‚¤ã‚¯ï¼ˆéŸ³å£°å…¥åŠ›ï¼‰</span>ã‚’ä½¿ç”¨
            </div>
          </div>

          <button id="btnToggleImportant" class="px-3 py-2 rounded-full border text-xs font-black">
            é‡è¦ï¼šOFF
          </button>
        </div>

        <div class="flex flex-col items-center py-1">
          <div class="relative">
            <div id="pulseRing" class="absolute inset-0 rounded-full bg-red-400 hidden recording-ring"></div>
            <button id="btnVoiceRec" class="relative z-10 w-20 h-20 rounded-full bg-blue-600 text-white shadow-lg flex items-center justify-center flex-col gap-0.5 transition-transform">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-18a3 3 0 013 3v8a3 3 0 01-3 3 3 3 0 01-3-3V5a3 3 0 013-3z"></path></svg>
              <span id="micText" class="text-[9px] font-black tracking-tighter uppercase">REC START</span>
            </button>
          </div>
          <div id="interimText" class="mt-2 text-xs text-blue-600 font-black h-4 italic"></div>

          <div id="voiceSupportHint" class="mt-1 text-[10px] font-bold text-slate-500 text-center leading-snug"></div>

          <button id="btnKeyboardDictation" class="mt-2 w-full py-3 rounded-2xl bg-white border text-sm font-black">
            ï¼ˆiPhoneç­‰ï¼‰ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒã‚¤ã‚¯ã§éŸ³å£°å…¥åŠ›ã™ã‚‹
          </button>
        </div>

        <div class="space-y-2">
          <textarea id="voiceInputArea" class="w-full p-4 bg-slate-50 border rounded-2xl text-base font-black focus:ring-2 focus:ring-blue-500 outline-none" rows="3" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›ï¼ˆéŸ³å£°ã®å ´åˆã‚‚ã“ã“ã«å…¥ã‚Šã¾ã™ï¼‰..."></textarea>
          <button id="btnAddTimeline" class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg">è¨˜éŒ²ï¼ˆãƒ­ã‚°ã«æ®‹ã™ï¼‰</button>
        </div>
      </div>

      <!-- quick tags accordions -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
        <div class="text-center">
          <div class="font-black text-sm text-slate-900">ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›</div>
          <div class="text-[10px] text-slate-400 font-black uppercase tracking-tight">Tap to Log</div>
        </div>

        <div class="space-y-3">
          <div class="border rounded-xl overflow-hidden">
            <button onclick="toggleAccordion('acc-status')" class="w-full px-4 py-3 bg-blue-50 flex justify-between items-center text-blue-800 font-black text-sm">
              <span>STATUS / æ„è­˜ãƒ»å‘¼å¸</span>
              <svg id="icon-acc-status" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="acc-status" class="collapse-content bg-white">
              <div id="quickStatusGrid" class="grid grid-cols-2 gap-2 p-3"></div>
            </div>
          </div>

          <div class="border rounded-xl overflow-hidden">
            <button onclick="toggleAccordion('acc-symptoms')" class="w-full px-4 py-3 bg-slate-100 flex justify-between items-center text-slate-800 font-black text-sm">
              <span>SYMPTOMS / å…¨èº«ç—‡çŠ¶</span>
              <svg id="icon-acc-symptoms" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="acc-symptoms" class="collapse-content bg-white">
              <div id="quickSymptomsGrid" class="grid grid-cols-2 gap-2 p-3"></div>
            </div>
          </div>

          <div class="border rounded-xl overflow-hidden">
            <button onclick="toggleAccordion('acc-treatment')" class="w-full px-4 py-3 bg-green-50 flex justify-between items-center text-green-800 font-black text-sm">
              <span>TREATMENT / å‡¦ç½®å†…å®¹</span>
              <svg id="icon-acc-treatment" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="acc-treatment" class="collapse-content bg-white">
              <div id="quickTreatmentGrid" class="grid grid-cols-2 gap-2 p-3"></div>
            </div>
          </div>

          <div class="grid grid-cols-1 gap-2">
            <button id="btnQuickAmbulance" class="quick-tag bg-slate-900 text-white rounded-2xl text-xs font-black">
              æ•‘æ€¥è»Š åˆ°ç€
            </button>
          </div>
        </div>
      </div>

      <!-- timeline -->
      <div class="space-y-3 px-1">
        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center py-2 italic border-b border-slate-200">Activity Log</h3>

        <div id="timeline" class="space-y-3">
          <p id="timelineEmpty" class="text-center text-slate-400 py-10 text-sm font-black">ï¼ˆè¨˜éŒ²ãªã—ï¼‰</p>
        </div>

        <!-- v17: ãƒœã‚¿ãƒ³ã¯ç¸¦3è¡Œã§å›ºå®šï¼ˆå´©ã‚Œé˜²æ­¢ï¼‰ -->
        <div class="flex flex-col gap-2 mt-6">
          <button id="btnCopyTimeline" class="w-full py-4 text-slate-700 text-sm font-black border-2 border-dashed border-slate-300 rounded-2xl">è¨˜éŒ²ã‚’ã‚³ãƒ”ãƒ¼</button>

          <button id="btnPrint" class="w-full py-4 bg-blue-600 text-white text-sm font-black rounded-2xl shadow-lg flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
            ç”¨ç´™ã¨ã—ã¦å°åˆ·
          </button>

          <button id="btnWord" class="w-full py-4 bg-white border text-slate-900 text-sm font-black rounded-2xl shadow-sm">
            Wordã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          </button>
        </div>
      </div>

    </div>
  </main>

  <!-- ===================== BOTTOM NAV ===================== -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex items-center justify-around px-2 py-2 no-print shadow-[0_-4px_15px_rgba(0,0,0,0.1)] z-40 safe-area-bottom">
    <button id="nav1" class="flex flex-col items-center gap-1 flex-1 py-1 text-blue-600">
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
      <span class="text-[10px] font-black">1. é€šå ±åŸç¨¿</span>
    </button>

    <button id="nav2" class="flex flex-col items-center gap-1 flex-1 py-1 text-slate-400">
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path></svg>
      <span class="text-[10px] font-black">2. çµŒéè¨˜éŒ²</span>
    </button>
  </nav>

  <!-- ===================== LOG VIEWER ===================== -->
  <div id="logViewerWrap" class="fixed inset-0 z-[90] hidden">
    <div id="logViewerBackdrop" class="absolute inset-0 bg-black/50"></div>

    <div class="absolute inset-0 bg-white flex flex-col">
      <div class="sticky top-0 bg-white border-b p-3 flex items-center gap-2">
        <div class="font-black">ğŸ‘€ è¨˜éŒ² å…¨ä»¶ãƒ“ãƒ¥ãƒ¼</div>
        <button id="btnCloseLogViewer" class="ml-auto px-3 py-2 rounded-full border text-xs font-black">é–‰ã˜ã‚‹</button>
      </div>

      <div class="p-3 space-y-2 border-b bg-slate-50">
        <input id="lvSearch" class="w-full p-3 bg-white border rounded-2xl text-sm font-black" placeholder="æ¤œç´¢ï¼ˆä¾‹ï¼šAED / ã‘ã„ã‚Œã‚“ / 12:34ï¼‰">

        <div class="grid grid-cols-4 gap-2">
          <button id="lvAddToggle" class="py-3 rounded-2xl bg-slate-900 text-white text-xs font-black">ï¼‹è¿½åŠ </button>
          <button id="lvOrder" class="py-3 rounded-2xl bg-white border text-xs font-black">è¡¨ç¤ºï¼šæ–°â†’å¤</button>
          <button id="lvOnlyImp" class="py-3 rounded-2xl bg-white border text-xs font-black">é‡è¦ã®ã¿ï¼šOFF</button>
          <button id="lvMode" class="py-3 rounded-2xl bg-white border text-xs font-black">è¡¨ç¤ºï¼šã‚«ãƒ¼ãƒ‰</button>
        </div>

        <div id="lvAddBox" class="hidden bg-white border rounded-2xl p-3 space-y-2">
          <textarea id="lvAddText" class="w-full p-3 bg-slate-50 border rounded-2xl text-sm font-black" rows="3" placeholder="è¿½åŠ ã™ã‚‹è¨˜éŒ²å†…å®¹ï¼ˆä¾‹ï¼šä¿è­·è€…ã¸é€£çµ¡ã€AEDåˆ°ç€ ãªã©ï¼‰"></textarea>
          <div class="grid grid-cols-2 gap-2">
            <button id="lvAddDo" class="py-3 rounded-2xl bg-blue-600 text-white text-sm font-black">è¿½åŠ ã—ã¦ä¿å­˜</button>
            <button id="lvAddCancel" class="py-3 rounded-2xl bg-white border text-sm font-black">ã‚„ã‚ã‚‹</button>
          </div>
        </div>

        <div class="text-[10px] font-bold text-slate-500">ä»¶æ•°ï¼š<span id="lvCount" class="font-black">0</span></div>
      </div>

      <div class="flex-1 overflow-y-auto p-3" id="lvBody"></div>

      <div class="border-t p-3 bg-white grid grid-cols-2 gap-2">
        <button id="lvCopy" class="py-4 rounded-2xl bg-white border font-black text-sm">ã‚³ãƒ”ãƒ¼</button>
        <button id="lvShare" class="py-4 rounded-2xl bg-slate-900 text-white font-black text-sm">å…±æœ‰</button>
      </div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);

/* ===================== v17: å…¨ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ„Ÿï¼ˆå¼·åˆ¶ï¼‰ ===================== */
(function installGlobalPressFeedback(){
  const add = (el)=>{ try{ el.classList.add("pressing"); }catch(e){} };
  const del = (el)=>{ try{ el.classList.remove("pressing"); }catch(e){} };
  const findBtn = (t)=> t && (t.closest ? t.closest("button, a") : null);

  document.addEventListener("pointerdown", (e)=>{
    const b = findBtn(e.target);
    if(b) add(b);
  }, true);
  document.addEventListener("pointerup", (e)=>{
    const b = findBtn(e.target);
    if(b) del(b);
  }, true);
  document.addEventListener("pointercancel", (e)=>{
    const b = findBtn(e.target);
    if(b) del(b);
  }, true);

  /* pointeræœªå¯¾å¿œç«¯æœ«å‘ã‘ */
  document.addEventListener("touchstart", (e)=>{
    const b = findBtn(e.target);
    if(b) add(b);
  }, {capture:true, passive:true});
  document.addEventListener("touchend", (e)=>{
    const b = findBtn(e.target);
    if(b) del(b);
  }, {capture:true, passive:true});
})();

/* ===================== keysï¼ˆv17ï¼‰ ===================== */
const SETTINGS_KEY_V17 = "school_emergency_settings_v17";
const INCIDENT_KEY_V17  = "school_emergency_incident_v17";
const SETTINGS_KEY_V16 = "school_emergency_settings_v16";
const INCIDENT_KEY_V16  = "school_emergency_incident_v16";

/* ===================== utils ===================== */
function nowTimeStr(d=new Date()){
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}
function fmtDateTime(ts){
  if(!ts) return "--";
  const d = new Date(ts);
  return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")} ${nowTimeStr(d)}`;
}
function msToElapsed(ms){
  if(ms==null || isNaN(ms)) return "--";
  const sec = Math.max(0, Math.floor(ms/1000));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  if(h>0) return `${h}æ™‚é–“${String(m).padStart(2,"0")}åˆ†`;
  if(m>0) return `${m}åˆ†${String(s).padStart(2,"0")}ç§’`;
  return `${s}ç§’`;
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function tapFlash(el){
  el.classList.add("tap-flash");
  setTimeout(()=> el.classList.remove("tap-flash"), 180);
}
function genId(){
  return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
}
function copyText(text){
  return navigator.clipboard.writeText(text).then(()=>alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")).catch(()=>{
    const ta=document.createElement("textarea");
    ta.value=text; document.body.appendChild(ta); ta.select();
    document.execCommand("copy"); document.body.removeChild(ta);
    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  });
}
async function shareText(title, text){
  try{
    if(navigator.share){
      await navigator.share({ title, text });
      return;
    }
  }catch(e){}
  return copyText(text);
}
function downloadFile(filename, content, mime){
  const blob = new Blob([content], {type: mime || "text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function ymd_hm(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0");
  const mm=String(d.getMinutes()).padStart(2,"0");
  return `${y}${m}${da}_${hh}${mm}`;
}

/* v17: CSS.escape ãŒç„¡ã„ç«¯æœ«ã®ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
function cssEscapeCompat(s){
  if(window.CSS && typeof CSS.escape === "function") return CSS.escape(String(s));
  return String(s).replace(/[^a-zA-Z0-9_\-]/g, (c)=> "\\" + c);
}

/* CSV helpers */
function csvEscape(v){
  const s = String(v ?? "");
  if(/[",\n\r]/.test(s)){
    return `"${s.replaceAll('"','""')}"`;
  }
  return s;
}
function toCSV(rows){
  return rows.map(r=>r.map(csvEscape).join(",")).join("\n");
}
function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let i = 0;
  let inQ = false;
  while(i < text.length){
    const ch = text[i];
    if(inQ){
      if(ch === '"'){
        if(text[i+1] === '"'){ cur += '"'; i += 2; continue; }
        inQ = false; i++; continue;
      }
      cur += ch; i++; continue;
    }else{
      if(ch === '"'){ inQ = true; i++; continue; }
      if(ch === ","){ row.push(cur); cur = ""; i++; continue; }
      if(ch === "\n"){
        row.push(cur); rows.push(row);
        row = []; cur = ""; i++; continue;
      }
      if(ch === "\r"){ i++; continue; }
      cur += ch; i++; continue;
    }
  }
  row.push(cur);
  rows.push(row);
  return rows.filter(r=>r.some(c=>String(c).trim()!==""));
}

/* ===================== defaults ===================== */
const DEFAULT_CASES = [
  "é ­éƒ¨æ‰“æ’²ï¼ˆè»¢å€’ãƒ»è¡çªï¼‰",
  "åˆ‡ã‚Šå‚·ãƒ»å‡ºè¡€ï¼ˆå·¥ä½œ/ä½“è‚²ï¼‰",
  "éª¨æŠ˜ç–‘ã„ï¼ˆè»¢å€’ãƒ»è½ä¸‹ï¼‰",
  "ç†±ä¸­ç—‡ç–‘ã„ï¼ˆå±‹å¤–æ´»å‹•ï¼‰",
  "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼åå¿œï¼ˆã˜ã‚“ã¾ã—ã‚“ç­‰ï¼‰",
  "å–˜æ¯ç™ºä½œï¼ˆå‘¼å¸è‹¦ï¼‰",
  "ã‘ã„ã‚Œã‚“ï¼ˆã²ãã¤ã‘ï¼‰",
  "èª¤é£²ãƒ»çª’æ¯ç–‘ã„",
  "è…¹ç—›ãƒ»å˜”åï¼ˆä½“èª¿æ€¥å¤‰ï¼‰",
  "æ„è­˜æ¶ˆå¤±ï¼ˆå€’ã‚ŒãŸï¼‰"
];
const DEFAULT_CHECKS = [
  "å‘¨å›²å®‰å…¨ç¢ºä¿ï¼ˆå±é™ºé™¤å»ãƒ»å…ç«¥ã‚’é›¢ã™ï¼‰",
  "ç®¡ç†è·ã¸é€£çµ¡ï¼ˆçŠ¶æ³å…±æœ‰ï¼‰",
  "119é€šå ±ï¼ˆå¿…è¦æ™‚ï¼‰",
  "AEDæ‰‹é…ï¼ˆå ´æ‰€ç¢ºèªâ†’æ¬é€ï¼‰",
  "èƒ¸éª¨åœ§è¿« / AEDè§£æï¼ˆå¿…è¦æ™‚ï¼‰",
  "æ­£é–€èª˜å°æ‰‹é…ï¼ˆèª˜å°ä½ç½®ã¸ï¼‰",
  "ä¿å¥å®¤æº–å‚™ï¼ˆæ¯›å¸ƒãƒ»æ°·ãƒ»æ‹…æ¶ç­‰ï¼‰",
  "ä¿è­·è€…ã¸é€£çµ¡ï¼ˆçŠ¶æ³å…±æœ‰ï¼‰",
  "å…ç«¥èª˜å°ï¼ˆåˆ¥å®¤ãƒ»å°ç·šç¢ºä¿ï¼‰",
  "æ•‘æ€¥éšŠã¸å¼•ç¶™ãï¼ˆè¨˜éŒ²æ¸¡ã—ï¼‰"
];

const DEFAULT_QUICK_STATUS = [
  "æ„è­˜ã‚ã‚Š|æ„è­˜ã‚ã‚Šï¼ˆæ˜ç­ï¼‰",
  "æ„è­˜æ··æ¿|æ„è­˜æ··æ¿ï¼ˆå‘¼ã³ã‹ã‘ã«åå¿œè–„ã„ï¼‰",
  "æ„è­˜æ¶ˆå¤±|æ„è­˜æ¶ˆå¤±ãƒ»ç„¡åå¿œ",
  "å‘¼å¸æ­£å¸¸|å‘¼å¸æ­£å¸¸",
  "å‘¼å¸å›°é›£|å‘¼å¸å›°é›£ï¼ˆã‚¼ãƒ¼ã‚¼ãƒ¼ã™ã‚‹ï¼‰",
  "å‘¼å¸åœæ­¢|å‘¼å¸åœæ­¢ãƒ»æ­»æˆ¦æœŸå‘¼å¸ï¼ˆã‚ãˆãå‘¼å¸ï¼‰"
];
const DEFAULT_QUICK_SYMPTOMS = [
  "é¡”é¢è’¼ç™½|é¡”é¢è’¼ç™½ï¼ˆè¡€ã®æ°—ãŒå¼•ã„ãŸï¼‰",
  "é¡”é¢ç´…æ½®|é¡”é¢ç´…æ½®ï¼ˆèµ¤ã‚‰é¡”ï¼‰",
  "å†·ã‚„æ±—|å†·ã‚„æ±—ãŒã²ã©ã„",
  "å˜”åã‚ã‚Š|å˜”åï¼ˆãŠã†ã¨ï¼‰ã‚ã‚Š",
  "ç—™æ”£é–‹å§‹|ç—™æ”£ï¼ˆã‘ã„ã‚Œã‚“ï¼‰é–‹å§‹",
  "ç—™æ”£æ¶ˆå¤±|ç—™æ”£ï¼ˆã‘ã„ã‚Œã‚“ï¼‰æ¶ˆå¤±",
  "ã˜ã‚“ã¾ã—ã‚“|å…¨èº«ã«ã˜ã‚“ã¾ã—ã‚“å‡ºç¾",
  "æ¿€ã—ã„è…¹ç—›|æ¿€ã—ã„è…¹ç—›",
  "å¤±ç¦ã‚ã‚Š|å¤±ç¦ã‚ã‚Š",
  "é¼»å‡ºè¡€|é¼»å‡ºè¡€ï¼ˆé¼»è¡€ï¼‰"
];
const DEFAULT_QUICK_TREATMENT = [
  "ã‚¨ãƒ”ãƒšãƒ³ä½¿ç”¨|ã‚¨ãƒ”ãƒšãƒ³ï¼ˆè‡ªå·±æ³¨å°„è–¬ï¼‰ä½¿ç”¨",
  "å›å¾©ä½“ä½|å›å¾©ä½“ä½ï¼ˆæ¨ªå‘ãï¼‰ã«å›ºå®š",
  "è¡£æœã‚’ç·©ã‚ã‚‹|è¡£æœã‚’ç·©ã‚ã‚‹ï¼ˆè¥Ÿå…ƒç­‰ï¼‰",
  "æ¯›å¸ƒã§ä¿æ¸©|æ¯›å¸ƒã§ä¿æ¸©é–‹å§‹",
  "å†·å´é–‹å§‹|ä¿å†·å‰¤ã§æ‚£éƒ¨ã‚’å†·å´ä¸­",
  "å‚·å£æ´—æµ„|å‚·å£ã‚’æµæ°´ã§æ´—æµ„",
  "åœ§è¿«æ­¢è¡€|åœ§è¿«ã«ã‚ˆã‚‹æ­¢è¡€å‡¦ç½®",
  "èƒ¸éª¨åœ§è¿«é–‹å§‹|èƒ¸éª¨åœ§è¿«ï¼ˆå¿ƒè‡“ãƒãƒƒã‚µãƒ¼ã‚¸ï¼‰é–‹å§‹",
  "AEDè§£æ|AEDè£…ç€ãƒ»è§£æé–‹å§‹",
  "é›»æ°—ã‚·ãƒ§ãƒƒã‚¯|AEDã«ã‚ˆã‚‹é›»æ°—ã‚·ãƒ§ãƒƒã‚¯å®Ÿæ–½"
];

/* ===================== state ===================== */
let settings = {
  schoolName:"", schoolAddr:"", schoolPhone:"",
  casePresets:[...DEFAULT_CASES],
  checkPresets:[...DEFAULT_CHECKS],
  quickStatus:[...DEFAULT_QUICK_STATUS],
  quickSymptoms:[...DEFAULT_QUICK_SYMPTOMS],
  quickTreatment:[...DEFAULT_QUICK_TREATMENT]
};

let incident = {
  active:false,
  startTs:null,
  endTs:null,
  importantNext:false,
  entries:[],
  checklist:{},
  form:{
    place:"", pName:"", pGrade:"", pSex:"", pBirth:"",
    symptom:"", pHistory:"", pAllergy:""
  },
  computedAgeStr:"--"
};

function toggleCollapse(id){ $(id).classList.toggle("hidden"); }
function toggleAccordion(id){
  const el = $(id);
  const icon = $("icon-" + id);
  el.classList.toggle("open");
  icon.classList.toggle("rotate-180");
}

/* ===================== tab ===================== */
function switchTab(tabNum){
  if(tabNum===1){
    $("section1").classList.remove("hidden");
    $("section2").classList.add("hidden");
    $("nav1").classList.replace("text-slate-400", "text-blue-600");
    $("nav2").classList.replace("text-blue-600", "text-slate-400");
  }else{
    $("section1").classList.add("hidden");
    $("section2").classList.remove("hidden");
    $("nav2").classList.replace("text-slate-400", "text-blue-600");
    $("nav1").classList.replace("text-blue-600", "text-slate-400");
    updateIncidentBar();
  }
}
$("nav1").onclick = () => switchTab(1);
$("nav2").onclick = () => switchTab(2);

/* ===================== migration v16 -> v17 ===================== */
function migrateIfNeeded(){
  if(!localStorage.getItem(SETTINGS_KEY_V17)){
    const s16 = localStorage.getItem(SETTINGS_KEY_V16);
    if(s16) localStorage.setItem(SETTINGS_KEY_V17, s16);
  }
  if(!localStorage.getItem(INCIDENT_KEY_V17)){
    const i16 = localStorage.getItem(INCIDENT_KEY_V16);
    if(i16) localStorage.setItem(INCIDENT_KEY_V17, i16);
  }
}

/* ===================== settings UI ===================== */
function setPresetInputs(){
  document.querySelectorAll(".casePreset").forEach(inp=>{
    const idx = parseInt(inp.dataset.idx,10);
    inp.value = settings.casePresets[idx] ?? "";
  });
  document.querySelectorAll(".checkPreset").forEach(inp=>{
    const idx = parseInt(inp.dataset.idx,10);
    inp.value = settings.checkPresets[idx] ?? "";
  });
  document.querySelectorAll(".quickStatusPreset").forEach(inp=>{
    const idx = parseInt(inp.dataset.idx,10);
    inp.value = settings.quickStatus[idx] ?? "";
  });
  document.querySelectorAll(".quickSymptomsPreset").forEach(inp=>{
    const idx = parseInt(inp.dataset.idx,10);
    inp.value = settings.quickSymptoms[idx] ?? "";
  });
  document.querySelectorAll(".quickTreatmentPreset").forEach(inp=>{
    const idx = parseInt(inp.dataset.idx,10);
    inp.value = settings.quickTreatment[idx] ?? "";
  });
}
function compactListFromInputs(selector){
  const arr=[];
  document.querySelectorAll(selector).forEach(inp=>{
    const v=(inp.value||"").trim();
    if(v) arr.push(v);
  });
  return arr.slice(0,10);
}
function loadSettings(){
  const saved = localStorage.getItem(SETTINGS_KEY_V17);
  if(saved){
    try{
      const s=JSON.parse(saved);
      settings = {
        schoolName: s.schoolName ?? s.name ?? "",
        schoolAddr: s.schoolAddr ?? s.addr ?? "",
        schoolPhone: s.schoolPhone ?? s.phone ?? "",
        casePresets: Array.isArray(s.casePresets) ? s.casePresets.slice(0,10) : [...DEFAULT_CASES],
        checkPresets: Array.isArray(s.checkPresets) ? s.checkPresets.slice(0,10) : [...DEFAULT_CHECKS],
        quickStatus: Array.isArray(s.quickStatus) ? s.quickStatus.slice(0,10) : [...DEFAULT_QUICK_STATUS],
        quickSymptoms: Array.isArray(s.quickSymptoms) ? s.quickSymptoms.slice(0,10) : [...DEFAULT_QUICK_SYMPTOMS],
        quickTreatment: Array.isArray(s.quickTreatment) ? s.quickTreatment.slice(0,10) : [...DEFAULT_QUICK_TREATMENT],
      };
    }catch(e){}
  }
  $("schoolName").value = settings.schoolName || "";
  $("schoolAddr").value = settings.schoolAddr || "";
  $("schoolPhone").value = settings.schoolPhone || "";
  setPresetInputs();
  renderCaseButtons();
  renderChecklist();
  renderQuickButtons();
}
function saveSettings(){
  settings.schoolName = $("schoolName").value || "";
  settings.schoolAddr = $("schoolAddr").value || "";
  settings.schoolPhone = $("schoolPhone").value || "";
  settings.casePresets = compactListFromInputs(".casePreset");
  settings.checkPresets = compactListFromInputs(".checkPreset");
  settings.quickStatus = compactListFromInputs(".quickStatusPreset");
  settings.quickSymptoms = compactListFromInputs(".quickSymptomsPreset");
  settings.quickTreatment = compactListFromInputs(".quickTreatmentPreset");
  localStorage.setItem(SETTINGS_KEY_V17, JSON.stringify(settings));
}

/* ===================== settings CSV export/import ===================== */
function settingsToCSV(){
  const rows = [];
  rows.push(["type","index","value"]);
  rows.push(["schoolName","",settings.schoolName||""]);
  rows.push(["schoolAddr","",settings.schoolAddr||""]);
  rows.push(["schoolPhone","",settings.schoolPhone||""]);
  (settings.casePresets||[]).slice(0,10).forEach((v,i)=> rows.push(["case", String(i+1), v]));
  (settings.checkPresets||[]).slice(0,10).forEach((v,i)=> rows.push(["check", String(i+1), v]));
  (settings.quickStatus||[]).slice(0,10).forEach((v,i)=> rows.push(["quickStatus", String(i+1), v]));
  (settings.quickSymptoms||[]).slice(0,10).forEach((v,i)=> rows.push(["quickSymptoms", String(i+1), v]));
  (settings.quickTreatment||[]).slice(0,10).forEach((v,i)=> rows.push(["quickTreatment", String(i+1), v]));
  return toCSV(rows);
}
function applySettingsFromCSV(csvText){
  const rows = parseCSV(csvText);
  if(rows.length < 2) throw new Error("CSVã®å†…å®¹ãŒä¸è¶³ã—ã¦ã„ã¾ã™");

  const head = rows[0].map(x=>String(x||"").trim());
  const tIdx = head.indexOf("type");
  const vIdx = head.indexOf("value");
  if(tIdx === -1 || vIdx === -1) throw new Error("CSVãƒ˜ãƒƒãƒ€ãƒ¼ãŒä¸æ­£ã§ã™ï¼ˆtype,valueãŒå¿…è¦ï¼‰");

  const next = {
    schoolName:"", schoolAddr:"", schoolPhone:"",
    casePresets:[],
    checkPresets:[],
    quickStatus:[],
    quickSymptoms:[],
    quickTreatment:[]
  };

  for(let r=1; r<rows.length; r++){
    const row = rows[r];
    const type = String(row[tIdx] ?? "").trim();
    const val  = String(row[vIdx] ?? "").trim();
    if(!type) continue;

    if(type === "schoolName") next.schoolName = val;
    else if(type === "schoolAddr") next.schoolAddr = val;
    else if(type === "schoolPhone") next.schoolPhone = val;
    else if(type === "case") next.casePresets.push(val);
    else if(type === "check") next.checkPresets.push(val);
    else if(type === "quickStatus") next.quickStatus.push(val);
    else if(type === "quickSymptoms") next.quickSymptoms.push(val);
    else if(type === "quickTreatment") next.quickTreatment.push(val);
  }

  settings = {
    schoolName: next.schoolName || "",
    schoolAddr: next.schoolAddr || "",
    schoolPhone: next.schoolPhone || "",
    casePresets: (next.casePresets.length ? next.casePresets : DEFAULT_CASES).slice(0,10),
    checkPresets: (next.checkPresets.length ? next.checkPresets : DEFAULT_CHECKS).slice(0,10),
    quickStatus: (next.quickStatus.length ? next.quickStatus : DEFAULT_QUICK_STATUS).slice(0,10),
    quickSymptoms: (next.quickSymptoms.length ? next.quickSymptoms : DEFAULT_QUICK_SYMPTOMS).slice(0,10),
    quickTreatment: (next.quickTreatment.length ? next.quickTreatment : DEFAULT_QUICK_TREATMENT).slice(0,10),
  };

  localStorage.setItem(SETTINGS_KEY_V17, JSON.stringify(settings));
  loadSettings();
}

/* ===================== incident load/save ===================== */
function ensureEntryIds(){
  incident.entries = (Array.isArray(incident.entries) ? incident.entries : []).map(e=>{
    if(!e) return null;
    return {
      id: e.id || genId(),
      ts: e.ts || Date.now(),
      time: e.time || nowTimeStr(new Date(e.ts || Date.now())),
      text: e.text || "",
      important: !!e.important
    };
  }).filter(Boolean);
}
function saveIncident(){
  incident.form = {
    place:$("place").value || "",
    pName:$("pName").value || "",
    pGrade:$("pGrade").value || "",
    pSex:$("pSex").value || "",
    pBirth:$("pBirth").value || "",
    symptom:$("symptom").value || "",
    pHistory:$("pHistory").value || "",
    pAllergy:$("pAllergy").value || ""
  };
  ensureEntryIds();
  localStorage.setItem(INCIDENT_KEY_V17, JSON.stringify(incident));
}
function loadIncident(){
  const saved = localStorage.getItem(INCIDENT_KEY_V17);
  if(saved){
    try{
      const i=JSON.parse(saved);
      incident = {
        ...incident,
        ...i,
        entries: Array.isArray(i.entries) ? i.entries : [],
        checklist: (i.checklist && typeof i.checklist==="object") ? i.checklist : {},
        form: (i.form && typeof i.form==="object") ? i.form : incident.form,
        computedAgeStr: i.computedAgeStr ?? incident.computedAgeStr
      };
    }catch(e){}
  }

  ensureEntryIds();

  $("place").value   = incident.form.place || "";
  $("pName").value   = incident.form.pName || "";
  $("pGrade").value  = incident.form.pGrade || "";
  $("pSex").value    = incident.form.pSex || "";
  $("pBirth").value  = incident.form.pBirth || "";
  $("symptom").value = incident.form.symptom || "";
  $("pHistory").value = incident.form.pHistory || "";
  $("pAllergy").value = incident.form.pAllergy || "";

  $("ageDisplay").innerText = `å¹´é½¢ï¼š${incident.computedAgeStr || "--"} æ­³`;
  renderTimeline();
  renderChecklist();
  updateIncidentBar();
  buildScript();
}

/* ===================== age ===================== */
function updateAge(){
  const birthVal = $("pBirth").value;
  const gradeVal = $("pGrade").value;
  const now = new Date();

  let computedAgeStr = "--";
  if(birthVal){
    const bd = new Date(birthVal);
    let age = now.getFullYear() - bd.getFullYear();
    const m = now.getMonth() - bd.getMonth();
    if(m < 0 || (m===0 && now.getDate() < bd.getDate())) age--;
    computedAgeStr = String(age);
  }else if(gradeVal && !isNaN(gradeVal)){
    const g = parseInt(gradeVal,10);
    computedAgeStr = `${g+5}ã€œ${g+6}`;
  }else{
    computedAgeStr = "--";
  }
  incident.computedAgeStr = computedAgeStr;
  $("ageDisplay").innerText = `å¹´é½¢ï¼š${computedAgeStr} æ­³`;
  saveIncident();
  buildScript();
}

/* ===================== script ===================== */
function buildScript(){
  const gradeVal = $("pGrade").value;
  const gradeStr = gradeVal
    ? (String(gradeVal).match(/^\d$/) ? `${gradeVal}å¹´ç”Ÿ` : gradeVal)
    : "ï¼ˆä¸æ˜ï¼‰";

  const ageStr = (incident.computedAgeStr && incident.computedAgeStr!=="--") ? `${incident.computedAgeStr}æ­³` : "";

  const data = {
    school: $("schoolName").value || "ï¼ˆå­¦æ ¡åï¼‰",
    addr: $("schoolAddr").value || "ï¼ˆå­¦æ ¡ä½æ‰€ï¼‰",
    place: $("place").value || "ï¼ˆå ´æ‰€ä¸æ˜ï¼‰",
    phone: $("schoolPhone").value || "ï¼ˆé›»è©±ï¼‰",
    pName: $("pName").value || "ï¼ˆæ°åä¸æ˜ï¼‰",
    pGrade: gradeStr,
    pSex: $("pSex").value || "ï¼ˆæ€§åˆ¥ä¸æ˜ï¼‰",
    symptom: $("symptom").value || "ï¼ˆç—‡çŠ¶ä¸æ˜ï¼‰",
    age: ageStr
  };

  $("scriptDisplay").innerText =
`ã€Œæ•‘æ€¥è¦è«‹ã§ã™ã€
å ´æ‰€ï¼š${data.school}
ä½æ‰€ï¼š${data.addr}
è©³ç´°ï¼š${data.place}
é›»è©±ï¼š${data.phone}

å¯¾è±¡ï¼š${data.pName}ã•ã‚“ï¼ˆ${data.pGrade}ãƒ»${data.pSex}${data.age ? "ãƒ»" + data.age : ""}ï¼‰
ç—‡çŠ¶ï¼š${data.symptom}

æ­£é–€ã«ã¦èª˜å°å¾…æ©Ÿä¸­ã§ã™ã€‚`;
}

/* ===================== logging ===================== */
function addEntry(text, forceImportant=false){
  const t = (text||"").trim();
  if(!t) return;

  const d = new Date();
  const e = {
    id: genId(),
    ts: d.getTime(),
    time: nowTimeStr(d),
    text: t,
    important: forceImportant ? true : !!incident.importantNext
  };

  incident.entries.push(e);

  incident.importantNext = false;
  $("btnToggleImportant").textContent = "é‡è¦ï¼šOFF";
  $("btnToggleImportant").classList.remove("bg-amber-400","border-amber-400","text-slate-900");
  $("btnToggleImportant").classList.add("border");

  saveIncident();
  renderTimeline();
  updateIncidentBar();
}

function renderTimeline(){
  const wrap = $("timeline");
  const empty = $("timelineEmpty");
  wrap.innerHTML = "";
  const entries = Array.isArray(incident.entries) ? incident.entries : [];

  if(entries.length===0){
    empty.classList.remove("hidden");
    wrap.appendChild(empty);
    return;
  }
  empty.classList.add("hidden");

  const list = entries.slice().reverse();
  list.forEach(e=>{
    const div = document.createElement("div");
    div.className = `flex gap-3 bg-white p-4 rounded-2xl shadow-sm border ${e.important ? "border-amber-300 bg-amber-50" : "border-slate-200"}`;
    div.innerHTML = `
      <div class="shrink-0">
        <div class="text-blue-600 font-black text-xs">${escapeHtml(e.time)}</div>
        <div class="mt-1 text-[10px] font-black ${e.important ? "text-amber-700" : "text-slate-400"}">${e.important ? "â˜…é‡è¦" : ""}</div>
      </div>
      <div class="flex-1 text-slate-900 text-sm font-black whitespace-pre-wrap break-words">${escapeHtml(e.text)}</div>
    `;
    wrap.appendChild(div);
  });
}

/* ===================== incident bar ===================== */
let incidentTimer = null;
function updateIncidentBar(){
  const start = incident.startTs;
  $("incidentStartLabel").textContent = start ? fmtDateTime(start).split(" ").slice(-1)[0] : "--:--";
  const entries = Array.isArray(incident.entries) ? incident.entries : [];
  $("lastEntryLabel").textContent = entries.length ? entries[entries.length-1].time : "--:--";

  if(incident.active && start){
    $("incidentElapsedLabel").textContent = msToElapsed(Date.now() - start);
  }else if(!incident.active && start && incident.endTs){
    $("incidentElapsedLabel").textContent = msToElapsed(incident.endTs - start);
  }else{
    $("incidentElapsedLabel").textContent = "--";
  }

  /* v17: disabledã«ä¾å­˜ã—ãªã„ï¼ˆæŠ¼ã›ãªããªã‚‹äº‹æ•…ã‚’é˜²ãï¼‰ */
  $("btnStartIncident").classList.toggle("opacity-50", incident.active);
  $("btnStopIncident").classList.toggle("opacity-50", !incident.active);
}
function startIncident(){
  if(incident.active) return;
  incident.active = true;
  incident.startTs = incident.startTs || Date.now();
  incident.endTs = null;
  saveIncident();
  addEntry("è¨˜éŒ²é–‹å§‹", true);
  updateIncidentBar();
  startIncidentTimer();
}
function stopIncident(){
  if(!incident.active) return;
  incident.active = false;
  incident.endTs = Date.now();
  saveIncident();
  addEntry("è¨˜éŒ²çµ‚äº†ï¼ˆå¼•ãç¶™ãå®Œäº†ãªã©ï¼‰", true);
  updateIncidentBar();
  stopIncidentTimer();
}
function startIncidentTimer(){
  if(incidentTimer) clearInterval(incidentTimer);
  incidentTimer = setInterval(()=>updateIncidentBar(), 1000);
}
function stopIncidentTimer(){
  if(incidentTimer) clearInterval(incidentTimer);
  incidentTimer = null;
}

/* v17: è¨˜éŒ²é–‹å§‹/çµ‚äº†ã®åå¿œæ”¹å–„ï¼ˆpointerupå¯¾å¿œï¼‹äºŒé‡ç™ºç«ã‚¬ãƒ¼ãƒ‰ï¼‹ä¾‹å¤–å¸åï¼‰ */
let lastStartStopTs = 0;
function guarded(actionFn){
  const now = Date.now();
  if(now - lastStartStopTs < 350) return; // äºŒé‡ç™ºç«é˜²æ­¢
  lastStartStopTs = now;
  try{
    actionFn();
  }catch(err){
    console.error(err);
    alert("ãƒœã‚¿ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nï¼ˆç«¯æœ«ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰");
  }finally{
    requestAnimationFrame(()=>updateIncidentBar());
  }
}
function onPress(el, fn){
  el.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); fn(); }, {passive:false});
  el.addEventListener("pointerup", (e)=>{ e.preventDefault(); e.stopPropagation(); fn(); }, {passive:false});
  el.addEventListener("touchend", (e)=>{ e.preventDefault(); e.stopPropagation(); fn(); }, {passive:false});
}

/* ===================== checklist ===================== */
function checklistItems(){
  return (settings.checkPresets || []).filter(Boolean).slice(0,10);
}
function renderChecklist(){
  const wrap = $("checklist");
  wrap.innerHTML = "";
  const items = checklistItems();

  if(items.length===0){
    wrap.innerHTML = `<div class="text-center text-sm font-black text-slate-400 py-6 border rounded-2xl bg-slate-50">
      ï¼ˆãƒã‚§ãƒƒã‚¯é …ç›®ãŒæœªè¨­å®šã§ã™ã€‚å­¦æ ¡æƒ…å ±ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰
    </div>`;
    return;
  }

  items.forEach(label=>{
    const checked = !!incident.checklist[label];
    const row = document.createElement("button");
    row.className = `w-full text-left border rounded-2xl p-3 flex items-start gap-3 ${checked ? "bg-emerald-50 border-emerald-200" : "bg-white border-slate-200"}`;
    row.innerHTML = `
      <div class="mt-0.5 w-7 h-7 rounded-xl flex items-center justify-center ${checked ? "bg-emerald-600 text-white" : "bg-slate-100 text-slate-500"} font-black text-xs">
        ${checked ? "âœ“" : ""}
      </div>
      <div class="flex-1">
        <div class="font-black text-sm text-slate-900">${escapeHtml(label)}</div>
        <div class="text-[10px] font-black ${checked ? "text-emerald-700" : "text-slate-500"}">
          ${checked ? "å®Œäº†ï¼ˆã‚¿ãƒƒãƒ—ã§è§£é™¤ï¼‰" : "æœªï¼ˆã‚¿ãƒƒãƒ—ã§å®Œäº†ï¼‰"}
        </div>
      </div>
    `;
    row.onclick = ()=>{
      incident.checklist[label] = !incident.checklist[label];
      saveIncident();
      renderChecklist();
      addEntry((incident.checklist[label] ? "åˆå‹•ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼š " : "åˆå‹•ãƒã‚§ãƒƒã‚¯è§£é™¤ï¼š ") + label);
    };
    wrap.appendChild(row);
  });
}
function resetChecklist(){
  incident.checklist = {};
  saveIncident();
  renderChecklist();
  addEntry("åˆå‹•ãƒã‚§ãƒƒã‚¯ï¼šå…¨è§£é™¤");
}

/* ===================== cases ===================== */
function renderCaseButtons(){
  const wrap = $("caseButtons");
  wrap.innerHTML = "";
  const cases = (settings.casePresets || []).filter(Boolean).slice(0,10);

  if(cases.length===0){
    wrap.innerHTML = `<div class="col-span-2 text-center text-sm font-black text-slate-400 py-6 border rounded-2xl bg-slate-50">
      ï¼ˆã‚±ãƒ¼ã‚¹æœªè¨­å®šã§ã™ã€‚å­¦æ ¡æƒ…å ±ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰
    </div>`;
    return;
  }

  cases.forEach(label=>{
    const btn = document.createElement("button");
    btn.className = "quick-tag bg-amber-50 border border-amber-200 text-amber-900 rounded-2xl text-xs font-black";
    btn.textContent = label;
    btn.onclick = ()=>{
      tapFlash(btn);
      const cur = ($("symptom").value || "").trim();
      const add = label;
      $("symptom").value = cur ? (cur.includes(add) ? cur : (cur + " / " + add)) : add;
      buildScript();
      saveIncident();
      addEntry(`ã‚±ãƒ¼ã‚¹é¸æŠï¼š${label}`, true);
    };
    wrap.appendChild(btn);
  });
}

/* ===================== quick inputs (editable) ===================== */
function parseQuickLine(line){
  const raw = (line||"").trim();
  if(!raw) return null;
  if(raw.includes("|")){
    const [left, ...rest] = raw.split("|");
    const label = (left||"").trim();
    const val = rest.join("|").trim();
    if(!label && !val) return null;
    return { label: label || val || raw, val: val || label || raw };
  }
  const display = raw.split("ï¼ˆ")[0].trim() || raw;
  return { label: display.length > 10 ? display.slice(0,10) : display, val: raw };
}

function renderQuickGrid(gridId, lines, theme){
  const grid = $(gridId);
  grid.innerHTML = "";
  const items = (lines || []).filter(Boolean).slice(0,10).map(parseQuickLine).filter(Boolean);

  if(items.length===0){
    grid.innerHTML = `<div class="col-span-2 text-center text-sm font-black text-slate-400 py-6 border rounded-2xl bg-slate-50">
      ï¼ˆæœªè¨­å®šã§ã™ã€‚å­¦æ ¡æƒ…å ±ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰
    </div>`;
    return;
  }

  items.forEach(it=>{
    const btn = document.createElement("button");
    btn.className = `quick-tag rounded-lg text-xs font-black ${theme}`;
    btn.textContent = it.label;
    btn.onclick = ()=>{
      tapFlash(btn);
      addEntry(it.val);
    };
    grid.appendChild(btn);
  });
}

function renderQuickButtons(){
  renderQuickGrid("quickStatusGrid", settings.quickStatus, "bg-blue-100 text-blue-800");
  renderQuickGrid("quickSymptomsGrid", settings.quickSymptoms, "bg-slate-50 border text-slate-800");
  renderQuickGrid("quickTreatmentGrid", settings.quickTreatment, "bg-green-100 text-green-800");
}

/* ===================== voice (same as v16) ===================== */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let isRecording = false;
let voiceBase = "";
let voiceInterim = "";

function isIOS(){
  const ua = navigator.userAgent || "";
  return /iPhone|iPad|iPod/.test(ua);
}
function isSecure(){
  return window.isSecureContext || location.protocol === "https:" || location.hostname === "localhost";
}

function voiceSupportedHint(){
  const parts = [];
  if(!isSecure()){
    parts.push("âš ï¸ éŸ³å£°å…¥åŠ›ã¯HTTPSç’°å¢ƒã§ãªã„ã¨å‹•ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆfile://ã¯ä¸å¯ã®ã“ã¨ãŒå¤šã„ï¼‰");
  }
  if(!SpeechRecognition){
    parts.push("ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã€Œãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°èªè­˜ã€æœªå¯¾å¿œã§ã™ã€‚iPhoneã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒã‚¤ã‚¯ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  }else if(isIOS()){
    parts.push("iPhoneã¯ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°èªè­˜ãŒä¸å®‰å®š/æœªå¯¾å¿œã®ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚å‹•ã‹ãªã„å ´åˆã¯ä¸‹ã®ãƒœã‚¿ãƒ³ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰éŸ³å£°å…¥åŠ›ï¼‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚");
  }else{
    parts.push("å¯¾å¿œç«¯æœ«ã§ã¯ã€RECã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã—ã—ã¾ã™ã€‚");
  }
  $("voiceSupportHint").textContent = parts.join(" / ");
}

function setupRecognition(){
  if(!SpeechRecognition) return;
  recognition = new SpeechRecognition();
  recognition.lang = "ja-JP";
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onresult = (event)=>{
    let interim = "";
    let final = "";
    for(let i=event.resultIndex; i<event.results.length; i++){
      if(event.results[i].isFinal) final += event.results[i][0].transcript;
      else interim += event.results[i][0].transcript;
    }

    if(final){
      voiceBase += final;
      voiceInterim = "";
    }else{
      voiceInterim = interim;
    }

    $("voiceInputArea").value = (voiceBase + voiceInterim).trimStart();
    $("interimText").innerText = voiceInterim ? voiceInterim : "";
    saveIncident();
  };

  recognition.onerror = (e)=>{
    $("interimText").innerText = "";
    stopRecUIOnly();
    const msg = e?.error ? `éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼ï¼š${e.error}` : "éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼";
    alert(msg + "\n\nå‹•ã‹ãªã„å ´åˆï¼š\nãƒ»HTTPSã§é–‹ã\nãƒ»æ¨©é™ï¼ˆãƒã‚¤ã‚¯ï¼‰è¨±å¯\nãƒ»iPhoneã¯ã€Œã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒã‚¤ã‚¯ã€ã§å…¥åŠ›");
  };

  recognition.onend = ()=>{
    if(isRecording){
      try{ recognition.start(); }catch(e){}
    }
  };
}

function startRec(){
  if(isIOS() && !SpeechRecognition){
    focusForKeyboardDictation();
    return;
  }
  if(!recognition){
    focusForKeyboardDictation();
    return;
  }
  if(!isSecure()){
    alert("ã“ã®ãƒšãƒ¼ã‚¸ãŒHTTPSã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\néŸ³å£°å…¥åŠ›ã¯HTTPSã§ãªã„ã¨å‹•ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚\n\nå¯èƒ½ãªã‚‰HTTPSã§é–‹ã„ã¦ãã ã•ã„ã€‚");
  }

  isRecording = true;
  voiceBase = ($("voiceInputArea").value || "");
  voiceInterim = "";

  try{ recognition.start(); }catch(e){
    isRecording = false;
    focusForKeyboardDictation();
    return;
  }

  $("pulseRing").classList.remove("hidden");
  $("btnVoiceRec").classList.remove("bg-blue-600");
  $("btnVoiceRec").classList.add("bg-red-600");
  $("micText").innerText = "REC ON";
}

function stopRecUIOnly(){
  $("pulseRing").classList.add("hidden");
  $("btnVoiceRec").classList.remove("bg-red-600");
  $("btnVoiceRec").classList.add("bg-blue-600");
  $("micText").innerText = "REC START";
}

function stopRec(){
  isRecording = false;
  try{ if(recognition) recognition.stop(); }catch(e){}
  stopRecUIOnly();

  $("interimText").innerText = "";

  if(voiceInterim){
    voiceBase += voiceInterim;
    voiceInterim = "";
    $("voiceInputArea").value = voiceBase.trimStart();
  }
  saveIncident();
}

function focusForKeyboardDictation(){
  stopRec();
  $("voiceInputArea").focus();
  $("voiceInputArea").scrollIntoView({behavior:"smooth", block:"center"});
  alert("ã“ã®ç«¯æœ«ã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®éŸ³å£°èªè­˜ãŒå‹•ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚\n\nâœ… å¯¾å‡¦ï¼šã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒã‚¤ã‚¯ï¼ˆéŸ³å£°å…¥åŠ›ï¼‰ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚\nï¼ˆå…¥åŠ›æ¬„ã‚’ã‚¿ãƒƒãƒ— â†’ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒã‚¤ã‚¯ï¼‰");
}

$("btnVoiceRec").onclick = ()=>{
  if(isRecording) stopRec();
  else startRec();
};
$("btnKeyboardDictation").onclick = ()=> focusForKeyboardDictation();

/* ===================== log viewer (v17: delete/saveã‚’ç¢ºå®Ÿã«) ===================== */
let lvOrderNewestFirst = true;
let lvOnlyImportant = false;
let lvMode = "card";
let lvEditingId = null;

function entriesToText(entries){
  return entries.map(e=>`${e.time} ${e.important ? "â˜… " : ""}${e.text}`).join("\n") || "ï¼ˆè¨˜éŒ²ãªã—ï¼‰";
}
function filteredEntries(){
  const q = ($("lvSearch").value||"").trim().toLowerCase();
  let entries = incident.entries.slice();

  if(lvOnlyImportant) entries = entries.filter(e=>!!e.important);
  if(q){
    entries = entries.filter(e=>{
      const t=(e.text||"").toLowerCase();
      const tm=(e.time||"").toLowerCase();
      return t.includes(q) || tm.includes(q);
    });
  }
  if(lvOrderNewestFirst) entries = entries.slice().reverse();
  return entries;
}
function updateEntryById(id, patch){
  const idx = incident.entries.findIndex(e=>e.id===id);
  if(idx<0) return false;
  incident.entries[idx] = { ...incident.entries[idx], ...patch };
  saveIncident();
  renderTimeline();
  updateIncidentBar();
  return true;
}
function deleteEntryById(id){
  const idx = incident.entries.findIndex(e=>e.id===id);
  if(idx<0) return false;
  incident.entries.splice(idx,1);
  if(lvEditingId === id) lvEditingId = null;
  saveIncident();
  renderTimeline();
  updateIncidentBar();
  return true;
}

function openLogViewer(){
  $("logViewerWrap").classList.remove("hidden");
  renderLogViewer();
}
function closeLogViewer(){
  $("logViewerWrap").classList.add("hidden");
  lvEditingId = null;
  $("lvAddBox").classList.add("hidden");
  $("lvAddText").value = "";
}

function renderLogViewer(){
  const list = filteredEntries();
  $("lvCount").textContent = String(list.length);
  $("lvOrder").textContent = `è¡¨ç¤ºï¼š${lvOrderNewestFirst ? "æ–°â†’å¤" : "å¤â†’æ–°"}`;
  $("lvOnlyImp").textContent = `é‡è¦ã®ã¿ï¼š${lvOnlyImportant ? "ON" : "OFF"}`;
  $("lvMode").textContent = `è¡¨ç¤ºï¼š${lvMode==="card" ? "ã‚«ãƒ¼ãƒ‰" : "ãƒ†ã‚­ã‚¹ãƒˆ"}`;

  const body = $("lvBody");
  body.innerHTML = "";

  if(lvMode==="text"){
    const pre=document.createElement("pre");
    pre.className="w-full whitespace-pre-wrap break-words text-sm font-black bg-slate-50 border rounded-2xl p-3";
    pre.textContent = entriesToText(list);
    body.appendChild(pre);
    return;
  }

  if(list.length===0){
    body.innerHTML = `<div class="text-center text-sm font-black text-slate-400 py-10">ï¼ˆè©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰</div>`;
    return;
  }

  list.forEach(e=>{
    const isEditing = (lvEditingId === e.id);
    const card=document.createElement("div");
    card.className=`bg-white border rounded-2xl p-3 shadow-sm mb-2 ${e.important ? "border-amber-300" : "border-slate-200"}`;

    card.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="shrink-0">
          <div class="text-blue-600 font-black text-xs">${escapeHtml(e.time)}</div>
          <button data-action="toggleImp" data-id="${escapeHtml(e.id)}" class="mt-1 text-[10px] font-black ${e.important ? "text-amber-600" : "text-slate-400"}">
            ${e.important ? "â˜…é‡è¦ï¼ˆè§£é™¤ï¼‰" : "â˜†é‡è¦ã«ã™ã‚‹"}
          </button>
        </div>

        <div class="flex-1">
          ${isEditing
            ? `<textarea data-edit-id="${escapeHtml(e.id)}" class="w-full p-3 bg-slate-50 border rounded-2xl text-sm font-black" rows="3">${escapeHtml(e.text)}</textarea>
               <div class="grid grid-cols-2 gap-2 mt-2">
                 <button data-action="save" data-id="${escapeHtml(e.id)}" class="py-3 rounded-2xl bg-blue-600 text-white text-sm font-black">ä¿å­˜</button>
                 <button data-action="cancel" data-id="${escapeHtml(e.id)}" class="py-3 rounded-2xl bg-white border text-sm font-black">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
               </div>`
            : `<div class="text-sm font-black whitespace-pre-wrap break-words">${escapeHtml(e.text||"")}</div>`
          }
        </div>
      </div>

      ${isEditing ? "" : `
      <div class="grid grid-cols-2 gap-2 mt-3">
        <button data-action="edit" data-id="${escapeHtml(e.id)}" class="py-3 rounded-2xl bg-white border text-sm font-black">ç·¨é›†</button>
        <button data-action="del" data-id="${escapeHtml(e.id)}" class="py-3 rounded-2xl bg-white border text-sm font-black text-red-600">å‰Šé™¤</button>
      </div>`}
    `;
    body.appendChild(card);
  });
}

/* v17: clickã ã‘ã§ãªã pointerup / touchend ã§ã‚‚ç¢ºå®Ÿã«å‡¦ç† */
function handleLvAction(ev){
  const btn = ev.target.closest && ev.target.closest("button[data-action]");
  if(!btn) return;
  ev.preventDefault(); ev.stopPropagation();

  const act = btn.dataset.action;
  const id = btn.dataset.id;

  if(act==="toggleImp"){
    const e = incident.entries.find(x=>x.id===id);
    if(!e) return;
    updateEntryById(id, { important: !e.important });
    renderLogViewer();
    return;
  }
  if(act==="edit"){
    lvEditingId = id;
    renderLogViewer();
    return;
  }
  if(act==="cancel"){
    lvEditingId = null;
    renderLogViewer();
    return;
  }
  if(act==="save"){
    const sel = `textarea[data-edit-id="${cssEscapeCompat(id)}"]`;
    const ta = document.querySelector(sel);
    const newText = (ta?.value || "").trim();
    if(!newText){
      alert("ç©ºã®è¨˜éŒ²ã¯ä¿å­˜ã§ãã¾ã›ã‚“ã€‚");
      return;
    }
    updateEntryById(id, { text: newText });
    lvEditingId = null;              // â† v17: ä¿å­˜ã ã‘ã§æˆ»ã‚‹
    renderLogViewer();
    return;
  }
  if(act==="del"){
    const ok = confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if(!ok) return;
    deleteEntryById(id);             // â† v17: å‰Šé™¤æŠ¼ä¸‹ã§å³æ¶ˆãˆã‚‹
    lvEditingId = null;
    renderLogViewer();
    return;
  }
}
$("lvBody").addEventListener("click", handleLvAction, {passive:false});
$("lvBody").addEventListener("pointerup", handleLvAction, {passive:false});
$("lvBody").addEventListener("touchend", handleLvAction, {passive:false});

/* ===================== report build (print + word) ===================== */
function buildReportData(){
  const schoolLine = `${$("schoolName").value || "æœªè¨­å®š"} / ${$("schoolAddr").value || "ä½æ‰€æœªè¨­å®š"} / ${$("schoolPhone").value || "é›»è©±æœªè¨­å®š"}`;

  const start = incident.startTs ? fmtDateTime(incident.startTs) : "æœªè¨˜éŒ²";
  const end   = incident.endTs ? fmtDateTime(incident.endTs) : (incident.active ? "ç¶™ç¶šä¸­" : "æœªè¨˜éŒ²");
  const elapsed = (incident.startTs && (incident.endTs || incident.active))
    ? msToElapsed((incident.endTs || Date.now()) - incident.startTs)
    : "--";

  const gradeVal = $("pGrade").value || "-";
  const gradeStr = String(gradeVal).match(/^\d$/) ? `${gradeVal}å¹´` : gradeVal;
  const patientLine = `${$("pName").value || "æ°åæœªè©³"} / ${gradeStr} / ${$("pSex").value || "-"} / ${incident.computedAgeStr || "--"}æ­³`;

  let medInfo = `ã€ç—‡çŠ¶ã€‘${$("symptom").value || "æœªå…¥åŠ›"}`;
  if($("pHistory").value) medInfo += `  ã€æ—¢å¾€ã€‘${$("pHistory").value}`;
  if($("pAllergy").value) medInfo += `  ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã€‘${$("pAllergy").value}`;

  const items = checklistItems();
  const ok = items.filter(x=>incident.checklist[x]);
  const ng = items.filter(x=>!incident.checklist[x]);

  return {
    created: new Date().toLocaleString("ja-JP"),
    schoolLine,
    incidentLine: `é–‹å§‹ï¼š${start} / çµ‚äº†ï¼š${end} / çµŒéï¼š${elapsed}`,
    patientLine,
    medInfo,
    checklistOk: ok,
    checklistNg: ng,
    entries: incident.entries.slice()
  };
}

function buildWordHtml(data){
  const rows = data.entries.length
    ? data.entries.map(e => `
      <tr>
        <td style="width:90px;font-weight:bold;vertical-align:top;border-bottom:1px solid #ccc;padding:6px;">${escapeHtml(e.time)}${e.important ? " â˜…" : ""}</td>
        <td style="border-bottom:1px solid #ccc;padding:6px;">${escapeHtml(e.text)}</td>
      </tr>
    `).join("")
    : `<tr><td colspan="2" style="padding:10px;color:#666;">è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>`;

  const checklistHtml = (checklistItems().length===0)
    ? `<div>ï¼ˆæœªè¨­å®šï¼‰</div>`
    : `<div><b>å®Œäº†ï¼š</b>${escapeHtml(data.checklistOk.length ? data.checklistOk.join(" / ") : "ãªã—")}</div>
       <div><b>æœªï¼š</b>${escapeHtml(data.checklistNg.length ? data.checklistNg.join(" / ") : "ãªã—")}</div>`;

  return `
<html>
<head>
<meta charset="UTF-8">
<style>
  body{ font-family: "Meiryo","Yu Gothic","MS PGothic",sans-serif; }
  h1{ font-size: 20pt; margin: 0 0 6pt 0; }
  .sub{ color:#666; font-size:10pt; margin-bottom:10pt; }
  .box{ border:1px solid #000; padding:10pt; margin-bottom:10pt; }
  table{ border-collapse:collapse; width:100%; }
</style>
</head>
<body>
  <h1>æ•‘æ€¥æ¬é€ãƒ»çµŒéè¨˜éŒ²ç”¨ç´™</h1>
  <div class="sub">ä½œæˆæ—¥ï¼š${escapeHtml(data.created)}ï¼ˆç¾å ´æœ€å¼· v17ï¼‰</div>

  <div class="box">
    <div><b>å­¦æ ¡å / ä½æ‰€ / é›»è©±ï¼š</b>${escapeHtml(data.schoolLine)}</div>
    <div style="margin-top:6pt;"><b>ç™ºç”Ÿ / çµ‚äº† / çµŒéï¼š</b>${escapeHtml(data.incidentLine)}</div>
    <div style="margin-top:6pt;"><b>å‚·ç—…è€…ï¼š</b>${escapeHtml(data.patientLine)}</div>
    <div style="margin-top:6pt;"><b>ç¾åœ¨ã®ä¸»ãªç—‡çŠ¶ãƒ»æ—¢å¾€æ­´ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ï¼š</b><br>${escapeHtml(data.medInfo)}</div>
    <div style="margin-top:6pt;"><b>åˆå‹•ãƒã‚§ãƒƒã‚¯çŠ¶æ³ï¼š</b><br>${checklistHtml}</div>
  </div>

  <h2 style="font-size:14pt;border-left:4px solid #000;padding-left:6pt;">æ™‚ç³»åˆ—è¨˜éŒ²</h2>
  <table>
    ${rows}
  </table>
</body>
</html>`;
}

/* ===================== print ===================== */
$("btnPrint").onclick = ()=>{
  const d = buildReportData();
  $("printTimestamp").innerText = `ä½œæˆæ—¥ï¼š${d.created}`;
  $("printSchoolInfo").innerText = d.schoolLine;
  $("printIncidentInfo").innerText = d.incidentLine;
  $("printPatientInfo").innerText = d.patientLine;
  $("printMedicalInfo").innerText = d.medInfo;

  const items = checklistItems();
  if(items.length===0){
    $("printChecklist").innerText = "ï¼ˆæœªè¨­å®šï¼‰";
  }else{
    $("printChecklist").innerHTML =
      `<div><b>å®Œäº†ï¼š</b>${escapeHtml(d.checklistOk.length ? d.checklistOk.join(" / ") : "ãªã—")}</div>` +
      `<div><b>æœªï¼š</b>${escapeHtml(d.checklistNg.length ? d.checklistNg.join(" / ") : "ãªã—")}</div>`;
  }

  const container = $("printTimeline");
  container.innerHTML = "";
  if(d.entries.length===0){
    container.innerHTML = "<p class='py-4 text-center text-sm text-gray-400'>è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
  }else{
    d.entries.forEach(e=>{
      const row = document.createElement("div");
      row.className = "flex border-b border-gray-300 py-2 timeline-item";
      row.innerHTML = `<div class="w-24 font-bold text-sm">${escapeHtml(e.time)}${e.important ? " â˜…" : ""}</div><div class="flex-1 text-sm">${escapeHtml(e.text)}</div>`;
      container.appendChild(row);
    });
  }

  window.print();
};

/* ===================== Word export ===================== */
$("btnWord").onclick = ()=>{
  const d = buildReportData();
  const html = buildWordHtml(d);
  const content = "\ufeff" + html; // BOMä»˜ã
  downloadFile(`æ•‘æ€¥æ¬é€_çµŒéè¨˜éŒ²_${ymd_hm()}.doc`, content, "application/msword");
  alert("Wordãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.docï¼‰ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\nï¼ˆWordã§é–‹ã‘ã¾ã™ï¼‰");
};

/* ===================== wiring ===================== */
$("btnAddTimeline").onclick = ()=>{
  const text = ($("voiceInputArea").value || "").trim();
  if(!text) return;
  addEntry(text);
  $("voiceInputArea").value = "";
  voiceBase = ""; voiceInterim = "";
  stopRec();
};

$("btnToggleImportant").onclick = ()=>{
  incident.importantNext = !incident.importantNext;
  $("btnToggleImportant").textContent = incident.importantNext ? "é‡è¦ï¼šON" : "é‡è¦ï¼šOFF";
  if(incident.importantNext){
    $("btnToggleImportant").classList.add("bg-amber-400","border-amber-400","text-slate-900");
    $("btnToggleImportant").classList.remove("border");
  }else{
    $("btnToggleImportant").classList.remove("bg-amber-400","border-amber-400","text-slate-900");
    $("btnToggleImportant").classList.add("border");
  }
  saveIncident();
};

$("btnCopyTimeline").onclick = ()=> copyText(entriesToText(incident.entries));
$("btnCopyScript").onclick = ()=> copyText($("scriptDisplay").innerText);
$("btnShareScript").onclick = ()=> shareText("119é€šå ±ç”¨åŸç¨¿", $("scriptDisplay").innerText);

/* v17: é–‹å§‹/çµ‚äº†ã®åå¿œæ”¹å–„ï¼ˆclick/pointer/touchï¼‰ */
onPress($("btnStartIncident"), ()=> guarded(()=>{
  if(incident.active){ alert("ã™ã§ã«è¨˜éŒ²ä¸­ã§ã™ã€‚"); return; }
  startIncident();
}));
onPress($("btnStopIncident"), ()=> guarded(()=>{
  if(!incident.active){ alert("ã¾ã è¨˜éŒ²é–‹å§‹ã—ã¦ã„ã¾ã›ã‚“ã€‚"); return; }
  stopIncident();
}));

$("btnResetAll").onclick = ()=>{
  const ok = confirm("å…¨æ¶ˆå»ã—ã¾ã™ã€‚\nï¼ˆè¨˜éŒ²ãƒ»ãƒã‚§ãƒƒã‚¯ãƒ»å…¥åŠ›å†…å®¹ãŒç«¯æœ«ã‹ã‚‰æ¶ˆãˆã¾ã™ï¼‰\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
  if(!ok) return;
  incident = {
    active:false, startTs:null, endTs:null,
    importantNext:false,
    entries:[],
    checklist:{},
    form:{ place:"", pName:"", pGrade:"", pSex:"", pBirth:"", symptom:"", pHistory:"", pAllergy:"" },
    computedAgeStr:"--"
  };
  saveIncident();
  loadIncident();
  stopIncidentTimer();
  alert("æ¶ˆå»ã—ã¾ã—ãŸã€‚");
};

$("btnChecklistReset").onclick = resetChecklist;

$("btnCopyChecklist").onclick = ()=>{
  const items = checklistItems();
  if(items.length===0) return copyText("ï¼ˆåˆå‹•ãƒã‚§ãƒƒã‚¯ï¼šæœªè¨­å®šï¼‰");

  const ok = items.filter(x=>incident.checklist[x]);
  const ng = items.filter(x=>!incident.checklist[x]);
  const txt = `ã€åˆå‹•ãƒã‚§ãƒƒã‚¯ã€‘\nå®Œäº†ï¼š${ok.length ? ok.join(" / ") : "ãªã—"}\næœªï¼š${ng.length ? ng.join(" / ") : "ãªã—"}`;
  copyText(txt);
};

$("btnSaveSettings").onclick = ()=>{
  saveSettings();
  loadSettings();
  alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
};

$("btnExportSettings").onclick = async ()=>{
  saveSettings();
  const pack = {
    version:"v17",
    school: settings.schoolName || "",
    addr: settings.schoolAddr || "",
    phone: settings.schoolPhone || "",
    casePresets: settings.casePresets || [],
    checkPresets: settings.checkPresets || [],
    quickStatus: settings.quickStatus || [],
    quickSymptoms: settings.quickSymptoms || [],
    quickTreatment: settings.quickTreatment || []
  };
  const txt = `ã€æ•‘æ€¥è¦è«‹ã‚µãƒãƒ¼ãƒˆ è¨­å®šï¼ˆv17ï¼‰ã€‘\n` + JSON.stringify(pack, null, 2);
  await shareText("æ•‘æ€¥è¦è«‹ã‚µãƒãƒ¼ãƒˆ è¨­å®šï¼ˆv17ï¼‰", txt);
};

$("btnRestoreDefaultCases").onclick = ()=> document.querySelectorAll(".casePreset").forEach((inp,idx)=> inp.value = DEFAULT_CASES[idx] || "");
$("btnClearCases").onclick = ()=> document.querySelectorAll(".casePreset").forEach(inp=> inp.value = "");

$("btnRestoreDefaultChecks").onclick = ()=> document.querySelectorAll(".checkPreset").forEach((inp,idx)=> inp.value = DEFAULT_CHECKS[idx] || "");
$("btnClearChecks").onclick = ()=> document.querySelectorAll(".checkPreset").forEach(inp=> inp.value = "");

$("btnRestoreDefaultQuickStatus").onclick = ()=> document.querySelectorAll(".quickStatusPreset").forEach((inp,idx)=> inp.value = DEFAULT_QUICK_STATUS[idx] || "");
$("btnClearQuickStatus").onclick = ()=> document.querySelectorAll(".quickStatusPreset").forEach(inp=> inp.value = "");

$("btnRestoreDefaultQuickSymptoms").onclick = ()=> document.querySelectorAll(".quickSymptomsPreset").forEach((inp,idx)=> inp.value = DEFAULT_QUICK_SYMPTOMS[idx] || "");
$("btnClearQuickSymptoms").onclick = ()=> document.querySelectorAll(".quickSymptomsPreset").forEach(inp=> inp.value = "");

$("btnRestoreDefaultQuickTreatment").onclick = ()=> document.querySelectorAll(".quickTreatmentPreset").forEach((inp,idx)=> inp.value = DEFAULT_QUICK_TREATMENT[idx] || "");
$("btnClearQuickTreatment").onclick = ()=> document.querySelectorAll(".quickTreatmentPreset").forEach(inp=> inp.value = "");

$("btnCasesHint").onclick = ()=> { toggleCollapse("schoolPanel"); $("schoolPanel").scrollIntoView({behavior:"smooth", block:"start"}); };
$("btnChecklistSettingsHint").onclick = ()=> { switchTab(1); toggleCollapse("schoolPanel"); $("schoolPanel").scrollIntoView({behavior:"smooth", block:"start"}); };
$("btnOpenSettings").onclick = ()=> { switchTab(1); toggleCollapse("schoolPanel"); $("schoolPanel").scrollIntoView({behavior:"smooth", block:"start"}); };

$("btnQuickAmbulance").onclick = ()=>{ tapFlash($("btnQuickAmbulance")); addEntry("æ•‘æ€¥è»ŠãŒåˆ°ç€ãƒ»å¼•ãç¶™ãé–‹å§‹"); };

$("pBirth").onchange = updateAge;
$("pGrade").onchange = updateAge;

/* å…¥åŠ›ã®è‡ªå‹•ä¿å­˜ï¼ˆè¨­å®šå…¥åŠ›ã¯é™¤å¤–ï¼‰ */
document.querySelectorAll("input, textarea, select").forEach(el=>{
  el.addEventListener("input", ()=>{
    if(el.classList.contains("casePreset") || el.classList.contains("checkPreset")
      || el.classList.contains("quickStatusPreset") || el.classList.contains("quickSymptomsPreset") || el.classList.contains("quickTreatmentPreset")) return;
    buildScript();
    saveIncident();
  });
});

/* log viewer */
$("btnOpenLogViewer").onclick = openLogViewer;
$("btnCloseLogViewer").onclick = closeLogViewer;
$("logViewerBackdrop").onclick = closeLogViewer;
$("lvSearch").addEventListener("input", renderLogViewer);
$("lvOrder").onclick = ()=>{ lvOrderNewestFirst=!lvOrderNewestFirst; renderLogViewer(); };
$("lvOnlyImp").onclick = ()=>{ lvOnlyImportant=!lvOnlyImportant; renderLogViewer(); };
$("lvMode").onclick = ()=>{ lvMode = (lvMode==="card" ? "text" : "card"); renderLogViewer(); };
$("lvCopy").onclick = ()=> copyText(entriesToText(filteredEntries()));
$("lvShare").onclick = ()=> shareText("æ•‘æ€¥å¯¾å¿œ è¨˜éŒ²ï¼ˆãƒ•ã‚£ãƒ«ã‚¿çµæœï¼‰", entriesToText(filteredEntries()));

$("lvAddToggle").onclick = ()=>{
  $("lvAddBox").classList.toggle("hidden");
  if(!$("lvAddBox").classList.contains("hidden")) $("lvAddText").focus();
};
$("lvAddCancel").onclick = ()=>{
  $("lvAddBox").classList.add("hidden");
  $("lvAddText").value = "";
};
$("lvAddDo").onclick = ()=>{
  const t = ($("lvAddText").value||"").trim();
  if(!t) return;
  addEntry(t, false);
  $("lvAddText").value = "";
  $("lvAddBox").classList.add("hidden");
  renderLogViewer();
};

/* CSV export/import wiring */
$("btnExportCSV").onclick = ()=>{
  saveSettings();
  const csv = settingsToCSV();
  downloadFile(`æ•‘æ€¥è¦è«‹ã‚µãƒãƒ¼ãƒˆ_è¨­å®š_${ymd_hm()}.csv`, csv, "text/csv;charset=utf-8");
  alert("è¨­å®šCSVã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
};
$("btnImportCSV").onclick = ()=> $("csvFile").click();
$("csvFile").addEventListener("change", async (ev)=>{
  const file = ev.target.files?.[0];
  if(!file) return;
  try{
    const text = await file.text();
    applySettingsFromCSV(text);
    alert("CSVã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
  }catch(e){
    alert("CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + (e?.message || e));
  }finally{
    $("csvFile").value = "";
  }
});

/* ===================== init ===================== */
migrateIfNeeded();
loadSettings();
loadIncident();
if(incident.active && incident.startTs) startIncidentTimer();
updateAge();
buildScript();
setupRecognition();
voiceSupportedHint();
renderQuickButtons();
</script>
</body>
</html>
