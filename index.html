<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>救急要請サポート（現場最強 v20）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{
      -webkit-tap-highlight-color: transparent;
      padding-bottom: 92px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .safe-area-bottom{ padding-bottom: env(safe-area-inset-bottom); }
    input, select, textarea { min-height: 48px; }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1rem;
      padding-right: 2.5rem !important;
    }
    .input-label{
      font-size: 0.75rem; font-weight: 800; color: #64748b;
      margin-bottom: 0.25rem; display:block;
    }

    /* 押した感（全ボタン共通） */
    .pressable{
      transition: transform 0.08s ease, filter 0.08s ease, box-shadow 0.08s ease;
      user-select: none; -webkit-user-select: none;
      touch-action: manipulation;
    }
    .pressable:active{ transform: scale(0.97); filter: brightness(0.92); }
    .pressed{ transform: scale(0.97); filter: brightness(0.92); }

    /* トースト */
    .toast{
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 96px; z-index: 80;
      background: rgba(15,23,42,0.95);
      color:#fff; padding:10px 12px; border-radius: 14px;
      font-size: 12px; font-weight: 800;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      max-width: calc(100vw - 24px);
      display:none;
    }

    /* モーダル共通 */
    .modal-backdrop{
      position: fixed; inset:0; z-index:70;
      background: rgba(2,6,23,0.55);
      display:none;
    }
    .modal{
      position: fixed; inset: 10px; z-index: 75;
      background:#fff; border-radius: 18px;
      display:none; overflow:hidden;
      box-shadow: 0 25px 60px rgba(0,0,0,0.35);
    }

    /* 折りたたみ（初動チェック用） */
    .collapse-content{
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.28s ease;
    }
    .collapse-content.open{
      max-height: 1200px;
      transition: max-height 0.38s ease;
    }

    /* 印刷用 */
    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff !important; padding:0; }
      main{ padding:0 !important; }
      .print-report{ display:block !important; padding: 18px; color:#000; }
      .timeline-item{ border-bottom:1px solid #ccc !important; break-inside: avoid; }
    }
    .print-report{ display:none; }

    /* 音声リング */
    .recording-ring{ animation:ring-pulse 1.5s cubic-bezier(0.24,0,0.38,1) infinite; }
    @keyframes ring-pulse{ 0%{transform:scale(1);opacity:0.5;} 100%{transform:scale(1.5);opacity:0;} }
  </style>
</head>

<body class="bg-slate-100 text-slate-900">

  <!-- 印刷/Word用（共通内容） -->
  <div class="print-report">
    <div class="border-b-2 border-black pb-2 mb-4 flex justify-between items-end">
      <h1 class="text-2xl font-bold">救急搬送・経過記録用紙</h1>
      <p id="printTimestamp" class="text-sm"></p>
    </div>
    <div class="grid grid-cols-2 gap-4 mb-6 border p-4 rounded-lg">
      <div>
        <p class="text-xs font-bold text-gray-500">学校名 / 住所</p>
        <p id="printSchoolInfo" class="text-sm font-bold"></p>
      </div>
      <div>
        <p class="text-xs font-bold text-gray-500">傷病者氏名 / 学年 / 性別 / 年齢</p>
        <p id="printPatientInfo" class="text-sm font-bold"></p>
      </div>
      <div class="col-span-2 border-t pt-2">
        <p class="text-xs font-bold text-gray-500">現在の主な症状・既往歴・アレルギー</p>
        <p id="printMedicalInfo" class="text-sm"></p>
      </div>
    </div>
    <h2 class="text-lg font-bold border-l-4 border-black pl-2 mb-2">時系列記録</h2>
    <div id="printTimeline" class="border-t border-black"></div>
    <div class="mt-8 text-[10px] text-gray-400 text-right">Generated by 救急要請サポートアプリ</div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white shadow-sm border-b no-print">
    <div class="px-4 py-3 flex items-center justify-between">
      <div class="flex flex-col">
        <h1 class="text-base font-black leading-tight text-red-600">救急要請サポート</h1>
        <div class="text-[10px] text-slate-400 font-bold">現場最強 v20</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnOpenSettings" class="pressable px-3 py-2 rounded-full border text-xs font-black text-slate-700 bg-slate-50">設定</button>
        <a href="tel:119" class="pressable bg-red-600 text-white px-4 py-2 rounded-full text-sm font-black flex items-center gap-2 animate-pulse">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
          119通報
        </a>
      </div>
    </div>
  </header>

  <main class="p-3 space-y-4 no-print">

    <!-- Section 1: 通報原稿 -->
    <div id="section1" class="space-y-4">

      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
        <div class="flex justify-between items-center border-b pb-2 mb-2">
          <h2 class="font-black text-sm border-l-4 border-slate-800 pl-2 text-slate-800">1. 発生場所</h2>
          <button id="btnOpenSettings2" class="pressable text-xs text-blue-600 font-black">SETTINGS</button>
        </div>
        <div>
          <label class="input-label">校内の詳しい場所</label>
          <input id="place" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="例：3F図工室、体育館北側など" />
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-4">
        <h2 class="font-black text-sm border-l-4 border-red-500 pl-2 text-slate-800">2. 傷病者の詳細</h2>

        <div class="space-y-3">
          <div>
            <label class="input-label">氏名（ふりがな）</label>
            <input id="pName" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black placeholder:font-normal" placeholder="山田 太郎" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="input-label">学年・組</label>
              <select id="pGrade" class="w-full p-3 bg-slate-50 border rounded-xl text-sm">
                <option value="">選択</option>
                <option value="1">1年</option><option value="2">2年</option><option value="3">3年</option>
                <option value="4">4年</option><option value="5">5年</option><option value="6">6年</option>
                <option value="職員">教職員</option><option value="他">その他</option>
              </select>
            </div>
            <div>
              <label class="input-label">性別</label>
              <select id="pSex" class="w-full p-3 bg-slate-50 border rounded-xl text-sm">
                <option value="">選択</option>
                <option value="男性">男性</option>
                <option value="女性">女性</option>
              </select>
            </div>
          </div>

          <!-- 生年月日：スマホではみ出さないように幅固定 + min-w 0 -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-3 bg-blue-50 rounded-xl border border-blue-100">
            <div class="min-w-0">
              <label class="input-label text-blue-700">生年月日</label>
              <input id="pBirth" type="date" class="w-full min-w-0 p-2 border rounded-lg text-sm bg-white" />
            </div>
            <div class="flex items-end min-w-0">
              <div id="ageDisplay" class="text-sm font-black text-blue-800 bg-white border border-blue-200 w-full p-2 rounded-lg text-center h-[48px] flex items-center justify-center shadow-sm">
                年齢：-- 歳
              </div>
            </div>
          </div>
        </div>

        <div>
          <label class="input-label">現在の症状</label>
          <textarea id="symptom" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" rows="2" placeholder="例：呼吸困難、意識混濁、けいれん など"></textarea>
        </div>

        <button id="btnToggleDetailMedical" class="pressable w-full py-2 bg-slate-100 rounded-xl text-[11px] font-black text-slate-500 flex justify-center items-center gap-1 tracking-wider">
          既往歴・アレルギー等
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
        </button>

        <div id="detailMedical" class="hidden space-y-3 pt-2">
          <div><label class="input-label">既往歴（持病）</label><input id="pHistory" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" placeholder="喘息、てんかん等" /></div>
          <div><label class="input-label">アレルギー</label><input id="pAllergy" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" placeholder="卵、ピーナッツ等" /></div>
        </div>
      </div>

      <!-- よく起きるケース（10） -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="font-black text-sm border-l-4 border-emerald-500 pl-2 text-slate-800">3. よく起きるケース</h2>
          <button id="btnOpenSettings3" class="pressable text-xs text-blue-600 font-black">編集</button>
        </div>
        <div id="caseButtons" class="grid grid-cols-2 gap-2"></div>
        <p class="text-[10px] text-slate-400 font-bold">※押すと「症状」に自動入力（各校で最大10件まで編集可）</p>
      </div>

      <div class="bg-slate-900 rounded-2xl p-4 shadow-xl">
        <div class="flex justify-between items-center mb-2 border-b border-white/10 pb-2">
          <span class="text-[10px] uppercase tracking-widest text-slate-400 font-black">119通報用原稿</span>
          <button id="btnCopyScript" class="pressable text-xs bg-white text-slate-900 px-3 py-1 rounded-full font-black">コピー</button>
        </div>
        <div id="scriptDisplay" class="text-white text-sm font-medium leading-relaxed min-h-[120px] whitespace-pre-wrap"></div>
      </div>
    </div>

    <!-- Section 2: 経過記録 -->
    <div id="section2" class="hidden space-y-4 pb-24">

      <!-- v20: 固定ボックス（スクロールしても動かない） -->
      <div id="stickyBox" class="sticky top-16 z-20 bg-slate-100 pt-1">
        <div class="bg-white rounded-2xl shadow-sm border p-4">
          <div class="flex items-center justify-between gap-2">
            <div class="min-w-0">
              <div class="text-xs font-black text-slate-500">最新記録</div>
              <div id="lastEntryText" class="text-sm font-black text-slate-900 truncate">（まだありません）</div>
            </div>
            <div class="flex items-center gap-2">
              <span id="sessionBadge" class="text-[10px] font-black px-2 py-1 rounded-full bg-slate-100 text-slate-600">未開始</span>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-3">
            <button id="btnStart" class="pressable py-4 bg-emerald-600 text-white font-black rounded-2xl shadow-lg">記録開始</button>
            <button id="btnEnd" class="pressable py-4 bg-slate-800 text-white font-black rounded-2xl shadow-lg">記録終了</button>
          </div>
        </div>
      </div>

      <!-- v20: 初動チェックは折りたたみ（省スペース） -->
      <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
        <button id="btnToggleInitial" class="pressable w-full px-4 py-3 bg-blue-50 flex items-center justify-between">
          <div class="font-black text-sm text-blue-900">初動チェック</div>
          <div class="flex items-center gap-2">
            <button id="btnEditInitialChecks" class="pressable px-3 py-2 rounded-full bg-white border text-xs font-black text-blue-700">編集</button>
            <svg id="iconInitial" class="w-4 h-4 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
          </div>
        </button>
        <div id="initialPanel" class="collapse-content bg-white">
          <div class="p-4 space-y-2" id="initialChecks"></div>
          <div class="px-4 pb-4 text-[10px] text-slate-400 font-bold">※チェックすると自動でログに記録されます</div>
        </div>
      </div>

      <!-- メモ（音声/手入力） -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="font-black text-sm border-l-4 border-slate-800 pl-2 text-slate-800">メモ</h2>
          <button id="btnVoiceToggle" class="pressable relative w-14 h-14 rounded-full bg-blue-600 text-white shadow-lg flex items-center justify-center">
            <div id="pulseRing" class="absolute inset-0 rounded-full bg-red-400 hidden recording-ring"></div>
            <svg class="w-6 h-6 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-18a3 3 0 013 3v8a3 3 0 01-3 3 3 3 0 01-3-3V5a3 3 0 013-3z" />
            </svg>
          </button>
        </div>

        <textarea id="voiceInputArea" class="w-full p-4 bg-slate-50 border rounded-2xl text-base focus:ring-2 focus:ring-blue-500 outline-none" rows="3" placeholder=""></textarea>
        <div id="interimText" class="text-xs text-blue-600 font-black h-4 italic"></div>
        <button id="btnAddMemo" class="pressable w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg">このメモを記録</button>
      </div>

      <!-- クイック入力 -->
      <div class="bg-white rounded-2xl shadow-sm border p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="font-black text-sm border-l-4 border-amber-500 pl-2 text-slate-800">クイック入力</h2>
          <button id="btnEditQuick" class="pressable text-xs text-blue-600 font-black">編集</button>
        </div>
        <div class="space-y-3">
          <div class="space-y-2">
            <div class="text-xs font-black text-slate-500">意識・呼吸</div>
            <div id="quick_status" class="grid grid-cols-2 gap-2"></div>
          </div>
          <div class="space-y-2">
            <div class="text-xs font-black text-slate-500">全身症状</div>
            <div id="quick_symptoms" class="grid grid-cols-2 gap-2"></div>
          </div>
          <div class="space-y-2">
            <div class="text-xs font-black text-slate-500">処置内容</div>
            <div id="quick_treatment" class="grid grid-cols-2 gap-2"></div>
          </div>
          <button id="btnQuickArrival" class="pressable w-full py-3 rounded-2xl bg-slate-800 text-white font-black">救急車 到着</button>
        </div>
      </div>

      <!-- アクション（縦） -->
      <div class="space-y-3">
        <button id="btnCopyAll" class="pressable w-full py-4 text-slate-700 text-sm font-black border-2 border-dashed border-slate-300 rounded-2xl bg-white">記録をコピー</button>
        <button id="btnPrint" class="pressable w-full py-4 bg-blue-600 text-white text-sm font-black rounded-2xl shadow-lg flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
          用紙として印刷
        </button>
        <button id="btnWord" class="pressable w-full py-4 bg-slate-900 text-white text-sm font-black rounded-2xl shadow-lg">Wordでエクスポート</button>
        <button id="btnOpenAll" class="pressable w-full py-4 bg-white border rounded-2xl text-sm font-black text-slate-800">ACTIVITY LOG</button>
        <button id="btnClearAll" class="pressable w-full py-4 bg-red-600 text-white text-sm font-black rounded-2xl shadow-lg">全消去</button>
      </div>
    </div>
  </main>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex items-center justify-around px-2 py-2 no-print shadow-[0_-4px_15px_rgba(0,0,0,0.1)] z-40 safe-area-bottom">
    <button id="nav1" class="pressable flex flex-col items-center gap-1 flex-1 py-1 text-blue-600">
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
      <span class="text-[10px] font-black">1. 通報原稿</span>
    </button>
    <button id="nav2" class="pressable flex flex-col items-center gap-1 flex-1 py-1 text-slate-400">
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path></svg>
      <span class="text-[10px] font-black">2. 経過記録</span>
    </button>
  </nav>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Settings Modal -->
  <div id="settingsBackdrop" class="modal-backdrop"></div>
  <div id="settingsModal" class="modal">
    <div class="px-4 py-3 border-b flex items-center justify-between bg-slate-50">
      <div class="font-black text-slate-800">設定</div>
      <button id="btnCloseSettings" class="pressable px-3 py-2 rounded-full bg-white border text-xs font-black">閉じる</button>
    </div>

    <div class="p-4 overflow-auto" style="height: calc(100% - 56px);">

      <!-- 学校情報 -->
      <div class="bg-white rounded-2xl border p-4 space-y-3">
        <div class="font-black text-sm text-slate-800">学校情報</div>
        <div><label class="input-label">学校名</label><input id="schoolName" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="〇〇市立〇〇小学校" /></div>
        <div><label class="input-label">住所</label><input id="schoolAddr" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" placeholder="市区町村からの住所" /></div>
        <div><label class="input-label">電話番号</label><input id="schoolPhone" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" placeholder="03-xxxx-xxxx" inputmode="tel" /></div>
        <button id="btnSaveSettings" class="pressable w-full py-3 bg-slate-900 text-white font-black rounded-2xl shadow-lg">この端末に保存</button>
      </div>

      <!-- ケース（10） -->
      <div class="bg-white rounded-2xl border p-4 space-y-3 mt-4">
        <div class="font-black text-sm text-slate-800">よく起きるケース（最大10）</div>
        <div id="caseEditors" class="space-y-3"></div>
        <p class="text-[10px] text-slate-400 font-bold">※タイトル（ボタン表示）と、押した時に入る文章（症状欄）</p>
      </div>

      <!-- 初動チェック（10） -->
      <div class="bg-white rounded-2xl border p-4 space-y-3 mt-4">
        <div class="font-black text-sm text-slate-800">初動チェック（最大10）</div>
        <div id="checkEditors" class="space-y-3"></div>
      </div>

      <!-- クイック入力（各10） -->
      <div class="bg-white rounded-2xl border p-4 space-y-3 mt-4">
        <div class="font-black text-sm text-slate-800">クイック入力（各最大10）</div>

        <div class="space-y-2">
          <div class="text-xs font-black text-slate-500">意識・呼吸</div>
          <div id="quickEditors_status" class="space-y-2"></div>
        </div>

        <div class="space-y-2 mt-3">
          <div class="text-xs font-black text-slate-500">全身症状</div>
          <div id="quickEditors_symptoms" class="space-y-2"></div>
        </div>

        <div class="space-y-2 mt-3">
          <div class="text-xs font-black text-slate-500">処置内容</div>
          <div id="quickEditors_treatment" class="space-y-2"></div>
        </div>

        <button id="btnSaveQuick" class="pressable w-full py-3 bg-slate-900 text-white font-black rounded-2xl shadow-lg mt-2">クイック入力を保存</button>
      </div>

      <!-- v20: CSV Export / Import（ファイルアップロード対応） -->
      <div class="bg-white rounded-2xl border p-4 space-y-3 mt-4">
        <div class="font-black text-sm text-slate-800">設定CSV（エクスポート / インポート）</div>

        <button id="btnExportCSV" class="pressable w-full py-3 bg-blue-600 text-white font-black rounded-2xl shadow-lg">CSVでエクスポート</button>

        <div class="space-y-2">
          <label class="input-label">CSVファイルを選択してインポート</label>
          <input id="csvFileInput" type="file" accept=".csv,text/csv" class="w-full p-3 bg-slate-50 border rounded-xl text-sm">
          <button id="btnImportCSVFile" class="pressable w-full py-3 bg-slate-900 text-white font-black rounded-2xl shadow-lg">CSVファイルをインポート</button>
        </div>

        <details class="bg-slate-50 border rounded-xl p-3">
          <summary class="font-black text-xs text-slate-700">（任意）CSVを貼り付けてインポート</summary>
          <div class="mt-2 space-y-2">
            <textarea id="csvImportArea" class="w-full p-3 bg-white border rounded-xl text-sm" rows="6" placeholder="ここにCSVを貼り付け"></textarea>
            <button id="btnImportCSVText" class="pressable w-full py-3 bg-slate-900 text-white font-black rounded-2xl shadow-lg">貼り付けCSVをインポート</button>
          </div>
        </details>

        <p class="text-[10px] text-slate-400 font-bold">※設定のみ（ログは対象外）</p>
      </div>

      <div class="h-6"></div>
    </div>
  </div>

  <!-- All Logs Modal（ACTIVITY LOG） -->
  <div id="allBackdrop" class="modal-backdrop"></div>
  <div id="allModal" class="modal">
    <div class="px-4 py-3 border-b flex items-center justify-between bg-slate-50">
      <div class="font-black text-slate-800">ACTIVITY LOG</div>
      <button id="btnCloseAll" class="pressable px-3 py-2 rounded-full bg-white border text-xs font-black">閉じる</button>
    </div>

    <div class="p-4 overflow-auto" style="height: calc(100% - 56px);">
      <!-- v20: カード追加 -->
      <div class="bg-white border rounded-2xl p-4 shadow-sm mb-3">
        <div class="font-black text-sm text-slate-800 mb-2">カードを追加</div>
        <div class="grid grid-cols-2 gap-2">
          <div class="min-w-0">
            <label class="input-label">時刻（HH:MM）</label>
            <input id="addTime" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="09:10" inputmode="numeric">
          </div>
          <div class="flex items-end">
            <button id="btnAddCard" class="pressable w-full py-3 bg-slate-900 text-white font-black rounded-2xl shadow-lg">追加</button>
          </div>
        </div>
        <label class="input-label mt-2">内容</label>
        <textarea id="addText" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" rows="2" placeholder="例：到着、処置、変化など"></textarea>
      </div>

      <div class="flex items-center justify-between gap-2 mb-3">
        <div class="text-xs font-black text-slate-500">全記録</div>
        <button id="btnExportAllJSON" class="pressable px-3 py-2 rounded-full bg-white border text-xs font-black">JSONコピー</button>
      </div>

      <div id="allEmpty" class="text-center text-slate-400 py-10 text-sm font-bold">（記録なし）</div>
      <div id="allList" class="space-y-3"></div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // ====== Storage Keys ======
  const KEY_SETTINGS = "school_emergency_settings_v20";
  const KEY_LOGS = "school_emergency_logs_v20";
  const KEY_SESSION = "school_emergency_session_v20";

  // ====== Default Settings ======
  const DEFAULT_SETTINGS = {
    school: { name: "", addr: "", phone: "" },

    // よく起きるケース10：初期セット案
    cases: [
      { title: "転倒・頭部打撲", text: "転倒し頭部を打撲。頭痛/吐き気/意識状態を確認中。" },
      { title: "けいれん", text: "けいれん発作。発作開始時刻を記録し、呼吸状態を確認中。" },
      { title: "アナフィラキシー", text: "アレルギー反応疑い（じんましん/呼吸苦）。エピペン有無確認中。" },
      { title: "熱中症", text: "熱中症疑い（ふらつき/頭痛/吐き気）。涼しい場所へ移動し冷却中。" },
      { title: "骨折疑い", text: "骨折疑い（強い痛み/腫れ/変形）。固定し安静保持中。" },
      { title: "出血（切創）", text: "出血あり（切創）。圧迫止血を実施中。" },
      { title: "意識消失", text: "意識消失。呼吸・脈を確認中。必要に応じてAED準備。" },
      { title: "窒息疑い", text: "窒息疑い（咳が弱い/呼吸苦）。異物除去・背部叩打法を検討中。" },
      { title: "胸痛・呼吸苦", text: "胸痛/呼吸苦を訴え。安静保持し呼吸状態を観察中。" },
      { title: "腹痛・嘔吐", text: "強い腹痛/嘔吐。脱水に注意し安静保持中。" },
    ],

    // 初動チェック10
    initialChecks: [
      "養護教諭（保健室）へ連絡",
      "管理職へ連絡",
      "119通報（指示を受ける）",
      "保護者へ連絡（状況共有）",
      "AED手配・搬送準備",
      "周囲の安全確保・群衆整理",
      "他児童の対応（別室/見守り）",
      "誘導者を正門に配置",
      "既往歴・薬・アレルギー確認",
      "時刻記録（発生/処置/変化）",
    ],

    // クイック入力（各10まで）
    quick: {
      status: [
        "意識あり（明瞭）","意識混濁（呼びかけに反応薄い）","意識消失・無反応",
        "呼吸正常","呼吸困難（ゼーゼーする）","呼吸停止・死戦期呼吸（あえぎ呼吸）",
      ],
      symptoms: [
        "顔面蒼白（血の気が引いた）","顔面紅潮（赤ら顔）","冷や汗がひどい","嘔吐（おうと）あり",
        "痙攣（けいれん）開始","痙攣（けいれん）消失","全身にじんましん出現","激しい腹痛","失禁あり","鼻出血（鼻血）",
      ],
      treatment: [
        "エピペン（自己注射薬）使用","回復体位（横向き）に固定","衣服を緩める（ネクタイ・襟元）","毛布で保温開始",
        "保冷剤で患部を冷却中","傷口を流水で洗浄","圧迫による止血処置","酸素投与開始","胸骨圧迫（心臓マッサージ）開始","AED装着・解析開始",
      ]
    }
  };

  // ====== App State ======
  let settings = structuredClone(DEFAULT_SETTINGS);
  let logs = []; // {id, ts, time, text}
  let session = { active:false, startTs:null, endTs:null };

  // ====== Utilities ======
  const pad2 = (n)=> String(n).padStart(2,"0");
  const nowTime = () => {
    const d = new Date();
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  };
  const uid = ()=> `${Date.now()}_${Math.random().toString(16).slice(2)}`;

  function toast(msg){
    const el = $("toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> el.style.display="none", 1600);
  }

  // 押した感を「確実」に（iOS向けに pointerdown で短時間付与）
  function bindPressFeedback(){
    const sel = "button, a";
    document.querySelectorAll(sel).forEach(el=>{
      el.classList.add("pressable");
      const onDown = ()=> el.classList.add("pressed");
      const onUp = ()=> el.classList.remove("pressed");
      el.addEventListener("pointerdown", onDown, {passive:true});
      el.addEventListener("pointerup", onUp, {passive:true});
      el.addEventListener("pointercancel", onUp, {passive:true});
      el.addEventListener("pointerleave", onUp, {passive:true});
    });
  }

  function isValidHHMM(s){
    return /^([01]\d|2[0-3]):[0-5]\d$/.test(String(s||"").trim());
  }

  // ====== Persistence ======
  function saveSettings(){ localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)); }
  function loadSettings(){
    const s = localStorage.getItem(KEY_SETTINGS);
    if(!s) return;
    try{
      const obj = JSON.parse(s);
      settings = {
        ...structuredClone(DEFAULT_SETTINGS),
        ...obj,
        school: {...structuredClone(DEFAULT_SETTINGS.school), ...(obj.school||{})},
        cases: Array.isArray(obj.cases)? obj.cases.slice(0,10) : structuredClone(DEFAULT_SETTINGS.cases),
        initialChecks: Array.isArray(obj.initialChecks)? obj.initialChecks.slice(0,10) : structuredClone(DEFAULT_SETTINGS.initialChecks),
        quick: {
          status: (obj.quick && Array.isArray(obj.quick.status))? obj.quick.status.slice(0,10) : structuredClone(DEFAULT_SETTINGS.quick.status),
          symptoms:(obj.quick && Array.isArray(obj.quick.symptoms))? obj.quick.symptoms.slice(0,10) : structuredClone(DEFAULT_SETTINGS.quick.symptoms),
          treatment:(obj.quick && Array.isArray(obj.quick.treatment))? obj.quick.treatment.slice(0,10) : structuredClone(DEFAULT_SETTINGS.quick.treatment),
        }
      };
    }catch(e){}
  }
  function saveLogs(){ localStorage.setItem(KEY_LOGS, JSON.stringify(logs)); }
  function loadLogs(){
    const s = localStorage.getItem(KEY_LOGS);
    if(!s) return;
    try{
      const arr = JSON.parse(s);
      if(Array.isArray(arr)) logs = arr;
    }catch(e){}
  }
  function saveSession(){ localStorage.setItem(KEY_SESSION, JSON.stringify(session)); }
  function loadSession(){
    const s = localStorage.getItem(KEY_SESSION);
    if(!s) return;
    try{
      const obj = JSON.parse(s);
      if(obj && typeof obj==="object") session = {...session, ...obj};
    }catch(e){}
  }

  // ====== Tabs ======
  function switchTab(tabNum){
    if(tabNum===1){
      $("section1").classList.remove("hidden");
      $("section2").classList.add("hidden");
      $("nav1").classList.replace("text-slate-400", "text-blue-600");
      $("nav2").classList.replace("text-blue-600", "text-slate-400");
    }else{
      $("section1").classList.add("hidden");
      $("section2").classList.remove("hidden");
      $("nav2").classList.replace("text-slate-400", "text-blue-600");
      $("nav1").classList.replace("text-blue-600", "text-slate-400");
    }
  }
  $("nav1").onclick = ()=> switchTab(1);
  $("nav2").onclick = ()=> switchTab(2);

  // ====== Age ======
  let computedAgeStr="--";
  function updateAge(){
    const birthVal = $("pBirth").value;
    const gradeVal = $("pGrade").value;
    const now = new Date();
    if(birthVal){
      const b = new Date(birthVal);
      let age = now.getFullYear() - b.getFullYear();
      const m = now.getMonth() - b.getMonth();
      if(m<0 || (m===0 && now.getDate()<b.getDate())) age--;
      computedAgeStr = `${age}歳`;
    }else if(gradeVal && !isNaN(gradeVal)){
      const g = parseInt(gradeVal,10);
      computedAgeStr = `${g+5}〜${g+6}歳相当`;
    }else computedAgeStr="--";
    $("ageDisplay").innerText = `年齢：${computedAgeStr}`;
    buildScript();
  }

  // ====== Script ======
  function buildScript(){
    const data = {
      school: settings.school.name || "（学校名）",
      addr: settings.school.addr || "（学校住所）",
      phone: settings.school.phone || "（電話）",
      place: $("place").value || "（場所不明）",
      pName: $("pName").value || "（名前不明）",
      pGrade: $("pGrade").value ? ($("pGrade").value + ($("pGrade").value.match(/^\d$/) ? "年生" : "")) : "（不明）",
      pSex: $("pSex").value || "（性別不明）",
      age: computedAgeStr!=="--" ? computedAgeStr : "",
      symptom: $("symptom").value || "（不明）"
    };
    $("scriptDisplay").innerText =
`「救急要請です」
場所：${data.school}
住所：${data.addr}
詳細：${data.place}
電話：${data.phone}

対象：${data.pName}さん（${data.pGrade}・${data.pSex}・${data.age}）
症状：${data.symptom}

正門にて誘導待機中です。`;
  }

  // ====== Logs ======
  function addLog(text, fixedTime=null){
    const t = (text||"").trim();
    if(!t) return;
    const entry = { id: uid(), ts: new Date().toISOString(), time: fixedTime || nowTime(), text: t };
    logs.unshift(entry);
    saveLogs();
    renderLast();
  }

  function renderLast(){
    if(logs.length===0){
      $("lastEntryText").textContent = "（まだありません）";
      return;
    }
    const e = logs[0];
    $("lastEntryText").textContent = `${e.time}　${e.text}`;
  }

  // ====== Session Start/End (安定化) ======
  let busyStartEnd = false;
  function updateSessionBadge(){
    if(session.active){
      const st = session.startTs ? new Date(session.startTs) : null;
      const t = st ? `${pad2(st.getHours())}:${pad2(st.getMinutes())}` : "";
      $("sessionBadge").textContent = t ? `記録中 ${t}〜` : "記録中";
      $("sessionBadge").className = "text-[10px] font-black px-2 py-1 rounded-full bg-emerald-100 text-emerald-700";
    }else if(session.endTs){
      const et = new Date(session.endTs);
      $("sessionBadge").textContent = `終了 ${pad2(et.getHours())}:${pad2(et.getMinutes())}`;
      $("sessionBadge").className = "text-[10px] font-black px-2 py-1 rounded-full bg-slate-100 text-slate-600";
    }else{
      $("sessionBadge").textContent = "未開始";
      $("sessionBadge").className = "text-[10px] font-black px-2 py-1 rounded-full bg-slate-100 text-slate-600";
    }
  }

  function startSession(){
    if(busyStartEnd) return;
    busyStartEnd = true;
    try{
      if(session.active){ toast("すでに記録中です"); return; }
      session.active = true;
      session.startTs = new Date().toISOString();
      session.endTs = null;
      saveSession();
      addLog("【開始】記録開始");
      updateSessionBadge();
      toast("記録開始");
    }catch(e){
      alert("ボタン処理にエラーが発生しました。");
    }finally{
      busyStartEnd = false;
    }
  }

  function endSession(){
    if(busyStartEnd) return;
    busyStartEnd = true;
    try{
      if(!session.active){ toast("記録中ではありません"); return; }
      session.active = false;
      session.endTs = new Date().toISOString();
      saveSession();
      addLog("【終了】記録終了");
      updateSessionBadge();
      toast("記録終了");
    }catch(e){
      alert("ボタン処理にエラーが発生しました。");
    }finally{
      busyStartEnd = false;
    }
  }

  $("btnStart").onclick = startSession;
  $("btnEnd").onclick = endSession;

  // ====== Initial Checks (auto record) ======
  function renderInitialChecks(){
    const wrap = $("initialChecks");
    wrap.innerHTML = "";
    settings.initialChecks.slice(0,10).forEach((label, idx)=>{
      const id = `chk_${idx}`;
      const row = document.createElement("label");
      row.className = "flex items-center gap-3 p-3 rounded-2xl bg-slate-50 border";
      row.innerHTML = `
        <input type="checkbox" id="${id}" class="w-5 h-5">
        <div class="text-sm font-black text-slate-800">${escapeHtml(label)}</div>
      `;
      wrap.appendChild(row);
      row.querySelector("input").addEventListener("change",(e)=>{
        if(e.target.checked){
          addLog(`【初動】${label}`);
          toast("記録しました");
        }
      });
    });
  }

  // 初動チェックの折りたたみ
  let initialOpen = false;
  function toggleInitial(){
    initialOpen = !initialOpen;
    $("initialPanel").classList.toggle("open", initialOpen);
    $("iconInitial").classList.toggle("rotate-180", initialOpen);
  }
  $("btnToggleInitial").onclick = (e)=>{
    // 編集ボタン押下は除外
    if(e.target && e.target.id === "btnEditInitialChecks") return;
    toggleInitial();
  };

  // ====== Cases ======
  function renderCaseButtons(){
    const wrap = $("caseButtons");
    wrap.innerHTML = "";
    settings.cases.slice(0,10).forEach((c)=>{
      const b = document.createElement("button");
      b.className = "pressable py-3 rounded-2xl bg-emerald-50 border border-emerald-100 text-emerald-800 font-black text-xs";
      b.textContent = c.title || "（未設定）";
      b.onclick = ()=>{
        if(c.text){
          $("symptom").value = c.text;
          buildScript();
          toast("症状に入力しました");
        }
      };
      wrap.appendChild(b);
    });
  }

  // ====== Quick Buttons ======
  function makeQuickBtn(text, kind){
    const b = document.createElement("button");
    let cls = "pressable rounded-2xl text-xs font-black py-3 px-2 ";
    if(kind==="status") cls += "bg-blue-100 text-blue-800";
    if(kind==="symptoms") cls += "bg-slate-50 border text-slate-800";
    if(kind==="treatment") cls += "bg-green-100 text-green-800";
    b.className = cls;
    b.textContent = text;
    b.onclick = ()=>{ addLog(text); toast("記録しました"); };
    return b;
  }
  function renderQuick(){
    $("quick_status").innerHTML = "";
    $("quick_symptoms").innerHTML = "";
    $("quick_treatment").innerHTML = "";
    settings.quick.status.slice(0,10).forEach(t=> $("quick_status").appendChild(makeQuickBtn(t,"status")));
    settings.quick.symptoms.slice(0,10).forEach(t=> $("quick_symptoms").appendChild(makeQuickBtn(t,"symptoms")));
    settings.quick.treatment.slice(0,10).forEach(t=> $("quick_treatment").appendChild(makeQuickBtn(t,"treatment")));
  }
  $("btnQuickArrival").onclick = ()=>{ addLog("救急車が到着・引き継ぎ開始"); toast("記録しました"); };

  // ====== Voice (Web Speech API) ======
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let isRecording = false;

  function initRecognition(){
    if(!SpeechRecognition) return null;
    const r = new SpeechRecognition();
    r.lang = "ja-JP";
    r.interimResults = true;
    r.continuous = false; // モバイル安定化：false + 逐次再開
    r.onresult = (event)=>{
      let interim = "";
      let final = "";
      for(let i=event.resultIndex; i<event.results.length; i++){
        const res = event.results[i];
        if(res.isFinal) final += res[0].transcript;
        else interim += res[0].transcript;
      }
      if(final) $("voiceInputArea").value += final;
      $("interimText").innerText = interim;
    };
    r.onend = ()=>{
      if(isRecording){
        try{ r.start(); }catch(e){}
      }else{
        $("interimText").innerText = "";
      }
    };
    r.onerror = ()=>{
      stopRec();
      toast("音声文字起こし：非対応/権限未許可");
    };
    return r;
  }

  function startRec(){
    if(!recognition) recognition = initRecognition();
    if(!recognition){ toast("この端末/ブラウザは音声文字起こし非対応"); return; }
    try{
      isRecording = true;
      $("pulseRing").classList.remove("hidden");
      $("btnVoiceToggle").classList.remove("bg-blue-600");
      $("btnVoiceToggle").classList.add("bg-red-600");
      recognition.start();
      toast("REC");
    }catch(e){
      isRecording = false;
      $("pulseRing").classList.add("hidden");
      $("btnVoiceToggle").classList.add("bg-blue-600");
      $("btnVoiceToggle").classList.remove("bg-red-600");
      toast("音声開始できませんでした");
    }
  }

  function stopRec(){
    isRecording = false;
    $("pulseRing").classList.add("hidden");
    $("btnVoiceToggle").classList.add("bg-blue-600");
    $("btnVoiceToggle").classList.remove("bg-red-600");
    try{ if(recognition) recognition.stop(); }catch(e){}
    $("interimText").innerText = "";
  }

  $("btnVoiceToggle").onclick = ()=>{ isRecording ? stopRec() : startRec(); };

  $("btnAddMemo").onclick = ()=>{
    const v = $("voiceInputArea").value;
    addLog(v);
    $("voiceInputArea").value = "";
    stopRec();
    toast("記録しました");
  };

  // ====== Copy/Print/Word ======
  function logsToText(){
    return logs.slice().reverse().map(e=> `${e.time} ${e.text}`).join("\n");
  }

  $("btnCopyAll").onclick = async ()=>{
    const text = logsToText();
    if(!text.trim()){ toast("記録がありません"); return; }
    try{
      await navigator.clipboard.writeText(text);
      toast("コピーしました");
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      toast("コピーしました");
    }
  };

  function fillPrintFields(){
    $("printTimestamp").innerText = `作成日：${new Date().toLocaleString('ja-JP')}`;
    $("printSchoolInfo").innerText = `${settings.school.name || "未設定"} / ${settings.school.addr || "住所未設定"}`;
    $("printPatientInfo").innerText = `${$("pName").value || "氏名未詳"} / ${$("pGrade").value || "-"} / ${$("pSex").value || "-"} / ${computedAgeStr}`;
    let medInfo = `【症状】${$("symptom").value || "未入力"}`;
    if($("pHistory").value) medInfo += ` 【既往】${$("pHistory").value}`;
    if($("pAllergy").value) medInfo += ` 【アレルギー】${$("pAllergy").value}`;
    $("printMedicalInfo").innerText = medInfo;

    const container = $("printTimeline");
    container.innerHTML = "";
    const list = logs.slice().reverse();
    if(list.length===0){
      container.innerHTML = "<p class='py-4 text-center text-sm text-gray-400'>記録はありません</p>";
      return;
    }
    list.forEach(e=>{
      const row = document.createElement("div");
      row.className = "flex border-b border-gray-300 py-2 timeline-item";
      row.innerHTML = `<div class="w-20 font-bold text-sm">${escapeHtml(e.time)}</div><div class="flex-1 text-sm">${escapeHtml(e.text)}</div>`;
      container.appendChild(row);
    });
  }

  $("btnPrint").onclick = ()=>{
    fillPrintFields();
    window.print();
  };

  $("btnWord").onclick = ()=>{
    fillPrintFields();
    const title = "救急搬送・経過記録用紙";
    const school = $("printSchoolInfo").innerText;
    const patient = $("printPatientInfo").innerText;
    const med = $("printMedicalInfo").innerText;
    const list = logs.slice().reverse();

    const rows = list.length
      ? list.map(e=> `<tr><td style="width:90px;font-weight:700;">${escapeHtml(e.time)}</td><td>${escapeHtml(e.text)}</td></tr>`).join("")
      : `<tr><td colspan="2" style="color:#999;">記録はありません</td></tr>`;

    const html = `
      <html><head><meta charset="UTF-8">
      <style>
        body{ font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; }
        .h1{ font-size:18pt; font-weight:800; margin-bottom:8px; }
        .meta{ font-size:10pt; color:#333; margin-bottom:10px; }
        table{ width:100%; border-collapse:collapse; }
        td{ border-bottom:1px solid #ccc; padding:6px; font-size:11pt; vertical-align:top; }
        .box{ border:1px solid #000; padding:10px; margin-bottom:12px; }
        .label{ font-size:9pt; color:#555; font-weight:800; }
        .val{ font-size:11pt; font-weight:800; }
      </style>
      </head><body>
        <div class="h1">${escapeHtml(title)}</div>
        <div class="meta">${escapeHtml($("printTimestamp").innerText)}</div>

        <div class="box">
          <div><span class="label">学校名 / 住所：</span><span class="val">${escapeHtml(school)}</span></div>
          <div style="margin-top:6px;"><span class="label">傷病者：</span><span class="val">${escapeHtml(patient)}</span></div>
          <div style="margin-top:6px;"><span class="label">医療情報：</span><span>${escapeHtml(med)}</span></div>
        </div>

        <div style="font-weight:800; margin-bottom:6px;">時系列記録</div>
        <table>${rows}</table>
      </body></html>
    `;

    const blob = new Blob([html], {type: "application/msword"});
    const a = document.createElement("a");
    const d = new Date();
    const fn = `救急搬送_経過記録_${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}_${pad2(d.getHours())}${pad2(d.getMinutes())}.doc`;
    a.href = URL.createObjectURL(blob);
    a.download = fn;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    toast("Wordを書き出しました");
  };

  // ====== ACTIVITY LOG Modal ======
  function openAll(){
    $("allBackdrop").style.display = "block";
    $("allModal").style.display = "block";
    renderAllList();
  }
  function closeAll(){
    $("allBackdrop").style.display = "none";
    $("allModal").style.display = "none";
  }
  $("btnOpenAll").onclick = openAll;
  $("btnCloseAll").onclick = closeAll;
  $("allBackdrop").onclick = closeAll;

  function renderAllList(){
    const empty = $("allEmpty");
    const list = $("allList");
    list.innerHTML = "";
    if(logs.length===0){
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    logs.forEach(e=>{
      const card = document.createElement("div");
      card.className = "bg-white border rounded-2xl p-4 shadow-sm";
      card.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div class="min-w-0">
            <div class="text-xs font-black text-blue-600" data-time>${escapeHtml(e.time)}</div>
            <div class="text-sm font-black text-slate-800 mt-1 whitespace-pre-wrap break-words" data-view>${escapeHtml(e.text)}</div>
          </div>
          <div class="flex flex-col gap-2 shrink-0">
            <button class="pressable px-3 py-2 rounded-full bg-slate-50 border text-xs font-black" data-edit>編集</button>
            <button class="pressable px-3 py-2 rounded-full bg-red-600 text-white text-xs font-black" data-del>削除</button>
          </div>
        </div>
        <div class="mt-3 hidden" data-editbox>
          <div class="grid grid-cols-2 gap-2">
            <div class="min-w-0">
              <label class="input-label">時刻（HH:MM）</label>
              <input class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" data-timeedit value="${escapeAttr(e.time)}" placeholder="09:10" inputmode="numeric">
            </div>
            <div class="flex items-end">
              <button class="pressable w-full py-3 rounded-2xl bg-slate-900 text-white font-black" data-save>保存</button>
            </div>
          </div>
          <label class="input-label mt-2">内容</label>
          <textarea class="w-full p-3 bg-slate-50 border rounded-xl text-sm" rows="3" data-textedit>${escapeHtml(e.text)}</textarea>
          <button class="pressable w-full py-3 mt-2 rounded-2xl bg-white border font-black" data-cancel>キャンセル</button>
        </div>
      `;

      const btnEdit = card.querySelector("[data-edit]");
      const btnDel = card.querySelector("[data-del]");
      const view = card.querySelector("[data-view]");
      const timeView = card.querySelector("[data-time]");
      const box = card.querySelector("[data-editbox]");
      const timeInp = card.querySelector("[data-timeedit]");
      const textTa = card.querySelector("[data-textedit]");
      const btnSave = card.querySelector("[data-save]");
      const btnCancel = card.querySelector("[data-cancel]");

      btnEdit.onclick = ()=>{
        box.classList.remove("hidden");
        textTa.focus();
      };
      btnCancel.onclick = ()=>{
        box.classList.add("hidden");
        timeInp.value = e.time;
        textTa.value = e.text;
      };
      btnSave.onclick = ()=>{
        const newTime = String(timeInp.value||"").trim();
        const newText = String(textTa.value||"").trim();
        if(!newText){ toast("空白は保存できません"); return; }
        if(newTime && !isValidHHMM(newTime)){ toast("時刻は HH:MM 形式"); return; }
        e.time = newTime || e.time;
        e.text = newText;
        saveLogs();
        timeView.textContent = e.time;
        view.textContent = e.text;
        renderLast();
        box.classList.add("hidden"); // 保存だけで戻る
        toast("保存しました");
      };

      btnDel.onclick = ()=>{
        const ok = confirm("この記録を削除します。よろしいですか？");
        if(!ok) return;
        logs = logs.filter(x=> x.id !== e.id);
        saveLogs();
        renderLast();
        renderAllList();
        toast("削除しました");
      };

      list.appendChild(card);
    });

    bindPressFeedback();
  }

  // v20: カード追加
  $("btnAddCard").onclick = ()=>{
    const t = $("addText").value.trim();
    let tm = $("addTime").value.trim();
    if(!t){ toast("内容を入力してください"); return; }
    if(tm && !isValidHHMM(tm)){ toast("時刻は HH:MM 形式"); return; }
    if(!tm) tm = nowTime();
    addLog(t, tm);
    $("addText").value = "";
    $("addTime").value = "";
    renderAllList();
    toast("追加しました");
  };

  $("btnExportAllJSON").onclick = async ()=>{
    const text = JSON.stringify(logs, null, 2);
    try{
      await navigator.clipboard.writeText(text);
      toast("JSONをコピーしました");
    }catch(e){
      toast("コピーできませんでした");
    }
  };

  // ====== Clear All ======
  $("btnClearAll").onclick = ()=>{
    const ok = confirm("ログ（ACTIVITY LOG）を含め、記録をすべて消去します。よろしいですか？");
    if(!ok) return;
    logs = [];
    saveLogs();
    session = { active:false, startTs:null, endTs:null };
    saveSession();
    document.querySelectorAll("#initialChecks input[type=checkbox]").forEach(x=> x.checked = false);
    renderLast();
    updateSessionBadge();
    toast("全消去しました");
    if($("allModal").style.display==="block") renderAllList();
  };

  // ====== Settings Modal ======
  function openSettings(){
    $("settingsBackdrop").style.display = "block";
    $("settingsModal").style.display = "block";
    fillSettingsUI();
  }
  function closeSettings(){
    $("settingsBackdrop").style.display = "none";
    $("settingsModal").style.display = "none";
  }
  $("btnOpenSettings").onclick = openSettings;
  $("btnOpenSettings2").onclick = openSettings;
  $("btnOpenSettings3").onclick = openSettings;
  $("btnCloseSettings").onclick = closeSettings;
  $("settingsBackdrop").onclick = closeSettings;

  function fillSettingsUI(){
    $("schoolName").value = settings.school.name || "";
    $("schoolAddr").value = settings.school.addr || "";
    $("schoolPhone").value = settings.school.phone || "";

    // cases editors
    const wrap = $("caseEditors");
    wrap.innerHTML = "";
    settings.cases.slice(0,10).forEach((c, i)=>{
      const block = document.createElement("div");
      block.className = "p-3 rounded-2xl bg-slate-50 border space-y-2";
      block.innerHTML = `
        <div class="text-xs font-black text-slate-500">ケース ${i+1}</div>
        <input class="w-full p-3 bg-white border rounded-xl text-sm font-black" data-case-title value="${escapeAttr(c.title||"")}" placeholder="ボタン名（例：転倒・頭部打撲）">
        <textarea class="w-full p-3 bg-white border rounded-xl text-sm" rows="2" data-case-text placeholder="症状欄に入る文章">${escapeHtml(c.text||"")}</textarea>
      `;
      wrap.appendChild(block);
    });

    // check editors
    const cwrap = $("checkEditors");
    cwrap.innerHTML = "";
    settings.initialChecks.slice(0,10).forEach((t, i)=>{
      const block = document.createElement("div");
      block.className = "p-3 rounded-2xl bg-slate-50 border";
      block.innerHTML = `
        <div class="text-xs font-black text-slate-500">チェック ${i+1}</div>
        <input class="w-full p-3 bg-white border rounded-xl text-sm font-black" data-check value="${escapeAttr(t||"")}" placeholder="例：管理職へ連絡">
      `;
      cwrap.appendChild(block);
    });

    // quick editors
    renderQuickEditors("status", $("quickEditors_status"));
    renderQuickEditors("symptoms", $("quickEditors_symptoms"));
    renderQuickEditors("treatment", $("quickEditors_treatment"));

    bindPressFeedback();
  }

  function renderQuickEditors(kind, root){
    root.innerHTML = "";
    const arr = settings.quick[kind].slice(0,10);
    for(let i=0;i<10;i++){
      const v = arr[i] || "";
      const row = document.createElement("div");
      row.className = "flex gap-2";
      row.innerHTML = `
        <input class="flex-1 p-3 bg-slate-50 border rounded-xl text-sm font-black" data-q="${kind}" data-i="${i}" value="${escapeAttr(v)}" placeholder="（空欄可）">
      `;
      root.appendChild(row);
    }
  }

  $("btnSaveSettings").onclick = ()=>{
    settings.school.name = $("schoolName").value.trim();
    settings.school.addr = $("schoolAddr").value.trim();
    settings.school.phone = $("schoolPhone").value.trim();

    // cases
    const titles = Array.from(document.querySelectorAll("[data-case-title]")).map(x=> x.value.trim());
    const texts  = Array.from(document.querySelectorAll("[data-case-text]")).map(x=> x.value.trim());
    settings.cases = titles.map((t,i)=> ({ title: t || `ケース${i+1}`, text: texts[i] || "" })).slice(0,10);

    // initial checks
    settings.initialChecks = Array.from(document.querySelectorAll("[data-check]")).map(x=> x.value.trim()).filter(Boolean).slice(0,10);
    if(settings.initialChecks.length===0) settings.initialChecks = structuredClone(DEFAULT_SETTINGS.initialChecks);

    saveSettings();
    renderCaseButtons();
    renderInitialChecks();
    buildScript();
    toast("保存しました");
  };

  $("btnSaveQuick").onclick = ()=>{
    const q = { status:[], symptoms:[], treatment:[] };
    document.querySelectorAll("[data-q]").forEach(inp=>{
      const kind = inp.dataset.q;
      const idx = parseInt(inp.dataset.i,10);
      q[kind][idx] = inp.value.trim();
    });
    ["status","symptoms","treatment"].forEach(k=>{
      settings.quick[k] = (q[k]||[]).filter(Boolean).slice(0,10);
      if(settings.quick[k].length===0) settings.quick[k] = structuredClone(DEFAULT_SETTINGS.quick[k]);
    });

    saveSettings();
    renderQuick();
    toast("保存しました");
  };

  // ====== CSV Export/Import (settings only) ======
  function toCSVValue(str){
    const s = String(str ?? "");
    const esc = s.replace(/"/g,'""');
    return `"${esc}"`;
  }
  function exportSettingsCSV(){
    const rows = [];
    rows.push(`key,value`);
    rows.push(`school.name,${toCSVValue(settings.school.name)}`);
    rows.push(`school.addr,${toCSVValue(settings.school.addr)}`);
    rows.push(`school.phone,${toCSVValue(settings.school.phone)}`);
    rows.push(`cases,${toCSVValue(JSON.stringify(settings.cases))}`);
    rows.push(`initialChecks,${toCSVValue(JSON.stringify(settings.initialChecks))}`);
    rows.push(`quick,${toCSVValue(JSON.stringify(settings.quick))}`);
    return rows.join("\n");
  }

  function parseCSVKeyValue(csv){
    const lines = csv.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    if(lines.length<2) return null;
    const out = {};
    for(let i=1;i<lines.length;i++){
      const line = lines[i];
      const m = line.match(/^([^,]+),(.*)$/);
      if(!m) continue;
      const key = m[1].trim();
      let val = m[2].trim();
      if(val.startsWith('"') && val.endsWith('"')){
        val = val.slice(1,-1).replace(/""/g,'"');
      }
      out[key] = val;
    }
    return out;
  }

  $("btnExportCSV").onclick = ()=>{
    const csv = exportSettingsCSV();
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    const d = new Date();
    a.href = URL.createObjectURL(blob);
    a.download = `救急要請設定_v20_${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    toast("CSVを書き出しました");
  };

  function importFromCSVText(csv){
    const kv = parseCSVKeyValue(csv);
    if(!kv){ toast("CSVを読み取れません"); return; }
    try{
      if(kv["school.name"]!=null) settings.school.name = kv["school.name"];
      if(kv["school.addr"]!=null) settings.school.addr = kv["school.addr"];
      if(kv["school.phone"]!=null) settings.school.phone = kv["school.phone"];

      if(kv["cases"]){
        const arr = JSON.parse(kv["cases"]);
        if(Array.isArray(arr)) settings.cases = arr.slice(0,10);
      }
      if(kv["initialChecks"]){
        const arr = JSON.parse(kv["initialChecks"]);
        if(Array.isArray(arr)) settings.initialChecks = arr.slice(0,10);
      }
      if(kv["quick"]){
        const obj = JSON.parse(kv["quick"]);
        if(obj && typeof obj==="object"){
          settings.quick.status = Array.isArray(obj.status)? obj.status.slice(0,10): settings.quick.status;
          settings.quick.symptoms = Array.isArray(obj.symptoms)? obj.symptoms.slice(0,10): settings.quick.symptoms;
          settings.quick.treatment = Array.isArray(obj.treatment)? obj.treatment.slice(0,10): settings.quick.treatment;
        }
      }

      saveSettings();
      renderCaseButtons();
      renderInitialChecks();
      renderQuick();
      buildScript();
      fillSettingsUI();
      toast("インポートしました");
    }catch(e){
      toast("インポートに失敗しました");
    }
  }

  // v20: ファイルアップロードでCSVインポート
  $("btnImportCSVFile").onclick = ()=>{
    const file = $("csvFileInput").files && $("csvFileInput").files[0];
    if(!file){ toast("CSVファイルを選択してください"); return; }
    const reader = new FileReader();
    reader.onload = ()=>{
      const text = String(reader.result||"");
      importFromCSVText(text);
    };
    reader.onerror = ()=> toast("ファイルを読み取れませんでした");
    reader.readAsText(file, "utf-8");
  };

  // v20: テキスト貼り付けインポート
  $("btnImportCSVText").onclick = ()=>{
    const csv = $("csvImportArea").value.trim();
    if(!csv){ toast("CSVが空です"); return; }
    importFromCSVText(csv);
  };

  // ====== Script Copy ======
  $("btnCopyScript").onclick = async ()=>{
    const text = $("scriptDisplay").innerText;
    try{
      await navigator.clipboard.writeText(text);
      toast("コピーしました");
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text; document.body.appendChild(ta); ta.select();
      document.execCommand("copy"); document.body.removeChild(ta);
      toast("コピーしました");
    }
  };

  // ====== Misc Toggles ======
  $("btnToggleDetailMedical").onclick = ()=> $("detailMedical").classList.toggle("hidden");
  $("btnEditInitialChecks").onclick = (e)=>{ e.stopPropagation(); openSettings(); };
  $("btnEditQuick").onclick = openSettings;

  // ====== Escape helpers ======
  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, s=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[s]));
  }
  function escapeAttr(str){
    return String(str ?? "").replace(/"/g,"&quot;");
  }

  // ====== Init ======
  function init(){
    loadSettings();
    loadLogs();
    loadSession();

    renderCaseButtons();
    renderInitialChecks();
    renderQuick();
    renderLast();
    updateSessionBadge();

    // 初動チェックは初期：閉じた状態（省スペース）
    initialOpen = false;
    $("initialPanel").classList.remove("open");
    $("iconInitial").classList.remove("rotate-180");

    $("pBirth").onchange = updateAge;
    $("pGrade").onchange = updateAge;
    ["place","pName","pSex","symptom","pHistory","pAllergy"].forEach(id=>{
      $(id).addEventListener("input", buildScript);
    });
    $("pGrade").addEventListener("change", buildScript);

    buildScript();
    bindPressFeedback();
  }
  init();
</script>
</body>
</html>
