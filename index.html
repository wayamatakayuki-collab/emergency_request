<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ•‘æ€¥å¯¾å¿œã‚µãƒãƒ¼ãƒˆï¼ˆæœ€ä¸Šä½UXãƒ»å­¦æ ¡ç‰ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      -webkit-tap-highlight-color: transparent;
      padding-bottom: 110px; /* bottom action bar */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    input, select, textarea { min-height: 48px; }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1rem;
      padding-right: 2.5rem !important;
    }
    .input-label {
      font-size: 0.75rem;
      font-weight: 800;
      color: #64748b;
      margin-bottom: 0.25rem;
      display: block;
      letter-spacing: .02em;
    }
    .chip {
      transition: all 0.12s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 10px 8px;
      line-height: 1.2;
      user-select: none;
    }
    .chip:active { transform: scale(0.97); filter: brightness(0.95); }

    .collapse-content { max-height: 0; overflow: hidden; transition: max-height 0.35s ease-out; }
    .collapse-content.open { max-height: 2000px; transition: max-height 0.5s ease-in; }

    .recording-ring { animation: ring-pulse 1.5s cubic-bezier(0.24, 0, 0.38, 1) infinite; }
    @keyframes ring-pulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.5); opacity: 0; } }

    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 120px;
      z-index: 60;
      background: rgba(15, 23, 42, 0.92);
      color: white;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
      max-width: calc(100vw - 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .toast.show { opacity: 1; }

    /* å°åˆ·ç”¨è¨­å®š */
    @media print {
      .no-print { display: none !important; }
      body { background: #fff !important; padding: 0 !important; }
      main { padding: 0 !important; }
      #printArea { display: block !important; }
      #printArea * { color: #000 !important; }
      .print-section { break-inside: avoid; }
      .print-row { border-bottom: 1px solid #bbb; padding: 6px 0; }
    }
    #printArea { display:none; }
  </style>
</head>

<body class="bg-slate-100 text-slate-900">

  <!-- PRINT AREA -->
  <section id="printArea" class="p-5">
    <div class="flex items-end justify-between border-b-2 border-black pb-2 mb-4">
      <div>
        <h1 class="text-2xl font-black">æ•‘æ€¥æ¬é€ãƒ»çµŒéè¨˜éŒ²ç”¨ç´™</h1>
        <div class="text-xs font-bold text-gray-600">ï¼ˆç«¯æœ«å†…ã§ä½œæˆãƒ»è¨˜éŒ²ï¼‰</div>
      </div>
      <div class="text-sm font-bold" id="printTimestamp"></div>
    </div>

    <div class="grid grid-cols-2 gap-3 border p-3 rounded-lg mb-3 print-section">
      <div>
        <div class="text-[10px] font-black text-gray-600">å­¦æ ¡å</div>
        <div id="p_schoolName" class="text-sm font-bold"></div>
      </div>
      <div>
        <div class="text-[10px] font-black text-gray-600">ä½æ‰€ / é›»è©±</div>
        <div id="p_schoolAddrPhone" class="text-sm font-bold"></div>
      </div>
      <div class="col-span-2 border-t pt-2">
        <div class="text-[10px] font-black text-gray-600">ç™ºç”Ÿå ´æ‰€ï¼ˆæ ¡å†…ï¼‰</div>
        <div id="p_place" class="text-sm font-bold"></div>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-3 border p-3 rounded-lg mb-3 print-section">
      <div>
        <div class="text-[10px] font-black text-gray-600">å‚·ç—…è€…ï¼ˆæ°åï¼‰</div>
        <div id="p_name" class="text-sm font-bold"></div>
      </div>
      <div>
        <div class="text-[10px] font-black text-gray-600">å­¦å¹´ / æ€§åˆ¥ / å¹´é½¢</div>
        <div id="p_gradeSexAge" class="text-sm font-bold"></div>
      </div>
      <div class="col-span-2 border-t pt-2">
        <div class="text-[10px] font-black text-gray-600">ä¸»è¨´ãƒ»ç—‡çŠ¶ / æ—¢å¾€ / ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</div>
        <div id="p_med" class="text-sm"></div>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-3 border p-3 rounded-lg mb-3 print-section">
      <div>
        <div class="text-[10px] font-black text-gray-600">å¯¾å¿œè€…ï¼ˆä¸»ï¼‰</div>
        <div id="p_responder" class="text-sm font-bold"></div>
      </div>
      <div>
        <div class="text-[10px] font-black text-gray-600">è¨˜éŒ²è€…</div>
        <div id="p_recorder" class="text-sm font-bold"></div>
      </div>
      <div class="col-span-2 border-t pt-2">
        <div class="text-[10px] font-black text-gray-600">é€£çµ¡ï¼ˆä¿è­·è€…ç­‰ï¼‰</div>
        <div id="p_contact" class="text-sm"></div>
      </div>
    </div>

    <div class="border-t-2 border-black pt-2 mb-2 print-section">
      <h2 class="text-lg font-black">æ™‚ç³»åˆ—è¨˜éŒ²</h2>
      <div class="text-[10px] font-bold text-gray-600 mb-1">â€»æŠ¼ã—ãŸé †ã«è¨˜éŒ²ï¼ˆç·¨é›†å¯ï¼‰</div>
      <div id="p_timeline" class="border-t border-black"></div>
    </div>

    <div class="grid grid-cols-2 gap-6 mt-8 print-section">
      <div class="border-t border-black pt-2">
        <div class="text-xs font-black">æ•‘æ€¥éšŠã¸å¼•ç¶™ãï¼ˆç½²åï¼‰</div>
        <div class="h-10"></div>
      </div>
      <div class="border-t border-black pt-2">
        <div class="text-xs font-black">ç®¡ç†è·å ±å‘Šï¼ˆç½²åï¼‰</div>
        <div class="h-10"></div>
      </div>
    </div>

    <div class="mt-6 text-[10px] text-gray-400 text-right">Generated by æ•‘æ€¥å¯¾å¿œã‚µãƒãƒ¼ãƒˆ</div>
  </section>

  <!-- HEADER -->
  <header class="sticky top-0 z-40 bg-white shadow-sm border-b no-print">
    <div class="px-4 py-3 flex items-center justify-between gap-3">
      <div class="min-w-0">
        <h1 class="text-base font-black leading-tight text-red-600 truncate">æ•‘æ€¥å¯¾å¿œã‚µãƒãƒ¼ãƒˆ</h1>
        <div class="text-[10px] text-slate-500 font-bold">å­¦æ ¡ç”¨ï¼šé€šå ±åŸç¨¿ + è¨˜éŒ² + å¼•ç¶™ãï¼ˆç«¯æœ«å†…ä¿å­˜ï¼‰</div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnNewIncident" class="px-3 py-2 rounded-full text-xs font-black border border-slate-200 bg-slate-50 active:bg-slate-100">
          æ–°è¦
        </button>
        <a href="tel:119" class="bg-red-600 text-white px-4 py-2 rounded-full text-sm font-black flex items-center gap-2 animate-pulse">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>
          119
        </a>
      </div>
    </div>

    <!-- STEPS -->
    <div class="px-3 pb-2">
      <div class="bg-slate-50 border rounded-2xl p-2 flex items-center gap-2 overflow-x-auto">
        <button class="stepBtn px-3 py-2 rounded-xl text-xs font-black bg-white border" data-step="1">â‘ åˆå‹•</button>
        <button class="stepBtn px-3 py-2 rounded-xl text-xs font-black bg-white border" data-step="2">â‘¡é€šå ±</button>
        <button class="stepBtn px-3 py-2 rounded-xl text-xs font-black bg-white border" data-step="3">â‘¢è¨˜éŒ²</button>
        <button class="stepBtn px-3 py-2 rounded-xl text-xs font-black bg-white border" data-step="4">â‘£å¼•ç¶™ã</button>
        <div class="ml-auto flex items-center gap-2 pr-1">
          <div class="text-[10px] font-black text-slate-500">çµŒé</div>
          <div id="elapsedBadge" class="px-2 py-1 rounded-full bg-slate-900 text-white text-[10px] font-black">--:--</div>
        </div>
      </div>
    </div>
  </header>

  <main class="p-3 space-y-4 no-print">
    <!-- NOTICE / SAFETY -->
    <section class="bg-white border rounded-2xl p-4 shadow-sm">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-2xl bg-red-50 border border-red-100 flex items-center justify-center">
          <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 9v4m0 4h.01M10.29 3.86l-7.14 12.36A2 2 0 004.88 19h14.24a2 2 0 001.73-2.78L13.71 3.86a2 2 0 00-3.42 0z"/></svg>
        </div>
        <div class="min-w-0">
          <div class="font-black text-sm text-slate-900">ã“ã‚Œã¯ã€Œé€šå ±ãƒ»è¨˜éŒ²ãƒ»å¼•ç¶™ãã€ã‚’é€Ÿãæ­£ç¢ºã«ã™ã‚‹ãŸã‚ã®ã‚¢ãƒ—ãƒªã§ã™</div>
          <div class="text-xs text-slate-600 font-bold leading-relaxed mt-1">
            é‡å¤§æ™‚ã¯ <span class="text-red-600 font-black">119</span> ã¨ã€ç¾å ´ã®æŒ‡ç¤ºï¼ˆæ•‘æ€¥éšŠãƒ»åŒ»å¸«ãƒ»ç®¡ç†è·ï¼‰ã‚’æœ€å„ªå…ˆã«ã€‚<br>
            è¨˜éŒ²ã¯ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã€å…±æœ‰ãƒ»å°åˆ·ã§å¼•ç¶™ãã§ãã¾ã™ã€‚
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2 mt-3">
        <button id="btnMarkStart" class="py-3 rounded-2xl bg-slate-900 text-white font-black text-xs active:scale-[0.99]">
          â± ç™ºç”Ÿï¼ˆé–‹å§‹ï¼‰ã‚’è¨˜éŒ²
        </button>
        <button id="btnCallAdmin" class="py-3 rounded-2xl border bg-white font-black text-xs active:bg-slate-50">
          ğŸ“£ å¿œæ´è¦è«‹ï¼ˆæ ¡å†…ï¼‰
        </button>
      </div>

      <div id="safetyQuick" class="grid grid-cols-2 gap-2 mt-3">
        <button class="chip rounded-2xl bg-red-600 text-white text-xs font-black" data-log="é‡å¤§ï¼šæ„è­˜ãªã— / å‘¼å¸ä¸æ˜ï¼ˆç·Šæ€¥å¯¾å¿œï¼‰">é‡å¤§ï¼šæ„è­˜ãªã—</button>
        <button class="chip rounded-2xl bg-orange-100 text-orange-900 text-xs font-black border border-orange-200" data-log="å®‰å…¨ç¢ºä¿ï¼šå‘¨å›²ã®å±é™ºæ’é™¤ / å…ç«¥ã‚’é›¢ã™">å®‰å…¨ç¢ºä¿</button>
        <button class="chip rounded-2xl bg-blue-100 text-blue-900 text-xs font-black border border-blue-200" data-log="é€£çµ¡ï¼šç®¡ç†è·ã¸å ±å‘Šï¼ˆçŠ¶æ³å…±æœ‰ï¼‰">ç®¡ç†è·ã¸å ±å‘Š</button>
        <button class="chip rounded-2xl bg-emerald-100 text-emerald-900 text-xs font-black border border-emerald-200" data-log="èª˜å°ï¼šæ­£é–€ã§æ•‘æ€¥éšŠã‚’èª˜å°ã™ã‚‹è·å“¡ã‚’é…ç½®">æ­£é–€èª˜å°</button>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="bg-white border rounded-2xl p-4 shadow-sm space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="font-black text-sm border-l-4 border-slate-900 pl-2">å­¦æ ¡ãƒ»é€£çµ¡ ã¾ã¨ã‚è¨­å®š</h2>
        <button id="btnToggleSettings" class="text-xs font-black text-blue-600">é–‹ã</button>
      </div>

      <div id="settingsPanel" class="hidden space-y-3 bg-slate-50 p-3 rounded-2xl border border-dashed border-slate-200">
        <div>
          <label class="input-label">å­¦æ ¡å</label>
          <input id="schoolName" class="w-full p-3 bg-white border rounded-xl text-sm font-bold" placeholder="ã€‡ã€‡å¸‚ç«‹ã€‡ã€‡å°å­¦æ ¡" />
        </div>
        <div>
          <label class="input-label">ä½æ‰€</label>
          <input id="schoolAddr" class="w-full p-3 bg-white border rounded-xl text-sm font-bold" placeholder="å¸‚åŒºç”ºæ‘ã‹ã‚‰ã®ä½æ‰€" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="input-label">å­¦æ ¡é›»è©±</label>
            <input id="schoolPhone" class="w-full p-3 bg-white border rounded-xl text-sm font-bold" placeholder="03-xxxx-xxxx" inputmode="tel" />
          </div>
          <div>
            <label class="input-label">ä¿è­·è€…é€£çµ¡ï¼ˆä»»æ„ï¼‰</label>
            <input id="guardianPhone" class="w-full p-3 bg-white border rounded-xl text-sm font-bold" placeholder="ä¾‹ï¼š090-xxxx-xxxx" inputmode="tel" />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="input-label">å¯¾å¿œè€…ï¼ˆä¸»ï¼‰</label>
            <input id="responder" class="w-full p-3 bg-white border rounded-xl text-sm font-bold" placeholder="ä¾‹ï¼šå’Œå±±" />
          </div>
          <div>
            <label class="input-label">è¨˜éŒ²è€…</label>
            <input id="recorder" class="w-full p-3 bg-white border rounded-xl text-sm font-bold" placeholder="ä¾‹ï¼šã€‡ã€‡" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="btnSaveSettings" class="py-3 rounded-2xl bg-slate-900 text-white text-xs font-black">ã“ã®ç«¯æœ«ã«ä¿å­˜</button>
          <button id="btnResetSettings" class="py-3 rounded-2xl bg-white border text-xs font-black active:bg-slate-50">è¨­å®šã‚’æ¶ˆå»</button>
        </div>

        <div class="text-[10px] font-bold text-slate-500">
          â€»è¨­å®šã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆlocalStorageï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚µãƒ¼ãƒé€ä¿¡ã¯ã—ã¾ã›ã‚“ã€‚
        </div>
      </div>

      <div class="grid grid-cols-1 gap-3">
        <div>
          <label class="input-label">æ ¡å†…ã®è©³ã—ã„å ´æ‰€ï¼ˆç™ºç”Ÿå ´æ‰€ï¼‰</label>
          <input id="place" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="ä¾‹ï¼š3Få›³å·¥å®¤ã€ä½“è‚²é¤¨åŒ—å´ãªã©" />
        </div>
      </div>
    </section>

    <!-- PATIENT -->
    <section class="bg-white border rounded-2xl p-4 shadow-sm space-y-3">
      <h2 class="font-black text-sm border-l-4 border-red-500 pl-2">å‚·ç—…è€…æƒ…å ±</h2>

      <div class="space-y-3">
        <div>
          <label class="input-label">æ°åï¼ˆãµã‚ŠãŒãªï¼‰</label>
          <input id="pName" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-black" placeholder="å±±ç”° å¤ªéƒï¼ˆã‚„ã¾ã  ãŸã‚ã†ï¼‰" />
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="input-label">å­¦å¹´ãƒ»åŒºåˆ†</label>
            <select id="pGrade" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-bold">
              <option value="">é¸æŠ</option>
              <option value="1">1å¹´</option>
              <option value="2">2å¹´</option>
              <option value="3">3å¹´</option>
              <option value="4">4å¹´</option>
              <option value="5">5å¹´</option>
              <option value="6">6å¹´</option>
              <option value="è·å“¡">æ•™è·å“¡</option>
              <option value="ä»–">ãã®ä»–</option>
            </select>
          </div>
          <div>
            <label class="input-label">æ€§åˆ¥</label>
            <select id="pSex" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-bold">
              <option value="">é¸æŠ</option>
              <option value="ç”·æ€§">ç”·æ€§</option>
              <option value="å¥³æ€§">å¥³æ€§</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 p-3 bg-blue-50 rounded-2xl border border-blue-100">
          <div>
            <label class="input-label text-blue-800">ç”Ÿå¹´æœˆæ—¥ï¼ˆä»»æ„ï¼‰</label>
            <input id="pBirth" type="date" class="w-full p-3 border rounded-xl text-sm bg-white font-bold" />
          </div>
          <div class="flex items-end">
            <div id="ageDisplay" class="w-full p-3 rounded-xl bg-white border border-blue-200 text-sm font-black text-blue-900 text-center h-[48px] flex items-center justify-center shadow-sm">
              å¹´é½¢ï¼š-- æ­³
            </div>
          </div>
        </div>

        <div>
          <label class="input-label">ä¸»ãªç—‡çŠ¶ï¼ˆçŸ­ãOKï¼‰</label>
          <textarea id="symptom" class="w-full p-3 bg-slate-50 border rounded-2xl text-sm font-bold" rows="2" placeholder="ä¾‹ï¼šå‘¼å¸è‹¦ã€æ„è­˜ã‚‚ã†ã‚ã†ã€å…¨èº«ã˜ã‚“ã¾ã—ã‚“ ç­‰"></textarea>
        </div>

        <button id="btnToggleMedical" class="w-full py-3 bg-slate-100 rounded-2xl text-[11px] font-black text-slate-600 flex justify-center items-center gap-2">
          æ—¢å¾€æ­´ãƒ»ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç­‰ï¼ˆå¿…è¦ãªã‚‰ï¼‰
          <svg id="iconMedical" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
        </button>
        <div id="medicalPanel" class="collapse-content bg-white">
          <div class="pt-3 space-y-3">
            <div>
              <label class="input-label">æ—¢å¾€æ­´ï¼ˆæŒç—…ï¼‰</label>
              <input id="pHistory" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-bold" placeholder="å–˜æ¯ã€ã¦ã‚“ã‹ã‚“ ç­‰" />
            </div>
            <div>
              <label class="input-label">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
              <input id="pAllergy" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-bold" placeholder="åµã€ãƒ”ãƒ¼ãƒŠãƒƒãƒ„ ç­‰" />
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <a id="btnCallGuardian" href="#" class="py-3 rounded-2xl bg-white border text-xs font-black flex items-center justify-center gap-2 active:bg-slate-50">
            ğŸ“ ä¿è­·è€…ã¸é›»è©±
          </a>
          <button id="btnCopyGuardianMsg" class="py-3 rounded-2xl bg-slate-900 text-white text-xs font-black active:scale-[0.99]">
            âœ‰ï¸ é€£çµ¡æ–‡ã‚’ã‚³ãƒ”ãƒ¼
          </button>
        </div>
      </div>
    </section>

    <!-- CALL SCRIPT -->
    <section class="bg-slate-900 rounded-2xl p-4 shadow-xl space-y-3">
      <div class="flex items-center justify-between border-b border-white/10 pb-2">
        <div>
          <div class="text-[10px] uppercase tracking-widest text-slate-400 font-black">119é€šå ±ç”¨ åŸç¨¿</div>
          <div class="text-[10px] text-slate-500 font-bold">å…¥åŠ›ã«å¿œã˜ã¦è‡ªå‹•ç”Ÿæˆ</div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnCopyScript" class="text-xs bg-white text-slate-900 px-3 py-2 rounded-full font-black active:bg-slate-200">
            ã‚³ãƒ”ãƒ¼
          </button>
          <button id="btnShareScript" class="text-xs bg-slate-700 text-white px-3 py-2 rounded-full font-black active:bg-slate-600">
            å…±æœ‰
          </button>
        </div>
      </div>
      <div id="scriptDisplay" class="text-white text-sm font-medium leading-relaxed min-h-[120px] whitespace-pre-wrap"></div>
    </section>

    <!-- TIMELINE / RECORD -->
    <section class="bg-white border rounded-2xl p-4 shadow-sm space-y-4">
      <div class="text-center">
        <h2 class="font-black text-slate-900">çµŒéãƒ»å‡¦ç½®ã®è¨˜éŒ²</h2>
        <p class="text-[10px] text-slate-500 font-black uppercase tracking-tight">Tap to Log / Voice / Edit</p>
      </div>

      <!-- VOICE -->
      <div class="flex flex-col items-center py-2">
        <div class="relative">
          <div id="pulseRing" class="absolute inset-0 rounded-full bg-red-400 hidden recording-ring"></div>
          <button id="btnVoiceRec" class="relative z-10 w-20 h-20 rounded-full bg-blue-600 text-white shadow-lg flex items-center justify-center flex-col gap-0.5 active:scale-95 transition-transform">
            <svg id="micIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-18a3 3 0 013 3v8a3 3 0 01-3 3 3 3 0 01-3-3V5a3 3 0 013-3z"></path></svg>
            <span id="micText" class="text-[9px] font-black tracking-tighter uppercase">REC START</span>
          </button>
        </div>
        <div id="interimText" class="mt-2 text-xs text-blue-600 font-black h-4 italic"></div>
        <div id="voiceHint" class="text-[10px] text-slate-500 font-bold mt-1">â€»å¯¾å¿œç«¯æœ«ã®ã¿éŸ³å£°å…¥åŠ›ã§ãã¾ã™</div>
      </div>

      <div class="space-y-2">
        <textarea id="voiceInputArea" class="w-full p-4 bg-slate-50 border rounded-2xl text-base font-bold focus:ring-2 focus:ring-blue-500 outline-none" rows="2" placeholder="è‡ªç”±å…¥åŠ›ï¼ˆä¾‹ï¼šâ—‹â—‹ã§è»¢å€’ã€è†ã‚’æ‰“æ’²ã€‚å†·å´é–‹å§‹ ãªã©ï¼‰"></textarea>
        <div class="grid grid-cols-2 gap-2">
          <button id="btnAddTimeline" class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg active:scale-[0.98]">ï¼‹ è¨˜éŒ²</button>
          <button id="btnUndo" class="w-full py-4 bg-white border font-black rounded-2xl active:bg-slate-50">â†© å–ã‚Šæ¶ˆã—</button>
        </div>
      </div>

      <hr class="my-3">

      <!-- QUICK LOGS -->
      <div class="space-y-3">
        <div class="border rounded-2xl overflow-hidden">
          <button class="accBtn w-full px-4 py-3 bg-blue-50 flex justify-between items-center text-blue-900 font-black text-sm" data-acc="acc-status">
            <span>STATUS / æ„è­˜ãƒ»å‘¼å¸</span>
            <svg class="w-4 h-4 transform transition-transform" id="icon-acc-status" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
          </button>
          <div id="acc-status" class="collapse-content bg-white">
            <div class="grid grid-cols-2 gap-2 p-3">
              <button class="chip bg-blue-100 text-blue-900 rounded-xl text-xs font-black border border-blue-200" data-log="æ„è­˜ã‚ã‚Šï¼ˆä¼šè©±å¯èƒ½ï¼‰">æ„è­˜ã‚ã‚Š</button>
              <button class="chip bg-orange-100 text-orange-900 rounded-xl text-xs font-black border border-orange-200" data-log="æ„è­˜æ··æ¿ï¼ˆåå¿œå¼±ã„ï¼‰">æ„è­˜æ··æ¿</button>
              <button class="chip bg-red-600 text-white rounded-xl text-xs font-black" data-log="æ„è­˜ãªã—ï¼ˆç„¡åå¿œï¼‰">æ„è­˜ãªã—</button>
              <button class="chip bg-slate-100 text-slate-900 rounded-xl text-xs font-black border" data-log="å‘¼å¸ï¼šæ­£å¸¸">å‘¼å¸æ­£å¸¸</button>
              <button class="chip bg-orange-100 text-orange-900 rounded-xl text-xs font-black border border-orange-200" data-log="å‘¼å¸ï¼šè‹¦ã—ãã†ï¼ˆå‘¼å¸å›°é›£ï¼‰">å‘¼å¸å›°é›£</button>
              <button class="chip bg-red-600 text-white rounded-xl text-xs font-black" data-log="å‘¼å¸ï¼šåœæ­¢/ä¸æ˜ï¼ˆç·Šæ€¥ï¼‰">å‘¼å¸åœæ­¢/ä¸æ˜</button>
            </div>
          </div>
        </div>

        <div class="border rounded-2xl overflow-hidden">
          <button class="accBtn w-full px-4 py-3 bg-slate-100 flex justify-between items-center text-slate-900 font-black text-sm" data-acc="acc-symptoms">
            <span>SYMPTOMS / å…¨èº«ç—‡çŠ¶</span>
            <svg class="w-4 h-4 transform transition-transform" id="icon-acc-symptoms" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
          </button>
          <div id="acc-symptoms" class="collapse-content bg-white">
            <div class="grid grid-cols-2 gap-2 p-3">
              <button class="chip bg-white border text-slate-900 rounded-xl text-xs font-black" data-log="é¡”é¢è’¼ç™½">é¡”é¢è’¼ç™½</button>
              <button class="chip bg-white border text-slate-900 rounded-xl text-xs font-black" data-log="å†·ã‚„æ±—ãŒå¤šã„">å†·ã‚„æ±—</button>
              <button class="chip bg-white border text-slate-900 rounded-xl text-xs font-black" data-log="å˜”åã‚ã‚Š">å˜”åã‚ã‚Š</button>
              <button class="chip bg-white border text-slate-900 rounded-xl text-xs font-black" data-log="ç—™æ”£ï¼ˆã‘ã„ã‚Œã‚“ï¼‰ã‚ã‚Š">ç—™æ”£ã‚ã‚Š</button>
              <button class="chip bg-white border text-slate-900 rounded-xl text-xs font-black" data-log="ã˜ã‚“ã¾ã—ã‚“å‡ºç¾">ã˜ã‚“ã¾ã—ã‚“</button>
              <button class="chip bg-white border text-slate-900 rounded-xl text-xs font-black" data-log="æ¿€ã—ã„è…¹ç—›">æ¿€ã—ã„è…¹ç—›</button>
              <button class="chip bg-white border text-slate-900 rounded-xl text-xs font-black" data-log="é¼»å‡ºè¡€ï¼ˆé¼»è¡€ï¼‰">é¼»å‡ºè¡€</button>
              <button class="chip bg-white border text-slate-900 rounded-xl text-xs font-black" data-log="ç—›ã¿ãŒå¼·ã„ï¼ˆéƒ¨ä½ï¼šæœªè¨˜è¼‰ï¼‰">å¼·ã„ç—›ã¿</button>
            </div>
          </div>
        </div>

        <div class="border rounded-2xl overflow-hidden">
          <button class="accBtn w-full px-4 py-3 bg-emerald-50 flex justify-between items-center text-emerald-900 font-black text-sm" data-acc="acc-treatment">
            <span>TREATMENT / å¯¾å¿œãƒ»å‡¦ç½®ï¼ˆè¨˜éŒ²ç”¨ï¼‰</span>
            <svg class="w-4 h-4 transform transition-transform" id="icon-acc-treatment" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
          </button>
          <div id="acc-treatment" class="collapse-content bg-white">
            <div class="grid grid-cols-2 gap-2 p-3">
              <button class="chip bg-emerald-100 text-emerald-900 rounded-xl text-xs font-black border border-emerald-200" data-log="å®‰é™ç¢ºä¿ï¼ˆåº§ä½/è‡¥ä½ï¼‰">å®‰é™ç¢ºä¿</button>
              <button class="chip bg-emerald-100 text-emerald-900 rounded-xl text-xs font-black border border-emerald-200" data-log="å†·å´é–‹å§‹ï¼ˆä¿å†·å‰¤ç­‰ï¼‰">å†·å´é–‹å§‹</button>
              <button class="chip bg-emerald-100 text-emerald-900 rounded-xl text-xs font-black border border-emerald-200" data-log="åœ§è¿«æ­¢è¡€ï¼ˆã‚¬ãƒ¼ã‚¼ç­‰ï¼‰">åœ§è¿«æ­¢è¡€</button>
              <button class="chip bg-emerald-100 text-emerald-900 rounded-xl text-xs font-black border border-emerald-200" data-log="ä¿æ¸©ï¼ˆæ¯›å¸ƒç­‰ï¼‰">ä¿æ¸©</button>
              <button class="chip bg-emerald-100 text-emerald-900 rounded-xl text-xs font-black border border-emerald-200" data-log="æ°´åˆ†æ‘‚å–ã¯æ§ãˆã‚‹ï¼ˆæŒ‡ç¤ºå¾…ã¡ï¼‰">é£²é£Ÿæ§ãˆ</button>
              <button class="chip bg-emerald-100 text-emerald-900 rounded-xl text-xs font-black border border-emerald-200" data-log="æ•‘æ€¥ã‚»ãƒƒãƒˆä½¿ç”¨ï¼ˆå†…å®¹ã¯åˆ¥é€”ï¼‰">æ•‘æ€¥ã‚»ãƒƒãƒˆ</button>

              <button class="chip bg-red-100 text-red-900 rounded-xl text-xs font-black border-2 border-red-200" data-log="AEDæº–å‚™/è£…ç€ï¼ˆè§£æå¾…ã¡ï¼‰">AEDæº–å‚™</button>
              <button class="chip bg-red-600 text-white rounded-xl text-xs font-black" data-log="æ•‘æ€¥éšŠã¸å¼•ç¶™ãé–‹å§‹">å¼•ç¶™ãé–‹å§‹</button>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-2">
          <button class="chip bg-slate-900 text-white rounded-2xl text-xs font-black" data-log="æ•‘æ€¥è»Š åˆ°ç€ï¼ˆæ­£é–€èª˜å°â†’å¼•ç¶™ãã¸ï¼‰">ğŸš‘ æ•‘æ€¥è»Š åˆ°ç€</button>
        </div>
      </div>

      <!-- LOG LIST -->
      <div class="pt-3">
        <div class="flex items-center justify-between">
          <h3 class="text-[11px] font-black text-slate-500 uppercase tracking-widest">Activity Log</h3>
          <div class="flex items-center gap-2">
            <button id="btnCopyTimeline" class="px-3 py-2 text-slate-600 text-xs font-black border rounded-full active:bg-slate-50">ã‚³ãƒ”ãƒ¼</button>
            <button id="btnExportTxt" class="px-3 py-2 text-slate-600 text-xs font-black border rounded-full active:bg-slate-50">TXT</button>
            <button id="btnExportJson" class="px-3 py-2 text-slate-600 text-xs font-black border rounded-full active:bg-slate-50">JSON</button>
          </div>
        </div>

        <div id="timeline" class="space-y-2 mt-3">
          <p id="timelineEmpty" class="text-center text-slate-400 py-10 text-sm font-bold">ï¼ˆè¨˜éŒ²ãªã—ï¼‰</p>
        </div>
      </div>
    </section>

    <!-- HANDOFF -->
    <section class="bg-white border rounded-2xl p-4 shadow-sm space-y-3">
      <h2 class="font-black text-sm border-l-4 border-blue-600 pl-2">å¼•ç¶™ãï¼ˆå°åˆ· / å…±æœ‰ï¼‰</h2>

      <div class="grid grid-cols-2 gap-2">
        <button id="btnPrint" class="py-4 bg-blue-600 text-white text-xs font-black rounded-2xl shadow-lg flex items-center justify-center gap-2 active:scale-95">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
          ç”¨ç´™ã¨ã—ã¦å°åˆ·
        </button>
        <button id="btnShareAll" class="py-4 bg-slate-900 text-white text-xs font-black rounded-2xl shadow-lg active:scale-95">
          å…±æœ‰ï¼ˆå…¨æ–‡ï¼‰
        </button>
      </div>

      <div class="text-[10px] text-slate-500 font-bold leading-relaxed">
        å…±æœ‰ã¯ç«¯æœ«ã®ã€Œå…±æœ‰ã€æ©Ÿèƒ½ãŒã‚ã‚‹å ´åˆã«å‹•ä½œã—ã¾ã™ï¼ˆãƒ¡ãƒ¼ãƒ«/Teams/ãƒ¡ãƒ¢ç­‰ã¸ï¼‰ã€‚<br>
        å°åˆ·ã¯ãƒ—ãƒªãƒ³ã‚¿ãŒãªãã¦ã‚‚ã€ŒPDFä¿å­˜ã€ã§æå‡ºç”¨ã«æ®‹ã›ã¾ã™ã€‚
      </div>
    </section>

  </main>

  <!-- BOTTOM ACTION BAR -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t no-print shadow-[0_-4px_15px_rgba(0,0,0,0.1)] z-50 safe-area-bottom">
    <div class="px-3 py-2 grid grid-cols-3 gap-2">
      <button id="btnGoCall" class="py-3 rounded-2xl bg-white border font-black text-xs active:bg-slate-50">â‘¡é€šå ±ã¸</button>
      <button id="btnGoLog" class="py-3 rounded-2xl bg-slate-900 text-white font-black text-xs active:scale-[0.99]">â‘¢è¨˜éŒ²ã¸</button>
      <button id="btnGoHandoff" class="py-3 rounded-2xl bg-blue-600 text-white font-black text-xs active:scale-[0.99]">â‘£å¼•ç¶™ãã¸</button>
    </div>
  </nav>

  <div id="toast" class="toast">OK</div>

<script>
  const $ = (id) => document.getElementById(id);

  // ---- constants
  const KEY_SETTINGS = "school_emergency_settings_v9";
  const KEY_INCIDENT  = "school_emergency_incident_v9";

  // ---- state
  let computedAgeStr = "--";
  let incidentStartAt = null; // timestamp
  let lastDeleted = null; // undo payload { id, data, index }

  // ---- toast
  function toast(msg) {
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1200);
  }
  function haptic(ms=15){ if(navigator.vibrate) navigator.vibrate(ms); }

  // ---- helpers
  function nowTimeStr(d=new Date()) {
    return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }
  function nowDateTimeStr(d=new Date()) {
    return d.toLocaleString('ja-JP');
  }
  function safeText(v){ return (v||"").toString().trim(); }

  // ---- accordion
  function toggleAccordion(id){
    const el = $(id);
    const icon = $("icon-" + id);
    el.classList.toggle("open");
    icon.classList.toggle("rotate-180");
  }
  document.querySelectorAll(".accBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      toggleAccordion(btn.dataset.acc);
    });
  });

  // medical panel
  $("btnToggleMedical").onclick = ()=>{
    $("medicalPanel").classList.toggle("open");
    $("iconMedical").classList.toggle("rotate-180");
  };

  // settings
  $("btnToggleSettings").onclick = ()=>{
    $("settingsPanel").classList.toggle("hidden");
    $("btnToggleSettings").textContent = $("settingsPanel").classList.contains("hidden") ? "é–‹ã" : "é–‰ã˜ã‚‹";
  };

  // ---- stepper scroll
  function scrollToSection(selector){
    const el = document.querySelector(selector);
    if(!el) return;
    el.scrollIntoView({behavior:"smooth", block:"start"});
  }
  function setStepActive(step){
    document.querySelectorAll(".stepBtn").forEach(b=>{
      const on = (b.dataset.step === String(step));
      b.classList.toggle("bg-slate-900", on);
      b.classList.toggle("text-white", on);
      b.classList.toggle("border-slate-900", on);
      b.classList.toggle("bg-white", !on);
    });
  }
  document.querySelectorAll(".stepBtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      const s = b.dataset.step;
      setStepActive(s);
      if(s==="1") scrollToSection("main section:nth-of-type(1)");
      if(s==="2") scrollToSection("section:nth-of-type(4)"); // call script card
      if(s==="3") scrollToSection("section:nth-of-type(5)"); // timeline card
      if(s==="4") scrollToSection("section:nth-of-type(6)"); // handoff
    });
  });
  $("btnGoCall").onclick = ()=>{ setStepActive(2); scrollToSection("section:nth-of-type(4)"); };
  $("btnGoLog").onclick  = ()=>{ setStepActive(3); scrollToSection("section:nth-of-type(5)"); };
  $("btnGoHandoff").onclick = ()=>{ setStepActive(4); scrollToSection("section:nth-of-type(6)"); };

  // ---- elapsed timer
  function tickElapsed(){
    const badge = $("elapsedBadge");
    if(!incidentStartAt){ badge.textContent = "--:--"; return; }
    const diff = Date.now() - incidentStartAt;
    const m = Math.floor(diff/60000);
    const s = Math.floor((diff%60000)/1000);
    badge.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }
  setInterval(tickElapsed, 1000);

  // ---- age calc
  function updateAge(){
    const birthVal = $("pBirth").value;
    const gradeVal = $("pGrade").value;
    const now = new Date();
    if (birthVal) {
      const birthDate = new Date(birthVal);
      let age = now.getFullYear() - birthDate.getFullYear();
      const m = now.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && now.getDate() < birthDate.getDate())) age--;
      computedAgeStr = `${age}æ­³`;
    } else if (gradeVal && !isNaN(gradeVal)) {
      const grade = parseInt(gradeVal,10);
      computedAgeStr = `${grade + 5}ã€œ${grade + 6}æ­³ç›¸å½“`;
    } else {
      computedAgeStr = "--";
    }
    $("ageDisplay").innerText = `å¹´é½¢ï¼š${computedAgeStr}`;
    buildScript();
    persistIncident();
  }

  // ---- call/guardian helpers
  function guardianHref(){
    const p = safeText($("guardianPhone").value);
    return p ? `tel:${p}` : "#";
  }
  function updateGuardianLink(){
    const a = $("btnCallGuardian");
    const p = safeText($("guardianPhone").value);
    if(p){
      a.href = `tel:${p}`;
      a.classList.remove("opacity-50");
    }else{
      a.href = "#";
      a.classList.add("opacity-50");
    }
  }

  // ---- speech recognition
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let isRecording = false;

  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = "ja-JP";
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.onresult = (event)=>{
      let interim = "";
      let final = "";
      for(let i=event.resultIndex; i<event.results.length; i++){
        if(event.results[i].isFinal) final += event.results[i][0].transcript;
        else interim += event.results[i][0].transcript;
      }
      if(final) $("voiceInputArea").value += final;
      $("interimText").innerText = interim;
    };
    recognition.onend = ()=>{
      if(isRecording) recognition.start();
    };
  } else {
    $("voiceHint").textContent = "â€»ã“ã®ç«¯æœ«ã§ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“";
    $("btnVoiceRec").disabled = true;
    $("btnVoiceRec").classList.add("opacity-50");
  }

  function startRec(){
    if(!recognition) return;
    isRecording = true;
    try {
      recognition.start();
      $("pulseRing").classList.remove("hidden");
      $("btnVoiceRec").classList.replace("bg-blue-600","bg-red-600");
      $("micText").innerText = "REC ON";
      toast("éŒ²éŸ³é–‹å§‹");
      haptic(20);
    } catch(e){
      // ignore if already started
    }
  }
  function stopRec(){
    isRecording = false;
    if(recognition) recognition.stop();
    $("pulseRing").classList.add("hidden");
    $("btnVoiceRec").classList.replace("bg-red-600","bg-blue-600");
    $("micText").innerText = "REC START";
    $("interimText").innerText = "";
    haptic(10);
  }
  $("btnVoiceRec").onclick = ()=> isRecording ? stopRec() : startRec();

  // ---- timeline CRUD
  function makeEntryObj(text, t=new Date()){
    return {
      id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
      at: t.toISOString(),
      time: nowTimeStr(t),
      text: safeText(text),
      important: false
    };
  }

  function renderEntry(entry){
    const div = document.createElement("div");
    div.className = "bg-white border rounded-2xl p-3 shadow-sm";
    div.dataset.id = entry.id;

    const impClass = entry.important ? "bg-yellow-50 border-yellow-200" : "";
    div.classList.add(...impClass.split(" ").filter(Boolean));

    div.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="shrink-0">
          <div class="text-blue-600 font-black text-xs">${entry.time}</div>
          <button class="mt-1 px-2 py-1 rounded-full text-[10px] font-black border ${entry.important ? "bg-yellow-200 border-yellow-300" : "bg-slate-50"}" data-act="imp">
            ${entry.important ? "â˜…é‡è¦" : "â˜†é‡è¦"}
          </button>
        </div>
        <div class="flex-1 min-w-0">
          <div class="text-slate-900 text-sm font-black whitespace-pre-wrap break-words" data-role="text">${escapeHtml(entry.text)}</div>
          <div class="flex items-center gap-2 mt-2">
            <button class="px-3 py-2 rounded-full text-xs font-black border bg-white active:bg-slate-50" data-act="edit">ç·¨é›†</button>
            <button class="px-3 py-2 rounded-full text-xs font-black border bg-white active:bg-slate-50" data-act="del">å‰Šé™¤</button>
            <button class="ml-auto px-3 py-2 rounded-full text-xs font-black bg-slate-900 text-white active:scale-[0.99]" data-act="dup">åŒã˜å†…å®¹</button>
          </div>
        </div>
      </div>
    `;
    div.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const act = btn.dataset.act;
      if(act==="edit") editEntry(entry.id);
      if(act==="del") deleteEntry(entry.id);
      if(act==="dup") addEntry(entry.text);
      if(act==="imp") toggleImportant(entry.id);
    });
    return div;
  }

  function escapeHtml(str){
    return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function getEntries(){
    const saved = localStorage.getItem(KEY_INCIDENT);
    if(!saved) return [];
    try { return (JSON.parse(saved).entries || []); } catch { return []; }
  }
  function setEntries(entries){
    const incident = loadIncidentRaw() || {};
    incident.entries = entries;
    localStorage.setItem(KEY_INCIDENT, JSON.stringify(incident));
  }

  function refreshTimeline(){
    const box = $("timeline");
    box.innerHTML = "";
    const entries = getEntries();
    if(entries.length===0){
      $("timelineEmpty").classList.remove("hidden");
      box.appendChild($("timelineEmpty"));
      return;
    }
    $("timelineEmpty").classList.add("hidden");

    // newest first
    entries.slice().reverse().forEach(en=>{
      box.appendChild(renderEntry(en));
    });
  }

  function addEntry(text){
    const t = safeText(text);
    if(!t) return;

    const entries = getEntries();
    const obj = makeEntryObj(t, new Date());
    entries.push(obj);
    setEntries(entries);

    $("voiceInputArea").value = "";
    stopRec();
    refreshTimeline();
    buildScript();
    persistIncident();

    toast("è¨˜éŒ²ã—ã¾ã—ãŸ");
    haptic(12);
  }

  function findEntryIndex(entries, id){
    return entries.findIndex(e=>e.id===id);
  }

  function editEntry(id){
    const entries = getEntries();
    const idx = findEntryIndex(entries, id);
    if(idx<0) return;
    const current = entries[idx].text;
    const next = prompt("è¨˜éŒ²ã‚’ç·¨é›†ï¼ˆçŸ­ãã¦ã‚‚OKï¼‰", current);
    if(next===null) return;
    entries[idx].text = safeText(next);
    setEntries(entries);
    refreshTimeline();
    buildScript();
    persistIncident();
    toast("ç·¨é›†ã—ã¾ã—ãŸ");
  }

  function deleteEntry(id){
    const entries = getEntries();
    const idx = findEntryIndex(entries, id);
    if(idx<0) return;

    const removed = entries.splice(idx,1)[0];
    setEntries(entries);
    lastDeleted = { removed, idx };
    refreshTimeline();
    buildScript();
    persistIncident();
    toast("å‰Šé™¤ã—ã¾ã—ãŸï¼ˆå–ã‚Šæ¶ˆã—å¯ï¼‰");
    haptic(10);
  }

  function toggleImportant(id){
    const entries = getEntries();
    const idx = findEntryIndex(entries, id);
    if(idx<0) return;
    entries[idx].important = !entries[idx].important;
    setEntries(entries);
    refreshTimeline();
    persistIncident();
  }

  $("btnUndo").onclick = ()=>{
    if(!lastDeleted) { toast("å–ã‚Šæ¶ˆã™ã‚‚ã®ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
    const entries = getEntries();
    entries.splice(lastDeleted.idx, 0, lastDeleted.removed);
    setEntries(entries);
    lastDeleted = null;
    refreshTimeline();
    persistIncident();
    toast("å–ã‚Šæ¶ˆã—ã¾ã—ãŸ");
  };

  // quick log buttons
  document.querySelectorAll("[data-log]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      addEntry(btn.dataset.log);
    });
  });

  $("btnAddTimeline").onclick = ()=> addEntry($("voiceInputArea").value);

  // ---- call script builder
  function gradeLabel(){
    const v = $("pGrade").value;
    if(!v) return "ï¼ˆä¸æ˜ï¼‰";
    if(/^\d$/.test(v)) return v + "å¹´ç”Ÿ";
    return v;
  }

  function buildScript(){
    const data = {
      school: $("schoolName").value || "ï¼ˆå­¦æ ¡åï¼‰",
      addr: $("schoolAddr").value || "ï¼ˆå­¦æ ¡ä½æ‰€ï¼‰",
      place: $("place").value || "ï¼ˆæ ¡å†…ã®å ´æ‰€ï¼‰",
      phone: $("schoolPhone").value || "ï¼ˆé›»è©±ï¼‰",
      pName: $("pName").value || "ï¼ˆæ°åï¼‰",
      pGrade: gradeLabel(),
      pSex: $("pSex").value || "ï¼ˆæ€§åˆ¥ï¼‰",
      age: (computedAgeStr !== "--") ? computedAgeStr : "",
      symptom: $("symptom").value || "ï¼ˆç—‡çŠ¶ï¼‰",
      responder: $("responder").value || "ï¼ˆå¯¾å¿œè€…ï¼‰",
    };

    const startLine = incidentStartAt ? `ç™ºç”Ÿï¼š${new Date(incidentStartAt).toLocaleString('ja-JP')}` : `ç™ºç”Ÿï¼šæœªè¨˜éŒ²`;
    const escortLine = `æ­£é–€ã«ã¦èª˜å°å¾…æ©Ÿã—ã¾ã™ã€‚`;
    const script =
`ã€Œæ•‘æ€¥è¦è«‹ã§ã™ã€ 
${startLine}

å ´æ‰€ï¼š${data.school}
ä½æ‰€ï¼š${data.addr}
æ ¡å†…ï¼š${data.place}
é›»è©±ï¼š${data.phone}

å¯¾è±¡ï¼š${data.pName}ï¼ˆ${data.pGrade}ãƒ»${data.pSex}${data.age ? "ãƒ»" + data.age : ""}ï¼‰
ç—‡çŠ¶ï¼š${data.symptom}

å¯¾å¿œï¼š${data.responder}
${escortLine}`;

    $("scriptDisplay").innerText = script.trim();
  }

  // ---- copy/share
  async function copyText(text){
    try {
      await navigator.clipboard.writeText(text);
      toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    } catch {
      const temp = document.createElement("textarea");
      temp.value = text;
      document.body.appendChild(temp);
      temp.select();
      document.execCommand("copy");
      document.body.removeChild(temp);
      toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }
  }

  function fullReportText(){
    const entries = getEntries();
    const lines = entries.map(e=> `${e.time} ${e.important ? "â˜… " : ""}${e.text}`);
    const contact = safeText($("guardianPhone").value) ? `ä¿è­·è€…é€£çµ¡ï¼š${$("guardianPhone").value}` : `ä¿è­·è€…é€£çµ¡ï¼šæœªè¨­å®š`;
    return [
      "ã€æ•‘æ€¥å¯¾å¿œ è¨˜éŒ²ã€‘",
      `ä½œæˆï¼š${nowDateTimeStr()}`,
      "",
      `å­¦æ ¡ï¼š${$("schoolName").value || "æœªè¨­å®š"}`,
      `ä½æ‰€ï¼š${$("schoolAddr").value || "æœªè¨­å®š"}`,
      `é›»è©±ï¼š${$("schoolPhone").value || "æœªè¨­å®š"}`,
      `ç™ºç”Ÿå ´æ‰€ï¼š${$("place").value || "æœªå…¥åŠ›"}`,
      "",
      `å‚·ç—…è€…ï¼š${$("pName").value || "æœªå…¥åŠ›"}`,
      `å­¦å¹´ç­‰ï¼š${gradeLabel()}`,
      `æ€§åˆ¥ï¼š${$("pSex").value || "-"}`,
      `å¹´é½¢ï¼š${computedAgeStr}`,
      `ç—‡çŠ¶ï¼š${$("symptom").value || "-"}`,
      `æ—¢å¾€ï¼š${$("pHistory").value || "-"}`,
      `ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ï¼š${$("pAllergy").value || "-"}`,
      "",
      `å¯¾å¿œè€…ï¼š${$("responder").value || "-"}`,
      `è¨˜éŒ²è€…ï¼š${$("recorder").value || "-"}`,
      contact,
      "",
      "ã€æ™‚ç³»åˆ—ã€‘",
      ...(lines.length ? lines : ["ï¼ˆè¨˜éŒ²ãªã—ï¼‰"]),
    ].join("\n");
  }

  async function shareText(title, text){
    if(navigator.share){
      try{
        await navigator.share({ title, text });
        toast("å…±æœ‰ã—ã¾ã—ãŸ");
        return;
      }catch(e){
        // user canceled or not supported
      }
    }
    await copyText(text);
    toast("å…±æœ‰ã§ããªã„ãŸã‚ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  }

  $("btnCopyScript").onclick = ()=> copyText($("scriptDisplay").innerText);
  $("btnShareScript").onclick = ()=> shareText("119é€šå ±ç”¨åŸç¨¿", $("scriptDisplay").innerText);

  $("btnCopyTimeline").onclick = ()=>{
    const entries = getEntries();
    const lines = entries.map(e=> `${e.time} ${e.important ? "â˜… " : ""}${e.text}`);
    copyText(lines.join("\n") || "ï¼ˆè¨˜éŒ²ãªã—ï¼‰");
  };

  // ---- exports
  function downloadBlob(filename, text, type="text/plain"){
    const blob = new Blob([text], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  $("btnExportTxt").onclick = ()=>{
    const name = ($("pName").value || "report").replace(/\s+/g,"_");
    downloadBlob(`emergency_${name}_${Date.now()}.txt`, fullReportText(), "text/plain");
    toast("TXTã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ");
  };
  $("btnExportJson").onclick = ()=>{
    const obj = loadIncidentRaw() || {};
    downloadBlob(`emergency_data_${Date.now()}.json`, JSON.stringify(obj, null, 2), "application/json");
    toast("JSONã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ");
  };

  $("btnShareAll").onclick = ()=> shareText("æ•‘æ€¥å¯¾å¿œ è¨˜éŒ²", fullReportText());

  // ---- print
  $("btnPrint").onclick = ()=>{
    // populate print
    $("printTimestamp").innerText = `ä½œæˆï¼š${nowDateTimeStr()}`;

    $("p_schoolName").innerText = $("schoolName").value || "æœªè¨­å®š";
    $("p_schoolAddrPhone").innerText = `${$("schoolAddr").value || "æœªè¨­å®š"} / ${$("schoolPhone").value || "æœªè¨­å®š"}`;
    $("p_place").innerText = $("place").value || "æœªå…¥åŠ›";

    $("p_name").innerText = $("pName").value || "æœªå…¥åŠ›";
    $("p_gradeSexAge").innerText = `${gradeLabel()} / ${$("pSex").value || "-"} / ${computedAgeStr}`;

    let med = `ã€ç—‡çŠ¶ã€‘${$("symptom").value || "æœªå…¥åŠ›"}`;
    if($("pHistory").value) med += `ã€€ã€æ—¢å¾€ã€‘${$("pHistory").value}`;
    if($("pAllergy").value) med += `ã€€ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã€‘${$("pAllergy").value}`;
    $("p_med").innerText = med;

    $("p_responder").innerText = $("responder").value || "-";
    $("p_recorder").innerText = $("recorder").value || "-";
    $("p_contact").innerText = $("guardianPhone").value ? `ä¿è­·è€…ï¼š${$("guardianPhone").value}` : "æœªè¨­å®š";

    // timeline
    const entries = getEntries();
    const container = $("p_timeline");
    container.innerHTML = "";
    if(entries.length===0){
      container.innerHTML = `<div class="print-row text-sm text-gray-500">è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    } else {
      entries.forEach(e=>{
        const row = document.createElement("div");
        row.className = "print-row flex gap-3";
        row.innerHTML = `<div class="w-16 font-bold">${e.time}</div><div class="flex-1 text-sm">${escapeHtml((e.important ? "â˜… " : "") + e.text)}</div>`;
        container.appendChild(row);
      });
    }

    window.print();
  };

  // ---- start mark
  $("btnMarkStart").onclick = ()=>{
    if(!incidentStartAt){
      incidentStartAt = Date.now();
      persistIncident();
      toast("é–‹å§‹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ");
      haptic(18);
      buildScript();
    } else {
      toast("ã™ã§ã«é–‹å§‹ã¯è¨˜éŒ²æ¸ˆã¿");
    }
  };

  // ---- call admin (log only)
  $("btnCallAdmin").onclick = ()=>{
    addEntry("å¿œæ´è¦è«‹ï¼šæ ¡å†…ã¸å”åŠ›ä¾é ¼ï¼ˆå½¹å‰²åˆ†æ‹…ï¼‰");
  };

  // ---- guardian msg copy
  $("btnCopyGuardianMsg").onclick = ()=>{
    const msg =
`ã€å­¦æ ¡ã‹ã‚‰ã®é€£çµ¡ã€‘${$("schoolName").value || "ï¼ˆå­¦æ ¡ï¼‰"}ã§ã™ã€‚
ãŠå­ã•ã‚“ã®ä½“èª¿ä¸è‰¯/è² å‚·ã§å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
çŠ¶æ³ï¼š${$("symptom").value || "ç¢ºèªä¸­"}
å ´æ‰€ï¼š${$("place").value || "æ ¡å†…"}
å¿…è¦ã«å¿œã˜ã¦æ•‘æ€¥è¦è«‹ãƒ»åŒ»ç™‚æ©Ÿé–¢å—è¨ºã‚’è¡Œã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
æŠ˜ã‚Šè¿”ã—é€£çµ¡å…ˆï¼š${$("schoolPhone").value || "ï¼ˆå­¦æ ¡é›»è©±ï¼‰"}`;
    copyText(msg);
  };

  // ---- new incident (clear)
  $("btnNewIncident").onclick = ()=>{
    const ok = confirm("æ–°è¦å¯¾å¿œã¨ã—ã¦è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚\nï¼ˆå­¦æ ¡è¨­å®šã¯æ®‹ã‚Šã¾ã™ï¼‰\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if(!ok) return;
    localStorage.removeItem(KEY_INCIDENT);
    incidentStartAt = null;
    lastDeleted = null;
    $("place").value = "";
    $("pName").value = "";
    $("pGrade").value = "";
    $("pSex").value = "";
    $("pBirth").value = "";
    $("symptom").value = "";
    $("pHistory").value = "";
    $("pAllergy").value = "";
    computedAgeStr = "--";
    $("ageDisplay").innerText = `å¹´é½¢ï¼š${computedAgeStr} æ­³`;
    $("voiceInputArea").value = "";
    refreshTimeline();
    buildScript();
    toast("æ–°è¦ã¨ã—ã¦é–‹å§‹ã§ãã¾ã™");
  };

  // ---- settings save/reset
  $("btnSaveSettings").onclick = ()=>{
    const settings = {
      schoolName: $("schoolName").value,
      schoolAddr: $("schoolAddr").value,
      schoolPhone: $("schoolPhone").value,
      guardianPhone: $("guardianPhone").value,
      responder: $("responder").value,
      recorder: $("recorder").value,
    };
    localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings));
    toast("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    haptic(12);
    updateGuardianLink();
    persistIncident();
    buildScript();
  };

  $("btnResetSettings").onclick = ()=>{
    const ok = confirm("å­¦æ ¡ãƒ»é€£çµ¡ã®è¨­å®šã‚’æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
    if(!ok) return;
    localStorage.removeItem(KEY_SETTINGS);
    ["schoolName","schoolAddr","schoolPhone","guardianPhone","responder","recorder"].forEach(id=> $(id).value="");
    updateGuardianLink();
    persistIncident();
    buildScript();
    toast("è¨­å®šã‚’æ¶ˆå»ã—ã¾ã—ãŸ");
  };

  function loadSettings(){
    const saved = localStorage.getItem(KEY_SETTINGS);
    if(!saved) return;
    try{
      const s = JSON.parse(saved);
      $("schoolName").value = s.schoolName || "";
      $("schoolAddr").value = s.schoolAddr || "";
      $("schoolPhone").value = s.schoolPhone || "";
      $("guardianPhone").value = s.guardianPhone || "";
      $("responder").value = s.responder || "";
      $("recorder").value = s.recorder || "";
    }catch(e){}
  }

  // ---- incident persistence (autosave)
  function loadIncidentRaw(){
    const saved = localStorage.getItem(KEY_INCIDENT);
    if(!saved) return null;
    try { return JSON.parse(saved); } catch { return null; }
  }

  function persistIncident(){
    const cur = loadIncidentRaw() || {};
    cur.meta = {
      updatedAt: Date.now(),
      startAt: incidentStartAt,
    };
    cur.form = {
      place: $("place").value,
      pName: $("pName").value,
      pGrade: $("pGrade").value,
      pSex: $("pSex").value,
      pBirth: $("pBirth").value,
      symptom: $("symptom").value,
      pHistory: $("pHistory").value,
      pAllergy: $("pAllergy").value,
      computedAgeStr,
    };
    // entries are managed separately in setEntries/getEntries but keep consistent
    if(!cur.entries) cur.entries = [];
    localStorage.setItem(KEY_INCIDENT, JSON.stringify(cur));
  }

  let autosaveTimer = null;
  function scheduleAutosave(){
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(()=>{
      persistIncident();
    }, 250);
  }

  function loadIncident(){
    const obj = loadIncidentRaw();
    if(!obj) return;
    const form = obj.form || {};
    $("place").value = form.place || "";
    $("pName").value = form.pName || "";
    $("pGrade").value = form.pGrade || "";
    $("pSex").value = form.pSex || "";
    $("pBirth").value = form.pBirth || "";
    $("symptom").value = form.symptom || "";
    $("pHistory").value = form.pHistory || "";
    $("pAllergy").value = form.pAllergy || "";
    computedAgeStr = form.computedAgeStr || "--";
    $("ageDisplay").innerText = `å¹´é½¢ï¼š${computedAgeStr}`;

    incidentStartAt = obj.meta?.startAt || null;

    // restore entries if present
    if(Array.isArray(obj.entries)){
      localStorage.setItem(KEY_INCIDENT, JSON.stringify(obj)); // keep as-is
    }
  }

  // ---- inputs listeners
  ["pBirth","pGrade"].forEach(id=>{
    $(id).addEventListener("change", ()=>{ updateAge(); scheduleAutosave(); });
  });
  document.querySelectorAll("input, textarea, select").forEach(el=>{
    el.addEventListener("input", ()=>{
      buildScript();
      updateGuardianLink();
      scheduleAutosave();
    });
  });

  // ---- init
  loadSettings();
  loadIncident();
  updateGuardianLink();

  // ensure entries exist in incident storage
  const raw = loadIncidentRaw();
  if(raw && Array.isArray(raw.entries)){
    // ok
  } else {
    const base = raw || {};
    base.entries = [];
    localStorage.setItem(KEY_INCIDENT, JSON.stringify(base));
  }

  refreshTimeline();
  buildScript();
  tickElapsed();

  // step default
  setStepActive(1);
</script>

</body>
</html>
